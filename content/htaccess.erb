
# CORS-enabled images
<IfModule mod_setenvif.c>
  <IfModule mod_headers.c>
    <FilesMatch "\.(gif|ico|jpe?g|png|svgz?|webp)$">
      SetEnvIf Origin ":" IS_CORS
      Header set Access-Control-Allow-Origin "*" env=IS_CORS
    </FilesMatch>
  </IfModule>
</IfModule>

# Allow access from all domains for web fonts
<IfModule mod_headers.c>
  <FilesMatch "\.(eot|font.css|otf|ttc|ttf|woff)$">
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>
</IfModule>

Options -MultiViews
ErrorDocument 404 /404/index.html
# Don't really need to worry about other error documents...

# Force IE to render pages in the highest available mode in the various
# cases when it may not
<IfModule mod_headers.c>
    Header set X-UA-Compatible "IE=edge"
    # `mod_headers` can't match based on the content-type, however, we only
    # want to send this header for HTML pages and not for the other resources
    <FilesMatch "\.(appcache|crx|css|eot|gif|htc|ico|jpe?g|js|m4a|m4v|manifest|mp4|oex|oga|ogg|ogv|otf|pdf|png|safariextz|svgz?|ttf|vcf|webapp|webm|webp|woff|xml|xpi)$">
        Header unset X-UA-Compatible
    </FilesMatch>
</IfModule>

# Mime types and encoding
<IfModule mod_mime.c>
  # Audio
  AddType audio/mp4                                   m4a f4a f4b
  AddType audio/ogg                                   oga ogg

  # JavaScript
  # Normalize to standard type (it's sniffed in IE anyways):
  # http://tools.ietf.org/html/rfc4329#section-7.2
  AddType application/javascript                      js
  AddType application/json                            json

  # Video
  AddType video/mp4                                   mp4 m4v f4v f4p
  AddType video/ogg                                   ogv
  AddType video/webm                                  webm
  AddType video/x-flv                                 flv

  # Web fonts
  AddType application/font-woff                       woff
  AddType application/vnd.ms-fontobject               eot

  # Browsers usually ignore the font MIME types and sniff the content,
  # however, Chrome shows a warning if other MIME types are used for the
  # following fonts.
  AddType application/x-font-ttf                      ttc ttf
  AddType font/opentype                               otf

  # Make SVGZ fonts work on iPad:
  # https://twitter.com/FontSquirrel/status/14855840545
  AddType     image/svg+xml                           svg svgz
  AddEncoding gzip                                    svgz

  # Other
  AddType application/octet-stream                    safariextz
  AddType application/x-chrome-extension              crx
  AddType application/x-opera-extension               oex
  AddType application/x-shockwave-flash               swf
  AddType application/x-web-app-manifest+json         webapp
  AddType application/x-xpinstall                     xpi
  AddType application/xml                             atom rdf rss xml
  AddType image/webp                                  webp
  AddType image/x-icon                                ico
  AddType text/cache-manifest                         appcache manifest
  AddType text/vtt                                    vtt
  AddType text/x-component                            htc
  AddType text/x-vcard                                vcf
</IfModule>

# Use UTF-8 encoding for anything served as `text/html` or `text/plain`.
AddDefaultCharset utf-8

# Force UTF-8 for certain file formats.
<IfModule mod_mime.c>
  AddCharset utf-8 .atom .css .js .json .rss .vtt .webapp .xml
</IfModule>

# URL rewrites

# Turning on the rewrite engine and enabling the `FollowSymLinks` option is
# necessary for the following directives to work.
<IfModule mod_rewrite.c>
  Options +FollowSymlinks
  # Options +SymLinksIfOwnerMatch
  RewriteEngine On
  # RewriteBase /
</IfModule>

# Rewrite www.example.com â†’ example.com
<IfModule mod_rewrite.c>
  RewriteCond %{HTTPS} !=on
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^ http://%1%{REQUEST_URI} [R=301,L]
</IfModule>

# Content Security Policy (CSP)

# You can mitigate the risk of cross-site scripting and other content-injection
# attacks by setting a Content Security Policy which whitelists trusted sources
# of content for your site.

# The example header below allows ONLY scripts that are loaded from the current
# site's origin (no inline scripts, no CDN, etc). This almost certainly won't
# work as-is for your site!

# To get all the details you'll need to craft a reasonable policy for your site,
# read: http://html5rocks.com/en/tutorials/security/content-security-policy (or
# see the specification: http://w3.org/TR/CSP).

# <IfModule mod_headers.c>
#  Header set Content-Security-Policy "script-src 'self'; object-src 'self'"
#  <FilesMatch "\.(appcache|crx|css|eot|gif|htc|ico|jpe?g|js|m4a|m4v|manifest|mp4|oex|oga|ogg|ogv|otf|pdf|png|safariextz|svgz?|ttf|vcf|webapp|webm|webp|woff|xml|xpi)$">
#    Header unset Content-Security-Policy
#  </FilesMatch>
# </IfModule>

# File access

# Block access to directories without a default document. Usually you should
# leave this uncommented because you shouldn't allow anyone to surf through
# every directory on your server (which may includes rather private places like
# the CMS's directories).
<IfModule mod_autoindex.c>
  Options -Indexes
</IfModule>

# Block access to hidden files and directories.
<IfModule mod_rewrite.c>
  RewriteCond %{SCRIPT_FILENAME} -d [OR]
  RewriteCond %{SCRIPT_FILENAME} -f
  RewriteRule "(^|/)\." - [F]
</IfModule>

# Block access to backup and source files.
<FilesMatch "(^#.*#|\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
  Order allow,deny
  Deny from all
  Satisfy All
</FilesMatch>

# Secure Sockets Layer (SSL)

#<IfModule mod_rewrite.c>
#  RewriteCond %{SERVER_PORT} !^443
#  RewriteRule ^ https://example.com%{REQUEST_URI} [R=301,L]
#</IfModule>

# HTTP Strict Transport Security (HSTS)

# Force client-side SSL redirection.

# If a user types "example.com" in his browser, the above rule will redirect
# him to the secure version of the site. That still leaves a window of oppor-
# tunity (the initial HTTP connection) for an attacker to downgrade or redirect
# the request. The following header ensures that browser will ONLY connect to
# your server via HTTPS, regardless of what the users type in the address bar.
# http://tools.ietf.org/html/draft-ietf-websec-strict-transport-sec-14#section-6.1
# http://www.html5rocks.com/en/tutorials/security/transport-layer-security/

# (!) Remove the `includeSubDomains` optional directive if the subdomains are
# not using HTTPS.

#<IfModule mod_headers.c>
#  Header set Strict-Transport-Security "max-age=16070400; includeSubDomains"
#</IfModule>

# Web Performance

# Compression
<IfModule mod_deflate.c>
  <IfModule mod_setenvif.c>
    <IfModule mod_headers.c>
      SetEnvIfNoCase ^(Accept-EncodXng|X-cept-Encoding|X{15}|~{15}|-{15})$ ^((gzip|deflate)\s*,?\s*)+|[X~-]{4,13}$ HAVE_Accept-Encoding
      RequestHeader append Accept-Encoding "gzip,deflate" env=HAVE_Accept-Encoding
    </IfModule>
  </IfModule>

  # Compress all output labeled with one of the following MIME-types (for
  # Apache versions below 2.3.7, you don't need to enable `mod_filter` and can
  # remove the `<IfModule mod_filter.c>` and `</IfModule>` lines as
  # `AddOutputFilterByType` is still in the core directives).
  <IfModule mod_filter.c>
    AddOutputFilterByType DEFLATE application/atom+xml \
                                  application/javascript \
                                  application/json \
                                  application/rss+xml \
                                  application/vnd.ms-fontobject \
                                  application/x-font-ttf \
                                  application/x-web-app-manifest+json \
                                  application/xhtml+xml \
                                  application/xml \
                                  font/opentype \
                                  image/svg+xml \
                                  image/x-icon \
                                  text/css \
                                  text/html \
                                  text/plain \
                                  text/x-component \
                                  text/xml
  </IfModule>
</IfModule>

# Content transformations

# Prevent some of the mobile network providers from modifying the content of
<IfModule mod_headers.c>
  Header set Cache-Control "no-transform"
</IfModule>

# ETag removal
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>

FileETag None

# Expires headers (for better cache control)

# The following expires headers are set pretty far in the future. If you don't
# control versioning with filename-based cache busting, consider lowering the
# cache time for resources like CSS and JS to something like 1 week.
<IfModule mod_expires.c>
  ExpiresActive on
  ExpiresDefault                                    "access plus 1 month"

  # CSS
  ExpiresByType text/css                            "access plus 1 year"

  # Data interchange
  ExpiresByType application/json                    "access plus 0 seconds"
  ExpiresByType application/xml                     "access plus 0 seconds"
  ExpiresByType text/xml                            "access plus 0 seconds"

  # Favicon (cannot be renamed!)
  ExpiresByType image/x-icon                        "access plus 1 week"

  # HTML components (HTCs)
  ExpiresByType text/x-component                    "access plus 1 month"

  # HTML
  ExpiresByType text/html                           "access plus 0 seconds"

  # JavaScript
  ExpiresByType application/javascript              "access plus 1 year"

  # Manifest files
  ExpiresByType application/x-web-app-manifest+json "access plus 0 seconds"
  ExpiresByType text/cache-manifest                 "access plus 0 seconds"

  # Media
  ExpiresByType audio/ogg                           "access plus 1 month"
  ExpiresByType image/gif                           "access plus 1 month"
  ExpiresByType image/jpeg                          "access plus 1 month"
  ExpiresByType image/png                           "access plus 1 month"
  ExpiresByType video/mp4                           "access plus 1 month"
  ExpiresByType video/ogg                           "access plus 1 month"
  ExpiresByType video/webm                          "access plus 1 month"

  # Web feeds
  ExpiresByType application/atom+xml                "access plus 1 hour"
  ExpiresByType application/rss+xml                 "access plus 1 hour"

  # Web fonts
  ExpiresByType application/font-woff               "access plus 1 month"
  ExpiresByType application/vnd.ms-fontobject       "access plus 1 month"
  ExpiresByType application/x-font-ttf              "access plus 1 month"
  ExpiresByType font/opentype                       "access plus 1 month"
  ExpiresByType image/svg+xml                       "access plus 1 month"
</IfModule>

# The short url map is configured in the nanoc.yaml file using the `short_urls`
# key.
<IfModule mod_rewrite.c>
  RewriteEngine On

<% (@site.config[:short_url_map] || {}).each do |short_code, url| %>
  RewriteRule ^s/<%= short_code %>/?$ <%= url %> [R=301,L,NC]
<% end %>

  RewriteRule ^blog/2012/12/02/rubys-option-parser-a-more-complete-example/?$ /blog/2012/12/rubys-option-parser-a-more-complete-example/ [R=301,L,NC]
</IfModule>
