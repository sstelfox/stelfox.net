<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>NTPd - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="NTPd" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/ntpd/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git https://io.stelfox.net/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>NTPd</h1>

<p>The Network Time Protocol (NTP) is a protocol for synchronizing the clocks of
computer systems over packet-switched, variable-latency data networks. NTP uses
UDP on port 123 as its transport layer. It is designed particularly to resist
the effects of variable latency by using a jitter buffer.</p>

<p>NTP also refers to a reference software implementation that is distributed by
the NTP Public Services Project.</p>

<h2>Security Notes</h2>

<p>Several authentication schemes and miscellaneous programs running on the
servers rely heavily on closely synced clocks. NTP provides a clock
synchronized to within 10 milliseconds of the other clocks over the internet
and as close as 200 microseconds.</p>

<p>This runs as an unprivileged user with no shell when run as a server as such
it&#39;s compromise could at the very worst make it hand out incorrect time. While
this would mean the authentication schemes and programs wouldn&#39;t function
correctly this is something that would be noticed when day to day activity
ceased to function.</p>

<p>When run as a client, it has to be run as root to update the system&#39;s clock. If
an attacker was to compromise the data stream and was able to execute arbitrary
commands in a response packet there would be issues. This is a highly unlikely
scenario. None-the-less I prefer to have them synchronize against a trusted
locally run server.</p>

<h2>Firewall Adjustments</h2>

<p>NTP synchronizations are allowed through my default <a href="../iptables/">IPTables</a> firewall
script. By default it is unrestricted and should be configured to be more
restrictive by replacing it with the one below. You should replace the address
with your time server&#39;s address.</p>
<div class="CodeRay">
  <div class="code"><pre># Allow time sync updates, once an ntp server is setup this can be further
# restricted to only update from there.
-A OUTPUT -m udp -p udp --dport 123 -j ACCEPT
</pre></div>
</div>

<p>For the server the opposite should be true. The service should only accept
connections on the local subnets. The following firewall rules should be added
to the firewall.</p>
<div class="CodeRay">
  <div class="code"><pre># Allow other servers and clients on the local subnet to synchronize their
# clocks to this server using ntp
-A SERVICES -m udp -p udp -s 10.13.37.0/24 --dport 123 -j ACCEPT
-A SERVICES -m udp -p udp -s 10.13.38.0/24 --dport 123 -j ACCEPT
</pre></div>
</div>

<h2>Configuration</h2>

<h3>/etc/ntp.conf</h3>

<p>A standard configuration of ntp is shown below, there isn&#39;t a whole lot to
explain so I&#39;ll leave it at that.</p>
<div class="CodeRay">
  <div class="code"><pre># For more information about this file, see the man pages
# ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).

driftfile /var/lib/ntp/drift

# Permit time synchronization with our time source, but do not
# permit the source to query or modify the service on this system.
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery

restrict 127.0.0.1 
restrict -6 ::1

# Hosts on local network are less restricted.
restrict 10.13.37.64 mask 255.255.255.192 nomodify notrap nopeer
restrict 10.13.37.128 mask 255.255.255.192 nomodify notrap nopeer
restrict 10.13.37.192 mask 255.255.255.192 nomodify notrap nopeer

# Stratum 1 time servers - diverse group
server clock.nyc.he.net iburst # IPv6 enabled
server clock.sjc.he.net iburst # IPv6 enabled
server time.keneli.org iburst
server bonehed.lcs.mit.edu iburst
server gnomon.cc.columbia.edu iburst

# Enable public key cryptography.
#crypto
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys

# Specify the key identifiers which are trusted.
trustedkey 1

# Specify the key identifier to use with the ntpdc utility.
requestkey 1

# Specify the key identifier to use with the ntpq utility.
controlkey 1

# Enable writing of statistics records.
statistics clockstats cryptostats loopstats peerstats
</pre></div>
</div>

<p>The server will need to be set to start automatically on boot. Use the
following command to do this:</p>
<div class="CodeRay">
  <div class="code"><pre>chkconfig --level 345 ntpd on
</pre></div>
</div>

<h3>/etc/ntp/keys</h3>

<p>A keyfile needs to be created for local and remote administration of the
service. To do this generate a random 8 character alphanumeric password and
replace the &#39;xxxxxxxx&#39; in the file <code>/etc/ntp/keys</code>.</p>

<p>This file should also be protected from read / write from unauthorized users
<code>600</code> with chmod. The contents are below:</p>
<div class="CodeRay">
  <div class="code"><pre>1      M       xxxxxxxx
</pre></div>
</div>

<h2>Checking Server Status</h2>

<p>On the server running <code>ntpd</code> you can use the <code>ntpq</code> utility to check the
current status of the ntpd service like so:</p>
<div class="CodeRay">
  <div class="code"><pre>[root@localhost ~]# ntpq -p 127.0.0.1
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*clock.nyc.he.ne .CDMA.           1 u    1   64    1   52.015  -16.888   2.421
 clock.sjc.he.ne .GPS.            1 u    2   64    1  110.573    3.201   0.366
 time.keneli.org .PPS.            1 u    1   64    1   29.378   -4.100   1.737
 bonehed.lcs.mit .PPS.            1 u    2   64    1   16.254   -1.620   1.396
 gnomon.cc.colum .USNO.           1 u    1   64    1   51.110  -15.607   2.697
</pre></div>
</div>

    </div>
  </body>
</html>
