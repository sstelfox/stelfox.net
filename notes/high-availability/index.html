<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>High Availability</h1><div class="post-content"><p>Notes on making or refining systems to be highly available.</p>
<span id="continue-reading"></span>
<p>Packages of interest:</p>
<ul>
<li>keepalived</li>
<li>ipvsadm</li>
<li>pacemaker</li>
</ul>
<h2 id="ipvs">IPVS</h2>
<p>IPVS (IP Virtual Server) is used to present a single address in a high
availability scenario for one more services.</p>
<h2 id="installation-setup">Installation / Setup</h2>
<pre><code>yum install ipvsadm -y
</code></pre>
<p>A note about LXC containers: In order to make use of ipvsadm within an LXC
container, you will also need to install the ipvsadm package on the LXC host
and reboot it (optionally just load the kernel module though I don't know it by
name). Additionally the simplest version, VS/NAT, requires enabling IPv4 packet
forwarding which requires modification of the read-only proc filesystem and
thus doesn't seem to be an easy option, there may be work arounds for this, and
it may effect the other forms but they haven't been tested yet.</p>
<p>First pass at commands:</p>
<pre><code>ipvsadm -A -t 192.168.122.30:443 -s wlc
ipvsadm -a -t 192.168.122.30:443 -r 192.168.122.61:443 -g -w 1
ipvsadm -a -t 192.168.122.30:443 -r 192.168.122.62:443 -g -w 1
</code></pre>
<p>That didn't work so I rebooted to clear it all out.</p>
<pre><code>yum install keepalived -y
</code></pre>
<p>Ah ha, Eureka moment. Inside the LXC container I can unmount the <code>/proc/sys</code>
overlay as long as I'm root...</p>
<pre><code>umount /proc/sys
echo 1 > /proc/sys/net/ipv4/ip_forward
</code></pre>
<p>It seems that <code>net.ipv4.ip_nonlocal_bind</code> isn't available within an LXC
container: <code>cat /proc/sys/net/ipv4/ip_nonlocal_bind</code>.</p>
<p>Interesting use for this as a firewall:</p>
<ul>
<li><a href="https://keepalived.org/Keepalived-LVS-NAT-Director-ProxyArp-Firewall-HOWTO.html">Running a Proxy-Arp LVS-NAT Director/Firewall with Keepalived</a></li>
<li><a href="https://backreference.org/2013/04/03/firewall-ha-with-conntrackd-and-keepalived/">Firewall HA with conntrackd and keepalived</a></li>
</ul>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
