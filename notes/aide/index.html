<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="AIDE (Advanced Intrusion Detection Environment) is a file and directory integrity checker that compares the current hashes, permissions, and attributes of files directories against a known database built from the system.
This can be run periodically to detect manipulation of critical system files, though a motivated attacker with an appropriate level of permissions could modify this database or disable the check as long as the system is able to write to it."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,linux,security,services"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/aide/><title>AIDE :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="AIDE"><meta itemprop=description content="AIDE (Advanced Intrusion Detection Environment) is a file and directory integrity checker that compares the current hashes, permissions, and attributes of files directories against a known database built from the system.
This can be run periodically to detect manipulation of critical system files, though a motivated attacker with an appropriate level of permissions could modify this database or disable the check as long as the system is able to write to it."><meta itemprop=datePublished content="2017-10-11T02:19:45+00:00"><meta itemprop=dateModified content="2017-10-11T02:19:45+00:00"><meta itemprop=wordCount content="796"><meta itemprop=keywords content="Linux,Security,Services"><meta name=twitter:card content="summary"><meta name=twitter:title content="AIDE"><meta name=twitter:description content="AIDE (Advanced Intrusion Detection Environment) is a file and directory integrity checker that compares the current hashes, permissions, and attributes of files directories against a known database built from the system.
This can be run periodically to detect manipulation of critical system files, though a motivated attacker with an appropriate level of permissions could modify this database or disable the check as long as the system is able to write to it."><meta property="article:published_time" content="2017-10-11 02:19:45 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/aide/>AIDE</a></h2><div class=post-content><p>AIDE (Advanced Intrusion Detection Environment) is a file and directory integrity checker that compares the current hashes, permissions, and attributes of files directories against a known database built from the system.</p><p>This can be run periodically to detect manipulation of critical system files, though a motivated attacker with an appropriate level of permissions could modify this database or disable the check as long as the system is able to write to it.</p><p>For this to be effective this process needs to be added to the systems update process and the database should be backed up immediately after being updated. With good backups in place this can help identify what changes were made by an attacker after a breach which can be invaluable in knowing both the impact and intent of a security incident.</p><h2 id=important-caveat>Important Caveat</h2><p>There does seems to be an issue that causes core dumps like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Floating point exception (core dumped)
</span></span></code></pre></td></tr></table></div></div><p>I initially suspected UTF-8 characters in the path name or to many files. Both I was able to disprove. I can enable all checks on an effected directory except for any of the hashes (I tested all the ones available to me individually).</p><p>The issue itself could be with the specific compiled version (community/aide 0.16-1 on Arch Linux) I was testing with.</p><p>After strace'ing down the files it was having issues with I simply excluded the files that were triggering the issue from checksum validation. I couldn't find anything unusual about the files themselves though... No extended attributes, normal permissions, readable... Maybe a bug in "libmhash"?</p><h2 id=secure-usage>Secure Usage</h2><p>While this utility provides no preventative defense measures, it is extremely useful in the detection of malicious behavior on the host. To perform this detection, a cron job should periodically have AIDE analyze the files it is monitoring and report the findings. A central logging system should be setup to consume these reports.</p><p>For these reports to be effective, the reference database needs to be trusted and well maintained. To accomplish this I recommend hosting a read-only NFS volume mounted at a known location to store the current database.</p><p>This database will likely need to be updated after every system update as critical binaries and configuration files may have been updated. If an automation system like <a href=puppet>Puppet</a> is in use, automatic modification of configuration files or installed packages may also trigger this.</p><h2 id=initial-setup>Initial Setup</h2><p>The defaults are reasonably sane so you can continue with the default configuration that ships with several distributions, but there are several things it will miss. Arch Linux's default doesn't catch:</p><ul><li>SELinux and extended attributes (though SELinux doesn't apply)</li><li>Permissions and security hearings under /dev</li><li>Any of the content or security attributes for most files under /etc</li><li>/lib64 (though if it's a symlink it's likely covered)</li><li>/srv (though it's not commonly used)</li></ul><p>I have one <a href=/notes/aide/aide.conf>that avoids</a> these issues. I recommend reviewing it, understanding it, and adjusting it for your environment before installing it to "/etc/aide/aide.conf". Be sure to restrict access to the file appropriately:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> chmod <span class=m>0600</span> /etc/aide/aide.conf
</span></span><span class=line><span class=cl><span class=gp>$</span> chown root:root /etc/aide/aide.conf
</span></span></code></pre></td></tr></table></div></div><p>You need to initialize the database as a baseline for the system, which can be done with the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> aide --init
</span></span></code></pre></td></tr></table></div></div><p>Depending on the amount of packages installed on your system and the speed of your disks this can take quite some time (on a fairly minimal production system for me this took about two minutes). You then need to copy the created database into the reference location (these locations are dependent on <a href=/notes/aide/aide.conf>my configuration</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mkdir -p /var/lib/aide/reference
</span></span><span class=line><span class=cl><span class=gp>$</span> cp /var/lib/aide/aide-<span class=k>$(</span>hostname -f<span class=k>)</span>.db.new.gz /var/lib/aide/reference/aide-<span class=k>$(</span>hostname -f<span class=k>)</span>.db.gz
</span></span></code></pre></td></tr></table></div></div><p>You can confirm the system is working with:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> aide --check
</span></span></code></pre></td></tr></table></div></div><p>If any monitored file or directory's attributes changed they will be reported to both STDOUT and written to "/var/log/aide/aide.log". This file is always completely rewritten after every run, if you want to keep historical reports, <a href=logrotate>logrotate</a> can be used to move these files aside.</p><p>I recommend reviewing the configuration file both to ensure all critical system directories are covered on your systems and to be aware of what is monitored and to what extent. Pay special attention to the package manager files of your system as they may not be included in the default configuration.</p><p>If you make any changes it is wise to validate the configuration afterwards by running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> aide --config-check
</span></span></code></pre></td></tr></table></div></div><p>It will produce no output and exit with a zero status if the configuration is valid.</p><p>I have a modified configuration file covering my general use case <a href=/notes/aide/aide.conf>available</a>, a slightly tweaked <a href=/notes/aide/aide.cron>cron job</a> (<a href=http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/app-forensics/aide/files/aide.cron>original here</a>), and slightly <a href=/notes/aide/sshaide.sh>modified script</a> to check AIDE integrity remotely using SSH (original in the "contrib" directory of the AIDE source). If you use any of these you will likely need to adjust paths to match the configuration.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span>
<span class=tag><a href=https://stelfox.net/tags/security/>security</a></span>
<span class=tag><a href=https://stelfox.net/tags/services/>services</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=adbdd27b0c3e908cb1dca59e31b846a6a368cc76 target=_blank rel=noopener>adbdd27b</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>