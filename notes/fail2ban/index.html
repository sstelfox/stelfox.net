<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
fail2ban provides a vital service of blocking troublesome IPs from attempting brute force logins.
My immediate issue is that it requires a few packages off the bat that I do not want on my system."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/fail2ban/><title>fail2ban :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="fail2ban"><meta itemprop=description content="Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
fail2ban provides a vital service of blocking troublesome IPs from attempting brute force logins.
My immediate issue is that it requires a few packages off the bat that I do not want on my system."><meta itemprop=datePublished content="2013-01-01T00:00:01+00:00"><meta itemprop=dateModified content="2013-01-01T00:00:01+00:00"><meta itemprop=wordCount content="2135"><meta name=twitter:card content="summary"><meta name=twitter:title content="fail2ban"><meta name=twitter:description content="Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
fail2ban provides a vital service of blocking troublesome IPs from attempting brute force logins.
My immediate issue is that it requires a few packages off the bat that I do not want on my system."><meta property="article:published_time" content="2013-01-01 00:00:01 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/fail2ban/>fail2ban</a></h2><div class=post-content><p><em><strong>Note: This page is quite old and is likely out of date. My opinions may have
also changed dramatically since this was written. It is here as a reference
until I get around to updating it.</strong></em></p><p>fail2ban provides a vital service of blocking troublesome IPs from attempting
brute force logins.</p><p>My immediate issue is that it requires a few packages off the bat that I do not
want on my system. Specifically tcpwrappers and shorewall. My firewall scripts
are stronger, easier to use, and IMHO more secure than what shorewall provides
and I don't need it. Neither does the fail2ban package as indicated in <a href="https://bugzilla.redhat.com/show_bug.cgi?id=244275">this
ticket</a> on the redhat bug tracker.</p><p>TODO: <a href=https://stelfox.net/notes/mysql/>MySQL</a> logs now that the documented configuration logs authorization
failures.</p><h2 id=installation>Installation</h2><p>So what's my solution? Fuck the man we're doing this my way. Regular install
through yum, force the old packages out using rpm, and exclude fail2ban from
updating (and preventing those damn packages from coming back). This is done
using the following commands:</p><pre tabindex=0><code>[root@localhost ~]# yum install fail2ban -y
[root@localhost ~]# rpm -v --nodeps -e shorewall tcp_wrappers
</code></pre><p>Finally add this line to <code>/etc/yum.conf</code>.</p><pre tabindex=0><code>exclude=fail2ban shorewall tcp_wrappers
</code></pre><p>There are of course security implication too not updating a package (in this
case fail2ban won't ever get updated) however it's an exception that I'm
willing to make to get fail2ban and not have the shitty shittiness of shorewall
and tcp_wrappers on my systems.</p><h2 id=firewall-modifications>Firewall Modifications</h2><p>There are some small changes that need to be made to the firewall script that
should probably be merged with the default as they can't hurt and having
fail2ban easily available to my default config would be a significant benefit.</p><p>The changes are specifically:</p><ul><li>Add an "OFFENDINGIPS" chain</li><li>Push all incoming traffic through the OFFENDINGIPS chain before continuing
through the INPUT chain</li><li>Add a rule to the OFFENDINGIPS chain to prevent ongoing attacks from getting
through for the duration of the attack</li></ul><p>The chain definition (near the top) should look like this:</p><pre tabindex=0><code>:OFFENDINGIPS - [0:0]
</code></pre><p>Push all the traffic through the chain looks like this (this belongs above all other INPUT chain rules):</p><pre tabindex=0><code># [DEF-RULESET] Pass all traffic through the OFFENDINGIPS table to block
# any hosts that have been caught being malicious in some way
-A INPUT -j OFFENDINGIPS
</code></pre><p>Rule to prevent ongoing attacks:</p><pre tabindex=0><code># [DEF-RULESET] If something keeps trying to connect after we have marked
# them as an attacker, keep blocking them until they stop for a full hour.
# When fail2ban is adding IPs to this table, it will initially mark them
# as an ATTACKER and they will be banned for a minimum of the fail2ban time,
# but it will be indefinite as long as they keep trying 
-A OFFENDINGIPS -m recent --name ATTACKER --update --seconds 3600 -j DROP
</code></pre><h2 id=configuration>Configuration</h2><p>I've noticed that the documentation on the actual raw config files for fail2ban
is really poor. Most of the documentation I've found is drop in files for
specific services but completely unable to find coherent documentation on all
the options in the actions files. Sure signs of amateur work which disheartens
me. This package is still useful though...</p><h3 id=etcfail2banfail2banconf>/etc/fail2ban/fail2ban.conf</h3><pre tabindex=0><code>[Definition]
# Log informational level messages
loglevel = 3

# Log to syslog
logtarget = SYSLOG

socket = /var/run/fail2ban/fail2ban.sock
</code></pre><h3 id=etcfail2banjailconf>/etc/fail2ban/jail.conf</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[DEFAULT]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Never ban localhost or the internal network</span>
</span></span><span class=line><span class=cl><span class=na>ignoreip</span> <span class=o>=</span> <span class=s>127.0.0.1 10.13.37.0/24</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Number of seconds that a host is banned by default (12 Hours)</span>
</span></span><span class=line><span class=cl><span class=na>bantime</span>  <span class=o>=</span> <span class=s>43200</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The time period to look for number of failed attempts</span>
</span></span><span class=line><span class=cl><span class=na>findtime</span> <span class=o>=</span> <span class=s>600</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The number of failures before a host get banned</span>
</span></span><span class=line><span class=cl><span class=na>maxretry</span> <span class=o>=</span> <span class=s>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Pick the best backend based on what&#39;s available on the system</span>
</span></span><span class=line><span class=cl><span class=na>backend</span>  <span class=o>=</span> <span class=s>auto</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[ssh-iptables]</span>
</span></span><span class=line><span class=cl><span class=na>enabled</span>  <span class=o>=</span> <span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>filter</span>   <span class=o>=</span> <span class=s>sshd</span>
</span></span><span class=line><span class=cl><span class=na>action</span>   <span class=o>=</span> <span class=s>iptables</span>
</span></span><span class=line><span class=cl><span class=na>logpath</span>  <span class=o>=</span> <span class=s>/var/log/secure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If asterisk is installed on this machine turn this on. The log path assumes you&#39;ve followed the configuration in the FKAM wiki.</span>
</span></span><span class=line><span class=cl><span class=k>[asterisk-iptables]</span>
</span></span><span class=line><span class=cl><span class=na>enabled</span>  <span class=o>=</span> <span class=s>false</span>
</span></span><span class=line><span class=cl><span class=na>filter</span>   <span class=o>=</span> <span class=s>asterisk</span>
</span></span><span class=line><span class=cl><span class=na>action</span>   <span class=o>=</span> <span class=s>iptables</span>
</span></span><span class=line><span class=cl><span class=na>logpath</span>  <span class=o>=</span> <span class=s>/var/log/asterisk.log</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=etcfail2banfilterdsshdconf>/etc/fail2ban/filter.d/sshd.conf</h3><pre tabindex=0><code>[INCLUDES]
# Include common.conf before this file
before = common.conf

[Definition]
_daemon = sshd

failregex = ^%(__prefix_line)s(?:error: PAM: )?Authentication failure for .* from &lt;HOST&gt;\s*$
            ^%(__prefix_line)s(?:error: PAM: )?User not known to the underlying authentication module for .* from &lt;HOST&gt;\s*$
            ^%(__prefix_line)sFailed (?:password|publickey) for .* from &lt;HOST&gt;(?: port \d*)?(?: ssh\d*)?$
            ^%(__prefix_line)sROOT LOGIN REFUSED.* FROM &lt;HOST&gt;\s*$
            ^%(__prefix_line)s[iI](?:llegal|nvalid) user .* from &lt;HOST&gt;\s*$
            ^%(__prefix_line)sUser \S+ from &lt;HOST&gt; not allowed because not listed in AllowUsers$
            ^%(__prefix_line)sauthentication failure; logname=\S* uid=\S* euid=\S* tty=\S* ruser=\S* rhost=&lt;HOST&gt;(?:\s+user=.*)?\s*$
            ^%(__prefix_line)srefused connect from \S+ \(&lt;HOST&gt;\)\s*$
            ^%(__prefix_line)sAddress &lt;HOST&gt; .* POSSIBLE BREAK-IN ATTEMPT!*\s*$
            ^%(__prefix_line)sUser \S+ from &lt;HOST&gt; not allowed because none of user&#39;s groups are listed in AllowGroups$

ignoreregex =
</code></pre><h3 id=etcfail2banfilterdasteriskconf>/etc/fail2ban/filter.d/asterisk.conf</h3><p>This file required a bit of special attention, I noticed that the one set of
regular expressions that have been copied and pasted everywhere DIDN'T MATCH
actual logs. They didn't take into account the port, and frankly I like
matching the whole line rather than just part of it. I modified the expressions
which are now below. They are perfectly backwards compatible with older
versions of asterisk that may not include the port and as a bonus will match
against syslog output if you are logging to syslog as well.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[INCLUDES]</span>
</span></span><span class=line><span class=cl><span class=na>before</span> <span class=o>=</span> <span class=s>common.conf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Definition]</span>
</span></span><span class=line><span class=cl><span class=na>_daemon</span> <span class=o>=</span> <span class=s>asterisk</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># These are the regular expressions that will trigger fail2ban into blocking an</span>
</span></span><span class=line><span class=cl><span class=c1># IP address for an asterisk 1.8 installation. The first regular expression</span>
</span></span><span class=line><span class=cl><span class=c1># should match against the following line taken directly from a misconfigured</span>
</span></span><span class=line><span class=cl><span class=c1># client:</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Nov  9 18:47:21 pbx asterisk[3432]: NOTICE[3445]: chan_sip.c:24331 in handle_request_register: Registration from &#39;INCOMING CALL &lt;sip:SPA3000_PSTN@10.13.37.102&gt;&#39; failed for &#39;10.13.37.101:5061&#39; - No matching peer found</span>
</span></span><span class=line><span class=cl><span class=na>failregex</span> <span class=o>=</span> <span class=s>^%(__prefix_line)s?NOTICE\[[0-9]+\]: chan_sip.c:[0-9]+ in handle_request_register: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - No matching peer found\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The following should match against the following line log taken directly from</span>
</span></span><span class=line><span class=cl><span class=c1># an attack:</span>
</span></span><span class=line><span class=cl><span class=c1># Nov 14 06:32:16 pbx asterisk: NOTICE[1640]: chan_sip.c:21975 in handle_request_invite: Sending fake auth rejection for device &#34;sip&#34; &lt;sip:sip@91.226.97.107&gt;;tag=L7922NDHSn</span>
</span></span><span class=line><span class=cl>            <span class=na>^%(__prefix_line)s?NOTICE\[[0-9]+\]: chan_sip.c:[0-9]+ in handle_request_invite: Sending fake auth rejection for device &#34;.*&#34; &lt;sip:.*@&lt;HOST&gt;&gt;;tag</span><span class=o>=</span><span class=s>[a-zA-Z0-9]+\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The following regexes were provided through an asterisk forum, they are a bit</span>
</span></span><span class=line><span class=cl><span class=c1># sloppy and might be outdated. I&#39;ve already updated one (the first one above)</span>
</span></span><span class=line><span class=cl><span class=c1># to reflect what I actually see in my logs. The rest will be updated as</span>
</span></span><span class=line><span class=cl><span class=c1># I see the attacks</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#           ^%(__prefix_line)s?NOTICE.*: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - Wrong Password\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#           ^%(__prefix_line)s?NOTICE.*: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - Username/auth name mismatch\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#           ^%(__prefix_line)s?NOTICE.*: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - Device does not match ACL\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#           ^%(__prefix_line)s?NOTICE.* &lt;HOST&gt;(:[0-9]+)? failed to authenticate as &#39;.*&#39;\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#           ^%(__prefix_line)s?NOTICE.*: No registration for peer &#39;.*&#39; \(from &lt;HOST&gt;(:[0-9]+)?\)\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#           ^%(__prefix_line)s?NOTICE.*: Host &lt;HOST&gt;(:[0-9]+)? failed MD5 authentication for &#39;.*&#39; (.*)\s*$</span>
</span></span><span class=line><span class=cl><span class=c1>#           ^%(__prefix_line)s?NOTICE.*: Failed to authenticate user .*@&lt;HOST&gt;(:[0-9]+)?.*\s*$</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>ignoreregex</span> <span class=o>=</span>
</span></span></code></pre></td></tr></table></div></div><p>Some notes on this specific file. I found 'pre-made' asterisk configurations
for fail2ban on the internet and found them to be very lacking. The did not
deal with an attack log I saw actually hitting my server the 'Sending fake
auth rejection' log specifically.</p><p>I was also greatly displeased by their performance. By making the regular
expression more specific (without sacrificing positive matches) I was able to
get a real world performance increase of 442%.</p><p>This was measured using the unix 'time' program and fail2ban's regular
expression tester 'fail2ban-regex'. As an example with one rule (the 'No
matching peer found' log) turned on in each test, first the old than my updated
one gave the following results:</p><pre tabindex=0><code>[root@localhost ~]# time fail2ban-regex /var/log/asterisk.log /etc/fail2ban/filter.d/old-asterisk.conf &gt; /dev/null

real    0m1.621s
user    0m1.534s
sys     0m0.049s
[root@localhost ~]# time fail2ban-regex /var/log/asterisk.log /etc/fail2ban/filter.d/asterisk.conf &gt; /dev/null

real    0m0.367s
user    0m0.298s
sys     0m0.047s
</code></pre><h3 id=etcfail2banactionsdiptablesconf>/etc/fail2ban/actions.d/iptables.conf</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23>23</a>
</span><span class=lnt id=hl-10-24><a class=lnlinks href=#hl-10-24>24</a>
</span><span class=lnt id=hl-10-25><a class=lnlinks href=#hl-10-25>25</a>
</span><span class=lnt id=hl-10-26><a class=lnlinks href=#hl-10-26>26</a>
</span><span class=lnt id=hl-10-27><a class=lnlinks href=#hl-10-27>27</a>
</span><span class=lnt id=hl-10-28><a class=lnlinks href=#hl-10-28>28</a>
</span><span class=lnt id=hl-10-29><a class=lnlinks href=#hl-10-29>29</a>
</span><span class=lnt id=hl-10-30><a class=lnlinks href=#hl-10-30>30</a>
</span><span class=lnt id=hl-10-31><a class=lnlinks href=#hl-10-31>31</a>
</span><span class=lnt id=hl-10-32><a class=lnlinks href=#hl-10-32>32</a>
</span><span class=lnt id=hl-10-33><a class=lnlinks href=#hl-10-33>33</a>
</span><span class=lnt id=hl-10-34><a class=lnlinks href=#hl-10-34>34</a>
</span><span class=lnt id=hl-10-35><a class=lnlinks href=#hl-10-35>35</a>
</span><span class=lnt id=hl-10-36><a class=lnlinks href=#hl-10-36>36</a>
</span><span class=lnt id=hl-10-37><a class=lnlinks href=#hl-10-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Init]</span>
</span></span><span class=line><span class=cl><span class=c1># The following had defaults that I wasn&#39;t happy with, but now they&#39;re not being</span>
</span></span><span class=line><span class=cl><span class=c1># used anyways as I don&#39;t want offending hosts talking to *any* service on this</span>
</span></span><span class=line><span class=cl><span class=c1># server until the ban expires. IF you just want to block access to the offending</span>
</span></span><span class=line><span class=cl><span class=c1># service these SHOULD NOT have defaults, the triggering rule should apply them</span>
</span></span><span class=line><span class=cl><span class=c1># so they actually block just that service rather than mess up whatever the default</span>
</span></span><span class=line><span class=cl><span class=c1># is</span>
</span></span><span class=line><span class=cl><span class=c1>#name =</span>
</span></span><span class=line><span class=cl><span class=c1>#port =</span>
</span></span><span class=line><span class=cl><span class=c1>#protocol =</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This is the manual table that I setup to handle blocked hosts</span>
</span></span><span class=line><span class=cl><span class=na>table</span> <span class=o>=</span> <span class=s>OFFENDINGIPS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Definition]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The commands that get executed when fail2ban starts up</span>
</span></span><span class=line><span class=cl><span class=c1># We don&#39;t need to do anything since I take care of this manually and permanently</span>
</span></span><span class=line><span class=cl><span class=na>actionstart</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The commands that get executed when fail2ban shuts down</span>
</span></span><span class=line><span class=cl><span class=c1># We don&#39;t need to do anything since I take care of this manually and permanently</span>
</span></span><span class=line><span class=cl><span class=na>actionstop</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># There doesn&#39;t really seem to be any documentation on what this actually does,</span>
</span></span><span class=line><span class=cl><span class=c1># I&#39;ve modified it so it will look at the appropriate table and it appears that</span>
</span></span><span class=line><span class=cl><span class=c1># it&#39;s just checking to make sure that the INPUT table is properly redirecting</span>
</span></span><span class=line><span class=cl><span class=c1># to the table that has the offending hosts in it</span>
</span></span><span class=line><span class=cl><span class=na>actioncheck</span> <span class=o>=</span> <span class=s>iptables -n -L INPUT | grep -q &lt;table&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This command bans the offending IP and marks them as an attacker</span>
</span></span><span class=line><span class=cl><span class=na>actionban</span> <span class=o>=</span> <span class=s>iptables -A &lt;table&gt; -s &lt;ip&gt; -j LOG --log-prefix &#34;Attacker&#39;s Back &#34;
</span></span></span><span class=line><span class=cl><span class=s>            iptables -A &lt;table&gt; -s &lt;ip&gt; -m recent --set --name ATTACKER -j DROP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This command removes an IP from the ban-list</span>
</span></span><span class=line><span class=cl><span class=na>actionunban</span> <span class=o>=</span> <span class=s>iptables -D &lt;table&gt; -s &lt;ip&gt; -j LOG --log-prefix &#34;Attacker&#39;s Back &#34;
</span></span></span><span class=line><span class=cl><span class=s>              iptables -D &lt;table&gt; -s &lt;ip&gt; -j DROP</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=testing-matchesregexesbans-without-making-the-system-live>Testing Matches/Regexes/Bans Without Making the System Live</h2><h3 id=validation-configuration>Validation Configuration</h3><p>Using the following command you can verify that the configuration is valid and
that fail2ban will be happy with what you told it. It's output isn't very
friendly but it'll do in a pinch.</p><pre tabindex=0><code>[root@localhost ~]# fail2ban-client -d
</code></pre><h3 id=validation-regular-expressions>Validation Regular Expressions</h3><p>First off you'll need a sample of the log that your going to be matching
against. If the message is already in your log more power to you, you can use
that logfile as the input (and it's what I did).</p><p>As for the regex, the tool supports passing the full thing on the command line
HOWEVER it doesn't expand fail2ban REGEX variables beyond (that is those
defined in the common.conf file) which means you won't get an accurate
representation on a match.</p><p>The best way is to define the regex in a filter file for fail2ban and run the
tool like so (This is from me testing asterisk with the output from my test):</p><pre tabindex=0><code>[root@localhost ~]# fail2ban-regex /var/log/asterisk.log /etc/fail2ban/filter.d/asterisk.conf

Running tests
=============

Use regex file : /etc/fail2ban/filter.d/asterisk.conf
Use log file   : /var/log/asterisk.log


Results
=======

Failregex
|- Regular expressions:
|  [1] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.*: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - Wrong Password\s*$
|  [2] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.*: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - No matching peer found\s*$
|  [3] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.*: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - Username/auth name mismatch\s*$
|  [4] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.*: Registration from &#39;.*&#39; failed for &#39;&lt;HOST&gt;(:[0-9]+)?&#39; - Device does not match ACL\s*$
|  [5] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.* &lt;HOST&gt;(:[0-9]+)? failed to authenticate as &#39;.*&#39;\s*$
|  [6] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.*: No registration for peer &#39;.*&#39; \(from &lt;HOST&gt;(:[0-9]+)?\)\s*$
|  [7] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.*: Host &lt;HOST&gt;(:[0-9]+)? failed MD5 authentication for &#39;.*&#39; (.*)\s*$
|  [8] ^\s*(?:\S+ )?(?:@vserver_\S+ )?(?:(?:\[\d+\])?:\s+[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?|[\[\(]?asterisk(?:\(\S+\))?[\]\)]?:?(?:\[\d+\])?:)?\s*?NOTICE.*: Failed to authenticate user .*@&lt;HOST&gt;(:[0-9]+)?.*\s*$
|
`- Number of matches:
   [1] 0 match(es)
   [2] 75 match(es)
   [3] 0 match(es)
   [4] 0 match(es)
   [5] 0 match(es)
   [6] 0 match(es)
   [7] 0 match(es)
   [8] 0 match(es)

Ignoreregex
|- Regular expressions:
|
`- Number of matches:

Summary
=======

Addresses found:
[1]
[2]
    X.X.X.X (Mon Nov 07 11:55:38 2011)
    X.X.X.X (Mon Nov 07 11:55:38 2011)
    X.X.X.X (Mon Nov 07 11:55:39 2011)
    X.X.X.X (Mon Nov 07 11:55:39 2011)
    Y.Y.Y.Y (Wed Nov 09 04:13:36 2011)
    Y.Y.Y.Y (Wed Nov 09 04:33:36 2011)
    Y.Y.Y.Y (Wed Nov 09 08:33:37 2011)
    Y.Y.Y.Y (Wed Nov 09 08:33:37 2011)
[3]
[4]
[5]
[6]
[7]
[8]

Date template hits:
13339 hit(s): MONTH Day Hour:Minute:Second
0 hit(s): WEEKDAY MONTH Day Hour:Minute:Second Year
0 hit(s): WEEKDAY MONTH Day Hour:Minute:Second
0 hit(s): Year/Month/Day Hour:Minute:Second
0 hit(s): Day/Month/Year Hour:Minute:Second
0 hit(s): Day/MONTH/Year:Hour:Minute:Second
0 hit(s): Month/Day/Year:Hour:Minute:Second
0 hit(s): Year-Month-Day Hour:Minute:Second
0 hit(s): Day-MONTH-Year Hour:Minute:Second[.Millisecond]
0 hit(s): Day-Month-Year Hour:Minute:Second
0 hit(s): TAI64N
0 hit(s): Epoch
0 hit(s): ISO 8601
0 hit(s): Hour:Minute:Second
0 hit(s): &lt;Month/Day/Year@Hour:Minute:Second&gt;

Success, the total number of match is 75

However, look at the above section &#39;Running tests&#39; which could contain
important information.
</code></pre><p>The above shows that I have 75 matches and the IPs (removed) that matched
against which rule.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=e0ae306a5897bc6892dbaa3e409f62aac8e8d735 target=_blank rel=noopener>e0ae306a</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>