<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>MySQL</h1><div class="post-content"><h2 id="server">Server</h2>
<h3 id="installation">Installation</h3>
<p>Install the package.</p>
<pre><code>yum install mysql-server -y
</code></pre>
<p>Set to start up auto-magically and get it going now.</p>
<pre><code>systemctl enable mysqld.service
systemctl start mysqld.service
</code></pre>
<p>Run the quick and dirty secure installation script that comes with the server.
The questions are pretty straight-forward just set a secure password when it
asks for it.</p>
<pre><code>mysql_secure_installation
</code></pre>
<h3 id="configuration">Configuration</h3>
<p>Before applying the <a href="https://stelfox.net/notes/mysql/my.cnf">configuration file</a> in <code>/etc/my.cnf</code>. Safely
shutdown the server and delete the logfiles <code>/var/lib/mysql/ib_logfile*</code>. This
configuration file will change the size of the log buffer and it will cause an
error when starting the server backup that will look like:</p>
<pre><code>InnoDB: Error: log file ./ib_logfile0 is of a different size 0 5242880 bytes
InnoDB: than specified in the .cnf file 0 67108864 bytes!
</code></pre>
<p>There is still one major security feature that I haven't added to this
configuration yet. Running the mysql daemon in a chroot environment. Details on
setting up a chroot environment for mysql can be found, <a href="https://community.broadcom.com/symantecenterprise/communities/community-home/librarydocuments/viewdocument?DocumentKey=e424fa89-758d-42ec-a272-a0c285d887ac&amp;CommunityKey=1ecf5f55-9545-44d6-b0f4-4e4a7f5f5e68&amp;tab=librarydocuments">here</a>.</p>
<p>Detailed information on all of the configuration options can be found
<a href="https://dev.mysql.com/doc/refman/8.0/en/dynamic-system-variables.html">here</a>. There is a script that can assist in tuning larger production
databases I've stored <a href="https://stelfox.net/notes/mysql/mysql_tuning.sh">here</a>.</p>
<p>There is some additional configuration in the systemd init script, specifically
which user/group the service will fork too (default is mysql/mysql). If you
need to change this you'll need to make the adjustment in
<code>/etc/systemd/system/multi-user.target.wants/mysqld.service</code>.</p>
<h3 id="firewall">Firewall</h3>
<pre><code>-A SERVICES -m tcp -p tcp --dport 3306 -j ACCEPT
</code></pre>
<h3 id="resetting-the-root-password">Resetting the Root Password</h3>
<p>Stop the MySQL daemon, and disable remote access to the server (block in
firewall etc). Start up MySQL with privilege checking disabled (In this mode
any credential will be accepted for any username and that user will have full
root database privileges (thus blocking remote access).</p>
<pre><code>mysqld_safe --skip-grant-tables
</code></pre>
<p>In a separate terminal window connect to the database:</p>
<pre><code>mysql -u root
</code></pre>
<p>Refer to the section on changing a user's password at this point. When done be
sure to kill the <code>mysqld_safe</code> instance, start up the daemon normally and
restore access to the server.</p>
<h3 id="quick-self-signed-ssl-cert-w-client">Quick Self Signed SSL Cert w/ Client</h3>
<p>This should be used for testing and development only, it requires a bit more
than a simple SSL cert as MySQL requires a CA cert as well so we'll generate a
self signed CA, a server certificate, and then a client certificate that can be
used for user authentication.</p>
<p>First the CA:</p>
<pre><code>openssl req -new -x509 -newkey rsa:4096 -keyout ca.key -nodes -days 365 \
  -out ca.crt
</code></pre>
<p>Then the server cert:</p>
<pre><code>openssl req -newkey rsa:4096 -keyout server.key -nodes -days 365 \
  -out server.csr
openssl x509 -req -in server.csr -days 365 -CA ca.crt -CAkey ca.key \
  -set_serial 01 -out server.crt
rm server.csr
</code></pre>
<p>Then the client cert:</p>
<pre><code>openssl req -newkey rsa:4096 -keyout client.key -nodes -days 365 \
  -out client.csr
openssl x509 -req -in client.csr -days 365 -CA ca.crt -CAkey ca.key \
  -set_serial 02 -out client.crt
rm client.csr
</code></pre>
<h2 id="client">Client</h2>
<h3 id="remotely-calculate-the-size-of-a-database">Remotely Calculate the Size of a Database</h3>
<p>Paste the following query into an interactive console session to collect the
sizes of all databases the current user has access to:</p>
<pre><code>SELECT table_schema "Database Name", SUM(data_length + index_length) / 1024
  / 1024 "Size in Mb" FROM information_schema.TABLES GROUP BY table_schema;
</code></pre>
<h3 id="drop-tables">Drop Tables</h3>
<p>Without being able to drop a database and create a new one it can be kind of
frustrating to empty a database of all it's tables so I've written a quick
script to drop all the tables from a specified database.</p>
<pre><code>#!/bin/bash

DBUSER="$1"
DBPASS="$2"
DBNAME="$3"
DBHOST="$4"

if [ $# -ne 4 ]; then
  echo "Usage: $0 {username} {password} {database} {hostname}"
  echo "Drops all tables from a MySQL"
  exit 1
fi

TABLES=$(mysql -u $DBUSER -p$DBPASS -h$DBHOST $DBNAME -e 'show tables;' |
  awk '{ print $1}' | grep -v '^Tables' )

for t in $TABLES; do
  echo "Deleting $t table from $MDB database..."
  mysql -u $DBUSER -p$DBPASS -h$DBHOST $DBNAME -e "drop table $t;"
done
</code></pre>
<h3 id="new-database-and-user">New Database and User</h3>
<p>Note: For security reasons user creation should be performed over an encrypted
channel. See the section on Using SSL.</p>
<pre><code>CREATE DATABASE example;
GRANT ALL ON example.* TO 'some-example-user'@'%.home-network.net' IDENTIFIED
  BY 'mYsUperSt0ngpassWordD0ntcoPyM3!';
FLUSH PRIVILEGES;
</code></pre>
<h3 id="change-user-password">Change User Password</h3>
<p>Note: For security reasons this password update should be performed over an
encrypted channel. See the section on Using SSL.</p>
<pre><code>UPDATE mysql.user SET password=PASSWORD("my-new-super-secure-password") WHERE
  user='some-user-name';
</code></pre>
<h3 id="configuration-1">Configuration</h3>
<p>Quick and simple change I make to my client configuration to make the prompt a
little more verbose. Create the following file in <code>~/.my.cnf</code>:</p>
<pre><code>[mysql]prompt=(\\u@\\h) [\\d]>\\_
</code></pre>
<p>This can also be set system wide in <code>/etc/my.cnf</code> for all users by appending
the above (which I do in all my server configurations).</p>
<h3 id="using-ssl">Using SSL</h3>
<p>Pretty straight forward, one off can be done like the following:</p>
<pre><code>mysql -u user -ppassword -h host --ssl-ca=./ca.crt database
</code></pre>
<p>Once connected you can verify the session is encrypted with the following
query:</p>
<pre><code>(root@127.0.0.1) [(none)]> show status like 'ssl_cipher';
</code></pre>
<p>If the second column returned is non-empty then your session is encrypted.</p>
<h3 id="see-remote-version">See Remote Version</h3>
<pre><code>(user@example-mysql) [(none)]> SELECT VERSION();
</code></pre>
<h3 id="useful-diagnostic-testing-maintenance-scripts">Useful Diagnostic / Testing / Maintenance Scripts</h3>
<ul>
<li><a href="https://www.percona.com/doc/percona-toolkit/2.1/index.html">Percona Toolkit</a></li>
</ul>
<h3 id="tcmalloc">TCMalloc</h3>
<p>Due to high thread contention in some versions of MySQL a huge performance
boost can be gained by using a third party malloc, TCMalloc has been proven to
reduce thread contention in MySQL and provide as much as a 30% boost in all
query timing.</p>
<ul>
<li><a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html">TCMalloc : Thread-Caching Malloc</a></li>
<li><a href="https://github.com/gperftools/gperftools">gperftools</a></li>
</ul>
<p>MORE TODO</p>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
