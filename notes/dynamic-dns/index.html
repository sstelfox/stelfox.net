<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>Dynamic DNS</h1><p class="meta">Posted on <span class="postdate">2016-01-22</span></p><div class="post-content"><p>This guide intends to help you setup DDNS updates between an ISC DHCP server
and an authoritative NSD name server. We assume you have a DHCP server with the
following config:</p>
<span id="continue-reading"></span><pre><code># /etc/dhcp/dhcpd.conf

authoritative;
option domain-name "example.lab";
option domain-name-servers google-public-dns-a.google.com, google-public-dns-b.google.com;
ddns-update-style none;

subnet 10.0.0.0 netmask 255.255.255.0 {
  range 10.0.0.192 10.0.0.254;
  option routers 10.0.0.1;
}
</code></pre>
<p>And a working NSD server with the following minimal config:</p>
<pre><code># /etc/nsd/nsd.conf

zone:
  name: "example.lab"
  zonefile: "%s.zone"

zone:
  name: "10.in-addr.arpa"
  zonefile: "%s.zone"
</code></pre>
<p>It's expected that you already have the zone files setup for the two zones as
well. The domain doesn't have to be the top level domain and it's generally
recommended to keep DDNS clients in a separate delegated zone from statically
configured entries to prevent them from overriding them.</p>
<p>Now we need to generate a key that'll be used by the DHCP server to
authenticate updates to the DNS server. A lot of guides recommend using either
the <code>dnssec-keygen</code> or <code>ddns-confgen</code> utilities. I have neither pre-installed
and would rather avoid installing additional tools for a one-off task.
Ultimately what those tools are giving you is pre-formatting the output for the
appropriate tool.</p>
<p>I prefer HMAC-SHA256 as the security algorithm for the updates. It's well into
the computational complexity range of unfeasible to attack and is not to far
overboard as to overload either the DNS or DHCP servers. In high stress
environments you can certainly drop it back down to reduce the CPU load
required for updates.</p>
<p>For key generation, I tend to shoot for half of the hash strength for the key.
For SHA256 that means 128 bits for the key. This is mostly personal preference,
though I wouldn't go below that.</p>
<p>To generate the key I use the following command which should work pretty much
everywhere:</p>
<pre><code>DDNS_KEY=$(dd status=none if=/dev/urandom bs=1 count=128 | base64 -w 0)
</code></pre>
<p>We'll start by configuring NSD to accept the signed updates with key. We're
going to put the NSD key config in it's own file and include it. First the
creation in the appropriate format:</p>
<pre><code>cat << EOF > /etc/nsd/ddns-key.conf
key:
  name: "ddns_update_key"
  algorithm: hmac-sha256
  secret: "${DDNS_KEY}"
EOF
</code></pre>
<p>And protect it:</p>
<pre><code>chown root:nsd /etc/nsd/ddns-key.conf
chmod 0640 /etc/nsd/ddns-key.conf
</code></pre>
<p>You'll need to edit your nsd.conf file with the following line <em>before</em> the
zones are defined:</p>
<pre><code>include: /etc/nsd/ddns-key.conf
</code></pre>
<p>TODO: I have no idea if NSD supports updating records using DDNS... If it does
I'll need to figure out the per-zone config. Everything else will have been
setup correctly though...</p>
<p>Now to setup the DHCPd server. Like NSD we need to get an external config file
with our authentication key in:</p>
<pre><code>cat << EOF > /etc/dhcp/ddns-key.conf
key ddns_update_key {
  algorithm HMAC-SHA256;
  secret "${DDNS_KEY}";
};
EOF
</code></pre>
<p>And protect this one to:</p>
<pre><code>chown root:dhcp /etc/dhcp/ddns-key.conf
chmod 0640 /etc/dhcp/ddns-key.conf
</code></pre>
<p>The following config assumes that the master DNS server is located at
10.0.0.33. I added the following config file before the global options,
ensuring that I remove the 'ddns-update-style none;' entry from the config if
it's present.</p>
<pre><code>ddns-updates off;
ddns-update-style interim;
ddns-hostname example.lab;
ddns-update-style standard;

ignore client-updates;
update-static-leases on;

include "/etc/dhcp/ddns.key";

zone example.lab. {
  primary 10.0.0.33;
  key ddns_update_key;
}

zone 10.in-addr.arpa. {
  primary 10.0.0.33;
  key ddns_update_key;
}
</code></pre>
<p>One final change is required to enable the updates. For each subnet definition
you want the DHCP server to subnet client updates for you'll want to add the
following entry:</p>
<pre><code>ddns-updates on;
</code></pre>
<p>Reload the DHCP server and it should begin issuing updates.</p>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
