<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>Router</h1><div class="post-content"><p>Resources:</p>
<ul>
<li><a href="https://www.systutorials.com/port-forwarding-using-iptables/">Linux Port Forwarding Using iptables</a></li>
</ul>
<p>This was done as a quick and dirty iptables NAT/gateway for a private LXC
network. Create the LXC container using our base templating trick:</p>
<pre><code>cp -ar /var/lib/libvirt/lxc/fedora-19-x86_64-template /var/lib/libvirt/lxc/gateway-01
virt-install --connect lxc:// --name gateway-01 --ram 512 --vcpus 1 \
  --filesystem "/var/lib/libvirt/lxc/gateway-01,/" --network="network=br0" \
  --network="network=isolated" --console "pty" --check-cpu
</code></pre>
<pre><code>echo 1 > /proc/sys/net/ipv4/ip_forward
echo 'net.ipv4.ip_forward = 1' > /etc/sysctl.d/70-routing.conf
</code></pre>
<p>cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=&quot;eth1&quot;
NM_CONTROLLED=&quot;no&quot;
ONBOOT=&quot;yes&quot;
TYPE=&quot;Ethernet&quot;
BOOTPROTO=&quot;static&quot;</p>
<p>IPADDR=&quot;10.0.0.1&quot;
NETMASK=&quot;255.255.255.0&quot;
DEFROUTE=&quot;no&quot;</p>
<p>IPV4_FAILURE_FATAL=&quot;no&quot;
IPV6INIT=&quot;yes&quot;</p>
<p>NAME=&quot;LAN&quot;
EOF</p>
<p>Going to ignore IPv6 for now :(</p>
<p>For this eth0 is the external network connection and eth1 is the internal
network. These will have 192.168.122.10 as the external IP address and 10.0.0.1
for the internal IP address.</p>
<h2 id="etc-sysconfig-iptables">/etc/sysconfig/iptables</h2>
<pre><code>*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT

# Allow the internal network to connect to this SSH server (harden to airlock)
-A INPUT -m tcp -p tcp --dport 22 -i eth1 -m conntrack --ctstate NEW -j ACCEPT

-A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A OUTPUT -p icmp -j ACCEPT
-A OUTPUT -o lo -j ACCEPT

# DNS requests (harden to internal server)
-A OUTPUT -m udp -p udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
-A OUTPUT -m tcp -p tcp --dport 53 -m conntrack --ctstate NEW -j ACCEPT

# For updates (harden to squid server)
-A OUTPUT -m tcp -p tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT
-A OUTPUT -m tcp -p tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT

# Log any attempts that try to slip through
-A OUTPUT -m limit --limit 2/s --limit-burst 5 -j LOG --log-prefix "Outgoing attempt: "
-A OUTPUT -j REJECT

# Allow existing connections in both directions
-A FORWARD -i eth0 -o eth1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Always allow pinging out from the internal network
-A FORWARD -i eth1 -o eth0 -s 10.0.0.0/24 -p icmp -j ACCEPT

# Allow us to forward to the airlock's SSH server
-A FORWARD -m tcp -p tcp -d 10.0.0.100 --dport 22 -j ACCEPT

# Temporarily allow routing all other traffic from the inside out
-A FORWARD -i eth1 -s 10.0.0.0/24 -o eth0 -j ACCEPT

COMMIT

*nat
:PREROUTING   ACCEPT [0:0] # TODO: Harden?
:INPUT        ACCEPT [0:0] # TODO: Harden?
:OUTPUT       ACCEPT [0:0] # TODO: Harden?
:POSTROUTING  ACCEPT [0:0] # TODO: Harden?

# Portfowarding port 2200 to port 22 on the airlock
-A PREROUTING -i eth0 -m tcp -p tcp --dport 2200 -j DNAT --to 10.0.0.100:22

# Handle the NAT routing
-A POSTROUTING -s 10.0.0.0/24 -o eth0 -j MASQUERADE

COMMIT
</code></pre>
<p>LXC /proc/sys fix can be accomplished by:</p>
<pre><code>cat << EOF > /etc/rc.d/rc.local
#!/bin/sh
umount /proc/sys
systemctl start systemd-sysctl.service
EOF
chmod +x /etc/rc.d/rc.local
</code></pre>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
