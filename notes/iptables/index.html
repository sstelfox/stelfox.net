<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='iptables (and ip6tables) is a simple application for interacting directly with the Linux kernel&#39;s netfilter firewall. nftables is attempting to replace it. nftables has better performance but is incredibly complex and difficult to use. Until the tooling and usability around nftables is addressed iptables will likely remain the reigning champion.
It is important that your systems have effective ingress and egress rules. Depending on your host OS, you&#39;ll find your rule set stored in different locations but the following list are where I&#39;ve seen them before:'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='IPTables • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='iptables (and ip6tables) is a simple application for interacting directly with the Linux kernel&#39;s netfilter firewall. nftables is attempting to replace it. nftables has better performance but is incredibly complex and difficult to use. Until the tooling and usability around nftables is addressed iptables will likely remain the reigning champion.
It is important that your systems have effective ingress and egress rules. Depending on your host OS, you&#39;ll find your rule set stored in different locations but the following list are where I&#39;ve seen them before:'>
<meta property='og:url' content='https://stelfox.net/notes/iptables/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='notes'><meta property='article:tag' content='linux'><meta property='article:tag' content='security'><meta property='article:published_time' content='2017-10-20T12:14:02-04:00'/><meta property='article:modified_time' content='2017-10-20T12:14:02-04:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.61.0-DEV" />

  <title>IPTables • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/notes/iptables/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-notes'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>IPTables</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2017-10-20T12:14:02-04:00'>2017, Oct 20</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
2 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>iptables (and ip6tables) is a simple application for interacting directly with
the Linux kernel's netfilter firewall. nftables is attempting to replace it.
nftables has better performance but is incredibly complex and difficult to use.
Until the tooling and usability around nftables is addressed iptables will
likely remain the reigning champion.</p>
<p>It is important that your systems have effective ingress and egress rules.
Depending on your host OS, you'll find your rule set stored in different
locations but the following list are where I've seen them before:</p>
<ul>
<li>/etc/conf.d/iptables, /etc/conf.d/ip6tables</li>
<li>/etc/sysconfig/iptables, /etc/conf.d/ip6tables</li>
<li>/var/lib/iptables/rules-save, /var/lib/ip6tables/rules-save</li>
</ul>
<p>I have a base rule set that I riff off of for <a href="/note_files/iptables/iptables.rules">iptables</a>, and
<a href="/note_files/iptables/ip6tables.rules">ip6tables</a>. It can generally be hardened a tad depending on the local
services you have available (such as a DNS resolver, local NTP servers, or an
HTTP(S) proxy).</p>
<h2 id="logging-from-rules">Logging From Rules</h2>
<p>If you're using my <a href="https://stelfox.net/notes/auditd/">auditd</a> rules, you'll already have a detailed log of any
connection to or from the system so this may be of little use. Sometimes it's
valuable to log attempts that don't successfully make it through the firewall
(such as failed outbound network attempts).  These are also valuable if your
system has too many connections for the auditd rules to be effective, or you're
not using my rule set.</p>
<p>The final step is actually making iptables log the information you want. This
is as simple as appending <code>--log-prefix &quot;iptables: &quot;</code> to whatever LOG targets
you have configured. Like so:</p>
<p>The following rule will log any new SSH connection attempts on the default port
for any traffic that successfully makes it to the rule:</p>
<pre><code>-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j LOG --log-prefix &quot;sshConn: &quot;
</code></pre><h2 id="additional-gentoo-config">Additional Gentoo Config</h2>
<p>Gentoo's defaults have an annoying habit to override the rules every time the
service is shut down. Before enabling the services I additionally drop the
configs around service control in place at <a href="/note_files/iptables/gentoo_iptables_conf">/etc/conf.d/iptables</a> and
<a href="/note_files/iptables/gentoo_ip6tables_conf">/etc/conf.d/ip6tables</a>.</p>
<p>This expects the iptables rules to be at <code>/var/lib/iptables/rules-save</code> and
<code>/var/lib/ip6tables/rules-save</code>.</p>
<h2 id="blocking-ispsas-numbers">Blocking ISPs/AS Numbers</h2>
<p>I've created <a href="/note_files/iptables/block_as.sh">a script</a> that generates rules to block the subnets associates
with given AS numbers. AS numbers can be found on <a href="ftp://ftp.arin.net/info/asn.txt">Arin's website</a> and <a href="http://www.team-cymru.org/Services/ip-to-asn.html">Team
Cymru</a> keeps a list of other places that keep this information.</p>
<p>It fetches all network via whois and generates appropriate iptables rules.
Maybe you have to adjust your whois-Query since I only ran tests against the
ripe db.</p>
<p>This script could be made significantly more efficient, and safer to update by
switching to ipsets, but I haven't gotten around to it.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/linux/'>linux</a>, <a class='tag' href='/tags/security/'>security</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/notes/time/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Time</a>
    </div><div class='next-entry sep-before'>
      <a href='/notes/mutt/'>
        <span class='screen-reader-text'>Next post: </span>Mutt<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2020 Sam Stelfox </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script>

</body>

</html>

