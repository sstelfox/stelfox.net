<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>IPTables</h1><div class="post-content"><p>iptables (and ip6tables) is a simple application for interacting directly with
the Linux kernel's netfilter firewall. nftables is attempting to replace it.
nftables has better performance but is incredibly complex and difficult to use.
Until the tooling and usability around nftables is addressed iptables will
likely remain the reigning champion.</p>
<span id="continue-reading"></span>
<p>It is important that your systems have effective ingress and egress rules.
Depending on your host OS, you'll find your rule set stored in different
locations but the following list are where I've seen them before:</p>
<ul>
<li>/etc/conf.d/iptables, /etc/conf.d/ip6tables</li>
<li>/etc/sysconfig/iptables, /etc/conf.d/ip6tables</li>
<li>/var/lib/iptables/rules-save, /var/lib/ip6tables/rules-save</li>
</ul>
<p>I have a base rule set that I riff off of for <a href="https://stelfox.net/notes/iptables/iptables.rules">iptables</a>, and
<a href="https://stelfox.net/notes/iptables/ip6tables.rules">ip6tables</a>. It can generally be hardened a tad depending on the local
services you have available (such as a DNS resolver, local NTP servers, or an
HTTP(S) proxy).</p>
<h2 id="logging-from-rules">Logging From Rules</h2>
<p>If you're using my <a href="https://stelfox.net/notes/auditd/">auditd</a> rules, you'll already have a detailed log of any
connection to or from the system so this may be of little use. Sometimes it's
valuable to log attempts that don't successfully make it through the firewall
(such as failed outbound network attempts).  These are also valuable if your
system has too many connections for the auditd rules to be effective, or you're
not using my rule set.</p>
<p>The final step is actually making iptables log the information you want. This
is as simple as appending <code>--log-prefix &quot;iptables: &quot;</code> to whatever LOG targets
you have configured. Like so:</p>
<p>The following rule will log any new SSH connection attempts on the default port
for any traffic that successfully makes it to the rule:</p>
<pre><code>-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j LOG --log-prefix "sshConn: "
</code></pre>
<h2 id="additional-gentoo-config">Additional Gentoo Config</h2>
<p>Gentoo's defaults have an annoying habit to override the rules every time the
service is shut down. Before enabling the services I additionally drop the
configs around service control in place at <a href="https://stelfox.net/notes/iptables/gentoo_iptables_conf">/etc/conf.d/iptables</a> and
<a href="https://stelfox.net/notes/iptables/gentoo_ip6tables_conf">/etc/conf.d/ip6tables</a>.</p>
<p>This expects the iptables rules to be at <code>/var/lib/iptables/rules-save</code> and
<code>/var/lib/ip6tables/rules-save</code>.</p>
<h2 id="blocking-isps-as-numbers">Blocking ISPs/AS Numbers</h2>
<p>I've created <a href="https://stelfox.net/notes/iptables/block_as.sh">a script</a> that generates rules to block the subnets associates
with given AS numbers. AS numbers can be found on <a href="ftp://ftp.arin.net/info/asn.txt">Arin's website</a> and <a href="https://team-cymru.com/community-services/ip-asn-mapping/">Team
Cymru</a> keeps a list of other places that keep this information.</p>
<p>It fetches all network via whois and generates appropriate iptables rules.
Maybe you have to adjust your whois-Query since I only ran tests against the
ripe db.</p>
<p>This script could be made significantly more efficient, and safer to update by
switching to ipsets, but I haven't gotten around to it.</p>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
