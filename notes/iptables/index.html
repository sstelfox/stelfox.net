<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="iptables (and ip6tables) is a simple application for interacting directly with the Linux kernel&amp;rsquo;s netfilter firewall. nftables is attempting to replace it. nftables has better performance but is incredibly complex and difficult to use. Until the tooling and usability around nftables is addressed iptables will likely remain the reigning champion.
It is important that your systems have effective ingress and egress rules. Depending on your host OS, you&amp;rsquo;ll find your rule set stored in different locations but the following list are where I&amp;rsquo;ve seen them before:"><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,linux,security"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/iptables/><title>IPTables :: Sam Stelfox — A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="IPTables"><meta itemprop=description content="iptables (and ip6tables) is a simple application for interacting directly with the Linux kernel’s netfilter firewall. nftables is attempting to replace it. nftables has better performance but is incredibly complex and difficult to use. Until the tooling and usability around nftables is addressed iptables will likely remain the reigning champion.
It is important that your systems have effective ingress and egress rules. Depending on your host OS, you’ll find your rule set stored in different locations but the following list are where I’ve seen them before:"><meta itemprop=datePublished content="2017-10-20T12:14:02-04:00"><meta itemprop=dateModified content="2017-10-20T12:14:02-04:00"><meta itemprop=wordCount content="419"><meta itemprop=keywords content="Linux,Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="IPTables"><meta name=twitter:description content="iptables (and ip6tables) is a simple application for interacting directly with the Linux kernel’s netfilter firewall. nftables is attempting to replace it. nftables has better performance but is incredibly complex and difficult to use. Until the tooling and usability around nftables is addressed iptables will likely remain the reigning champion.
It is important that your systems have effective ingress and egress rules. Depending on your host OS, you’ll find your rule set stored in different locations but the following list are where I’ve seen them before:"><meta property="article:published_time" content="2017-10-20 12:14:02 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/blog/>Blog Posts</a></li><li><a href=/notes/>Various Notes</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/iptables/>IPTables</a></h2><div class=post-content><p>iptables (and ip6tables) is a simple application for interacting directly with
the Linux kernel&rsquo;s netfilter firewall. nftables is attempting to replace it.
nftables has better performance but is incredibly complex and difficult to use.
Until the tooling and usability around nftables is addressed iptables will
likely remain the reigning champion.</p><p>It is important that your systems have effective ingress and egress rules.
Depending on your host OS, you&rsquo;ll find your rule set stored in different
locations but the following list are where I&rsquo;ve seen them before:</p><ul><li>/etc/conf.d/iptables, /etc/conf.d/ip6tables</li><li>/etc/sysconfig/iptables, /etc/conf.d/ip6tables</li><li>/var/lib/iptables/rules-save, /var/lib/ip6tables/rules-save</li></ul><p>I have a base rule set that I riff off of for <a href=/note_files/iptables/iptables.rules>iptables</a>, and
<a href=/note_files/iptables/ip6tables.rules>ip6tables</a>. It can generally be hardened a tad depending on the local
services you have available (such as a DNS resolver, local NTP servers, or an
HTTP(S) proxy).</p><h2 id=logging-from-rules>Logging From Rules</h2><p>If you&rsquo;re using my <a href=https://stelfox.net/notes/auditd/>auditd</a> rules, you&rsquo;ll already have a detailed log of any
connection to or from the system so this may be of little use. Sometimes it&rsquo;s
valuable to log attempts that don&rsquo;t successfully make it through the firewall
(such as failed outbound network attempts). These are also valuable if your
system has too many connections for the auditd rules to be effective, or you&rsquo;re
not using my rule set.</p><p>The final step is actually making iptables log the information you want. This
is as simple as appending <code>--log-prefix "iptables: "</code> to whatever LOG targets
you have configured. Like so:</p><p>The following rule will log any new SSH connection attempts on the default port
for any traffic that successfully makes it to the rule:</p><pre tabindex=0><code>-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j LOG --log-prefix &#34;sshConn: &#34;
</code></pre><h2 id=additional-gentoo-config>Additional Gentoo Config</h2><p>Gentoo&rsquo;s defaults have an annoying habit to override the rules every time the
service is shut down. Before enabling the services I additionally drop the
configs around service control in place at <a href=/note_files/iptables/gentoo_iptables_conf>/etc/conf.d/iptables</a> and
<a href=/note_files/iptables/gentoo_ip6tables_conf>/etc/conf.d/ip6tables</a>.</p><p>This expects the iptables rules to be at <code>/var/lib/iptables/rules-save</code> and
<code>/var/lib/ip6tables/rules-save</code>.</p><h2 id=blocking-ispsas-numbers>Blocking ISPs/AS Numbers</h2><p>I&rsquo;ve created <a href=/note_files/iptables/block_as.sh>a script</a> that generates rules to block the subnets associates
with given AS numbers. AS numbers can be found on <a href=ftp://ftp.arin.net/info/asn.txt>Arin&rsquo;s website</a> and <a href=http://www.team-cymru.org/Services/ip-to-asn.html>Team
Cymru</a> keeps a list of other places that keep this information.</p><p>It fetches all network via whois and generates appropriate iptables rules.
Maybe you have to adjust your whois-Query since I only ran tests against the
ripe db.</p><p>This script could be made significantly more efficient, and safer to update by
switching to ipsets, but I haven&rsquo;t gotten around to it.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span>
<span class=tag><a href=https://stelfox.net/tags/security/>security</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>