<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
SecurityIf at any point a decryption key is needed to access a file, it will be stored in RAM. If an otherwise encrypted file is edited it will get stored in RAM before being saved."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/swap/><title>Swap :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Swap"><meta itemprop=description content="Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
SecurityIf at any point a decryption key is needed to access a file, it will be stored in RAM. If an otherwise encrypted file is edited it will get stored in RAM before being saved."><meta itemprop=datePublished content="2013-01-01T00:00:01+00:00"><meta itemprop=dateModified content="2013-01-01T00:00:01+00:00"><meta itemprop=wordCount content="591"><meta name=twitter:card content="summary"><meta name=twitter:title content="Swap"><meta name=twitter:description content="Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
SecurityIf at any point a decryption key is needed to access a file, it will be stored in RAM. If an otherwise encrypted file is edited it will get stored in RAM before being saved."><meta property="article:published_time" content="2013-01-01 00:00:01 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/swap/>Swap</a></h2><div class=post-content><p><em><strong>Note: This page is quite old and is likely out of date. My opinions may have
also changed dramatically since this was written. It is here as a reference
until I get around to updating it.</strong></em></p><h2 id=security>Security</h2><p>If at any point a decryption key is needed to access a file, it will be stored
in RAM. If an otherwise encrypted file is edited it will get stored in RAM
before being saved. Without warning at any time that RAM can be swapped out to
disk, at which point there is now a recoverable copy of an encryption key or
sections of an encrypted document plain text on disk that <a href=https://stelfox.net/notes/data-recovery/>can be
recovered</a>.</p><p>To prevent this I strongly recommend encrypting the swap. During a standard
install of Fedora if you want to accomplish this you have to use dirty
VolGroups and LVMs. I hate VolGroups and LVMs and on top of that it will be
using a set static key that I'm sure will eventually be open to static
analysis. While most people won't care about the latter I like to avoid the
whole thing if I can do it with a fast simple solution.</p><p>My solution is to take swap out of the hands of fstab and mount it myself after
generating a one-time key for that session. When the computer turns off the key
will be completely lost and a new one will be generated the next time the
computer boots. I don't want to do this by hand every time the computer boots
so I'll make sure it does this automatically.</p><p>The first step is to prevent Linux from mounting the swap on it's own. To do
this comment out all the lines in fstab that have to do with swap. They will
look like the following:</p><pre tabindex=0><code>/dev/sda3       swap                swap        defaults        0 0
</code></pre><p>Your going to need to know what partitions your swap lives on. In the above
example swap lives on <code>/dev/sda3</code>, it is very likely that your's will live on a
different device/partition.</p><p>First we're going to want to fill the swap space with junk to make sure that
there isn't anything useful left on there to be recovered. Your going to want
to make sure that your system isn't currently using the swap, so first turn it
off before writing over the swap space. The latter command is very dangerous if
you do it on the wrong partition! Double check before executing it!</p><pre tabindex=0><code>[root@localhost ~]# swapoff -a
[root@localhost ~]# dd if=/dev/urandom of=/dev/sda3
</code></pre><p>Next we'll want to make one of the boot scripts initialize encryption and mount
the swap, there is a specific boot script created explicitly for user
modification that other packages won't touch. We're going to use that one which
is <code>/etc/rc.d/rc.local</code>. You'll want to add the following lines to it.</p><pre tabindex=0><code>cryptsetup -c blowfish -h sha256 -d /dev/urandom create swap /dev/sda3
mkswap -f /dev/mapper/swap
swapon /dev/mapper/swap
</code></pre><p>The cipher in the above command can be swapped around, blowfish is a strong
encryption with a fairly good throughput however it seems that 256bit
aes-xts-plain is a bit faster without sacrificing too much security. If you'd
prefer to use that instead, replace the cryptsetup invocation with the
following one:</p><pre tabindex=0><code>cryptsetup -c aes-xts-plain -s 256 -h sha256 -d /dev/urandom create swap /dev/sda3
</code></pre><p>Fedora has device mapper support built into the kernel, however if your
distribution doesn't have device mapper support active by default, in the line
right before the cryptsetup invocation add the line "modprobe dm-mod" to load
the kernel module. Otherwise you'll get a "Command failed: Incompatible
libdevmapper" error.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=e0ae306a5897bc6892dbaa3e409f62aac8e8d735 target=_blank rel=noopener>e0ae306a</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>