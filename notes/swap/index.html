<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
Security If at any point a decryption key is needed to access a file, it will be stored in RAM. If an otherwise encrypted file is edited it will get stored in RAM before being saved.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Swap • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
Security If at any point a decryption key is needed to access a file, it will be stored in RAM. If an otherwise encrypted file is edited it will get stored in RAM before being saved.'>
<meta property='og:url' content='https://stelfox.net/notes/swap/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='notes'><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.56.0-DEV" />

  <title>Swap • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/notes/swap/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-notes'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Swap</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='0001-01-01T00:00:00Z'>0001, Jan 01</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
3 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<p><strong><em>Note: This page is quite old and is likely out of date. My opinions may have
also changed dramatically since this was written. It is here as a reference
until I get around to updating it.</em></strong></p>

<h2 id="security">Security</h2>

<p>If at any point a decryption key is needed to access a file, it will be stored
in RAM. If an otherwise encrypted file is edited it will get stored in RAM
before being saved. Without warning at any time that RAM can be swapped out to
disk, at which point there is now a recoverable copy of an encryption key or
sections of an encrypted document plain text on disk that <a href="https://stelfox.net/notes/data-recovery/">can be
recovered</a>.</p>

<p>To prevent this I strongly recommend encrypting the swap. During a standard
install of Fedora if you want to accomplish this you have to use dirty
VolGroups and LVMs. I hate VolGroups and LVMs and on top of that it will be
using a set static key that I&rsquo;m sure will eventually be open to static
analysis. While most people won&rsquo;t care about the latter I like to avoid the
whole thing if I can do it with a fast simple solution.</p>

<p>My solution is to take swap out of the hands of fstab and mount it myself after
generating a one-time key for that session. When the computer turns off the key
will be completely lost and a new one will be generated the next time the
computer boots. I don&rsquo;t want to do this by hand every time the computer boots
so I&rsquo;ll make sure it does this automatically.</p>

<p>The first step is to prevent Linux from mounting the swap on it&rsquo;s own. To do
this comment out all the lines in fstab that have to do with swap. They will
look like the following:</p>

<pre><code>/dev/sda3       swap                swap        defaults        0 0
</code></pre>

<p>Your going to need to know what partitions your swap lives on. In the above
example swap lives on <code>/dev/sda3</code>, it is very likely that your&rsquo;s will live on a
different device/partition.</p>

<p>First we&rsquo;re going to want to fill the swap space with junk to make sure that
there isn&rsquo;t anything useful left on there to be recovered. Your going to want
to make sure that your system isn&rsquo;t currently using the swap, so first turn it
off before writing over the swap space. The latter command is very dangerous if
you do it on the wrong partition! Double check before executing it!</p>

<pre><code>[root@localhost ~]# swapoff -a
[root@localhost ~]# dd if=/dev/urandom of=/dev/sda3
</code></pre>

<p>Next we&rsquo;ll want to make one of the boot scripts initialize encryption and mount
the swap, there is a specific boot script created explicitly for user
modification that other packages won&rsquo;t touch. We&rsquo;re going to use that one which
is <code>/etc/rc.d/rc.local</code>. You&rsquo;ll want to add the following lines to it.</p>

<pre><code>cryptsetup -c blowfish -h sha256 -d /dev/urandom create swap /dev/sda3
mkswap -f /dev/mapper/swap
swapon /dev/mapper/swap
</code></pre>

<p>The cipher in the above command can be swapped around, blowfish is a strong
encryption with a fairly good throughput however it seems that 256bit
aes-xts-plain is a bit faster without sacrificing too much security. If you&rsquo;d
prefer to use that instead, replace the cryptsetup invocation with the
following one:</p>

<pre><code>cryptsetup -c aes-xts-plain -s 256 -h sha256 -d /dev/urandom create swap /dev/sda3
</code></pre>

<p>Fedora has device mapper support built into the kernel, however if your
distribution doesn&rsquo;t have device mapper support active by default, in the line
right before the cryptsetup invocation add the line &ldquo;modprobe dm-mod&rdquo; to load
the kernel module. Otherwise you&rsquo;ll get a &ldquo;Command failed: Incompatible
libdevmapper&rdquo; error.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/notes/tails-setup-notes/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Tails Setup Notes</a>
    </div><div class='next-entry sep-before'>
      <a href='/notes/suricata/'>
        <span class='screen-reader-text'>Next post: </span>Suricata<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2019 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.67d669ac.js'></script>

</body>

</html>

