<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Installation/Configuration Install the required packages with the following command:
yum install openstack-utils openstack-keystone python-keystoneclient -y Generate a long, strong unique password for keystone&amp;rsquo;s MySQL user (MySQL should already be setup at this point and bound to 10.100.0.11 if you&amp;rsquo;re following along from the Openstack page. Open up a MySQL console as the root user and run the following commands:
Important Note: Openstack has a convenient command openstack-db that does the following for you, however, when it creates the user it uses keystone for a password and doesn&amp;rsquo;t restrict the hosts that can use that account (globally available)."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/openstack_keystone/><title>Openstack Keystone :: Sam Stelfox
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Openstack Keystone"><meta itemprop=description content="Installation/Configuration Install the required packages with the following command:
yum install openstack-utils openstack-keystone python-keystoneclient -y Generate a long, strong unique password for keystone&rsquo;s MySQL user (MySQL should already be setup at this point and bound to 10.100.0.11 if you&rsquo;re following along from the Openstack page. Open up a MySQL console as the root user and run the following commands:
Important Note: Openstack has a convenient command openstack-db that does the following for you, however, when it creates the user it uses keystone for a password and doesn&rsquo;t restrict the hosts that can use that account (globally available)."><meta itemprop=wordCount content="1813"><meta name=twitter:card content="summary"><meta name=twitter:title content="Openstack Keystone"><meta name=twitter:description content="Installation/Configuration Install the required packages with the following command:
yum install openstack-utils openstack-keystone python-keystoneclient -y Generate a long, strong unique password for keystone&rsquo;s MySQL user (MySQL should already be setup at this point and bound to 10.100.0.11 if you&rsquo;re following along from the Openstack page. Open up a MySQL console as the root user and run the following commands:
Important Note: Openstack has a convenient command openstack-db that does the following for you, however, when it creates the user it uses keystone for a password and doesn&rsquo;t restrict the hosts that can use that account (globally available)."></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/blog/>Blog Posts</a></li><li><a href=/notes/>Various Notes</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/openstack_keystone/>Openstack Keystone</a></h2><div class=post-content><h2 id=installationconfiguration>Installation/Configuration</h2><p>Install the required packages with the following command:</p><pre tabindex=0><code>yum install openstack-utils openstack-keystone python-keystoneclient -y
</code></pre><p>Generate a long, strong unique password for keystone&rsquo;s <a href=https://stelfox.net/notes/mysql/>MySQL</a> user (MySQL
should already be setup at this point and bound to <code>10.100.0.11</code> if you&rsquo;re
following along from the <a href=https://stelfox.net/notes/openstack/>Openstack</a> page. Open up a MySQL console as the
root user and run the following commands:</p><p>Important Note: Openstack has a convenient command <code>openstack-db</code> that does the
following for you, however, when it creates the user it uses <code>keystone</code> for a
password and doesn&rsquo;t restrict the hosts that can use that account (globally
available). It seems a bit excessive to me to have a script for those three
MySQL commands:</p><pre tabindex=0><code>CREATE DATABASE keystone;
GRANT ALL ON keystone.* TO &#39;keystone&#39;@&#39;10.100.0.%&#39; IDENTIFIED BY
  &#39;LongStrongUniquePasswordYouGenerated&#39;;
FLUSH PRIVILEGES;
</code></pre><p>Generate a token to be used as the &lsquo;admin&rsquo; global token. When used this will
give you full admin credentials on the keystone service regardless of whether
or not an admin exists.</p><p>This is needed for the initial administration of the keystone service once we
get it up and running. I save it directly to the root user&rsquo;s bashrc file as it
it&rsquo;ll be useful to have later on:</p><pre tabindex=0><code>echo export ADMIN_TOKEN=$(openssl rand -hex 32) &gt; /root/.bashrc
</code></pre><p>After logging off and back on make sure you have the token and copy this for
use in the configuration file later on:</p><pre tabindex=0><code>echo $ADMIN_TOKEN
f35fb1205820907c2ddd1eb046f6ba2de1e5b729d6b7aedc5b0959156013f4a3
</code></pre><p>Open up the keystone configuration file at: <code>/etc/keystone/keystone.conf</code> and
replace it with the following (changing appropriate variables for your
installation such as <code>admin_token</code> and the MySQL password:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[DEFAULT]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>onready</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.common.systemd</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>admin_port</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>35357</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>admin_token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>ADMIN</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bind_host</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>0.0.0.0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>compute_port</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>8774</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>public_port</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Logging Options</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>debug</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>False</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>syslog_log_facility</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>LOG_USER</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>use_syslog</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>True</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>verbose</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[sql]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>mysql://keystone:keystone@127.0.0.1/keystone</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>idle_timeout</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[identity]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>driver</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.identity.backends.sql.Identity</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[catalog]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>driver</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.catalog.backends.sql.Catalog</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>template_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/keystone/default_catalog.templates</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[token]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>driver</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.token.backends.sql.Token</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>expiration</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>7200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[policy]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>driver</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.policy.backends.rules.Policy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[ec2]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>driver</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.contrib.ec2.backends.sql.Ec2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[ssl]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#enable = True</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#certfile = /etc/keystone/ssl/certs/keystone.pem</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#keyfile = /etc/keystone/ssl/private/keystonekey.pem</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ca_certs = /etc/keystone/ssl/certs/ca.pem</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#cert_required = True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[signing]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>certfile</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/keystone/ssl/certs/signing_cert.pem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ca_certs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/keystone/ssl/certs/ca.pem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ca_password</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>SuperSecretCAPass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>keyfile</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/keystone/ssl/private/signing_key.pem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>key_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>4096</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>valid_days</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>3650</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>token_format</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>PKI</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[ldap]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># url = ldap://localhost</span>
</span></span><span style=display:flex><span><span style=color:#75715e># user = dc=Manager,dc=example,dc=com</span>
</span></span><span style=display:flex><span><span style=color:#75715e># password = None</span>
</span></span><span style=display:flex><span><span style=color:#75715e># suffix = cn=example,cn=com</span>
</span></span><span style=display:flex><span><span style=color:#75715e># use_dumb_member = False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># user_tree_dn = ou=Users,dc=example,dc=com</span>
</span></span><span style=display:flex><span><span style=color:#75715e># user_objectclass = inetOrgPerson</span>
</span></span><span style=display:flex><span><span style=color:#75715e># user_id_attribute = cn</span>
</span></span><span style=display:flex><span><span style=color:#75715e># user_name_attribute = sn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># tenant_tree_dn = ou=Groups,dc=example,dc=com</span>
</span></span><span style=display:flex><span><span style=color:#75715e># tenant_objectclass = groupOfNames</span>
</span></span><span style=display:flex><span><span style=color:#75715e># tenant_id_attribute = cn</span>
</span></span><span style=display:flex><span><span style=color:#75715e># tenant_member_attribute = member</span>
</span></span><span style=display:flex><span><span style=color:#75715e># tenant_name_attribute = ou</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># role_tree_dn = ou=Roles,dc=example,dc=com</span>
</span></span><span style=display:flex><span><span style=color:#75715e># role_objectclass = organizationalRole</span>
</span></span><span style=display:flex><span><span style=color:#75715e># role_id_attribute = cn</span>
</span></span><span style=display:flex><span><span style=color:#75715e># role_member_attribute = roleOccupant</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:debug]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.common.wsgi:Debug.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:token_auth]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.middleware:TokenAuthMiddleware.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:admin_token_auth]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.middleware:AdminTokenAuthMiddleware.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:xml_body]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.middleware:XmlBodyMiddleware.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:json_body]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.middleware:JsonBodyMiddleware.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:user_crud_extension]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.contrib.user_crud:CrudExtension.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:crud_extension]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.contrib.admin_crud:CrudExtension.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:ec2_extension]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.contrib.ec2:Ec2Extension.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:s3_extension]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.contrib.s3:S3Extension.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:url_normalize]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.middleware:NormalizingFilter.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:stats_monitoring]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.contrib.stats:StatsMiddleware.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[filter:stats_reporting]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.filter_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.contrib.stats:StatsExtension.factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[app:public_service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.app_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.service:public_app_factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[app:admin_service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.app_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.service:admin_app_factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[pipeline:public_api]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pipeline</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>stats_monitoring url_normalize token_auth admin_token_auth xml_body json_body debug ec2_extension user_crud_extension public_service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[pipeline:admin_api]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pipeline</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>stats_monitoring url_normalize token_auth admin_token_auth xml_body json_body debug stats_reporting ec2_extension s3_extension crud_extension admin_service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[app:public_version_service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.app_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.service:public_version_app_factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[app:admin_version_service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>paste.app_factory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>keystone.service:admin_version_app_factory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[pipeline:public_version_api]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pipeline</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>stats_monitoring url_normalize xml_body public_version_service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[pipeline:admin_version_api]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pipeline</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>stats_monitoring url_normalize xml_body admin_version_service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[composite:main]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>egg:Paste#urlmap</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>/v2.0</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>public_api</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>/</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>public_version_api</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[composite:admin]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>egg:Paste#urlmap</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>/v2.0</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>admin_api</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>/</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>admin_version_api</span>
</span></span></code></pre></div><p>Please note that I haven&rsquo;t yet delved into the Compositions, Filters, Apps or
Pipelines and don&rsquo;t have a handle on what exactly they&rsquo;re doing. As far as
configuration documentation goes there is much to be desired in Keystone&mldr;</p><p>We need to create a full <a href=https://stelfox.net/notes/certificate_authority/>certificate authority</a> in
<code>/etc/keystone/ssl/certs</code>. Ideally the CA itself would be signed by a higher CA
of our control. A keystone SSL cert and key will also need to be created (and
signed by the CA).</p><p>The cert and key file should be placed at
<code>/etc/keystone/ssl/certs/signing_cert.pem</code> and
<code>/etc/keystone/ssl/private/signing_key.pem</code> respectively. You&rsquo;ll also want to
ensure the <code>[signing]</code> portion of the <code>keystone.conf</code> file reflects the actual
size of the key.</p><pre tabindex=0><code>keystone-manage db_sync
</code></pre><p>Now that we&rsquo;re configured let&rsquo;s get the service going&mldr;</p><pre tabindex=0><code>systemctl enable openstack-keystone.service
systemctl start openstack-keystone.service
</code></pre><p>You should now have a running (though empty) keystone service. Let&rsquo;s test and
make sure it&rsquo;s responding nicely:</p><pre tabindex=0><code>keystone --token $ADMIN_TOKEN --endpoint http://10.100.0.13:35357/v2.0/ tenant-list
</code></pre><h2 id=initial-setup>Initial Setup</h2><p>Now that we have the service up and running we need to add users, roles,
tenants, services and endpoints. A quick note on a couple of things here.
&lsquo;Tenant&rsquo; is used as a means of logically grouping a bunch of users. A user can
exist in multiple tenants and will only be aware of the resources within
tenants that it has been granted access too unless that user is an admin of the
special admin tenant which will automatically grant them full access to all
tenants and their contents regardless of whether that user is in that tenant
and as such care should be taken when granting that level of permissions.</p><p>First since we&rsquo;ll be running a lot of commands and it can quickly become
burdensome to repeatedly provide the endpoint and the token we&rsquo;re going to set
two environment variables to make the access easier, then test to make sure we
can still access the service:</p><pre tabindex=0><code>export SERVICE_ENDPOINT=http://10.100.0.13:35357/v2.0/
export SERVICE_TOKEN=$ADMIN_TOKEN
keystone tenant-list
</code></pre><p>There is another slightly annoying thing that can be easily worked around in
Openstack; Whenever you refer to a user, role, tenant, service, endpoint or
other object you need to do so by it&rsquo;s ID and not it&rsquo;s friendly name. As such
I&rsquo;ve adapted a few helper methods to easily grab an object ID based on it&rsquo;s
friendly name. Add these too root&rsquo;s bash file and re-source it by either
logging out and back in or by running &ldquo;. ~/.bashrc&rdquo;.</p><p>We now need to create an admin user, role, tenant, and combine them all:</p><pre tabindex=0><code>keystone user-create --name admin --pass secret --email admin@email.net
+----------+-------------------------------------------------------------------------------------------------------------------------+
| Property |                                                          Value                                                          |
+----------+-------------------------------------------------------------------------------------------------------------------------+
|  email   |                                                     sam@stelfox.net                                                     |
| enabled  |                                                           True                                                          |
|    id    |                                             2e981959c1d54789a3ae6a88611cc0db                                            |
|   name   |                                                          admin                                                          |
| password | $6$rounds=40000$ZXGfdZeIcwVWGWvA$VLgWIRk7tM5OdEjeYZEnpANbjVO0SydvXZgK7UAlh0VED4S1dbCMWYxFNWgz4p.7Ni6Nmzw3FUtLx6MLYVEm21 |
| tenantId |                                                                                                                         |
+----------+-------------------------------------------------------------------------------------------------------------------------+
keystone role-create --name admin
+----------+----------------------------------+
| Property |              Value               |
+----------+----------------------------------+
|    id    | df6b8c5b5a0847259e1c78a34aae09d1 |
|   name   |              admin               |
+----------+----------------------------------+
keystone tenant-create --name admin
+-------------+----------------------------------+
|   Property  |              Value               |
+-------------+----------------------------------+
| description |                                  |
|   enabled   |               True               |
|      id     | adb579d87cc7438da8ddb6147ca69717 |
|     name    |              admin               |
+-------------+----------------------------------+
keystone user-role-add --user-id 2e981959c1d54789a3ae6a88611cc0db --role-id df6b8c5b5a0847259e1c78a34aae09d1 --tenant-id adb579d87cc7438da8ddb6147ca69717
</code></pre><h2 id=potentially-old-information>Potentially Old Information</h2><pre tabindex=0><code>get_tenant_id() {
  echo `keystone tenant-list | grep $@ | awk &#39;{ print $2 }&#39;`
}

get_user_id() {
  echo `keystone user-list | grep $@ | awk &#39;{ print $2 }&#39;`
}

get_role_id() {
  echo `keystone role-list | grep $@ | awk &#39;{ print $2 }&#39;`
}

get_service_id() {
  echo `keystone service-list | grep $@ | awk &#39;{ print $2 }&#39;`
}
</code></pre><h3 id=tenant-creation>Tenant Creation</h3><pre tabindex=0><code>keystone tenant-create --name=admin
keystone tenant-create --name=service
</code></pre><h3 id=role-creation>Role Creation</h3><pre tabindex=0><code>keystone role-create --name admin
keystone role-create --name KeystoneAdmin
keystone role-create --name KeystoneServiceAdmin
keystone role-create --name Member
</code></pre><h3 id=user-creation>User Creation</h3><p>Generate a five long strong unique passwords for the admin user and each of the
four service accounts here. For this example I&rsquo;m going to use password{1-5}. If
you use the same ones&mldr; you probably shouldn&rsquo;t be playing at this level&mldr; You
will need these later when setting up each of the services so note them down
somewhere secure.</p><pre tabindex=0><code>keystone user-create --name=admin --pass=password1 --email=admin@your-admin.cn
keystone user-create --name=nova --pass=password2 --tenant_id $(get_tenant_id service)
keystone user-create --name=glance --pass=password3 --tenant_id $(get_tenant_id service)
keystone user-create --name=quantum --pass=password4 --tenant_id $(get_tenant_id service)
keystone user-create --name=cinder --pass=password5 --tenant_id $(get_tenant_id service)
</code></pre><h3 id=granting-roles>Granting Roles</h3><p>Grant the admin user the <code>admin</code>, <code>KeystoneAdmin</code>, and <code>KeystoneServiceAdmin</code>
roles within the admin tenant and the service accounts the admin role within
the service tenant.</p><pre tabindex=0><code>keystone user-role-add --user $(get_user_id admin) --role $(get_role_id admin) --tenant_id $(get_tenant_id admin)
keystone user-role-add --user $(get_user_id admin) --role $(get_role_id KeystoneAdmin) --tenant_id $(get_tenant_id admin)
keystone user-role-add --user $(get_user_id admin) --role $(get_role_id KeystoneServiceAdmin) --tenant_id $(get_tenant_id admin)

keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id nova) --role $(get_role_id admin)
keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id glance) --role $(get_role_id admin)
keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id quantum) --role $(get_role_id admin)
keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id cinder) --role $(get_role_id admin)
</code></pre><h3 id=service-creation>Service Creation</h3><pre tabindex=0><code>keystone service-create --name nova --type compute --description &#39;OpenStack Compute Service&#39;
keystone service-create --name cinder --type volume --description &#39;OpenStack Volume Service&#39;
keystone service-create --name glance --type image --description &#39;OpenStack Image Service&#39;
keystone service-create --name keystone --type identity --description &#39;OpenStack Identity&#39;
keystone service-create --name ec2 --type ec2 --description &#39;OpenStack EC2 service&#39;
keystone service-create --name quantum --type network --description &#39;OpenStack Networking service&#39;
</code></pre><h3 id=endpoint-creation>Endpoint Creation</h3><p>End points are the next thing to be defined, they require that a region be
specified. This is an arbitrary string that can be used to delinieate between
service regions that could be data centers, portions of a data-center or what
have you.</p><p>Since I&rsquo;m not working on an installation large enough to really need multiple
regions this name is more or less useless for me so I chose to just use Primary
as the region name.</p><pre tabindex=0><code>keystone endpoint-create --region Primary --service_id $(get_service_id compute) \
  --publicurl &#39;http://10.100.0.15:8774/v2/$(tenant_id)s&#39; \
  --adminurl &#39;http://10.100.0.15:8774/v2/$(tenant_id)s&#39; \
  --internalurl &#39;http://10.100.0.15:8774/v2/$(tenant_id)s&#39;

keystone endpoint-create --region Primary --service_id $(get_service_id volume) \
  --publicurl &#39;http://10.100.0.16:8776/v1/$(tenant_id)s&#39; \
  --adminurl &#39;http://10.100.0.16:8776/v1/$(tenant_id)s&#39; \
  --internalurl &#39;http://10.100.0.16:8776/v1/$(tenant_id)s&#39;

keystone endpoint-create --region Primary --service_id $(get_service_id image) \
  --publicurl &#39;http://10.100.0.17:9292/v2&#39; \
  --adminurl &#39;http://10.100.0.17:9292/v2&#39; \
  --internalurl &#39;http://10.100.0.17:9292/v2&#39;

keystone endpoint-create --region Primary --service_id $(get_service_id identity) \
  --publicurl &#39;http://10.100.0.13:5000/v2.0&#39; \
  --adminurl &#39;http://10.100.0.13:35357/v2.0&#39; \
  --internalurl &#39;http://10.100.0.13:5000/v2.0&#39;

keystone endpoint-create --region Primary --service_id $(get_service_id ec2) \
  --publicurl &#39;http://10.100.0.18:8773/services/Cloud&#39; \
  --adminurl &#39;http://10.100.0.18:8773/services/Admin&#39; \
  --internalurl &#39;http://10.100.0.18:8773/services/Cloud&#39;

keystone endpoint-create --region Primary --service_id $(get_service_id network) \
  --publicurl &#39;http://10.100.0.19:9696/&#39; \
  --adminurl &#39;http://10.100.0.19:9696/&#39; \
  --internalurl &#39;http://10.100.0.19:9696/&#39;
</code></pre><h3 id=keystone-management>Keystone Management</h3><p>With keystone setup, the admin user in place, and endpoints defined you no
longer need to use the admin token to authenticate and manage the service. As a
regular user export the following information into your bash shell, unset the
admin token and try to access the keystone user-list again:</p><pre tabindex=0><code>export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=password1
export OS_AUTH_URL=http://10.100.0.13:5000/v2.0/
unset ADMIN_TOKEN
keystone tenant-list
+----------------------------------+---------+---------+
|                id                |   name  | enabled |
+----------------------------------+---------+---------+
| bb9509fd9dea40f5b58d720aaaa15044 | service | True    |
| cbabea52a4be417998b266e43280ef35 | admin   | True    |
+----------------------------------+---------+---------+
</code></pre><p>You can also specify those options via the command line if you don&rsquo;t want to
set the environment variables like so:</p><pre tabindex=0><code>keystone --os_username admin --os_password password1 --os_tenant_name admin \
  --os_auth_url http://10.100.0.13:5000/v2.0/ tenant-list
+----------------------------------+---------+---------+
|                id                |   name  | enabled |
+----------------------------------+---------+---------+
| bb9509fd9dea40f5b58d720aaaa15044 | service | True    |
| cbabea52a4be417998b266e43280ef35 | admin   | True    |
+----------------------------------+---------+---------+
</code></pre><h2 id=future-steps>Future Steps</h2><p>There are some features that I&rsquo;d really like to take a look at getting as I
feel they will improve the quality, security or reliability of the service in
general. These features that I haven&rsquo;t documented here yet are as follows:</p><ul><li>LDAP Authentication Backend<ul><li>With Memcached queries</li></ul></li><li>SSL</li><li>Detailed policy.json evaluation<ul><li>Breaking out permissions into more explicit roles</li><li>What can I actually accomplish with this file?</li></ul></li></ul></div></article><hr><div class=post-info></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>