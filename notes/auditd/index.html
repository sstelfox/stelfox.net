<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Auditd collects any configured syscall execution with critical security metadata associated with the event. This can help enrich other security tools such as AIDE to determine what user and process are responsible for the change.
For reliable operation the rules should be carefully tuned to your system. Tracking every write to disk will generate an unreasonable amount of events and depending on the configuration of the kernel's audit subsystem, may trigger a kernel panic."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,linux,operations,security"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/auditd/><title>Auditd :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Auditd"><meta itemprop=description content="Auditd collects any configured syscall execution with critical security metadata associated with the event. This can help enrich other security tools such as AIDE to determine what user and process are responsible for the change.
For reliable operation the rules should be carefully tuned to your system. Tracking every write to disk will generate an unreasonable amount of events and depending on the configuration of the kernel's audit subsystem, may trigger a kernel panic."><meta itemprop=datePublished content="2017-10-12T15:33:21-04:00"><meta itemprop=dateModified content="2017-10-12T15:33:21-04:00"><meta itemprop=wordCount content="835"><meta itemprop=keywords content="Linux,Operations,Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="Auditd"><meta name=twitter:description content="Auditd collects any configured syscall execution with critical security metadata associated with the event. This can help enrich other security tools such as AIDE to determine what user and process are responsible for the change.
For reliable operation the rules should be carefully tuned to your system. Tracking every write to disk will generate an unreasonable amount of events and depending on the configuration of the kernel's audit subsystem, may trigger a kernel panic."><meta property="article:published_time" content="2017-10-12 15:33:21 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/auditd/>Auditd</a></h2><div class=post-content><p>Auditd collects any configured syscall execution with critical security metadata associated with the event. This can help enrich other security tools such as <a href=aide>AIDE</a> to determine what user and process are responsible for the change.</p><p>For reliable operation the rules should be carefully tuned to your system. Tracking every write to disk will generate an unreasonable amount of events and depending on the configuration of the kernel's audit subsystem, may trigger a kernel panic.</p><p>Auditd will also identify the IP address a remote user is connecting in allow cross system tracing of events.</p><h2 id=recommended-events-to-audit>Recommended Events to Audit</h2><ul><li>All logins to the system</li><li>Writes & attribute changes on sensitive files that are largely static (think /etc)</li><li>Writes & attribute changes to critical system binaries</li><li>Write to the kernel / initramfs</li><li>Any program executed with root privileges</li><li>Any program execution that has the suid bit set</li><li>Changes to SELinux policies</li><li>Time / Date changes (both to the system and sensitive files)</li><li>Truncation of log files</li><li>Access to the audit and audit reporting tools and logs</li><li>Creation, modification, and deletion of special files (think mknod)</li><li>Mount and unmount operations</li><li>User & Group creation and removal</li><li>Read/write access to private key material</li><li>Changes to the hostname</li><li>Any failure to access a file</li><li>Changes to power state (such as shutdown)</li><li>Administrative access to user home directories</li><li>Executions out of temporary directories (Only important if this is possible, but never hurts)</li></ul><h2 id=log-integrity>Log Integrity</h2><p>For these logs to be meaningful they need to be shipped off a system. Auditd itself can receive audit events over the network and comes with a utility for pushing them over the network. Without Kerberos though these events are sent without authentication or encryption and could be tampered with or spoofed by a crafty attacker.</p><p>Some log aggregators are able to read (tail) files and consume the lines as events (such as <a href=rsyslog>RSyslog</a>) and do so over a SSL or otherwise encrypted tunnel.</p><p>The final option for getting logs off the system, is to specify a custom dispatcher using the "dispatcher" configuration option in "/etc/audit/auditd.conf". This needs to be an executable on the system that will take audit records through STDIN. A custom dispatcher could POST individual events to an API, log the events directly to syslog, or anything else that can be coded. This will be run with root permissions, so the ability for it to drop permissions is highly desirable.</p><h2 id=configuration>Configuration</h2><p>I have a sample <a href=/notes/auditd/auditd.conf>/etc/audit/auditd.conf</a> and <a href=/notes/auditd/libaudit.conf>/etc/libaudit.conf</a> available as well as a matching set of <a href=/notes/auditd/audit.rules>/etc/audit/audit.rules</a> that are tuned for my environments. I consider them a good starting point for other people wanting detailed auditing logs.</p><h2 id=audit-dispatcher>Audit Dispatcher</h2><p>By default auditd has two mechanisms for sending audit events to an administrator for review. The first and common one is to log directly to disk. The other is to pass the events to a dispatch program. This is a very powerful second option as the other program will receive a binary stream of all events from auditd and can do anything with them.</p><p>Auditd comes with a dispatcher with the ability to send the messages directly to syslog, to a remote auditd instance, or to a unix socket. I normally use the log file option rather than the dispatcher, and use the ability to read in files as a log source inside my syslog daemon of choice to get those messages to a central log server. Sending them directly to syslog is significantly more efficient (push vs poll).</p><p>If you use another dispatcher other than the one that comes with auditd, be aware that it will be started up with root privileges.</p><p>Unfortunately it seems like the dispatcher that comes with auditd 2.6.4 is broken. With all plugins disabled (to eliminate them as a source of an issue), I was still receiving the following message in syslog:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Dispatcher protocol mismatch, exiting
</span></span></code></pre></td></tr></table></div></div><p>Which of course, hasn't seemed to have been encountered by anyone else online. Digging through the source code, it seems "audispd" hasn't been updated for an update to the protocol built into auditd. I'll have to look into either fixing the source or writing my own dispatcher...</p><p>I wasn't able to find anything about fixes that may be related so I'm unsure when it was fixed. I updated to 2.7.1 and it seemed to resolve that issue.</p><p>To get the information going to syslog I made two relatively small changes to the existing configurations. You really only need to set 'active' to yes in "/etc/audisp/plugins.d/syslog.conf". I made minor tweaks to the configuration to better support my logging environment (I keep "local6" reserved for auditd
records). These two files include my relevant changes:</p><ul><li><a href=/notes/auditd/audispd.conf>/etc/audisp/audispd.conf</a></li><li><a href=/notes/auditd/audispd_syslog.conf>/etc/audisp/plugins.d/syslog.conf</a></li></ul><p>If you reliably have your audit records going to syslog, you may want to consider removing or reducing the amount of audit logs stored. For a system that generates significant numbers of logs, the syslog route can be quite a bit more efficient, and support significantly more messages (this will only work with disk queues removed).</p><h2 id=more-references>More References</h2><ul><li><a href=https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Security_Guide/chap-system_auditing.html>https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Security_Guide/chap-system_auditing.html</a></li><li><a href=http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-123.pdf>http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-123.pdf</a></li><li><a href=https://security.stackexchange.com/questions/4629/simple-example-auditd-configuration>https://security.stackexchange.com/questions/4629/simple-example-auditd-configuration</a></li><li><a href=https://linux-audit.com/tuning-auditd-high-performance-linux-auditing/>https://linux-audit.com/tuning-auditd-high-performance-linux-auditing/</a></li></ul></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span>
<span class=tag><a href=https://stelfox.net/tags/operations/>operations</a></span>
<span class=tag><a href=https://stelfox.net/tags/security/>security</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=fbd8ca38d421539154d91c5d7396464201f62ccb target=_blank rel=noopener>fbd8ca38</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>