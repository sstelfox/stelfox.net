<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>IceCast</h1><div class="post-content"><p>While it's described and primarily used as an audio streaming server, it would
be more accurate to describe it as a media streaming server as it's perfectly
capable of rebroadcasting video streams with or without audio.</p>
<span id="continue-reading"></span><h2 id="setup-process">Setup Process</h2>
<p>As of this writing Fedora 16 comes with Icecast version 2.3.2, the associated
documentation can be found on the Icecast website. I found some documentation
had been removed rather than updated along with the software and that
documentation can be found in version 2.0.1's documentation.</p>
<h3 id="networking">Networking</h3>
<p>Setup a dedicated IP for use by the Icecast server (this is optional but a good
practice even if it's just an internal address). You'll want to note this down
for what the server will bind it's addresses to later on.</p>
<p>For the purposes of this example configuration I'm using <code>eth0:1</code> interface
with an IP Address of 192.168.20.45 configured like so in
<code>/etc/sysconfig/network-script/ifcfg-eth0:1</code></p>
<pre><code># eth0:1 - For Icecast Server
DEVICE="eth0:1"
NM_CONTROLLED="no"
ONBOOT="yes"
BOOTPROTO="static"

IPADDR="192.168.20.45"
NETMASK="255.255.255.0"
NETWORK="192.168.20.0"
BROADCAST="192.168.20.255"

IPV4_FAILURE_FATAL="yes"
IPV6_AUTOCONF="no"
IPV6INIT="no"

NAME="IceCast Interface"
</code></pre>
<p>Setup an A/CNAME record pointing at the server that will be hosting the Icecast
server, take note of this as it will be needed for the hostname param in the
configuration file. This example will use streams.example.org for the hostname.</p>
<h3 id="firewall">Firewall</h3>
<p>Add the following <a href="https://stelfox.net/notes/iptables/">IPTables</a> rules:</p>
<pre><code>-A SERVICES -d 192.168.20.45 -m tcp -p tcp --dport 8000 -j ACCEPT
-A SERVICES -d 192.168.20.45 -m tcp -p tcp --dport 8001 -j ACCEPT
</code></pre>
<h3 id="setup-the-chroot-environment">Setup the chroot Environment</h3>
<p>The configuration I have here uses a chrooted environment within
<code>/usr/share/icecast</code>. By default it isn't fully setup.</p>
<pre><code>mkdir /usr/share/icecast/log
chown -R icecast:icecast /usr/share/icecast
rm -rf /var/log/icecast
ln -s /usr/share/icecast/log/ /var/log/icecast
</code></pre>
<h3 id="installation-configuration">Installation &amp; Configuration</h3>
<pre><code>yum install icecast -y
</code></pre>
<p>Place a copy of the <a href="https://stelfox.net/notes/icecast/icecast_base.xml">icecast config</a> at <code>/etc/icecast.xml</code>. I also have a
<a href="https://stelfox.net/notes/icecast/icecast_fully_commented.xml">fully commented config</a> available as well. You'll need to change the
values, especially <a href="https://stelfox.net/notes/password-security/">passwords</a> listed in the configuration before making it
live.</p>
<p>Icecast hasn't been ported over to systemd yet so you mind as well use the old
configuration options to set it to start up on each boot:</p>
<pre><code>chkconfig icecast on
service icecast start
</code></pre>
<p>If you configured everything properly you now have a happy Icecast server ready
to have a source authenticate to it and listeners receive it.</p>
<h2 id="example-mount-definitions">Example Mount Definitions</h2>
<h3 id="livedj-with-automation-fallback">LiveDJ with Automation Fallback</h3>
<p>The following configuration provides a public and a hidden mount. If there is a
live DJ authenticated and streaming content it will pull users out of the
automated stream and to listen to the live DJ, if the automated DJ goes down it
will play silence but won't kill the stream. This requires that you put a file
in the web directory named 'silence.ogg'.</p>
<p>You can download the one <a href="https://stelfox.net/notes/icecast/silence.ogg">I use here</a>. With this you'll want to use the URL
<code>http://streams.example.org/radio.ogg.m3u</code> to access the stream.</p>
<pre data-lang="xml" class="language-xml "><code class="language-xml" data-lang="xml"><mount>
  <mount-name>/automation.ogg</mount-name>

  <username>automation</username>
  <password>robot-password-hackme</password>

  <fallback-mount>/silence.ogg</fallback-mount>
  <fallback-override>1</fallback-override>

  <charset>UTF8</charset>

  <stream-name>Radio - Automation System</stream-name>
  <stream-description>A Radio Station Automaton</stream-description>
  <stream-url>http://streams.example.org/</stream-url>
  <genre>A Genre!</genre>

  <bitrate>128</bitrate>

  <public>0</public>
  <hidden>1</hidden>
</mount>

<mount>
  <mount-name>/radio.ogg</mount-name>

  <username>livedj</username>
  <password>the-live-djs-password</password>

  <fallback-mount>/automation.ogg</fallback-mount>
  <fallback-override>1</fallback-override>

  <charset>UTF8</charset>

  <stream-name>Radio - Automation System</stream-name>
  <stream-description>A Radio Station Automaton</stream-description>
  <stream-url>http://streams.example.org/</stream-url>
  <genre>A Genre!</genre>

  <bitrate>128</bitrate>

  <public>1</public>
  <hidden>0</hidden>
</mount>
</code></pre>
<h2 id="logrotate-stanza">Logrotate Stanza</h2>
<p>TODO</p>
<h2 id="ffmpeg2theora-source-client">ffmpeg2theora Source Client</h2>
<p>TODO</p>
<h2 id="using-icecast-stream-in-html5">Using Icecast stream in HTML5</h2>
<h3 id="audio">Audio</h3>
<p>Here is a snippet of HTML5 for connecting to the stream
<code>http://streams.example.org:8000/radio.ogg</code> with some javascript controls,
pretty straight forward. The loop is included in case the stream dies or is
currently in fallback mode to a file.</p>
<pre data-lang="html" class="language-html "><code class="language-html" data-lang="html"><!DOCTYPE html>
<html lang=en>
  <head>
    <meta charset=utf-8 />
    <meta name=viewport content="width=device-width"/>
    <title>HTML5 Radio Player Test</title>
  </head>
  <body>
    <div id=container>
      <audio id=radioStream preload=metadata controls loop>
      <source src="http://streams.example.org:8000/radio.ogg" type="audio/ogg"/>
      </audio>
      <br/>
      <a href="#" onclick="javascript:rs=document.getElementById('radioStream');rs.play();">Play</a>
      <a href="#" onclick="javascript:rs=document.getElementById('radioStream');rs.pause();">Pause</a>
      <a href="#" onclick="javascript:rs=document.getElementById('radioStream');rs.pause();rs.currentTime=0;">Stop</a>
      <input id=volume value=100 type=text /><a href="#" onclick="javascript:rs=document.getElementById('radioStream');vo=document.getElementById('volume');rs.volume=parseInt(vo.value)/100.0;">Set Volume</a>
    </div>
  </body>
</html>
</code></pre>
<h3 id="video">Video</h3>
<p>Todo...</p>
<h2 id="next-steps">Next Steps</h2>
<ul>
<li><a href="https://stelfox.net/notes/ezstream/">EZStream</a></li>
<li><a href="http://www.linuxcertif.com/man/1/ezstream/">EZStream Manual</a></li>
</ul>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
