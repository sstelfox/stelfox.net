<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>Apache</h1><div class="post-content"><p>Apache or httpd is a strong and well tested webserver.</p>
<span id="continue-reading"></span><h2 id="installation">Installation</h2>
<p>To install the Apache web server for this hardening guide on fedora run the
following command as root:</p>
<pre><code>[root@localhost] ~# yum install httpd mod_evasive mod_gnutls mod_security mod_selinux -y
</code></pre>
<p>A few modules I need to look into (TODO):</p>
<ul>
<li><code>mod_log_post</code></li>
</ul>
<h2 id="security-notes">Security Notes</h2>
<p>Apache starts up using root privileges initially. Dropping the privileges is
highly recommended as soon as possible (which it does if alternative
credentials are supplied in it's configuration).</p>
<p>Additionally, the Apache web server can be used to remotely execute dynamic
code if a vulnerability is found with the privileges the process is running as.
This could be very dangerous... The languages allowed to be executed should be
chosen wisely and hardened appropriately.</p>
<p>User credentials can be passed through the web server so it is strongly
recommended that SSL certificates be used. If SSL certificates are available
there are very few reasons not to use SSL everywhere.</p>
<p>The only exception I have been able to come up with is for an application that
is extremely latency sensitive, contains no sensitive data, and have the data
verified in a different way (through data signatures like HMAC or GPG). The
latter is not necessarily required.</p>
<h3 id="firewall-adjustments">Firewall Adjustments</h3>
<p>By default Apache only runs on port 80 using TCP, if SSL is enabled it will
also use port 443 over SSL. Additional ports can be configured by the admin.</p>
<pre><code>-A SERVICES -m tcp -p tcp --dport 80 -j ACCEPT
-A SERVICES -m tcp -p tcp --dport 443 -j ACCEPT
</code></pre>
<p>This service is very sensitive to the flood attack rules. It is recommended
these be adjusted to allow twice the maximum number of connections expected
during a time frame or alternatively to allow traffic on these two ports too
bypass the anti-flood rules.</p>
<h2 id="performance-notes">Performance Notes</h2>
<p>If you use <code>mod_security</code> you should note that in my testing each Apache thread
increases it's resident memory size by ~27Mb using the stock configuration. For
servers that need to handle a high volume of requests this may not be
acceptable. If using <code>mod_security</code> you DEFINITELY need to adjust the
<code>ServerLimit</code> and <code>MaxClients</code> (they are aliases of each other so should always
be the same).</p>
<h3 id="tuning-serverlimit-maxclients-with-the-worker-mpm">Tuning ServerLimit/MaxClients with the worker MPM</h3>
<ul>
<li>Start up the apache server</li>
<li>Use the <code>ps</code> utility to determine the size of client threads (will be in Kb)</li>
<li>Determine that max amount of RAM the apache process should be allowed to use</li>
<li>Subtract the <code>parent</code> processes RAM from that</li>
<li>Divide the remaining RAM by the size of the client threads, this is your
ServerLimit / MaxClient value</li>
</ul>
<p>An example of this is provided below:</p>
<pre><code>[root@localhost ~]# /etc/init.d/httpd start
Starting httpd:                                            [  OK  ]
[root@localhost ~]# ps aux -u apache | grep httpd
root      2238  0.7  0.4 177132  9312 ?        Ss   10:45   0:00 /usr/sbin/httpd
apache    2240  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
apache    2241  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
apache    2242  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
apache    2243  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
apache    2244  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
apache    2245  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
apache    2246  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
apache    2247  0.0  0.2 177132  5124 ?        S    10:45   0:00 /usr/sbin/httpd
root      2249  0.0  0.0 103376   832 pts/0    S+   10:45   0:00 grep --color=auto httpd
[root@localhost ~]# PARENTMEMORY=$((9312/1024))
[root@localhost ~]# CHILDMEMORY=$((5124/1024))
[root@localhost ~]# APACHERAM=1024
[root@localhost ~]# echo $(($(($APACHERAM-$PARENTMEMORY))/$CHILDMEMORY))
203
</code></pre>
<p>The parent process will have a running user of 'root', all of the children
processes will have 'apache'. In the above example the parent process is using
9312Kb of memory or ~9Mb, the child process is using 5124Kb or ~5Mb, and we're
allowing Apache to use up to 1Gb of memory (1024Mb). With that knowledge we can
see that we should set ServerLimit and MaxClients to &quot;203&quot; each.</p>
<h2 id="configuration">Configuration</h2>
<ul>
<li><a href="https://stelfox.net/notes/apache/httpd.conf">/etc/httpd/conf/httpd.conf</a></li>
</ul>
<p>This is the main configuration file. This differs quite a bit from the
configuration files that come with most distributions, most notably most of the
modules are disabled and sections of the config are only applicable if certain
modules are loaded. This preserves compatibility with any functionality I may
need in the future while removing the bloat of the modules.</p>
<p>To use this configuration you'll need to create the directory
<code>/var/www/html/default</code>. Any additional domains should be created in
<code>/var/www/html</code> with their domain name as the folder name.</p>
<ul>
<li><a href="https://stelfox.net/notes/apache/php.conf">/etc/httpd/conf.d/php.conf</a></li>
</ul>
<p>This file is being included here as it will be needed most places that I run
Apache. Please refer to the PHP section below for more information.</p>
<ul>
<li><a href="https://stelfox.net/notes/apache/mod_evasive.conf">/etc/httpd/conf.d/mod_evasive.conf</a></li>
</ul>
<p><code>mod_evasive</code> is a crafty little module designed to limit the impact of DoS and
DDoS attacks. This won't stop them but it will help defend against them. It
will also send notices to an admin if desired (it's an optional feature which
can be disabled).</p>
<p>The one potential problem I can see cropping up is with AJAX requests. Those
can come in fast and hard, and they are intentional and necessary, if that
becomes a problem (you'll get a 403 response when you trip and it will last for
DOSBlockingPeriod seconds) then play with the DOSPageCount setting and the
DOSSiteCount setting. Alternatively you can just program your AJAX clients to
understand what happened and to react accordingly.</p>
<ul>
<li><a href="https://stelfox.net/notes/apache/mod_gnutls.conf">/etc/httpd/conf.d/mod_gnutls.conf</a></li>
</ul>
<p>The GnuTLS module provides SSL encryption for web requests. It's quite a bit
more flexible than <code>mod_ssl</code> though it hasn't been audited as thoroughly. It is
also considered an 'experimental' module for apache even though it's been in
the wild for two years.</p>
<ul>
<li>/etc/httpd/conf.d/mod_security.conf</li>
</ul>
<p>WARNING: While this is a good module to have loaded it sextuples the amount of
memory used by child processes. You will need to tune the server's performance
settings accordingly. This may have a huge impact on high-traffic sites.</p>
<p>With that out of the way this is a very good application firewall to have as
part of the defense-in-depth doctrine, though it's configuration can be a
burden. The <code>mod_security</code> module gives your Apache Web server increased
ability to inspect and process input from Web clients before it's acted on by
the scripts or processes waiting for the input.</p>
<p>The <code>mod_security</code> module even lets you inspect Web server output before it's
transmitted back to clients. I love this feature: it allows you to watch out
for server responses that might indicate that other filters have failed and an
attack has succeeded!</p>
<p>With that said this isn't the file you should actually be looking at. Yes this
is where everything will get loaded but the stock Fedora <code>mod_security</code> for the
most parts loads up <code>mod_security</code> rules in other places including the Core
ModSecurity Rule Set which will get updated with the rest of your server.</p>
<p>The variables that you'll want to play around with are located in
<code>/etc/httpd/modsecurity.d/modsecurity_crs_10_config.conf</code> and if you want to
write your own rules in <code>/etc/httpd/modsecurity.d/modsecurity_localrules.conf</code>.</p>
<p>Some changes I'd recommend in
<code>/etc/httpd/modsecurity.d/modsecurity_crs_10_config.conf</code>:</p>
<ul>
<li>Uncomment the rule that limits argument name length to 100 characters</li>
<li>Uncomment the rule that limits the value of an argument's length to 400
characters</li>
<li>Uncomment the rule that limits the total argument length to 64000 characters</li>
<li>Review the restricted extension types</li>
</ul>
<p>After keeping an eye on the logs for a few weeks and ensuring that there aren't
any false positives, you should change the line <code>SecDefaultAction &quot;phase:2,pass</code> to <code>SecDefaultAction &quot;phase:2,deny,log,status:403&quot;</code>.</p>
<ul>
<li><a href="https://stelfox.net/notes/apache/mod_selinux.conf">/etc/httpd/conf.d/mod_selinux.conf</a></li>
</ul>
<p>The <code>mod_selinux</code> module allows us to extend SELinux contexts into individual
web applications or virtual hosts without impacting the memory usage of
individual child processes (The parent process seems to use about 100Kb of
memory more but this is negligible).</p>
<p>Since I don't use the built in apache authentication I'm limited to
restrictions based on virtual hosts, which is still a rather large gain of
security.</p>
<p>You can additionally adjust contexts based on the IP the user is connecting
from.</p>
<p>If you enable the environment module (<code>env_module</code>) in apache the domain may be
available for use within the application (it would be <code>SELINUX_DOMAIN</code>). This
hasn't been tested. With PHP you may need to add the <code>E</code> to the string
<code>variable_order</code>, and adjust <code>auto_globals_jit</code> in the <code>php.ini</code> file.</p>
<p>Changing contexts with the stock SELinux rules is denied! You will need to
create a SELinux policy to allow it.</p>
<h3 id="virtual-host-contexts">Virtual Host Contexts</h3>
<p>To make use of this feature you need to define contexts within each of the
virtual host configuration directives after enabling <code>mod_selinux</code> by adding
the following line:</p>
<pre><code>selinuxDomainVal    *:s0:c1
</code></pre>
<p>The trailing domain should be different for virtual host (the next one would be
c2).</p>
<h3 id="ip-based-contexts">IP Based Contexts</h3>
<p>You can set contexts based on the IP address being connected from by adding the
following line within a Directory definition:</p>
<pre><code>SetEnvIf Remote_Addr "10.13.37.(25[0-5]|2[0-4][0-9]|[1-9]?[0-9])$" SELINUX_DOMAIN=*:s0:c1
</code></pre>
<ul>
<li><a href="https://stelfox.net/notes/apache/virtual_hosts.conf">/etc/httpd/conf.d/virtual_hosts.conf</a></li>
</ul>
<p>This does not exist upon the default installation and will need to be created.
No certificates are automatically generated when you install the GnuTLS module,
if you need them you will need to generate them yourself.</p>
<ul>
<li>/etc/httpd/conf.d/welcome.conf</li>
</ul>
<p>Delete this file, it has no use and should be removed.</p>
<h2 id="virtual-hosts">Virtual Hosts</h2>
<p>Please note that name based virtual hosts are not supported on SSL connections
when using <code>mod_ssl</code>. They work quite well with <code>mod_gnutls</code> and browsers that
support SNI (Server Name Indication, as described in section 3.1 of
<a href="https://www.ietf.org/rfc/rfc3546.txt">RFC3546</a>). Compatibility with older browsers may be impacted.</p>
<h3 id="name-based">Name Based</h3>
<p>Name based virtual hosts allow you to re-use an IP to host multiple websites.
This is only officially supported for unencrypted connections, however by using
the GnuTLS module you can easily set this up with SSL based hosts as well. An
example of how to use this can be seen in the <code>virtual_hosts.conf</code> file on this
page.</p>
<h3 id="ip-based">IP Based</h3>
<p>I don't really use these so I'm not including documentation, this section is
mostly so other people referencing this documentation can be aware that they
can have different virtual hosts bound to specific IP addresses rather than
hostnames.</p>
<h2 id="php">PHP</h2>
<pre><code>[root@localhost] ~# yum install php php-suhosin
</code></pre>
<p>Additional PHP packages that may be needed and that I've found very useful:</p>
<ul>
<li>
<p>php-mcrypt</p>
</li>
<li>
<p>php-bcmath</p>
</li>
<li>
<p>php-ldap</p>
</li>
<li>
<p>php-snmp</p>
</li>
<li>
<p>php-pdo</p>
</li>
<li>
<p>php-mysql</p>
</li>
<li>
<p>php-pecl-xdebug</p>
</li>
<li>
<p><a href="https://stelfox.net/notes/apache/php.ini">/etc/php.ini</a></p>
</li>
</ul>
<p>The following is for production use, <code>display_errors</code>,
<code>display_startup_errors</code>, <code>mysql.trace_mode</code> may be useful in development.</p>
<ul>
<li><a href="https://stelfox.net/notes/apache/suhosin.ini">/etc/php.d/suhosin.ini</a></li>
</ul>
<p>This is the config file for the suhosin extension. If an application isn't
working check the logs generated by suhosin to see if it is the issue.</p>
<h2 id="basic-authentication">Basic Authentication</h2>
<p>Sometimes it's just needed to prevent access to something for a little while,
HTTP basic authentication can help! If you're using the hardened configuration
above you'll need to enable a few modules to actually use it and make sure that
a .htaccess file has permission to override <code>AuthConfig</code>. Add the following
lines if they aren't already there in the section where you load modules:</p>
<pre><code>LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authz_user_module modules/mod_authz_user.so
</code></pre>
<p>Additionally if you want to use group based authentication add:</p>
<pre><code>LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
</code></pre>
<p>First create a user to use for the login:</p>
<pre><code>htpasswd -c .htpasswd demouser
</code></pre>
<p>Additional users can be added by omitting the <code>-c</code>.</p>
<p>Create or append the following to a <code>.htaccess</code> file in the directory you want
to protect:</p>
<pre><code>AuthType Basic
AuthName "Some Name Describing the site"
AuthUserFile /path/to/.htpasswd
Require valid-user
</code></pre>
<p>That's it you'll have HTTP Basic authentication. If you want to use a group
file you'll need to change the setting in the <code>.htaccess</code> file to match:</p>
<pre><code>AuthType Basic
AuthName "Some Name Describing the site"
AuthUserFile /path/to/.htpasswd
AuthGroupFile /path/to/.htgroups
Require group demogroup
</code></pre>
<p>And create a group file <code>.htgroups</code> with the following:</p>
<pre><code>demogroup: demouser someotheruser
</code></pre>
<h2 id="kerberos-authentication">Kerberos Authentication</h2>
<ul>
<li><a href="http://www.grolmsnet.de/kerbtut/">Using mod_auth_kerb and Windows 2000/2003/2008R2 as KDC</a></li>
</ul>
<h2 id="passenger">Passenger</h2>
<p>Before going through this you need to ensure that the tools for compiling ruby
are installed on the system these are listed in <a href="https://stelfox.net/notes/ruby/">Ruby</a>.</p>
<p>Ensure that ruby is installed on the system as well as the development headers
needed to compile the passenger module, this is all done as root:</p>
<pre><code>yum install ruby curl-devel ruby-devel httpd-devel apr-devel apr-util-devel -y
</code></pre>
<pre><code>gem install passenger
passenger-install-apache2-module
</code></pre>
<p>I wasn't able to get this working at the current time as there is a bug in
passenger 3.0.12 that prevents it from being compiled with GCC 4.6.</p>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
