<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="sam@stelfox.net Sam Stelfox ">
<meta name="description" content="Installation/Configuration Install the required packages with the following command:
yum install openstack-utils openstack-keystone python-keystoneclient -y Generate a long, strong unique password for keystone&amp;rsquo;s MySQL user (MySQL should already be setup at this point and bound to 10.100.0.11 if you&amp;rsquo;re following along from the Openstack page. Open up a MySQL console as the root user and run the following commands:
Important Note: Openstack has a convenient command openstack-db that does the following for you, however, when it creates the user it uses keystone for a password and doesn&amp;rsquo;t restrict the hosts that can use that account (globally available)." />
<meta name="keywords" content="blog, programming, linux, systems, personal" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://stelfox.net/notes/openstack-keystone/" />


    <title>
        
            Openstack Keystone :: Sam Stelfox 
        
    </title>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link rel="stylesheet" href="/main.2a064c455b0ecbd6b1481b3bf9df2441e95838691022f40a5338c2cb1244f075.css" integrity="sha256-KgZMRVsOy9axSBs7&#43;d8kQelYOGkQIvQKUzjCyxJE8HU=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Openstack Keystone">
<meta itemprop="description" content="Installation/Configuration Install the required packages with the following command:
yum install openstack-utils openstack-keystone python-keystoneclient -y Generate a long, strong unique password for keystone&rsquo;s MySQL user (MySQL should already be setup at this point and bound to 10.100.0.11 if you&rsquo;re following along from the Openstack page. Open up a MySQL console as the root user and run the following commands:
Important Note: Openstack has a convenient command openstack-db that does the following for you, however, when it creates the user it uses keystone for a password and doesn&rsquo;t restrict the hosts that can use that account (globally available).">

<meta itemprop="wordCount" content="1813">
<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Openstack Keystone"/>
<meta name="twitter:description" content="Installation/Configuration Install the required packages with the following command:
yum install openstack-utils openstack-keystone python-keystoneclient -y Generate a long, strong unique password for keystone&rsquo;s MySQL user (MySQL should already be setup at this point and bound to 10.100.0.11 if you&rsquo;re following along from the Openstack page. Open up a MySQL console as the root user and run the following commands:
Important Note: Openstack has a convenient command openstack-db that does the following for you, however, when it creates the user it uses keystone for a password and doesn&rsquo;t restrict the hosts that can use that account (globally available)."/>



    <meta property="og:title" content="Openstack Keystone" />
<meta property="og:description" content="Installation/Configuration Install the required packages with the following command:
yum install openstack-utils openstack-keystone python-keystoneclient -y Generate a long, strong unique password for keystone&rsquo;s MySQL user (MySQL should already be setup at this point and bound to 10.100.0.11 if you&rsquo;re following along from the Openstack page. Open up a MySQL console as the root user and run the following commands:
Important Note: Openstack has a convenient command openstack-db that does the following for you, however, when it creates the user it uses keystone for a password and doesn&rsquo;t restrict the hosts that can use that account (globally available)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stelfox.net/notes/openstack-keystone/" /><meta property="article:section" content="notes" />

















    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                ./Sam_Stelfox.sh</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about/">About</a></li><li><a href="/blog/">Blog Posts</a></li><li><a href="/notes/">Various Notes</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://stelfox.net/notes/openstack-keystone/">Openstack Keystone</a></h2>

            
            
            

            <div class="post-content">
                <h2 id="installationconfiguration">Installation/Configuration</h2>
<p>Install the required packages with the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>yum install openstack-utils openstack-keystone python-keystoneclient -y
</span></span></code></pre></div><p>Generate a long, strong unique password for keystone&rsquo;s <a href="https://stelfox.net/notes/mysql/">MySQL</a> user (MySQL
should already be setup at this point and bound to <code>10.100.0.11</code> if you&rsquo;re
following along from the <a href="https://stelfox.net/notes/openstack/">Openstack</a> page. Open up a MySQL console as the
root user and run the following commands:</p>
<p>Important Note: Openstack has a convenient command <code>openstack-db</code> that does the
following for you, however, when it creates the user it uses <code>keystone</code> for a
password and doesn&rsquo;t restrict the hosts that can use that account (globally
available). It seems a bit excessive to me to have a script for those three
MySQL commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CREATE DATABASE keystone;
</span></span><span style="display:flex;"><span>GRANT ALL ON keystone.* TO &#39;keystone&#39;@&#39;10.100.0.%&#39; IDENTIFIED BY
</span></span><span style="display:flex;"><span>  &#39;LongStrongUniquePasswordYouGenerated&#39;;
</span></span><span style="display:flex;"><span>FLUSH PRIVILEGES;
</span></span></code></pre></div><p>Generate a token to be used as the &lsquo;admin&rsquo; global token. When used this will
give you full admin credentials on the keystone service regardless of whether
or not an admin exists.</p>
<p>This is needed for the initial administration of the keystone service once we
get it up and running. I save it directly to the root user&rsquo;s bashrc file as it
it&rsquo;ll be useful to have later on:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>echo export ADMIN_TOKEN=$(openssl rand -hex 32) &gt; /root/.bashrc
</span></span></code></pre></div><p>After logging off and back on make sure you have the token and copy this for
use in the configuration file later on:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>echo $ADMIN_TOKEN
</span></span><span style="display:flex;"><span>f35fb1205820907c2ddd1eb046f6ba2de1e5b729d6b7aedc5b0959156013f4a3
</span></span></code></pre></div><p>Open up the keystone configuration file at: <code>/etc/keystone/keystone.conf</code> and
replace it with the following (changing appropriate variables for your
installation such as <code>admin_token</code> and the MySQL password:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#ff7b72">[DEFAULT]</span>
</span></span><span style="display:flex;"><span>onready <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.common.systemd</span>
</span></span><span style="display:flex;"><span>admin_port <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">35357</span>
</span></span><span style="display:flex;"><span>admin_token <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">ADMIN</span>
</span></span><span style="display:flex;"><span>bind_host <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0.0.0.0</span>
</span></span><span style="display:flex;"><span>compute_port <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">8774</span>
</span></span><span style="display:flex;"><span>public_port <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Logging Options</span>
</span></span><span style="display:flex;"><span>debug <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">False</span>
</span></span><span style="display:flex;"><span>syslog_log_facility <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">LOG_USER</span>
</span></span><span style="display:flex;"><span>use_syslog <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">True</span>
</span></span><span style="display:flex;"><span>verbose <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[sql]</span>
</span></span><span style="display:flex;"><span>connection <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">mysql://keystone:keystone@127.0.0.1/keystone</span>
</span></span><span style="display:flex;"><span>idle_timeout <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[identity]</span>
</span></span><span style="display:flex;"><span>driver <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.identity.backends.sql.Identity</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[catalog]</span>
</span></span><span style="display:flex;"><span>driver <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.catalog.backends.sql.Catalog</span>
</span></span><span style="display:flex;"><span>template_file <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">/etc/keystone/default_catalog.templates</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[token]</span>
</span></span><span style="display:flex;"><span>driver <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.token.backends.sql.Token</span>
</span></span><span style="display:flex;"><span>expiration <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">7200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[policy]</span>
</span></span><span style="display:flex;"><span>driver <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.policy.backends.rules.Policy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[ec2]</span>
</span></span><span style="display:flex;"><span>driver <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.contrib.ec2.backends.sql.Ec2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[ssl]</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#enable = True</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#certfile = /etc/keystone/ssl/certs/keystone.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#keyfile = /etc/keystone/ssl/private/keystonekey.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#ca_certs = /etc/keystone/ssl/certs/ca.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#cert_required = True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[signing]</span>
</span></span><span style="display:flex;"><span>certfile <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">/etc/keystone/ssl/certs/signing_cert.pem</span>
</span></span><span style="display:flex;"><span>ca_certs <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">/etc/keystone/ssl/certs/ca.pem</span>
</span></span><span style="display:flex;"><span>ca_password <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">SuperSecretCAPass</span>
</span></span><span style="display:flex;"><span>keyfile <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">/etc/keystone/ssl/private/signing_key.pem</span>
</span></span><span style="display:flex;"><span>key_size <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">4096</span>
</span></span><span style="display:flex;"><span>valid_days <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">3650</span>
</span></span><span style="display:flex;"><span>token_format <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">PKI</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[ldap]</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># url = ldap://localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># user = dc=Manager,dc=example,dc=com</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># password = None</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># suffix = cn=example,cn=com</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># use_dumb_member = False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># user_tree_dn = ou=Users,dc=example,dc=com</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># user_objectclass = inetOrgPerson</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># user_id_attribute = cn</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># user_name_attribute = sn</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># tenant_tree_dn = ou=Groups,dc=example,dc=com</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># tenant_objectclass = groupOfNames</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># tenant_id_attribute = cn</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># tenant_member_attribute = member</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># tenant_name_attribute = ou</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># role_tree_dn = ou=Roles,dc=example,dc=com</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># role_objectclass = organizationalRole</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># role_id_attribute = cn</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># role_member_attribute = roleOccupant</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:debug]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.common.wsgi:Debug.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:token_auth]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.middleware:TokenAuthMiddleware.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:admin_token_auth]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.middleware:AdminTokenAuthMiddleware.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:xml_body]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.middleware:XmlBodyMiddleware.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:json_body]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.middleware:JsonBodyMiddleware.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:user_crud_extension]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.contrib.user_crud:CrudExtension.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:crud_extension]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.contrib.admin_crud:CrudExtension.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:ec2_extension]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.contrib.ec2:Ec2Extension.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:s3_extension]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.contrib.s3:S3Extension.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:url_normalize]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.middleware:NormalizingFilter.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:stats_monitoring]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.contrib.stats:StatsMiddleware.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[filter:stats_reporting]</span>
</span></span><span style="display:flex;"><span>paste.filter_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.contrib.stats:StatsExtension.factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[app:public_service]</span>
</span></span><span style="display:flex;"><span>paste.app_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.service:public_app_factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[app:admin_service]</span>
</span></span><span style="display:flex;"><span>paste.app_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.service:admin_app_factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[pipeline:public_api]</span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">stats_monitoring url_normalize token_auth admin_token_auth xml_body json_body debug ec2_extension user_crud_extension public_service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[pipeline:admin_api]</span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">stats_monitoring url_normalize token_auth admin_token_auth xml_body json_body debug stats_reporting ec2_extension s3_extension crud_extension admin_service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[app:public_version_service]</span>
</span></span><span style="display:flex;"><span>paste.app_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.service:public_version_app_factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[app:admin_version_service]</span>
</span></span><span style="display:flex;"><span>paste.app_factory <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">keystone.service:admin_version_app_factory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[pipeline:public_version_api]</span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">stats_monitoring url_normalize xml_body public_version_service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[pipeline:admin_version_api]</span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">stats_monitoring url_normalize xml_body admin_version_service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[composite:main]</span>
</span></span><span style="display:flex;"><span>use <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">egg:Paste#urlmap</span>
</span></span><span style="display:flex;"><span>/v2.0 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">public_api</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">public_version_api</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">[composite:admin]</span>
</span></span><span style="display:flex;"><span>use <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">egg:Paste#urlmap</span>
</span></span><span style="display:flex;"><span>/v2.0 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">admin_api</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">admin_version_api</span>
</span></span></code></pre></div><p>Please note that I haven&rsquo;t yet delved into the Compositions, Filters, Apps or
Pipelines and don&rsquo;t have a handle on what exactly they&rsquo;re doing. As far as
configuration documentation goes there is much to be desired in Keystone&hellip;</p>
<p>We need to create a full <a href="https://stelfox.net/notes/building-a-certificate-authority/">certificate authority</a> in
<code>/etc/keystone/ssl/certs</code>. Ideally the CA itself would be signed by a higher CA
of our control. A keystone SSL cert and key will also need to be created (and
signed by the CA).</p>
<p>The cert and key file should be placed at
<code>/etc/keystone/ssl/certs/signing_cert.pem</code> and
<code>/etc/keystone/ssl/private/signing_key.pem</code> respectively. You&rsquo;ll also want to
ensure the <code>[signing]</code> portion of the <code>keystone.conf</code> file reflects the actual
size of the key.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone-manage db_sync
</span></span></code></pre></div><p>Now that we&rsquo;re configured let&rsquo;s get the service going&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>systemctl enable openstack-keystone.service
</span></span><span style="display:flex;"><span>systemctl start openstack-keystone.service
</span></span></code></pre></div><p>You should now have a running (though empty) keystone service. Let&rsquo;s test and
make sure it&rsquo;s responding nicely:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone --token $ADMIN_TOKEN --endpoint http://10.100.0.13:35357/v2.0/ tenant-list
</span></span></code></pre></div><h2 id="initial-setup">Initial Setup</h2>
<p>Now that we have the service up and running we need to add users, roles,
tenants, services and endpoints. A quick note on a couple of things here.
&lsquo;Tenant&rsquo; is used as a means of logically grouping a bunch of users. A user can
exist in multiple tenants and will only be aware of the resources within
tenants that it has been granted access too unless that user is an admin of the
special admin tenant which will automatically grant them full access to all
tenants and their contents regardless of whether that user is in that tenant
and as such care should be taken when granting that level of permissions.</p>
<p>First since we&rsquo;ll be running a lot of commands and it can quickly become
burdensome to repeatedly provide the endpoint and the token we&rsquo;re going to set
two environment variables to make the access easier, then test to make sure we
can still access the service:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>export SERVICE_ENDPOINT=http://10.100.0.13:35357/v2.0/
</span></span><span style="display:flex;"><span>export SERVICE_TOKEN=$ADMIN_TOKEN
</span></span><span style="display:flex;"><span>keystone tenant-list
</span></span></code></pre></div><p>There is another slightly annoying thing that can be easily worked around in
Openstack; Whenever you refer to a user, role, tenant, service, endpoint or
other object you need to do so by it&rsquo;s ID and not it&rsquo;s friendly name. As such
I&rsquo;ve adapted a few helper methods to easily grab an object ID based on it&rsquo;s
friendly name. Add these too root&rsquo;s bash file and re-source it by either
logging out and back in or by running &ldquo;. ~/.bashrc&rdquo;.</p>
<p>We now need to create an admin user, role, tenant, and combine them all:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone user-create --name admin --pass secret --email admin@email.net
</span></span><span style="display:flex;"><span>+----------+-------------------------------------------------------------------------------------------------------------------------+
</span></span><span style="display:flex;"><span>| Property |                                                          Value                                                          |
</span></span><span style="display:flex;"><span>+----------+-------------------------------------------------------------------------------------------------------------------------+
</span></span><span style="display:flex;"><span>|  email   |                                                     sam@stelfox.net                                                     |
</span></span><span style="display:flex;"><span>| enabled  |                                                           True                                                          |
</span></span><span style="display:flex;"><span>|    id    |                                             2e981959c1d54789a3ae6a88611cc0db                                            |
</span></span><span style="display:flex;"><span>|   name   |                                                          admin                                                          |
</span></span><span style="display:flex;"><span>| password | $6$rounds=40000$ZXGfdZeIcwVWGWvA$VLgWIRk7tM5OdEjeYZEnpANbjVO0SydvXZgK7UAlh0VED4S1dbCMWYxFNWgz4p.7Ni6Nmzw3FUtLx6MLYVEm21 |
</span></span><span style="display:flex;"><span>| tenantId |                                                                                                                         |
</span></span><span style="display:flex;"><span>+----------+-------------------------------------------------------------------------------------------------------------------------+
</span></span><span style="display:flex;"><span>keystone role-create --name admin
</span></span><span style="display:flex;"><span>+----------+----------------------------------+
</span></span><span style="display:flex;"><span>| Property |              Value               |
</span></span><span style="display:flex;"><span>+----------+----------------------------------+
</span></span><span style="display:flex;"><span>|    id    | df6b8c5b5a0847259e1c78a34aae09d1 |
</span></span><span style="display:flex;"><span>|   name   |              admin               |
</span></span><span style="display:flex;"><span>+----------+----------------------------------+
</span></span><span style="display:flex;"><span>keystone tenant-create --name admin
</span></span><span style="display:flex;"><span>+-------------+----------------------------------+
</span></span><span style="display:flex;"><span>|   Property  |              Value               |
</span></span><span style="display:flex;"><span>+-------------+----------------------------------+
</span></span><span style="display:flex;"><span>| description |                                  |
</span></span><span style="display:flex;"><span>|   enabled   |               True               |
</span></span><span style="display:flex;"><span>|      id     | adb579d87cc7438da8ddb6147ca69717 |
</span></span><span style="display:flex;"><span>|     name    |              admin               |
</span></span><span style="display:flex;"><span>+-------------+----------------------------------+
</span></span><span style="display:flex;"><span>keystone user-role-add --user-id 2e981959c1d54789a3ae6a88611cc0db --role-id df6b8c5b5a0847259e1c78a34aae09d1 --tenant-id adb579d87cc7438da8ddb6147ca69717
</span></span></code></pre></div><h2 id="potentially-old-information">Potentially Old Information</h2>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>get_tenant_id() {
</span></span><span style="display:flex;"><span>  echo `keystone tenant-list | grep $@ | awk &#39;{ print $2 }&#39;`
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get_user_id() {
</span></span><span style="display:flex;"><span>  echo `keystone user-list | grep $@ | awk &#39;{ print $2 }&#39;`
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get_role_id() {
</span></span><span style="display:flex;"><span>  echo `keystone role-list | grep $@ | awk &#39;{ print $2 }&#39;`
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get_service_id() {
</span></span><span style="display:flex;"><span>  echo `keystone service-list | grep $@ | awk &#39;{ print $2 }&#39;`
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="tenant-creation">Tenant Creation</h3>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone tenant-create --name=admin
</span></span><span style="display:flex;"><span>keystone tenant-create --name=service
</span></span></code></pre></div><h3 id="role-creation">Role Creation</h3>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone role-create --name admin
</span></span><span style="display:flex;"><span>keystone role-create --name KeystoneAdmin
</span></span><span style="display:flex;"><span>keystone role-create --name KeystoneServiceAdmin
</span></span><span style="display:flex;"><span>keystone role-create --name Member
</span></span></code></pre></div><h3 id="user-creation">User Creation</h3>
<p>Generate a five long strong unique passwords for the admin user and each of the
four service accounts here. For this example I&rsquo;m going to use password{1-5}. If
you use the same ones&hellip; you probably shouldn&rsquo;t be playing at this level&hellip; You
will need these later when setting up each of the services so note them down
somewhere secure.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone user-create --name=admin --pass=password1 --email=admin@your-admin.cn
</span></span><span style="display:flex;"><span>keystone user-create --name=nova --pass=password2 --tenant_id $(get_tenant_id service)
</span></span><span style="display:flex;"><span>keystone user-create --name=glance --pass=password3 --tenant_id $(get_tenant_id service)
</span></span><span style="display:flex;"><span>keystone user-create --name=quantum --pass=password4 --tenant_id $(get_tenant_id service)
</span></span><span style="display:flex;"><span>keystone user-create --name=cinder --pass=password5 --tenant_id $(get_tenant_id service)
</span></span></code></pre></div><h3 id="granting-roles">Granting Roles</h3>
<p>Grant the admin user the <code>admin</code>, <code>KeystoneAdmin</code>, and <code>KeystoneServiceAdmin</code>
roles within the admin tenant and the service accounts the admin role within
the service tenant.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone user-role-add --user $(get_user_id admin) --role $(get_role_id admin) --tenant_id $(get_tenant_id admin)
</span></span><span style="display:flex;"><span>keystone user-role-add --user $(get_user_id admin) --role $(get_role_id KeystoneAdmin) --tenant_id $(get_tenant_id admin)
</span></span><span style="display:flex;"><span>keystone user-role-add --user $(get_user_id admin) --role $(get_role_id KeystoneServiceAdmin) --tenant_id $(get_tenant_id admin)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id nova) --role $(get_role_id admin)
</span></span><span style="display:flex;"><span>keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id glance) --role $(get_role_id admin)
</span></span><span style="display:flex;"><span>keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id quantum) --role $(get_role_id admin)
</span></span><span style="display:flex;"><span>keystone user-role-add --tenant_id $(get_tenant_id service) --user $(get_user_id cinder) --role $(get_role_id admin)
</span></span></code></pre></div><h3 id="service-creation">Service Creation</h3>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone service-create --name nova --type compute --description &#39;OpenStack Compute Service&#39;
</span></span><span style="display:flex;"><span>keystone service-create --name cinder --type volume --description &#39;OpenStack Volume Service&#39;
</span></span><span style="display:flex;"><span>keystone service-create --name glance --type image --description &#39;OpenStack Image Service&#39;
</span></span><span style="display:flex;"><span>keystone service-create --name keystone --type identity --description &#39;OpenStack Identity&#39;
</span></span><span style="display:flex;"><span>keystone service-create --name ec2 --type ec2 --description &#39;OpenStack EC2 service&#39;
</span></span><span style="display:flex;"><span>keystone service-create --name quantum --type network --description &#39;OpenStack Networking service&#39;
</span></span></code></pre></div><h3 id="endpoint-creation">Endpoint Creation</h3>
<p>End points are the next thing to be defined, they require that a region be
specified. This is an arbitrary string that can be used to delinieate between
service regions that could be data centers, portions of a data-center or what
have you.</p>
<p>Since I&rsquo;m not working on an installation large enough to really need multiple
regions this name is more or less useless for me so I chose to just use Primary
as the region name.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone endpoint-create --region Primary --service_id $(get_service_id compute) \
</span></span><span style="display:flex;"><span>  --publicurl &#39;http://10.100.0.15:8774/v2/$(tenant_id)s&#39; \
</span></span><span style="display:flex;"><span>  --adminurl &#39;http://10.100.0.15:8774/v2/$(tenant_id)s&#39; \
</span></span><span style="display:flex;"><span>  --internalurl &#39;http://10.100.0.15:8774/v2/$(tenant_id)s&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keystone endpoint-create --region Primary --service_id $(get_service_id volume) \
</span></span><span style="display:flex;"><span>  --publicurl &#39;http://10.100.0.16:8776/v1/$(tenant_id)s&#39; \
</span></span><span style="display:flex;"><span>  --adminurl &#39;http://10.100.0.16:8776/v1/$(tenant_id)s&#39; \
</span></span><span style="display:flex;"><span>  --internalurl &#39;http://10.100.0.16:8776/v1/$(tenant_id)s&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keystone endpoint-create --region Primary --service_id $(get_service_id image) \
</span></span><span style="display:flex;"><span>  --publicurl &#39;http://10.100.0.17:9292/v2&#39; \
</span></span><span style="display:flex;"><span>  --adminurl &#39;http://10.100.0.17:9292/v2&#39; \
</span></span><span style="display:flex;"><span>  --internalurl &#39;http://10.100.0.17:9292/v2&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keystone endpoint-create --region Primary --service_id $(get_service_id identity) \
</span></span><span style="display:flex;"><span>  --publicurl &#39;http://10.100.0.13:5000/v2.0&#39; \
</span></span><span style="display:flex;"><span>  --adminurl &#39;http://10.100.0.13:35357/v2.0&#39; \
</span></span><span style="display:flex;"><span>  --internalurl &#39;http://10.100.0.13:5000/v2.0&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keystone endpoint-create --region Primary --service_id $(get_service_id ec2) \
</span></span><span style="display:flex;"><span>  --publicurl &#39;http://10.100.0.18:8773/services/Cloud&#39; \
</span></span><span style="display:flex;"><span>  --adminurl &#39;http://10.100.0.18:8773/services/Admin&#39; \
</span></span><span style="display:flex;"><span>  --internalurl &#39;http://10.100.0.18:8773/services/Cloud&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keystone endpoint-create --region Primary --service_id $(get_service_id network) \
</span></span><span style="display:flex;"><span>  --publicurl &#39;http://10.100.0.19:9696/&#39; \
</span></span><span style="display:flex;"><span>  --adminurl &#39;http://10.100.0.19:9696/&#39; \
</span></span><span style="display:flex;"><span>  --internalurl &#39;http://10.100.0.19:9696/&#39;
</span></span></code></pre></div><h3 id="keystone-management">Keystone Management</h3>
<p>With keystone setup, the admin user in place, and endpoints defined you no
longer need to use the admin token to authenticate and manage the service. As a
regular user export the following information into your bash shell, unset the
admin token and try to access the keystone user-list again:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>export OS_TENANT_NAME=admin
</span></span><span style="display:flex;"><span>export OS_USERNAME=admin
</span></span><span style="display:flex;"><span>export OS_PASSWORD=password1
</span></span><span style="display:flex;"><span>export OS_AUTH_URL=http://10.100.0.13:5000/v2.0/
</span></span><span style="display:flex;"><span>unset ADMIN_TOKEN
</span></span><span style="display:flex;"><span>keystone tenant-list
</span></span><span style="display:flex;"><span>+----------------------------------+---------+---------+
</span></span><span style="display:flex;"><span>|                id                |   name  | enabled |
</span></span><span style="display:flex;"><span>+----------------------------------+---------+---------+
</span></span><span style="display:flex;"><span>| bb9509fd9dea40f5b58d720aaaa15044 | service | True    |
</span></span><span style="display:flex;"><span>| cbabea52a4be417998b266e43280ef35 | admin   | True    |
</span></span><span style="display:flex;"><span>+----------------------------------+---------+---------+
</span></span></code></pre></div><p>You can also specify those options via the command line if you don&rsquo;t want to
set the  environment variables like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>keystone --os_username admin --os_password password1 --os_tenant_name admin \
</span></span><span style="display:flex;"><span>  --os_auth_url http://10.100.0.13:5000/v2.0/ tenant-list
</span></span><span style="display:flex;"><span>+----------------------------------+---------+---------+
</span></span><span style="display:flex;"><span>|                id                |   name  | enabled |
</span></span><span style="display:flex;"><span>+----------------------------------+---------+---------+
</span></span><span style="display:flex;"><span>| bb9509fd9dea40f5b58d720aaaa15044 | service | True    |
</span></span><span style="display:flex;"><span>| cbabea52a4be417998b266e43280ef35 | admin   | True    |
</span></span><span style="display:flex;"><span>+----------------------------------+---------+---------+
</span></span></code></pre></div><h2 id="future-steps">Future Steps</h2>
<p>There are some features that I&rsquo;d really like to take a look at getting as I
feel they will improve the quality, security or reliability of the service in
general. These features that I haven&rsquo;t documented here yet are as follows:</p>
<ul>
<li>LDAP Authentication Backend
<ul>
<li>With Memcached queries</li>
</ul>
</li>
<li>SSL</li>
<li>Detailed policy.json evaluation
<ul>
<li>Breaking out permissions into more explicit roles</li>
<li>What can I actually accomplish with this file?</li>
</ul>
</li>
</ul>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.c90b8161416b87c69a8e02683b54ddd6edb90aea699648bf655e6cbc45b419b8e465d196e715772463dba35a6faf5decb2eb247480d38680484d54645b434570.js" integrity="sha512-yQuBYUFrh8aajgJoO1Td1u25Cupplki/ZV5svEW0GbjkZdGW5xV3JGPbo1pvr13ssuskdIDThoBITVRkW0NFcA=="></script>



    </body>
</html>
