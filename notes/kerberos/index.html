<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1>Kerberos</h1><div class="post-content"><p>Kerberos is a secure network authentication system.</p>
<span id="continue-reading"></span>
<p>It is very important that system times are all very close for successful
authentication. You should configure <a href="https://stelfox.net/notes/ntpd/">NTPd</a> or <a href="https://stelfox.net/notes/chronyd/">Chronyd</a> to ensure the
systems stay in sync.</p>
<h2 id="root-kdc-configuration">Root KDC Configuration</h2>
<p>Edit the configuration files (provided at the bottom).</p>
<p>Create the initial database for the realm, it will ask for a master password
for the database. DO NOT FORGET THIS!!</p>
<pre><code>kdb5_util create -s
</code></pre>
<p>Create an administrator user, it will ask for the password ensure that it is
strong as this account will be able to create, delete, and see principal's
keys.</p>
<pre><code>kadmin.local -q "addprinc <<username>>/admin"
</code></pre>
<p>Set the services to startup automatically and start them up:</p>
<pre><code>chkconfig krb5kdc on
chkconfig kadmin on
/etc/init.d/krb5kdc start
/etc/init.d/kadmin start
</code></pre>
<p>After the database has been started you'll need to create at least one normal
user, it will ask for a password for the account.</p>
<pre><code>[root@localhost ~]# kadmin -p <<username>>/admin
kadmin:  addprinc <<username>>
</code></pre>
<h2 id="peer-kdc-configuration">Peer KDC Configuration</h2>
<p>Please note these instructions are untested but they are believed to be
correct.</p>
<p>First we'll need to create an ACL file for the replication utility <code>kprop</code>. It
should live <code>/var/Kerberos/krb5kdc/kpropd.acl</code> and have the contents:</p>
<pre><code>host/kdc1.home.bedroomprogrammers.net@BEDROOMPROGRAMMERS.NET
host/kdc2.home.bedroomprogrammers.net@BEDROOMPROGRAMMERS.NET
</code></pre>
<p>You'll need to create host keys for each of the kerberos servers if they
haven't been created already.</p>
<pre><code>[root@localhost ~]# kadmin -p <<username>>/admin
kadmin:  addprinc -rand host/kdc1.home.bedroomprogrammers.net
kadmin:  addprinc -rand host/kdc2.home.bedroomprogrammers.net
</code></pre>
<p>You'll need to add the keys to the local keytab file on the primary KDC.</p>
<pre><code>[root@localhost ~]# kadmin -p <<username>>/admin
kadmin:  ktadd host/kdc1.home.bedroomprogrammers.net
kadmin:  ktadd host/kdc2.home.bedroomprogrammers.net
</code></pre>
<p>Copy the keytab file from the primary KDC to the secondary server using an
encrypted transfer mechanism such as SCP.</p>
<pre><code>[root@localhost ~]# scp /etc/krb5.keytab root@krb2.home.bedroomprogrammers.net:/etc/krb5.keytab
</code></pre>
<p>At this point you'll want to restart the master's service and then start up the
kdc on the slave server:</p>
<pre><code>[root@slave ~]# chkconfig krb5kdc start
[root@slave ~]# /etc/init.d/krb5kdc start
</code></pre>
<p>Once the Slave is setup you'll need to modify the <code>/etc/krb5.conf</code> on the
client machines and the master machine to include the FQDN of the slave in the
<code>[realms]</code> section for the appropriate domain. The <code>[realms]</code> section would
then look like:</p>
<pre data-lang="ini" class="language-ini "><code class="language-ini" data-lang="ini">[realms]
  BEDROOMPROGRAMMERS.NET = {
    kdc = kdc1.home.bedroomprogrammers.net
    kdc = kdc2.home.bedroomprogrammers.net
    admin_server = kdc1.home.bedroomprogrammers.net
  }
</code></pre>
<h2 id="adding-a-new-host-to-the-domain">Adding a New Host to the Domain</h2>
<p>Hosts need <code>krb5-workstation</code> and <code>krb5-libs</code> installed. Make sure the client
firewall rules have been applied.</p>
<p>Be sure to copy the config file <code>/etc/krb5.conf</code> mentioned on this page to each
client machine.</p>
<pre><code>[root@kerb-client ~]# kadmin -p <<username>>/admin
kadmin:  addprinc -randkey host/<<FQDN>>
kadmin:  ktadd -k /etc/krb5.keytab host/<<FQDN>>
</code></pre>
<p>You'll need to replace <code>&lt;&lt;FQDN&gt;&gt;</code> with the domain name of the host you're
adding. It will need a DNS entry matching this hostname.</p>
<h2 id="firewall-configuration">Firewall Configuration</h2>
<p>Server Adjustments:</p>
<pre><code># Allow authentication to the KDC
-A INPUT -m tcp -p tcp --dport 88 -j ACCEPT
# Allow remote kerberos administration. This should probably be restricted more
-A INPUT -m tcp -p tcp --dport 749 -j ACCEPT
</code></pre>
<p>Client Adjustments:</p>
<pre><code># Allow authentication to the KDC
-A OUTPUT -m tcp -p tcp --dport 88 -j ACCEPT
</code></pre>
<p>Setting up a client machine to talk to the KDC will initially require this rule
as well:</p>
<pre><code># Temporarily need this to setup the connection with the KDC
-A OUTPUT -m tcp -p tcp --dport 749 -j ACCEPT
</code></pre>
<h2 id="sample-configuration-files">Sample Configuration Files</h2>
<ul>
<li><a href="https://stelfox.net/notes/kerberos/krb5.conf">/etc/krb5.conf</a></li>
<li><a href="https://stelfox.net/notes/kerberos/kadm5.acl">/var/kerberos/krb5kdc/kadm5.acl</a></li>
<li><a href="https://stelfox.net/notes/kerberos/kdc.conf">/var/kerberos/krb5kdc/kdc.conf</a></li>
</ul>
<h2 id="notes-on-cached-client-login">Notes on Cached Client Login</h2>
<ul>
<li><a href="https://redhatcat.blogspot.com/2008/07/caching-kerberos-credentials-for.html">Caching Kerberos credentials for offline logins</a></li>
<li><a href="https://ubuntuforums.org/showthread.php?t=1205604">Offline auth. with Kerberos and timeouts (pam_krb5.so, pam_ccreds.so)</a></li>
<li><a href="https://www.techrepublic.com/blog/linux-and-open-source/authentication-caching-with-nscd/">Authentication caching with nscd</a></li>
<li><a href="http://people.skolelinux.org/pere/blog/Caching_password__user_and_group_on_a_roaming_Debian_laptop.html">LDAP/Kerberos + nscd + libpam-ccreds + libpam-mklocaluser/pam_mkhomedir</a></li>
</ul>
</div>
</article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
