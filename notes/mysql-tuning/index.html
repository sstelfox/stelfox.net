<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
#!/bin/sh  # MySQL performance tuning primer script # # Writen by: Matthew Montgomery # Modified by: Sam Stelfox # Report bugs to: https://bugs.launchpad.net/mysql-tuning-primer # Inspired by: MySQLARd (http://gert.sos.be/demo/mysqlar/) # Version: 1.6-r1 # Released: 2011-08-06 # Updated: 2013-05-23 # # Licenced under GPLv2.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='MySQL Tuning • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
#!/bin/sh  # MySQL performance tuning primer script # # Writen by: Matthew Montgomery # Modified by: Sam Stelfox # Report bugs to: https://bugs.launchpad.net/mysql-tuning-primer # Inspired by: MySQLARd (http://gert.sos.be/demo/mysqlar/) # Version: 1.6-r1 # Released: 2011-08-06 # Updated: 2013-05-23 # # Licenced under GPLv2.'>
<meta property='og:url' content='https://stelfox.net/notes/mysql-tuning/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='notes'><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.51-DEV" />

  <title>MySQL Tuning • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/notes/mysql-tuning/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4267b3fa.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>


<body class='page type-notes'>

  <div class='site'>

    <a class='screen-reader-text' href='#content'>Skip to Content</a>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>MySQL Tuning</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='0001-01-01T00:00:00Z'>0001, Jan 01</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
28 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p><strong><em>Note: This page is quite old and is likely out of date. My opinions may have
also changed dramatically since this was written. It is here as a reference
until I get around to updating it.</em></strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># MySQL performance tuning primer script</span>
#
<span style="color:#75715e"># Writen by:      Matthew Montgomery</span>
<span style="color:#75715e"># Modified by:    Sam Stelfox</span>
<span style="color:#75715e"># Report bugs to: https://bugs.launchpad.net/mysql-tuning-primer</span>
<span style="color:#75715e"># Inspired by:    MySQLARd (http://gert.sos.be/demo/mysqlar/)</span>
<span style="color:#75715e"># Version:        1.6-r1</span>
<span style="color:#75715e"># Released:       2011-08-06</span>
<span style="color:#75715e"># Updated:        2013-05-23</span>
#
<span style="color:#75715e"># Licenced under GPLv2.</span>
#
<span style="color:#75715e"># Usage: ./tuning-primer.sh [mode]</span>
#
<span style="color:#75715e"># Available Modes:</span>
<span style="color:#75715e">#   all:         perform all checks (default)</span>
<span style="color:#75715e">#   prompt:      prompt for login credintials and socket and execution mode.</span>
<span style="color:#75715e">#   mem, memory: run checks for tunable options which effect memory usage.</span>
<span style="color:#75715e">#   disk, file:  run checks for options which effect i/o performance or file</span>
<span style="color:#75715e">#                handle limits</span>
<span style="color:#75715e">#   innodb:      run InnoDB checks, to be improved</span>
<span style="color:#75715e">#   misc:        run checks for that don&#39;t categorise well slow queries, binary</span>
<span style="color:#75715e">#                logs, used connections and worker threads.</span>

<span style="color:#75715e"># Set this socket variable ONLY if you have multiple instances running or we</span>
<span style="color:#75715e"># are unable to find your socket, and you don&#39;t want to to be prompted for</span>
<span style="color:#75715e"># input each time you run this script.</span>
socket<span style="color:#f92672">=</span>

<span style="color:#75715e"># Nice and easy names for the various colors</span>
export black<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0m&#39;</span>
export boldblack<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;0m&#39;</span>
export red<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[31m&#39;</span>
export boldred<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;31m&#39;</span>
export green<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[32m&#39;</span>
export boldgreen<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;32m&#39;</span>
export yellow<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[33m&#39;</span>
export boldyellow<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;33m&#39;</span>
export blue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[34m&#39;</span>
export boldblue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;34m&#39;</span>
export magenta<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[35m&#39;</span>
export boldmagenta<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;35m&#39;</span>
export cyan<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[36m&#39;</span>
export boldcyan<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;36m&#39;</span>
export white<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[37m&#39;</span>
export boldwhite<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[1;37m&#39;</span>

<span style="color:#75715e"># Function to easliy print colored text</span>
<span style="color:#75715e">#   Argument $1 = message</span>
<span style="color:#75715e">#   Argument $2 = color</span>
cecho<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local default_msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;No message passed.&#34;</span>
  message<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>1<span style="color:#66d9ef">:-</span>$default_msg<span style="color:#e6db74">}</span>

  <span style="color:#75715e"># Change it for fun, we use pure names. Defaults to black, if not specified.</span>
  color<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>2<span style="color:#66d9ef">:-</span>black<span style="color:#e6db74">}</span>

  <span style="color:#66d9ef">case</span> $color in
    black<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$black<span style="color:#e6db74">&#34;</span>;;
    boldblack<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldblack<span style="color:#e6db74">&#34;</span>;;
    red<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$red<span style="color:#e6db74">&#34;</span>;;
    boldred<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldred<span style="color:#e6db74">&#34;</span>;;
    green<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$green<span style="color:#e6db74">&#34;</span>;;
    boldgreen<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldgreen<span style="color:#e6db74">&#34;</span>;;
    yellow<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$yellow<span style="color:#e6db74">&#34;</span>;;
    boldyellow<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldyellow<span style="color:#e6db74">&#34;</span>;;
    blue<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$blue<span style="color:#e6db74">&#34;</span>;;
    boldblue<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldblue<span style="color:#e6db74">&#34;</span>;;
    magenta<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$magenta<span style="color:#e6db74">&#34;</span>;;
    boldmagenta<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldmagenta<span style="color:#e6db74">&#34;</span>;;
    cyan<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$cyan<span style="color:#e6db74">&#34;</span>;;
    boldcyan<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldcyan<span style="color:#e6db74">&#34;</span>;;
    white<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$white<span style="color:#e6db74">&#34;</span>;;
    boldwhite<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldwhite<span style="color:#e6db74">&#34;</span>;;
  <span style="color:#66d9ef">esac</span>

  printf <span style="color:#e6db74">&#34;%s&#34;</span> <span style="color:#e6db74">&#34;</span>$message<span style="color:#e6db74">&#34;</span>
  tput sgr0 <span style="color:#75715e"># Reset all the colors back to normal.</span>
  printf <span style="color:#e6db74">&#34;</span>$black<span style="color:#e6db74">&#34;</span>

  <span style="color:#66d9ef">return</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Function to easliy print colored text without a newline</span>
<span style="color:#75715e">#   Argument $1 = message</span>
<span style="color:#75715e">#   Argument $2 = color</span>
cechon<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local default_msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;No message passed.&#34;</span>
  message<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>1<span style="color:#66d9ef">:-</span>$default_msg<span style="color:#e6db74">}</span>

  color<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>2<span style="color:#66d9ef">:-</span>black<span style="color:#e6db74">}</span>

  <span style="color:#66d9ef">case</span> $color in
    black<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$black<span style="color:#e6db74">&#34;</span>;;
    boldblack<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldblack<span style="color:#e6db74">&#34;</span>;;
    red<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$red<span style="color:#e6db74">&#34;</span>;;
    boldred<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldred<span style="color:#e6db74">&#34;</span>;;
    green<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$green<span style="color:#e6db74">&#34;</span>;;
    boldgreen<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldgreen<span style="color:#e6db74">&#34;</span>;;
    yellow<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$yellow<span style="color:#e6db74">&#34;</span>;;
    boldyellow<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldyellow<span style="color:#e6db74">&#34;</span>;;
    blue<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$blue<span style="color:#e6db74">&#34;</span>;;
    boldblue<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldblue<span style="color:#e6db74">&#34;</span>;;
    magenta<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$magenta<span style="color:#e6db74">&#34;</span>;;
    boldmagenta<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldmagenta<span style="color:#e6db74">&#34;</span>;;
    cyan<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$cyan<span style="color:#e6db74">&#34;</span>;;
    boldcyan<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldcyan<span style="color:#e6db74">&#34;</span>;;
    white<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$white<span style="color:#e6db74">&#34;</span>;;
    boldwhite<span style="color:#f92672">)</span>
      printf <span style="color:#e6db74">&#34;</span>$boldwhite<span style="color:#e6db74">&#34;</span>;;
  <span style="color:#66d9ef">esac</span>

  printf <span style="color:#e6db74">&#34;%s&#34;</span> <span style="color:#e6db74">&#34;</span>$message<span style="color:#e6db74">&#34;</span>
  tput sgr0 <span style="color:#75715e"># Reset all the colors back to normal.</span>
  printf <span style="color:#e6db74">&#34;</span>$black<span style="color:#e6db74">&#34;</span>

  <span style="color:#66d9ef">return</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Banner</span>
print_banner<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34; -- MYSQL PERFORMANCE TUNING PRIMER --&#34;</span> boldblue
  cecho <span style="color:#e6db74">&#34;      - By: Matthew Montgomery -&#34;</span> black
  cecho <span style="color:#e6db74">&#34;   - Modifications By: Sam Stelfox -&#34;</span> black
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Find the location of the mysql.sock file</span>
check_for_socket<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">&#34;</span>$socket<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e"># Use ~/my.cnf version</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f ~/.my.cnf <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cnf_socket<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep ^socket ~/.my.cnf | awk -F <span style="color:#ae81ff">\=</span> <span style="color:#e6db74">&#39;{ print $2 }&#39;</span> | head -1<span style="color:#66d9ef">)</span>
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -S <span style="color:#e6db74">&#34;</span>$cnf_socket<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      socket<span style="color:#f92672">=</span>$cnf_socket
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> -S /var/lib/mysql/mysql.sock <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      socket<span style="color:#f92672">=</span>/var/lib/mysql/mysql.sock
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> -S /var/run/mysqld/mysqld.sock <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      socket<span style="color:#f92672">=</span>/var/run/mysqld/mysqld.sock
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> -S /tmp/mysql.sock <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      socket<span style="color:#f92672">=</span>/tmp/mysql.sock
    <span style="color:#66d9ef">else</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -S <span style="color:#e6db74">&#34;</span>$ps_socket<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
        socket<span style="color:#f92672">=</span>$ps_socket
      <span style="color:#66d9ef">fi</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -S <span style="color:#e6db74">&#34;</span>$socket<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    echo UP &gt; /dev/null
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#39;No valid socket file &#34;$socket&#34; found!&#39;</span> boldred
    cecho <span style="color:#e6db74">&#39;The mysqld process is not running or it is installed in a custom location.&#39;</span> red
    cecho <span style="color:#e6db74">&#39;If you are sure mysqld is running, execute script in &#34;prompt&#34; mode or set&#39;</span> red
    cecho <span style="color:#e6db74">&#39;the socket= variable at the top of this script&#39;</span> red
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Check for the existance of plesk and login using it&#39;s credentials</span>
check_for_plesk_passwords<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f /etc/psa/.psa.shadow <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql -S </span>$socket<span style="color:#e6db74"> -u admin -p</span><span style="color:#66d9ef">$(</span>cat /etc/psa/.psa.shadow<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    mysqladmin<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysqladmin -S </span>$socket<span style="color:#e6db74"> -u admin -p</span><span style="color:#66d9ef">$(</span>cat /etc/psa/.psa.shadow<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">else</span>
    mysql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql&#34;</span>
    mysqladmin<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysqladmin&#34;</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Test for running mysql</span>
check_mysql_login<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  is_up<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysqladmin ping <span style="color:#ae81ff">2</span>&gt;&amp;<span style="color:#ae81ff">1</span><span style="color:#66d9ef">)</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$is_up<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mysqld is alive&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    echo UP &gt; /dev/null
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$is_up<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mysqld is alive&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    printf <span style="color:#e6db74">&#34;\n&#34;</span>
    cecho <span style="color:#e6db74">&#34;Using login values from ~/.my.cnf&#34;</span>
    cecho <span style="color:#e6db74">&#34;- INITIAL LOGIN ATTEMPT FAILED -&#34;</span> boldred

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $prompted <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      find_webmin_passwords
    <span style="color:#66d9ef">else</span>
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Unknow exit status&#34;</span> red
    exit -1
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

final_login_attempt<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  is_up<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysqladmin ping <span style="color:#ae81ff">2</span>&gt;&amp;<span style="color:#ae81ff">1</span><span style="color:#66d9ef">)</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$is_up<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mysqld is alive&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    echo UP &gt; /dev/null
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$is_up<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mysqld is alive&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;- FINAL LOGIN ATTEMPT FAILED -&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;Unable to log into socket: </span>$socket<span style="color:#e6db74">&#34;</span> boldred

    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Create a ~/.my.cnf and exit when all else fails</span>
second_login_failed<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;Could not auto detect login info!&#34;</span>
  cecho <span style="color:#e6db74">&#34;Found potential sockets: </span>$found_socks<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Using: </span>$socket<span style="color:#e6db74">&#34;</span> red

  read -p <span style="color:#e6db74">&#34;Would you like to provide a different socket?: [y/N] &#34;</span> REPLY

  <span style="color:#66d9ef">case</span> $REPLY in
    yes|y|Y|YES<span style="color:#f92672">)</span>
      read -p <span style="color:#e6db74">&#34;Socket: &#34;</span> socket ;;
  <span style="color:#66d9ef">esac</span>

  read -p <span style="color:#e6db74">&#34;Do you have your login handy?: [y/N] &#34;</span> REPLY

  <span style="color:#66d9ef">case</span> $REPLY in
    yes|y|Y|YES<span style="color:#f92672">)</span>
      answer1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;yes&#39;</span>
      read -p <span style="color:#e6db74">&#34;User: &#34;</span> user
      read -rp <span style="color:#e6db74">&#34;Password: &#34;</span> pass

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $pass <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
        export mysql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$mysql<span style="color:#e6db74"> -S</span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74">&#34;</span>
        export mysqladmin<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$mysqladmin<span style="color:#e6db74"> -S</span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74">&#34;</span>
      <span style="color:#66d9ef">else</span>
        export mysql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$mysql<span style="color:#e6db74"> -S</span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74"> -p</span>$pass<span style="color:#e6db74">&#34;</span>
        export mysqladmin<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$mysqladmin<span style="color:#e6db74"> -S</span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74"> -p</span>$pass<span style="color:#e6db74">&#34;</span>
      <span style="color:#66d9ef">fi</span>
      ;;
    *<span style="color:#f92672">)</span>
      cecho <span style="color:#e6db74">&#34;Please create a valid login to MySQL&#34;</span>
      cecho <span style="color:#e6db74">&#34;Or, set correct values for  &#39;user=&#39; and &#39;password=&#39; in ~/.my.cnf&#34;</span>
      ;;
  <span style="color:#66d9ef">esac</span>

  cecho <span style="color:#e6db74">&#34; &#34;</span>
  read -p <span style="color:#e6db74">&#34;Would you like me to create a ~/.my.cnf file for you?: [y/N] &#34;</span> REPLY

  <span style="color:#66d9ef">case</span> $REPLY in
    yes|y|Y|YES<span style="color:#f92672">)</span>
      answer2<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;yes&#39;</span>

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -f ~/.my.cnf <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
        umask <span style="color:#ae81ff">077</span>
        printf <span style="color:#e6db74">&#34;[client]\nuser=</span>$user<span style="color:#e6db74">\npassword=</span>$pass<span style="color:#e6db74">\nsocket=</span>$socket<span style="color:#e6db74">&#34;</span> &gt; ~/.my.cnf

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$answer1<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;yes&#39;</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
          exit <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">else</span>
          final_login_attempt
          <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">fi</span>
      <span style="color:#66d9ef">else</span>
        printf <span style="color:#e6db74">&#34;\n&#34;</span>
        cecho <span style="color:#e6db74">&#34;~/.my.cnf already exists!&#34;</span> boldred
        printf <span style="color:#e6db74">&#34;\n&#34;</span>
        read -p <span style="color:#e6db74">&#34;Replace?: [y/N] &#34;</span> REPLY

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$REPLY<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;y&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$REPLY<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Y&#39;</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
          printf <span style="color:#e6db74">&#34;[client]\nuser=</span>$user<span style="color:#e6db74">\npassword=</span>$pass<span style="color:#e6db74">\socket=</span>$socket<span style="color:#e6db74">&#34;</span> &gt; ~/.my.cnf

          <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$answer1<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;yes&#39;</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
            exit <span style="color:#ae81ff">1</span>
          <span style="color:#66d9ef">else</span>
            final_login_attempt
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
          <span style="color:#66d9ef">fi</span>
        <span style="color:#66d9ef">else</span>
          cecho <span style="color:#e6db74">&#34;Please set the &#39;user=&#39; and &#39;password=&#39; and &#39;socket=&#39; values in ~/.my.cnf&#34;</span>
          exit <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">fi</span>
      <span style="color:#66d9ef">fi</span>
      ;;
    *<span style="color:#f92672">)</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$answer1<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;yes&#39;</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
        exit <span style="color:#ae81ff">1</span>
      <span style="color:#66d9ef">else</span>
        final_login_attempt
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
      <span style="color:#66d9ef">fi</span>
      ;;
  <span style="color:#66d9ef">esac</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Populate the .my.cnf file using values harvested from Webmin</span>
find_webmin_passwords<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;Testing for stored webmin passwords:&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f /etc/webmin/mysql/config <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    user<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep ^login<span style="color:#f92672">=</span> /etc/webmin/mysql/config | cut -d <span style="color:#e6db74">&#34;=&#34;</span> -f <span style="color:#ae81ff">2</span><span style="color:#66d9ef">)</span>
    pass<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep ^pass<span style="color:#f92672">=</span> /etc/webmin/mysql/config | cut -d <span style="color:#e6db74">&#34;=&#34;</span> -f <span style="color:#ae81ff">2</span><span style="color:#66d9ef">)</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>  $user <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $pass <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> ! -f ~/.my.cnf  <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;Setting login info as User: </span>$user<span style="color:#e6db74"> Password: </span>$pass<span style="color:#e6db74">&#34;</span>
      touch ~/.my.cnf
      chmod <span style="color:#ae81ff">600</span> ~/.my.cnf

      printf <span style="color:#e6db74">&#34;[client]\nuser=</span>$user<span style="color:#e6db74">\npassword=</span>$pass<span style="color:#e6db74">&#34;</span> &gt; ~/.my.cnf 
      cecho <span style="color:#e6db74">&#34;Retrying login&#34;</span>
      is_up<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysqladmin ping <span style="color:#ae81ff">2</span>&gt;&amp;<span style="color:#ae81ff">1</span><span style="color:#66d9ef">)</span>

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$is_up<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mysqld is alive&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
        echo UP &gt; /dev/null
      <span style="color:#66d9ef">else</span>
        second_login_failed
      <span style="color:#66d9ef">fi</span>

      echo
    <span style="color:#66d9ef">else</span>
      second_login_failed
      echo
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34; None Found&#34;</span> boldred
    second_login_failed
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Function to pull MySQL status variable</span>
#
<span style="color:#75715e"># Ex:</span>
<span style="color:#75715e">#     mysql_status &#39;Mysql_status_variable&#39; bash_dest_variable</span>
mysql_status<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local status<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;show /*!50000 global */ status like </span>$1<span style="color:#e6db74">&#34;</span> | awk <span style="color:#e6db74">&#39;{ print $2 }&#39;</span><span style="color:#66d9ef">)</span>
  export <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span><span style="color:#f92672">=</span>$status
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Function to pull MySQL server runtime variable</span>
#
<span style="color:#75715e"># Ex:</span>
<span style="color:#75715e">#     mysql_variable &#39;Mysql_server_variable&#39; bash_dest_variable</span>
<span style="color:#75715e">#     mysql_variableTSV &#39;Mysql_server_variable&#39; bash_dest_variable</span>
mysql_variable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local variable<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;show /*!50000 global */ variables like </span>$1<span style="color:#e6db74">&#34;</span> | awk <span style="color:#e6db74">&#39;{ print $2 }&#39;</span><span style="color:#66d9ef">)</span>
  export <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span><span style="color:#f92672">=</span>$variable
<span style="color:#f92672">}</span>

mysql_variableTSV<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local variable<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;show /*!50000 global */ variables like </span>$1<span style="color:#e6db74">&#34;</span> | awk -F <span style="color:#ae81ff">\t</span> <span style="color:#e6db74">&#39;{ print $2 }&#39;</span><span style="color:#66d9ef">)</span>
  export <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span><span style="color:#f92672">=</span>$variable
<span style="color:#f92672">}</span>

float2int<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local variable<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74"> / 1&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  export <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span><span style="color:#f92672">=</span>$variable
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Divide two integers</span>
divide<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  usage<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$0<span style="color:#e6db74"> dividend divisor &#39;</span>$variable<span style="color:#e6db74">&#39; scale&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $1 -ge <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    dividend<span style="color:#f92672">=</span>$1
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Invalid Dividend&#34;</span> red
    echo $usage
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $2 -ge <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    divisor<span style="color:#f92672">=</span>$2
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Invalid Divisor&#34;</span> red
    echo $usage
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -n $3 <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Invalid variable name&#34;</span> red
    echo $usage
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $4 <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    scale<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $4 -ge <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    scale<span style="color:#f92672">=</span>$4
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Invalid scale&#34;</span> red
    echo $usage
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  export $3<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=</span>$scale<span style="color:#e6db74">; </span>$dividend<span style="color:#e6db74"> / </span>$divisor<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Convert a value in to human readable size and populate a variable with the</span>
<span style="color:#75715e"># result.</span>
#
<span style="color:#75715e"># value=$1</span>
<span style="color:#75715e"># variable=$2</span>
#
<span style="color:#75715e"># Ex:</span>
<span style="color:#75715e">#     human_readable $value &#39;variable name&#39; [places of precision]</span>
human_readable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  scale<span style="color:#f92672">=</span>$3

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $1 -ge <span style="color:#ae81ff">1073741824</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $3 <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      scale<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
    <span style="color:#66d9ef">fi</span>

    divide $1 <span style="color:#ae81ff">1073741824</span> <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> $scale
    unit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;G&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $1 -ge <span style="color:#ae81ff">1048576</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $3 <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      scale<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">fi</span>

    divide $1 <span style="color:#ae81ff">1048576</span> <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> $scale
    unit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;M&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $1 -ge <span style="color:#ae81ff">1024</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $3 <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      scale<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">fi</span>

    divide $1 <span style="color:#ae81ff">1024</span> <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> $scale
    unit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;K&#34;</span>
  <span style="color:#66d9ef">else</span>
    export <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span><span style="color:#f92672">=</span>$1
    unit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bytes&#34;</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Function to produce human readable time</span>
human_readable_time<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  usage<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$0<span style="color:#e6db74"> seconds &#39;variable&#39;&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $1 <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> -z $2 <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho $usage red
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  days<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0 ; </span>$1<span style="color:#e6db74"> / 86400&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  remainder<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0 ; </span>$1<span style="color:#e6db74"> % 86400&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  hours<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0 ; </span>$remainder<span style="color:#e6db74"> / 3600&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  remainder<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0 ; </span>$remainder<span style="color:#e6db74"> % 3600&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  minutes<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0 ; </span>$remainder<span style="color:#e6db74"> / 60&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  seconds<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0 ; </span>$remainder<span style="color:#e6db74"> % 60&#34;</span> | bc -l<span style="color:#66d9ef">)</span>

  export $2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$days<span style="color:#e6db74"> days </span>$hours<span style="color:#e6db74"> hrs </span>$minutes<span style="color:#e6db74"> min </span>$seconds<span style="color:#e6db74"> sec&#34;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Print version info</span>
check_mysql_version<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  mysql_variable <span style="color:#ae81ff">\&#39;</span>version<span style="color:#ae81ff">\&#39;</span> mysql_version
  mysql_variable <span style="color:#ae81ff">\&#39;</span>version_compile_machine<span style="color:#ae81ff">\&#39;</span> mysql_version_compile_machine

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">050000</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;MySQL Version </span>$mysql_version<span style="color:#e6db74"> </span>$mysql_version_compile_machine<span style="color:#e6db74"> is EOL please upgrade to MySQL 4.1 or later&#34;</span> boldred
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;MySQL Version </span>$mysql_version<span style="color:#e6db74"> </span>$mysql_version_compile_machine<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Present a reminder that mysql must run for a couple of days to build up good</span>
<span style="color:#75715e"># numbers in server status variables before these tuning suggestions should be</span>
<span style="color:#75715e"># used.</span>
post_uptime_warning<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  mysql_status <span style="color:#ae81ff">\&#39;</span>Uptime<span style="color:#ae81ff">\&#39;</span> uptime
  mysql_status <span style="color:#ae81ff">\&#39;</span>Threads_connected<span style="color:#ae81ff">\&#39;</span> threads
  queries_per_sec<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$questions<span style="color:#f92672">/</span>$uptime<span style="color:#66d9ef">))</span>
  human_readable_time $uptime uptimeHR

  cecho <span style="color:#e6db74">&#34;Uptime = </span>$uptimeHR<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Avg. qps = </span>$queries_per_sec<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Total Questions = </span>$questions<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Threads Connected = </span>$threads<span style="color:#e6db74">&#34;</span>
  echo

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $uptime -gt <span style="color:#ae81ff">172800</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Server has been running for over 48hrs.&#34;</span>
    cecho <span style="color:#e6db74">&#34;It should be safe to follow these recommendations&#34;</span>
  <span style="color:#66d9ef">else</span>
    cechon <span style="color:#e6db74">&#34;Warning: &#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;Server has not been running for at least 48hrs.&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;It may not be safe to use these recommendations&#34;</span> boldred
  <span style="color:#66d9ef">fi</span>

  echo <span style="color:#e6db74">&#34;&#34;</span>
  cecho <span style="color:#e6db74">&#34;To find out more information on how each of these&#34;</span> red
  cecho <span style="color:#e6db74">&#34;runtime variables effects performance visit:&#34;</span> red

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;3.23&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4.0&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4.1&#39;</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;http://dev.mysql.com/doc/refman/4.1/en/server-system-variables.html&#34;</span> boldblue
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;5.0&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -gt <span style="color:#e6db74">&#39;050100&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;http://dev.mysql.com/doc/refman/</span>$major_version<span style="color:#e6db74">/en/server-system-variables.html&#34;</span> boldblue
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;UNSUPPORTED MYSQL VERSION&#34;</span> boldred
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  cecho <span style="color:#e6db74">&#34;Visit http://www.mysql.com/products/enterprise/advisors.html&#34;</span> boldblue
  cecho <span style="color:#e6db74">&#34;for info about MySQL&#39;s Enterprise Monitoring and Advisory Service&#34;</span> boldblue
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Slow Queries</span>
check_slow_queries <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;SLOW QUERIES&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Slow_queries<span style="color:#ae81ff">\&#39;</span> slow_queries
  mysql_variable <span style="color:#ae81ff">\&#39;</span>long_query_time<span style="color:#ae81ff">\&#39;</span> long_query_time
  mysql_variable <span style="color:#ae81ff">\&#39;</span>log%queries<span style="color:#ae81ff">\&#39;</span> log_slow_queries

  prefered_query_time<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -e /etc/my.cnf <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $log_slow_queries <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      log_slow_queries<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep log-slow-queries /etc/my.cnf<span style="color:#66d9ef">)</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$log_slow_queries<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ON&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;The slow query log is enabled.&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$log_slow_queries<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;OFF&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cechon <span style="color:#e6db74">&#34;The slow query log is &#34;</span>
    cechon <span style="color:#e6db74">&#34;NOT&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34; enabled.&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> -z $log_slow_queries <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cechon <span style="color:#e6db74">&#34;The slow query log is &#34;</span>
    cechon <span style="color:#e6db74">&#34;NOT&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34; enabled.&#34;</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Error: </span>$log_slow_queries<span style="color:#e6db74">&#34;</span> boldred
  <span style="color:#66d9ef">fi</span>

  cecho <span style="color:#e6db74">&#34;Current long_query_time = </span>$long_query_time<span style="color:#e6db74"> sec.&#34;</span>
  cechon <span style="color:#e6db74">&#34;You have &#34;</span>
  cechon <span style="color:#e6db74">&#34;</span>$slow_queries<span style="color:#e6db74">&#34;</span> boldred 
  cechon <span style="color:#e6db74">&#34; out of &#34;</span>
  cechon <span style="color:#e6db74">&#34;</span>$questions<span style="color:#e6db74">&#34;</span> boldred
  cecho <span style="color:#e6db74">&#34; that take longer than </span>$long_query_time<span style="color:#e6db74"> sec. to complete&#34;</span>

  float2int long_query_time long_query_timeInt

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $long_query_timeInt -gt $prefered_query_time <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Your long_query_time may be too high, I typically set this under </span>$prefered_query_time<span style="color:#e6db74"> sec.&#34;</span> red
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Your long_query_time seems to be fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Binary Log</span>
check_binary_log<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;BINARY UPDATE LOG&#34;</span> boldblue

  mysql_variable <span style="color:#ae81ff">\&#39;</span>log_bin<span style="color:#ae81ff">\&#39;</span> log_bin
  mysql_variable <span style="color:#ae81ff">\&#39;</span>max_binlog_size<span style="color:#ae81ff">\&#39;</span> max_binlog_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>expire_logs_days<span style="color:#ae81ff">\&#39;</span> expire_logs_days
  mysql_variable <span style="color:#ae81ff">\&#39;</span>sync_binlog<span style="color:#ae81ff">\&#39;</span> sync_binlog
  <span style="color:#75715e">#mysql_variable \&#39;max_binlog_cache_size\&#39; max_binlog_cache_size</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$log_bin<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ON&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;The binary update log is enabled&#34;</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">&#34;</span>$max_binlog_size<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;The max_binlog_size is not set. The binary log will rotate when it reaches 1GB.&#34;</span> red
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$expire_logs_days<span style="color:#e6db74">&#34;</span> -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;The expire_logs_days is not set.&#34;</span> boldred
      cechon <span style="color:#e6db74">&#34;The mysqld will retain the entire binary log until &#34;</span> red
      cecho <span style="color:#e6db74">&#34;RESET MASTER or PURGE MASTER LOGS commands are run manually&#34;</span> red
      cecho <span style="color:#e6db74">&#34;Setting expire_logs_days will allow you to remove old binary logs automatically&#34;</span>  yellow
      cecho <span style="color:#e6db74">&#34;See http://dev.mysql.com/doc/refman/</span>$major_version<span style="color:#e6db74">/en/purge-master-logs.html&#34;</span> yellow
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$sync_binlog<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;Binlog sync is not enabled, you could loose binlog records during a server crash&#34;</span> red
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">else</span>
    cechon <span style="color:#e6db74">&#34;The binary update log is &#34;</span>
    cechon <span style="color:#e6db74">&#34;NOT &#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;enabled.&#34;</span>
    cecho <span style="color:#e6db74">&#34;You will not be able to do point in time recovery&#34;</span> red
    cecho <span style="color:#e6db74">&#34;See http://dev.mysql.com/doc/refman/</span>$major_version<span style="color:#e6db74">/en/point-in-time-recovery.html&#34;</span> yellow
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Used Connections</span>
check_used_connections<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  mysql_variable <span style="color:#ae81ff">\&#39;</span>max_connections<span style="color:#ae81ff">\&#39;</span> max_connections
  mysql_status <span style="color:#ae81ff">\&#39;</span>Max_used_connections<span style="color:#ae81ff">\&#39;</span> max_used_connections
  mysql_status <span style="color:#ae81ff">\&#39;</span>Threads_connected<span style="color:#ae81ff">\&#39;</span> threads_connected

  connections_ratio<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$max_used_connections<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>$max_connections<span style="color:#66d9ef">))</span>

  cecho <span style="color:#e6db74">&#34;MAX CONNECTIONS&#34;</span> boldblue
  cecho <span style="color:#e6db74">&#34;Current max_connections = </span>$max_connections<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Current threads_connected = </span>$threads_connected<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Historic max_used_connections = </span>$max_used_connections<span style="color:#e6db74">&#34;</span>
  cechon <span style="color:#e6db74">&#34;The number of used connections is &#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $connections_ratio -ge <span style="color:#ae81ff">85</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    txt_color<span style="color:#f92672">=</span>red
    error<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $connections_ratio -le <span style="color:#ae81ff">10</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    txt_color<span style="color:#f92672">=</span>red
    error<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">else</span>
    txt_color<span style="color:#f92672">=</span>green
    error<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  cechon <span style="color:#e6db74">&#34;</span>$connections_ratio<span style="color:#e6db74">% &#34;</span> $txt_color
  cecho <span style="color:#e6db74">&#34;of the configured maximum.&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $error -eq <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You should raise max_connections&#34;</span> $txt_color
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $error -eq <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You are using less than 10% of your configured max_connections.&#34;</span> $txt_color
    cecho <span style="color:#e6db74">&#34;Lowering max_connections could help to avoid an over-allocation of memory&#34;</span> $txt_color
    cecho <span style="color:#e6db74">&#34;See \&#34;MEMORY USAGE\&#34; section to make sure you are not over-allocating&#34;</span> $txt_color
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Your max_connections variable seems to be fine.&#34;</span> $txt_color
  <span style="color:#66d9ef">fi</span>

  unset txt_color
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Worker Threads</span>
check_threads<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;WORKER THREADS&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Threads_created<span style="color:#ae81ff">\&#39;</span> threads_created1
  sleep <span style="color:#ae81ff">1</span>
  mysql_status <span style="color:#ae81ff">\&#39;</span>Threads_created<span style="color:#ae81ff">\&#39;</span> threads_created2

  mysql_status <span style="color:#ae81ff">\&#39;</span>Threads_cached<span style="color:#ae81ff">\&#39;</span> threads_cached
  mysql_status <span style="color:#ae81ff">\&#39;</span>Uptime<span style="color:#ae81ff">\&#39;</span> uptime
  mysql_variable <span style="color:#ae81ff">\&#39;</span>thread_cache_size<span style="color:#ae81ff">\&#39;</span> thread_cache_size

  historic_threads_per_sec<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$threads_created1<span style="color:#f92672">/</span>$uptime<span style="color:#66d9ef">))</span>
  current_threads_per_sec<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$threads_created2<span style="color:#f92672">-</span>$threads_created1<span style="color:#66d9ef">))</span>

  cecho <span style="color:#e6db74">&#34;Current thread_cache_size = </span>$thread_cache_size<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Current threads_cached = </span>$threads_cached<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Current threads_per_sec = </span>$current_threads_per_sec<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Historic threads_per_sec = </span>$historic_threads_per_sec<span style="color:#e6db74">&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $historic_threads_per_sec -ge <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $threads_cached -le <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Threads created per/sec are overrunning threads cached&#34;</span> red
    cecho <span style="color:#e6db74">&#34;You should raise thread_cache_size&#34;</span> red
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $current_threads_per_sec -ge <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Threads created per/sec are overrunning threads cached&#34;</span> red
    cecho <span style="color:#e6db74">&#34;You should raise thread_cache_size&#34;</span> red
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Your thread_cache_size is fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Key buffer Size</span>
check_key_buffer_size<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;KEY BUFFER&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Key_read_requests<span style="color:#ae81ff">\&#39;</span> key_read_requests
  mysql_status <span style="color:#ae81ff">\&#39;</span>Key_reads<span style="color:#ae81ff">\&#39;</span> key_reads
  mysql_status <span style="color:#ae81ff">\&#39;</span>Key_blocks_used<span style="color:#ae81ff">\&#39;</span> key_blocks_used
  mysql_status <span style="color:#ae81ff">\&#39;</span>Key_blocks_unused<span style="color:#ae81ff">\&#39;</span> key_blocks_unused
  mysql_variable <span style="color:#ae81ff">\&#39;</span>key_cache_block_size<span style="color:#ae81ff">\&#39;</span> key_cache_block_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>key_buffer_size<span style="color:#ae81ff">\&#39;</span> key_buffer_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>datadir<span style="color:#ae81ff">\&#39;</span> datadir
  mysql_variable <span style="color:#ae81ff">\&#39;</span>version_compile_machine<span style="color:#ae81ff">\&#39;</span> mysql_version_compile_machine

  myisam_indexes<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;/*!50000 SELECT IFNULL(SUM(INDEX_LENGTH),0) from information_schema.TABLES where ENGINE=&#39;MyISAM&#39; */&#34;</span><span style="color:#66d9ef">)</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $myisam_indexes <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    myisam_indexes<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>find $datadir -name <span style="color:#e6db74">&#39;*.MYI&#39;</span> -exec du $duflags <span style="color:#e6db74">&#39;{}&#39;</span> <span style="color:#ae81ff">\;</span> <span style="color:#ae81ff">2</span>&gt;&amp;<span style="color:#ae81ff">1</span> | awk <span style="color:#e6db74">&#39;{ s += $1 } END { printf(&#34;%.0f\n&#34;, s )}&#39;</span><span style="color:#66d9ef">)</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $key_reads -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;No key reads?!&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;Seriously look into using some indexes&#34;</span> red

    key_cache_miss_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    key_buffer_free<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$key_blocks_unused<span style="color:#e6db74"> * </span>$key_cache_block_size<span style="color:#e6db74"> / </span>$key_buffer_size<span style="color:#e6db74"> * 100&#34;</span> | bc -l <span style="color:#66d9ef">)</span>
    key_buffer_freeRND<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0; </span>$key_buffer_free<span style="color:#e6db74"> / 1&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  <span style="color:#66d9ef">else</span>
    key_cache_miss_rate<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$key_read_requests<span style="color:#f92672">/</span>$key_reads<span style="color:#66d9ef">))</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -z $key_blocks_unused <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
      key_buffer_free<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$key_blocks_unused<span style="color:#e6db74"> * </span>$key_cache_block_size<span style="color:#e6db74"> / </span>$key_buffer_size<span style="color:#e6db74"> * 100&#34;</span> | bc -l <span style="color:#66d9ef">)</span>
      key_buffer_freeRND<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0; </span>$key_buffer_free<span style="color:#e6db74"> / 1&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
    <span style="color:#66d9ef">else</span>
      key_buffer_free<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Unknown&#39;</span>
      key_buffer_freeRND<span style="color:#f92672">=</span><span style="color:#ae81ff">75</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>

  human_readable $myisam_indexes myisam_indexesHR
  cecho <span style="color:#e6db74">&#34;Current MyISAM index space = </span>$myisam_indexesHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span> 

  human_readable  $key_buffer_size key_buffer_sizeHR
  cecho <span style="color:#e6db74">&#34;Current key_buffer_size = </span>$key_buffer_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Key cache miss rate is 1 : </span>$key_cache_miss_rate<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;Key buffer free ratio = </span>$key_buffer_freeRND<span style="color:#e6db74"> %&#34;</span> 

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;5.1&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $mysql_version_num -lt <span style="color:#ae81ff">050123</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $key_buffer_size -ge <span style="color:#ae81ff">4294967296</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span> echo <span style="color:#e6db74">&#34;x86_64 ppc64 ia64 sparc64 i686&#34;</span> | grep -q $mysql_version_compile_machine <span style="color:#f92672">)</span> ; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;Using key_buffer_size &gt; 4GB will cause instability in versions prior to 5.1.23 &#34;</span> boldred
      cecho <span style="color:#e6db74">&#34;See Bug#5731, Bug#29419, Bug#29446&#34;</span> boldred
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;5.0&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $mysql_version_num -lt <span style="color:#ae81ff">050052</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $key_buffer_size -ge <span style="color:#ae81ff">4294967296</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span> echo <span style="color:#e6db74">&#34;x86_64 ppc64 ia64 sparc64 i686&#34;</span> | grep -q $mysql_version_compile_machine <span style="color:#f92672">)</span> ; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;Using key_buffer_size &gt; 4GB will cause instability in versions prior to 5.0.52 &#34;</span> boldred
      cecho <span style="color:#e6db74">&#34;See Bug#5731, Bug#29419, Bug#29446&#34;</span> boldred
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4.1&#39;</span> -o <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4.0&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $key_buffer_size -ge <span style="color:#ae81ff">4294967296</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span> echo <span style="color:#e6db74">&#34;x86_64 ppc64 ia64 sparc64 i686&#34;</span> | grep -q $mysql_version_compile_machine <span style="color:#f92672">)</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Using key_buffer_size &gt; 4GB will cause instability in versions prior to 5.0.52 &#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;Reduce key_buffer_size to a safe value&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;See Bug#5731, Bug#29419, Bug#29446&#34;</span> boldred
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $key_cache_miss_rate -le <span style="color:#ae81ff">100</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $key_cache_miss_rate -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $key_buffer_freeRND -le <span style="color:#ae81ff">20</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You could increase key_buffer_size&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;It is safe to raise this up to 1/4 of total system memory;&#34;</span>
    cecho <span style="color:#e6db74">&#34;assuming this is a dedicated database server.&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $key_buffer_freeRND -le <span style="color:#ae81ff">20</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $key_buffer_size -le $myisam_indexes <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You could increase key_buffer_size&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;It is safe to raise this up to 1/4 of total system memory;&#34;</span>
    cecho <span style="color:#e6db74">&#34;assuming this is a dedicated database server.&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $key_cache_miss_rate -ge <span style="color:#ae81ff">10000</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> $key_buffer_freeRND -le <span style="color:#ae81ff">50</span>  <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Your key_buffer_size seems to be too high.&#34;</span> red 
    cecho <span style="color:#e6db74">&#34;Perhaps you can use these resources elsewhere&#34;</span> red
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Your key_buffer_size seems to be fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Query Cache</span>
check_query_cache<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;QUERY CACHE&#34;</span> boldblue

  mysql_variable <span style="color:#ae81ff">\&#39;</span>version<span style="color:#ae81ff">\&#39;</span> mysql_version
  mysql_variable <span style="color:#ae81ff">\&#39;</span>query_cache_size<span style="color:#ae81ff">\&#39;</span> query_cache_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>query_cache_limit<span style="color:#ae81ff">\&#39;</span> query_cache_limit
  mysql_variable <span style="color:#ae81ff">\&#39;</span>query_cache_min_res_unit<span style="color:#ae81ff">\&#39;</span> query_cache_min_res_unit
  mysql_status <span style="color:#ae81ff">\&#39;</span>Qcache_free_memory<span style="color:#ae81ff">\&#39;</span> qcache_free_memory
  mysql_status <span style="color:#ae81ff">\&#39;</span>Qcache_total_blocks<span style="color:#ae81ff">\&#39;</span> qcache_total_blocks
  mysql_status <span style="color:#ae81ff">\&#39;</span>Qcache_free_blocks<span style="color:#ae81ff">\&#39;</span> qcache_free_blocks
  mysql_status <span style="color:#ae81ff">\&#39;</span>Qcache_lowmem_prunes<span style="color:#ae81ff">\&#39;</span> qcache_lowmem_prunes

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $query_cache_size <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You are using MySQL </span>$mysql_version<span style="color:#e6db74">, no query cache is supported.&#34;</span> red
    cecho <span style="color:#e6db74">&#34;I recommend an upgrade to MySQL 4.1 or better&#34;</span> red
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $query_cache_size -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Query cache is supported but not enabled&#34;</span> red
    cecho <span style="color:#e6db74">&#34;Perhaps you should set the query_cache_size&#34;</span> red
  <span style="color:#66d9ef">else</span>
    qcache_used_memory<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$query_cache_size<span style="color:#f92672">-</span>$qcache_free_memory<span style="color:#66d9ef">))</span>
    qcache_mem_fill_ratio<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=2; </span>$qcache_used_memory<span style="color:#e6db74"> * 100 / </span>$query_cache_size<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
    qcache_mem_fill_ratioHR<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0; </span>$qcache_mem_fill_ratio<span style="color:#e6db74"> / 1&#34;</span> | bc -l<span style="color:#66d9ef">)</span>

    cecho <span style="color:#e6db74">&#34;Query cache is enabled&#34;</span> green
    human_readable $query_cache_size query_cache_sizeHR
    cecho <span style="color:#e6db74">&#34;Current query_cache_size = </span>$query_cache_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
    human_readable $qcache_used_memory qcache_used_memoryHR
    cecho <span style="color:#e6db74">&#34;Current query_cache_used = </span>$qcache_used_memoryHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
    human_readable $query_cache_limit query_cache_limitHR
    cecho <span style="color:#e6db74">&#34;Current query_cache_limit = </span>$query_cache_limitHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
    cecho <span style="color:#e6db74">&#34;Current Query cache Memory fill ratio = </span>$qcache_mem_fill_ratio<span style="color:#e6db74"> %&#34;</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $query_cache_min_res_unit <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;No query_cache_min_res_unit is defined.  Using MySQL &lt; 4.1 cache fragmentation can be inpredictable&#34;</span> %yellow
    <span style="color:#66d9ef">else</span>
      human_readable $query_cache_min_res_unit query_cache_min_res_unitHR 
      cecho <span style="color:#e6db74">&#34;Current query_cache_min_res_unit = </span>$query_cache_min_res_unitHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $qcache_free_blocks -gt <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $qcache_total_blocks -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      qcache_percent_fragmented<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=2; </span>$qcache_free_blocks<span style="color:#e6db74"> * 100 / </span>$qcache_total_blocks<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
      qcache_percent_fragmentedHR<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0; </span>$qcache_percent_fragmented<span style="color:#e6db74"> / 1&#34;</span> | bc -l<span style="color:#66d9ef">)</span>

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $qcache_percent_fragmentedHR -gt <span style="color:#ae81ff">20</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
        cecho <span style="color:#e6db74">&#34;Query Cache is </span>$qcache_percent_fragmentedHR<span style="color:#e6db74"> % fragmented&#34;</span> red
        cecho <span style="color:#e6db74">&#34;Run \&#34;FLUSH QUERY CACHE\&#34; periodically to defragment the query cache memory&#34;</span> red 
        cecho <span style="color:#e6db74">&#34;If you have many small queries lower &#39;query_cache_min_res_unit&#39; to reduce fragmentation.&#34;</span> red
      <span style="color:#66d9ef">fi</span>
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $qcache_mem_fill_ratioHR -le <span style="color:#ae81ff">25</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;Your query_cache_size seems to be too high.&#34;</span> red
      cecho <span style="color:#e6db74">&#34;Perhaps you can use these resources elsewhere&#34;</span> red
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $qcache_lowmem_prunes -ge <span style="color:#ae81ff">50</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $qcache_mem_fill_ratioHR -ge <span style="color:#ae81ff">80</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cechon <span style="color:#e6db74">&#34;However, &#34;</span>
      cechon <span style="color:#e6db74">&#34;</span>$qcache_lowmem_prunes<span style="color:#e6db74"> &#34;</span> boldred
      cecho <span style="color:#e6db74">&#34;queries have been removed from the query cache due to lack of memory&#34;</span>
      cecho <span style="color:#e6db74">&#34;Perhaps you should raise query_cache_size&#34;</span> boldred
    <span style="color:#66d9ef">fi</span>

    cecho <span style="color:#e6db74">&#34;MySQL won&#39;t cache query results that are larger than query_cache_limit in size&#34;</span> yellow
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Sort Operations</span>
check_sort_operations<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;SORT OPERATIONS&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Sort_merge_passes<span style="color:#ae81ff">\&#39;</span> sort_merge_passes
  mysql_status <span style="color:#ae81ff">\&#39;</span>Sort_scan<span style="color:#ae81ff">\&#39;</span> sort_scan
  mysql_status <span style="color:#ae81ff">\&#39;</span>Sort_range<span style="color:#ae81ff">\&#39;</span> sort_range
  mysql_variable <span style="color:#ae81ff">\&#39;</span>sort_buffer%<span style="color:#ae81ff">\&#39;</span> sort_buffer_size 
  mysql_variable <span style="color:#ae81ff">\&#39;</span>read_rnd_buffer_size<span style="color:#ae81ff">\&#39;</span> read_rnd_buffer_size 

  total_sorts<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$sort_scan<span style="color:#f92672">+</span>$sort_range<span style="color:#66d9ef">))</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $read_rnd_buffer_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>record_buffer<span style="color:#ae81ff">\&#39;</span> read_rnd_buffer_size
  <span style="color:#66d9ef">fi</span>

  <span style="color:#75715e">## Correct for rounding error in mysqld where 512K != 524288 ##</span>
  sort_buffer_size<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$sort_buffer_size<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#66d9ef">))</span>
  read_rnd_buffer_size<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$read_rnd_buffer_size<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#66d9ef">))</span>

  human_readable $sort_buffer_size sort_buffer_sizeHR
  cecho <span style="color:#e6db74">&#34;Current sort_buffer_size = </span>$sort_buffer_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>

  human_readable $read_rnd_buffer_size read_rnd_buffer_sizeHR
  cechon <span style="color:#e6db74">&#34;Current &#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;3.23&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cechon <span style="color:#e6db74">&#34;record_rnd_buffer &#34;</span>
  <span style="color:#66d9ef">else</span>
    cechon <span style="color:#e6db74">&#34;read_rnd_buffer_size &#34;</span>
  <span style="color:#66d9ef">fi</span>

  cecho <span style="color:#e6db74">&#34;= </span>$read_rnd_buffer_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $total_sorts -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;No sort operations have been performed&#34;</span>
    passes_per_sort<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $sort_merge_passes -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    passes_per_sort<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$sort_merge_passes<span style="color:#f92672">/</span>$total_sorts<span style="color:#66d9ef">))</span>
  <span style="color:#66d9ef">else</span>
    passes_per_sort<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $passes_per_sort -ge <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cechon <span style="color:#e6db74">&#34;On average &#34;</span>
    cechon <span style="color:#e6db74">&#34;</span>$passes_per_sort<span style="color:#e6db74"> &#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;sort merge passes are made per sort operation&#34;</span>
    cecho <span style="color:#e6db74">&#34;You should raise your sort_buffer_size&#34;</span>
    cechon <span style="color:#e6db74">&#34;You should also raise your &#34;</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;3.23&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;record_rnd_buffer_size&#34;</span>
    <span style="color:#66d9ef">else</span>
      cecho <span style="color:#e6db74">&#34;read_rnd_buffer_size&#34;</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Sort buffer seems to be fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Joins</span>
check_join_operations<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;JOINS&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Select_full_join<span style="color:#ae81ff">\&#39;</span> select_full_join
  mysql_status <span style="color:#ae81ff">\&#39;</span>Select_range_check<span style="color:#ae81ff">\&#39;</span> select_range_check
  mysql_variable <span style="color:#ae81ff">\&#39;</span>join_buffer%<span style="color:#ae81ff">\&#39;</span> join_buffer_size

  <span style="color:#75715e"># Some 4K is dropped from join_buffer_size adding it back to make sane</span>
  <span style="color:#75715e"># handling of human-readable conversion</span>

  join_buffer_size<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$join_buffer_size<span style="color:#f92672">+</span><span style="color:#ae81ff">4096</span><span style="color:#66d9ef">))</span>
  human_readable $join_buffer_size join_buffer_sizeHR <span style="color:#ae81ff">2</span>

  cecho <span style="color:#e6db74">&#34;Current join_buffer_size = </span>$join_buffer_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
  cecho <span style="color:#e6db74">&#34;You have had </span>$select_full_join<span style="color:#e6db74"> queries where a join could not use an index properly&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $select_range_check -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $select_full_join -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Your joins seem to be using indexes properly&#34;</span> green
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $select_full_join -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    print_error<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>
    raise_buffer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $select_range_check -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You have had </span>$select_range_check<span style="color:#e6db74"> joins without keys that check for key usage after each row&#34;</span> red
    print_error<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>
    raise_buffer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $join_buffer_size -ge <span style="color:#ae81ff">4194304</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;join_buffer_size &gt;= 4 M&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;This is not advised&#34;</span> boldred
    raise_buffer<span style="color:#f92672">=</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $print_error <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;3.23&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4.0&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;You should enable \&#34;log-long-format\&#34; &#34;</span>
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -gt <span style="color:#ae81ff">040100</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;You should enable \&#34;log-queries-not-using-indexes\&#34;&#34;</span>
    <span style="color:#66d9ef">fi</span>

    cecho <span style="color:#e6db74">&#34;Then look for non indexed joins in the slow query log.&#34;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $raise_buffer <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;If you are unable to optimize your queries you may want to increase your&#34;</span>
      cecho <span style="color:#e6db74">&#34;join_buffer_size to accommodate larger joins in one pass.&#34;</span>
      printf <span style="color:#e6db74">&#34;\n&#34;</span>
      cecho <span style="color:#e6db74">&#34;Note! This script will still suggest raising the join_buffer_size when&#34;</span> boldred
      cecho <span style="color:#e6db74">&#34;ANY joins not using indexes are found.&#34;</span> boldred
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Temp Tables</span>
check_tmp_tables<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;TEMP TABLES&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Created_tmp_tables<span style="color:#ae81ff">\&#39;</span> created_tmp_tables 
  mysql_status <span style="color:#ae81ff">\&#39;</span>Created_tmp_disk_tables<span style="color:#ae81ff">\&#39;</span> created_tmp_disk_tables
  mysql_variable <span style="color:#ae81ff">\&#39;</span>tmp_table_size<span style="color:#ae81ff">\&#39;</span> tmp_table_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>max_heap_table_size<span style="color:#ae81ff">\&#39;</span> max_heap_table_size

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $created_tmp_tables -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    tmp_disk_tables<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">else</span>
    tmp_disk_tables<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>created_tmp_disk_tables*100/<span style="color:#f92672">(</span>created_tmp_tables+created_tmp_disk_tables<span style="color:#66d9ef">))</span><span style="color:#f92672">)</span>
  <span style="color:#66d9ef">fi</span>

  human_readable $max_heap_table_size max_heap_table_sizeHR
  cecho <span style="color:#e6db74">&#34;Current max_heap_table_size = </span>$max_heap_table_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>

  human_readable $tmp_table_size tmp_table_sizeHR 
  cecho <span style="color:#e6db74">&#34;Current tmp_table_size = </span>$tmp_table_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>

  cecho <span style="color:#e6db74">&#34;Of </span>$created_tmp_tables<span style="color:#e6db74"> temp tables, </span>$tmp_disk_tables<span style="color:#e6db74">% were created on disk&#34;</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $tmp_table_size -gt $max_heap_table_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Effective in-memory tmp_table_size is limited to max_heap_table_size.&#34;</span> yellow
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $tmp_disk_tables -ge <span style="color:#ae81ff">25</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Perhaps you should increase your tmp_table_size and/or max_heap_table_size&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;to reduce the number of disk-based temporary tables&#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;Note! BLOB and TEXT columns are not allow in memory tables.&#34;</span> yellow
    cecho <span style="color:#e6db74">&#34;If you are using these columns raising these values might not impact your &#34;</span> yellow
    cecho  <span style="color:#e6db74">&#34;ratio of on disk temp tables.&#34;</span> yellow
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Created disk tmp tables ratio seems fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Open Files Limit</span>
check_open_files<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;OPEN FILES LIMIT&#34;</span> boldblue

  mysql_variable <span style="color:#ae81ff">\&#39;</span>open_files_limit<span style="color:#ae81ff">\&#39;</span> open_files_limit
  mysql_status   <span style="color:#ae81ff">\&#39;</span>Open_files<span style="color:#ae81ff">\&#39;</span> open_files

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $open_files_limit <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> $open_files_limit -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    open_files_limit<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ulimit -n<span style="color:#66d9ef">)</span>
    cant_override<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">else</span>
    cant_override<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  cecho <span style="color:#e6db74">&#34;Current open_files_limit = </span>$open_files_limit<span style="color:#e6db74"> files&#34;</span>

  open_files_ratio<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$open_files<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>$open_files_limit<span style="color:#66d9ef">))</span>

  cecho <span style="color:#e6db74">&#34;The open_files_limit should typically be set to at least 2x-3x&#34;</span> yellow
  cecho <span style="color:#e6db74">&#34;that of table_cache if you have heavy MyISAM usage.&#34;</span> yellow
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $open_files_ratio -ge <span style="color:#ae81ff">75</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You currently have open more than 75% of your open_files_limit&#34;</span> boldred

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $cant_override -eq <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;You should set a higer value for ulimit -u in the mysql startup script then restart mysqld&#34;</span> boldred
      cecho <span style="color:#e6db74">&#34;MySQL 3.23 users : This is just a guess based upon the current shell&#39;s ulimit -u value&#34;</span> yellow
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $cant_override -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;You should set a higher value for open_files_limit in my.cnf&#34;</span> boldred
    <span style="color:#66d9ef">else</span>
      cecho <span style="color:#e6db74">&#34;ERROR can&#39;t determine if mysqld override of ulimit is allowed&#34;</span> boldred
      exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Your open_files_limit value seems to be fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Table Cache</span>
check_table_cache<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;TABLE CACHE&#34;</span> boldblue

  mysql_variable <span style="color:#ae81ff">\&#39;</span>datadir<span style="color:#ae81ff">\&#39;</span> datadir
  mysql_variable <span style="color:#ae81ff">\&#39;</span>table_cache<span style="color:#ae81ff">\&#39;</span> table_cache

  <span style="color:#75715e"># MySQL +5.1 version of table_cache</span>
  mysql_variable <span style="color:#ae81ff">\&#39;</span>table_open_cache<span style="color:#ae81ff">\&#39;</span> table_open_cache
  mysql_variable <span style="color:#ae81ff">\&#39;</span>table_definition_cache<span style="color:#ae81ff">\&#39;</span> table_definition_cache

  mysql_status <span style="color:#ae81ff">\&#39;</span>Open_tables<span style="color:#ae81ff">\&#39;</span> open_tables
  mysql_status <span style="color:#ae81ff">\&#39;</span>Opened_tables<span style="color:#ae81ff">\&#39;</span> opened_tables
  mysql_status <span style="color:#ae81ff">\&#39;</span>Open_table_definitions<span style="color:#ae81ff">\&#39;</span> open_table_definitions

  table_count<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;/*!50000 SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE=&#39;BASE TABLE&#39; */&#34;</span><span style="color:#66d9ef">)</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">&#34;</span>$table_count<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$UID<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span>$socket_owner<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$UID<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;You are not &#39;</span>$socket_owner<span style="color:#e6db74">&#39; or &#39;root&#39;&#34;</span> red
      cecho <span style="color:#e6db74">&#34;I am unable to determine the table_count!&#34;</span> red
    <span style="color:#66d9ef">else</span>
      table_count<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>find $datadir <span style="color:#ae81ff">2</span>&gt;&amp;<span style="color:#ae81ff">1</span> | grep -c .frm$<span style="color:#66d9ef">)</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $table_open_cache <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    table_cache<span style="color:#f92672">=</span>$table_open_cache
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $opened_tables -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $table_cache -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    table_cache_hit_rate<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$open_tables<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>$opened_tables<span style="color:#66d9ef">))</span>
    table_cache_fill<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$open_tables<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>$table_cache<span style="color:#66d9ef">))</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $opened_tables -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $table_cache -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    table_cache_hit_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>
    table_cache_fill<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$open_tables<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>$table_cache<span style="color:#66d9ef">))</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;ERROR no table_cache ?!&#34;</span> boldred
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $table_cache <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> ! $table_open_cache <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Current table_cache value = </span>$table_cache<span style="color:#e6db74"> tables&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $table_open_cache <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;Current table_open_cache = </span>$table_open_cache<span style="color:#e6db74"> tables&#34;</span>
    cecho <span style="color:#e6db74">&#34;Current table_definition_cache = </span>$table_definition_cache<span style="color:#e6db74"> tables&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $table_count <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You have a total of </span>$table_count<span style="color:#e6db74"> tables&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span>  <span style="color:#f92672">[</span> $table_cache_fill -lt <span style="color:#ae81ff">95</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cechon <span style="color:#e6db74">&#34;You have &#34;</span>
    cechon <span style="color:#e6db74">&#34;</span>$open_tables<span style="color:#e6db74"> &#34;</span> green
    cecho <span style="color:#e6db74">&#34;open tables.&#34;</span> 
    cecho <span style="color:#e6db74">&#34;The table_cache value seems to be fine&#34;</span> green
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $table_cache_hit_rate -le <span style="color:#ae81ff">85</span> -o  $table_cache_fill -ge <span style="color:#ae81ff">95</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cechon <span style="color:#e6db74">&#34;You have &#34;</span>
    cechon <span style="color:#e6db74">&#34;</span>$open_tables<span style="color:#e6db74"> &#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;open tables.&#34;</span>
    cechon <span style="color:#e6db74">&#34;Current table_cache hit rate is &#34;</span> 
    cecho <span style="color:#e6db74">&#34;</span>$table_cache_hit_rate<span style="color:#e6db74">%&#34;</span> boldred
    cechon <span style="color:#e6db74">&#34;, while &#34;</span>
    cechon <span style="color:#e6db74">&#34;</span>$table_cache_fill<span style="color:#e6db74">% &#34;</span> boldred
    cecho <span style="color:#e6db74">&#34;of your table cache is in use&#34;</span>
    cecho <span style="color:#e6db74">&#34;You should probably increase your table_cache&#34;</span> red
  <span style="color:#66d9ef">else</span>
    cechon <span style="color:#e6db74">&#34;Current table_cache hit rate is &#34;</span>
    cechon <span style="color:#e6db74">&#34;</span>$table_cache_hit_rate<span style="color:#e6db74">%&#34;</span> green
    cechon <span style="color:#e6db74">&#34;, while &#34;</span>
    cechon <span style="color:#e6db74">&#34;</span>$table_cache_fill<span style="color:#e6db74">% &#34;</span> green
    cecho <span style="color:#e6db74">&#34;of your table cache is in use&#34;</span>
    cecho <span style="color:#e6db74">&#34;The table cache value seems to be fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $table_definition_cache <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $table_definition_cache -le $table_count <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $table_count -ge <span style="color:#ae81ff">100</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You should probably increase your table_definition_cache value.&#34;</span> red
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Table Locking</span>
check_table_locking<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;TABLE LOCKING&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Table_locks_waited<span style="color:#ae81ff">\&#39;</span> table_locks_waited
  mysql_status <span style="color:#ae81ff">\&#39;</span>Table_locks_immediate<span style="color:#ae81ff">\&#39;</span> table_locks_immediate
  mysql_variable <span style="color:#ae81ff">\&#39;</span>concurrent_insert<span style="color:#ae81ff">\&#39;</span> concurrent_insert
  mysql_variable <span style="color:#ae81ff">\&#39;</span>low_priority_updates<span style="color:#ae81ff">\&#39;</span> low_priority_updates

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$concurrent_insert<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ON&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    concurrent_insert<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$concurrent_insert<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;OFF&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    concurrent_insert<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  cechon <span style="color:#e6db74">&#34;Current Lock Wait ratio = &#34;</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $table_locks_waited -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    immediate_locks_miss_rate<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$table_locks_immediate<span style="color:#f92672">/</span>$table_locks_waited<span style="color:#66d9ef">))</span>
    cecho <span style="color:#e6db74">&#34;1 : </span>$immediate_locks_miss_rate<span style="color:#e6db74">&#34;</span> red
  <span style="color:#66d9ef">else</span>
    immediate_locks_miss_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">99999</span> <span style="color:#75715e"># perfect</span>
    cecho <span style="color:#e6db74">&#34;0 : </span>$questions<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $immediate_locks_miss_rate -lt <span style="color:#ae81ff">5000</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    cecho <span style="color:#e6db74">&#34;You may benefit from selective use of InnoDB.&#34;</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$low_priority_updates<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;OFF&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;If you have long running SELECT&#39;s against MyISAM tables and perform&#34;</span>
      cecho <span style="color:#e6db74">&#34;frequent updates consider setting &#39;low_priority_updates=1&#39;&#34;</span>
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -gt <span style="color:#ae81ff">050000</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">050500</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $concurrent_insert -le <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
        cecho <span style="color:#e6db74">&#34;If you have a high concurrency of inserts on Dynamic row-length tables&#34;</span>
        cecho <span style="color:#e6db74">&#34;consider setting &#39;concurrent_insert=2&#39;.&#34;</span>
      <span style="color:#66d9ef">fi</span>
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -gt <span style="color:#ae81ff">050500</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$concurrent_insert<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;AUTO&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$concurrent_insert<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NEVER&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
        cecho <span style="color:#e6db74">&#34;If you have a high concurrency of inserts on Dynamic row-length tables&#34;</span>
        cecho <span style="color:#e6db74">&#34;consider setting &#39;concurrent_insert=ALWAYS&#39;.&#34;</span>
      <span style="color:#66d9ef">fi</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Your table locking seems to be fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Table Scans</span>
check_table_scans<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;TABLE SCANS&#34;</span> boldblue

  mysql_status <span style="color:#ae81ff">\&#39;</span>Com_select<span style="color:#ae81ff">\&#39;</span> com_select
  mysql_status <span style="color:#ae81ff">\&#39;</span>Handler_read_rnd_next<span style="color:#ae81ff">\&#39;</span> read_rnd_next
  mysql_variable <span style="color:#ae81ff">\&#39;</span>read_buffer_size<span style="color:#ae81ff">\&#39;</span> read_buffer_size

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $read_buffer_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>record_buffer<span style="color:#ae81ff">\&#39;</span> read_buffer_size
  <span style="color:#66d9ef">fi</span>

  human_readable $read_buffer_size read_buffer_sizeHR
  cecho <span style="color:#e6db74">&#34;Current read_buffer_size = </span>$read_buffer_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $com_select -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    full_table_scans<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$read_rnd_next<span style="color:#f92672">/</span>$com_select<span style="color:#66d9ef">))</span>

    cecho <span style="color:#e6db74">&#34;Current table scan ratio = </span>$full_table_scans<span style="color:#e6db74"> : 1&#34;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $full_table_scans -ge <span style="color:#ae81ff">4000</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> $read_buffer_size -le <span style="color:#ae81ff">2097152</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      cecho <span style="color:#e6db74">&#34;You have a high ratio of sequential access requests to SELECTs&#34;</span> red
      cechon <span style="color:#e6db74">&#34;You may benefit from raising &#34;</span> red

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;3.23&#39;</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
        cechon <span style="color:#e6db74">&#34;record_buffer &#34;</span> red
      <span style="color:#66d9ef">else</span>
        cechon <span style="color:#e6db74">&#34;read_buffer_size &#34;</span> red
      <span style="color:#66d9ef">fi</span>

      cecho <span style="color:#e6db74">&#34;and/or improving your use of indexes.&#34;</span> red
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $read_buffer_size -gt <span style="color:#ae81ff">8388608</span> <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
      cechon <span style="color:#e6db74">&#34;read_buffer_size is over 8 MB &#34;</span> red
      cecho <span style="color:#e6db74">&#34;there is probably no need for such a large read_buffer&#34;</span> red
    <span style="color:#66d9ef">else</span>
      cecho <span style="color:#e6db74">&#34;read_buffer_size seems to be fine&#34;</span> green
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;read_buffer_size seems to be fine&#34;</span> green
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># InnoDB</span>
check_innodb_status <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">## See http://bugs.mysql.com/59393</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">050603</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>have_innodb<span style="color:#ae81ff">\&#39;</span> have_innodb
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">050500</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$have_innodb<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YES&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -ge <span style="color:#ae81ff">050500</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">050512</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>ignore_builtin_innodb<span style="color:#ae81ff">\&#39;</span> ignore_builtin_innodb

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$ignore_builtin_innodb<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ON&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> $have_innodb <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NO&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">else</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;5.5&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -ge <span style="color:#ae81ff">050512</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>ignore_builtin_innodb<span style="color:#ae81ff">\&#39;</span> ignore_builtin_innodb
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$ignore_builtin_innodb<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ON&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">else</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -ge <span style="color:#ae81ff">050600</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">050603</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>ignore_builtin_innodb<span style="color:#ae81ff">\&#39;</span> ignore_builtin_innodb

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$ignore_builtin_innodb<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ON&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> $have_innodb <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NO&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">else</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;5.6&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$mysql_version_num<span style="color:#e6db74">&#34;</span> -ge <span style="color:#ae81ff">050603</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>ignore_builtin_innodb<span style="color:#ae81ff">\&#39;</span> ignore_builtin_innodb

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$ignore_builtin_innodb<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ON&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">else</span>
      innodb_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$innodb_enabled<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_buffer_pool_size<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_size
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_additional_mem_pool_size<span style="color:#ae81ff">\&#39;</span> innodb_additional_mem_pool_size
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_fast_shutdown<span style="color:#ae81ff">\&#39;</span> innodb_fast_shutdown
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_flush_log_at_trx_commit<span style="color:#ae81ff">\&#39;</span> innodb_flush_log_at_trx_commit
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_locks_unsafe_for_binlog<span style="color:#ae81ff">\&#39;</span> innodb_locks_unsafe_for_binlog
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_log_buffer_size<span style="color:#ae81ff">\&#39;</span> innodb_log_buffer_size
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_log_file_size<span style="color:#ae81ff">\&#39;</span> innodb_log_file_size
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_log_files_in_group<span style="color:#ae81ff">\&#39;</span> innodb_log_files_in_group
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_safe_binlog<span style="color:#ae81ff">\&#39;</span> innodb_safe_binlog
    mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_thread_concurrency<span style="color:#ae81ff">\&#39;</span> innodb_thread_concurrency

    cecho <span style="color:#e6db74">&#34;INNODB STATUS&#34;</span> boldblue
    innodb_indexes<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;/*!50000 SELECT IFNULL(SUM(INDEX_LENGTH),0) from information_schema.TABLES where ENGINE=&#39;InnoDB&#39; */&#34;</span><span style="color:#66d9ef">)</span>
    innodb_data<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;/*!50000 SELECT IFNULL(SUM(DATA_LENGTH),0) from information_schema.TABLES where ENGINE=&#39;InnoDB&#39; */&#34;</span><span style="color:#66d9ef">)</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -z <span style="color:#e6db74">&#34;</span>$innodb_indexes<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_buffer_pool_pages_data<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_pages_data
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_buffer_pool_pages_misc<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_pages_misc
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_buffer_pool_pages_free<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_pages_free
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_buffer_pool_pages_total<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_pages_total

      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_buffer_pool_read_ahead_seq<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_read_ahead_seq
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_buffer_pool_read_requests<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_read_requests

      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_os_log_pending_fsyncs<span style="color:#ae81ff">\&#39;</span> innodb_os_log_pending_fsyncs
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_os_log_pending_writes<span style="color:#ae81ff">\&#39;</span> innodb_os_log_pending_writes
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_log_waits<span style="color:#ae81ff">\&#39;</span> innodb_log_waits

      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_row_lock_time<span style="color:#ae81ff">\&#39;</span> innodb_row_lock_time
      mysql_status <span style="color:#ae81ff">\&#39;</span>Innodb_row_lock_waits<span style="color:#ae81ff">\&#39;</span> innodb_row_lock_waits

      human_readable $innodb_indexes innodb_indexesHR
      cecho <span style="color:#e6db74">&#34;Current InnoDB index space = </span>$innodb_indexesHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
      human_readable $innodb_data innodb_dataHR
      cecho <span style="color:#e6db74">&#34;Current InnoDB data space = </span>$innodb_dataHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
      percent_innodb_buffer_pool_free<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$innodb_buffer_pool_pages_free<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>$innodb_buffer_pool_pages_total<span style="color:#66d9ef">))</span>
      cecho <span style="color:#e6db74">&#34;Current InnoDB buffer pool free = &#34;</span>$percent_innodb_buffer_pool_free<span style="color:#e6db74">&#34; %&#34;</span>
    <span style="color:#66d9ef">else</span>
      cecho <span style="color:#e6db74">&#34;Cannot parse InnoDB stats prior to 5.0.x&#34;</span> red
      $mysql -s -e <span style="color:#e6db74">&#34;SHOW /*!50000 ENGINE */ INNODB STATUS\G&#34;</span>
    <span style="color:#66d9ef">fi</span>

    human_readable $innodb_buffer_pool_size innodb_buffer_pool_sizeHR
    cecho <span style="color:#e6db74">&#34;Current innodb_buffer_pool_size = </span>$innodb_buffer_pool_sizeHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span>
    cecho <span style="color:#e6db74">&#34;Depending on how much space your innodb indexes take up it may be safe&#34;</span>
    cecho <span style="color:#e6db74">&#34;to increase this value to up to 2 / 3 of total system memory&#34;</span>
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;No InnoDB Support Enabled!&#34;</span> boldred
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Total Memory Usage</span>
total_memory_used<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cecho <span style="color:#e6db74">&#34;MEMORY USAGE&#34;</span> boldblue

  mysql_variable <span style="color:#ae81ff">\&#39;</span>read_buffer_size<span style="color:#ae81ff">\&#39;</span> read_buffer_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>read_rnd_buffer_size<span style="color:#ae81ff">\&#39;</span> read_rnd_buffer_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>sort_buffer_size<span style="color:#ae81ff">\&#39;</span> sort_buffer_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>thread_stack<span style="color:#ae81ff">\&#39;</span> thread_stack
  mysql_variable <span style="color:#ae81ff">\&#39;</span>max_connections<span style="color:#ae81ff">\&#39;</span> max_connections
  mysql_variable <span style="color:#ae81ff">\&#39;</span>join_buffer_size<span style="color:#ae81ff">\&#39;</span> join_buffer_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>tmp_table_size<span style="color:#ae81ff">\&#39;</span> tmp_table_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>max_heap_table_size<span style="color:#ae81ff">\&#39;</span> max_heap_table_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>log_bin<span style="color:#ae81ff">\&#39;</span> log_bin
  mysql_status <span style="color:#ae81ff">\&#39;</span>Max_used_connections<span style="color:#ae81ff">\&#39;</span> max_used_connections

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$major_version<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3.23&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>record_buffer<span style="color:#ae81ff">\&#39;</span> read_buffer_size
    mysql_variable <span style="color:#ae81ff">\&#39;</span>record_rnd_buffer<span style="color:#ae81ff">\&#39;</span> read_rnd_buffer_size
    mysql_variable <span style="color:#ae81ff">\&#39;</span>sort_buffer<span style="color:#ae81ff">\&#39;</span> sort_buffer_size
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$log_bin<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ON&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    mysql_variable <span style="color:#ae81ff">\&#39;</span>binlog_cache_size<span style="color:#ae81ff">\&#39;</span> binlog_cache_size
  <span style="color:#66d9ef">else</span>
    binlog_cache_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $max_heap_table_size -le $tmp_table_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    effective_tmp_table_size<span style="color:#f92672">=</span>$max_heap_table_size
  <span style="color:#66d9ef">else</span>
    effective_tmp_table_size<span style="color:#f92672">=</span>$tmp_table_size
  <span style="color:#66d9ef">fi</span>

  per_thread_buffers<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;(</span>$read_buffer_size<span style="color:#e6db74">+</span>$read_rnd_buffer_size<span style="color:#e6db74">+</span>$sort_buffer_size<span style="color:#e6db74">+</span>$thread_stack<span style="color:#e6db74">+</span>$join_buffer_size<span style="color:#e6db74">+</span>$binlog_cache_size<span style="color:#e6db74">)*</span>$max_connections<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  per_thread_max_buffers<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;(</span>$read_buffer_size<span style="color:#e6db74">+</span>$read_rnd_buffer_size<span style="color:#e6db74">+</span>$sort_buffer_size<span style="color:#e6db74">+</span>$thread_stack<span style="color:#e6db74">+</span>$join_buffer_size<span style="color:#e6db74">+</span>$binlog_cache_size<span style="color:#e6db74">)*</span>$max_used_connections<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>

  mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_buffer_pool_size<span style="color:#ae81ff">\&#39;</span> innodb_buffer_pool_size
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $innodb_buffer_pool_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    innodb_buffer_pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_additional_mem_pool_size<span style="color:#ae81ff">\&#39;</span> innodb_additional_mem_pool_size
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $innodb_additional_mem_pool_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    innodb_additional_mem_pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  mysql_variable <span style="color:#ae81ff">\&#39;</span>innodb_log_buffer_size<span style="color:#ae81ff">\&#39;</span> innodb_log_buffer_size
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $innodb_log_buffer_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    innodb_log_buffer_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  mysql_variable <span style="color:#ae81ff">\&#39;</span>key_buffer_size<span style="color:#ae81ff">\&#39;</span> key_buffer_size
  mysql_variable <span style="color:#ae81ff">\&#39;</span>query_cache_size<span style="color:#ae81ff">\&#39;</span> query_cache_size
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $query_cache_size <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    query_cache_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  global_buffers<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$innodb_buffer_pool_size<span style="color:#e6db74">+</span>$innodb_additional_mem_pool_size<span style="color:#e6db74">+</span>$innodb_log_buffer_size<span style="color:#e6db74">+</span>$key_buffer_size<span style="color:#e6db74">+</span>$query_cache_size<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>

  max_memory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$global_buffers<span style="color:#e6db74">+</span>$per_thread_max_buffers<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>
  total_memory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$global_buffers<span style="color:#e6db74">+</span>$per_thread_buffers<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>

  pct_of_sys_mem<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;scale=0; </span>$total_memory<span style="color:#e6db74">*100/</span>$physical_memory<span style="color:#e6db74">&#34;</span> | bc -l<span style="color:#66d9ef">)</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $pct_of_sys_mem -gt <span style="color:#ae81ff">90</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    txt_color<span style="color:#f92672">=</span>boldred
    error<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">else</span>
    txt_color<span style="color:#f92672">=</span>
    error<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">fi</span>

  human_readable $max_memory max_memoryHR
  cecho <span style="color:#e6db74">&#34;Max Memory Ever Allocated : </span>$max_memoryHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span> $txt_color

  human_readable $per_thread_buffers per_thread_buffersHR
  cecho <span style="color:#e6db74">&#34;Configured Max Per-thread Buffers : </span>$per_thread_buffersHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span> $txt_color

  human_readable $global_buffers global_buffersHR
  cecho <span style="color:#e6db74">&#34;Configured Max Global Buffers : </span>$global_buffersHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span> $txt_color

  human_readable $total_memory total_memoryHR
  cecho <span style="color:#e6db74">&#34;Configured Max Memory Limit : </span>$total_memoryHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span> $txt_color

  human_readable $physical_memory physical_memoryHR
  cecho <span style="color:#e6db74">&#34;Physical Memory : </span>$physical_memoryHR<span style="color:#e6db74"> </span>$unit<span style="color:#e6db74">&#34;</span> $txt_color

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $error -eq <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    printf <span style="color:#e6db74">&#34;\n&#34;</span>
    cecho <span style="color:#e6db74">&#34;Max memory limit exceeds 90% of physical memory&#34;</span> $txt_color
  <span style="color:#66d9ef">else</span>
    cecho <span style="color:#e6db74">&#34;Max memory limit seem to be within acceptable norms&#34;</span> green
  <span style="color:#66d9ef">fi</span>
  unset txt_color
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Required Functions</span>
login_validation<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  check_for_socket          <span style="color:#75715e"># determine the socket location -- 1st login</span>
  check_for_plesk_passwords <span style="color:#75715e"># determine the login method -- 2nd login</span>
  check_mysql_login         <span style="color:#75715e"># determine if mysql is accepting login -- 3rd login</span>
  export major_version<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;SELECT SUBSTRING_INDEX(VERSION(), &#39;.&#39;, +2)&#34;</span><span style="color:#66d9ef">)</span>
  export mysql_version_num<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;SELECT VERSION()&#34;</span> |
    awk -F <span style="color:#ae81ff">\.</span> <span style="color:#e6db74">&#39;{ printf &#34;%02d&#34;, $1; printf &#34;%02d&#34;, $2; printf &#34;%02d&#34;, $3 }&#39;</span><span style="color:#66d9ef">)</span>
<span style="color:#f92672">}</span>

shared_info<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  export major_version<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;SELECT SUBSTRING_INDEX(VERSION(), &#39;.&#39;, +2)&#34;</span><span style="color:#66d9ef">)</span>
  export mysql_version_num<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>$mysql -Bse <span style="color:#e6db74">&#34;SELECT VERSION()&#34;</span> |
    awk -F <span style="color:#ae81ff">\.</span> <span style="color:#e6db74">&#39;{ printf &#34;%02d&#34;, $1; printf &#34;%02d&#34;, $2; printf &#34;%02d&#34;, $3 }&#39;</span><span style="color:#66d9ef">)</span>
  mysql_status <span style="color:#ae81ff">\&#39;</span>Questions<span style="color:#ae81ff">\&#39;</span> questions
  socket_owner<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ls -nH $socket | awk <span style="color:#e6db74">&#39;{ print $3 }&#39;</span><span style="color:#66d9ef">)</span>
<span style="color:#f92672">}</span>

get_system_info<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  export OS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>uname<span style="color:#66d9ef">)</span>

  <span style="color:#75715e"># Get information for various UNIXes</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$OS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Darwin&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    ps_socket<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -ln | awk <span style="color:#e6db74">&#39;/mysql(.*)?\.sock/ { print $9 }&#39;</span> | head -1<span style="color:#66d9ef">)</span>
    found_socks<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -ln | awk <span style="color:#e6db74">&#39;/mysql(.*)?\.sock/ { print $9 }&#39;</span><span style="color:#66d9ef">)</span>
    export physical_memory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>sysctl -n hw.memsize<span style="color:#66d9ef">)</span>
    export duflags<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$OS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;FreeBSD&#39;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$OS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;OpenBSD&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e">## On FreeBSD must be root to locate sockets.</span>
    ps_socket<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -ln | awk <span style="color:#e6db74">&#39;/mysql(.*)?\.sock/ { print $9 }&#39;</span> | head -1<span style="color:#66d9ef">)</span>
    found_socks<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -ln | awk <span style="color:#e6db74">&#39;/mysql(.*)?\.sock/ { print $9 }&#39;</span><span style="color:#66d9ef">)</span>
    export physical_memory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>sysctl -n hw.realmem<span style="color:#66d9ef">)</span>
    export duflags<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$OS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Linux&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e">## Includes SWAP</span>
    <span style="color:#75715e">## export physical_memory=$(free -b | grep -v buffers |  awk &#39;{ s += $2 } END { printf(&#34;%.0f\n&#34;, s ) }&#39;)</span>
    ps_socket<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -ln | awk <span style="color:#e6db74">&#39;/mysql(.*)?\.sock/ { print $9 }&#39;</span> | head -1<span style="color:#66d9ef">)</span>
    found_socks<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -ln | awk <span style="color:#e6db74">&#39;/mysql(.*)?\.sock/ { print $9 }&#39;</span><span style="color:#66d9ef">)</span>
    export physical_memory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>awk <span style="color:#e6db74">&#39;/^MemTotal/ { printf(&#34;%.0f&#34;, $2*1024 ) }&#39;</span> &lt; /proc/meminfo<span style="color:#66d9ef">)</span>
    export duflags<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-b&#39;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$OS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SunOS&#39;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    ps_socket<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -an | awk <span style="color:#e6db74">&#39;/mysql(.*)?.sock/ { print $5 }&#39;</span> | head -1<span style="color:#66d9ef">)</span>
    found_socks<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>netstat -an | awk <span style="color:#e6db74">&#39;/mysql(.*)?.sock/ { print $5 }&#39;</span><span style="color:#66d9ef">)</span>
    export physical_memory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>prtconf | awk <span style="color:#e6db74">&#39;/^Memory\ size:/ { print $3*1048576 }&#39;</span><span style="color:#66d9ef">)</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#66d9ef">$(</span>which bc<span style="color:#66d9ef">)</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;Error: Command line calculator &#39;bc&#39; not found!&#34;</span>
    exit
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">## Optional Components Groups</span>
banner_info<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  shared_info
  print_banner; echo
  check_mysql_version; echo
  post_uptime_warning; echo
<span style="color:#f92672">}</span>

misc<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  shared_info
  check_slow_queries; echo
  check_binary_log; echo
  check_threads; echo
  check_used_connections; echo
  check_innodb_status; echo
<span style="color:#f92672">}</span>

memory<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  shared_info
  total_memory_used; echo
  check_key_buffer_size; echo
  check_query_cache; echo
  check_sort_operations; echo
  check_join_operations; echo
<span style="color:#f92672">}</span>

file<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  shared_info
  check_open_files; echo
  check_table_cache; echo
  check_tmp_tables; echo
  check_table_scans; echo
  check_table_locking; echo
<span style="color:#f92672">}</span>

all<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  banner_info
  misc
  memory
  file
<span style="color:#f92672">}</span>

prompt<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  prompted<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>
  read -p <span style="color:#e6db74">&#34;Username [anonymous] : &#34;</span> user
  read -rp <span style="color:#e6db74">&#34;Password [&lt;none&gt;] : &#34;</span> pass
  cecho <span style="color:#e6db74">&#34; &#34;</span>
  read -p <span style="color:#e6db74">&#34;Socket [ /var/lib/mysql/mysql.sock ] : &#34;</span> socket

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $socket <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    export socket<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/var/lib/mysql/mysql.sock&#39;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $pass <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    export mysql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql -S </span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74">&#34;</span>
    export mysqladmin<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysqladmin -S </span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">else</span>
    export mysql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql -S </span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74"> -p</span>$pass<span style="color:#e6db74">&#34;</span>
    export mysqladmin<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysqladmin -S </span>$socket<span style="color:#e6db74"> -u</span>$user<span style="color:#e6db74"> -p</span>$pass<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>

  check_for_socket
  check_mysql_login

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>

  read -p <span style="color:#e6db74">&#34;Mode to test - banner, file, misc, mem, innodb, [all] : &#34;</span> REPLY

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z $REPLY <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    REPLY<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;all&#39;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#66d9ef">case</span> $REPLY in
    banner|BANNER|header|HEADER|head|HEAD<span style="color:#f92672">)</span>
      banner_info
      ;;
    misc|MISC|miscelaneous<span style="color:#f92672">)</span>
      misc
      ;;
    mem|memory|MEM|MEMORY<span style="color:#f92672">)</span>
      memory
      ;;
    file|FILE|disk|DISK<span style="color:#f92672">)</span>
      file
      ;;
    innodb|INNODB<span style="color:#f92672">)</span>
      innodb
      ;;
    all|ALL<span style="color:#f92672">)</span>
      cecho <span style="color:#e6db74">&#34; &#34;</span>
      all
      ;;
    *<span style="color:#f92672">)</span>
      cecho <span style="color:#e6db74">&#34;Invalid Mode!  Valid options are &#39;banner&#39;, &#39;misc&#39;, &#39;memory&#39;, &#39;file&#39;, &#39;innodb&#39; or &#39;all&#39;&#34;</span> boldred
      exit <span style="color:#ae81ff">1</span>
      ;;
  <span style="color:#66d9ef">esac</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Address environmental differences</span>
get_system_info

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  login_validation
  mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ALL&#39;</span>
<span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;prompt&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PROMPT&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  mode<span style="color:#f92672">=</span>$1
<span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;prompt&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PROMPT&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  login_validation
  mode<span style="color:#f92672">=</span>$1
<span style="color:#66d9ef">fi</span>

<span style="color:#66d9ef">case</span> $mode in
  all|ALL<span style="color:#f92672">)</span>
    cecho <span style="color:#e6db74">&#34; &#34;</span>
    all
    ;;
  mem|memory|MEM|MEMORY<span style="color:#f92672">)</span>
    cecho <span style="color:#e6db74">&#34; &#34;</span>
    memory
    ;;
  file|FILE|disk|DISK<span style="color:#f92672">)</span>
    cecho <span style="color:#e6db74">&#34; &#34;</span>
    file
    ;;
  banner|BANNER|header|HEADER|head|HEAD<span style="color:#f92672">)</span>
    banner_info
    ;;
  misc|MISC|miscelaneous<span style="color:#f92672">)</span>
    cecho <span style="color:#e6db74">&#34; &#34;</span>
    misc
    ;;
  innodb|INNOD <span style="color:#f92672">)</span>
    banner_info
    check_innodb_status; echo
    ;;
  prompt|PROMPT<span style="color:#f92672">)</span>
    prompt
    ;;
  *<span style="color:#f92672">)</span>
    cecho <span style="color:#e6db74">&#34;usage: </span>$0<span style="color:#e6db74"> [ all | banner | file | innodb | memory | misc | prompt ]&#34;</span> boldred
    exit <span style="color:#ae81ff">1</span>
    ;;
<span style="color:#66d9ef">esac</span></code></pre></div>
</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/notes/nfs/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>NFS</a>
    </div><div class='next-entry sep-before'>
      <a href='/notes/mysql/'>
        <span class='screen-reader-text'>Next post: </span>MySQL<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2018 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.59f76c44.js'></script>

</body>

</html>

