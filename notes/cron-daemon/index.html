<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="sam@stelfox.net Sam Stelfox ">
<meta name="description" content="Cron is a pretty standard utility and there isn&amp;rsquo;t much to it. I generally use cronie as my cron daemon with the associated anacron. Cron runs tasks periodically, and anacron helps ensure that a missed task will get run if it was off or powercycled when it would have otherwise run.
File Format The config format differs slightly between crontabs, regular cron files, and anacron entries. At the beginning of all the files environment variables can be set using key=value pairs to control the behavior of cron and anacron followed by entries for that file one to a line." />
<meta name="keywords" content="blog, programming, linux, systems, personal, linux" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://stelfox.net/notes/cron-daemon/" />


    <title>
        
            Cron Daemon :: Sam Stelfox 
        
    </title>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link rel="stylesheet" href="/main.2a064c455b0ecbd6b1481b3bf9df2441e95838691022f40a5338c2cb1244f075.css" integrity="sha256-KgZMRVsOy9axSBs7&#43;d8kQelYOGkQIvQKUzjCyxJE8HU=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Cron Daemon">
<meta itemprop="description" content="Cron is a pretty standard utility and there isn&rsquo;t much to it. I generally use cronie as my cron daemon with the associated anacron. Cron runs tasks periodically, and anacron helps ensure that a missed task will get run if it was off or powercycled when it would have otherwise run.
File Format The config format differs slightly between crontabs, regular cron files, and anacron entries. At the beginning of all the files environment variables can be set using key=value pairs to control the behavior of cron and anacron followed by entries for that file one to a line."><meta itemprop="datePublished" content="2017-10-26T17:35:42-04:00" />
<meta itemprop="dateModified" content="2017-10-26T17:35:42-04:00" />
<meta itemprop="wordCount" content="979">
<meta itemprop="keywords" content="linux," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cron Daemon"/>
<meta name="twitter:description" content="Cron is a pretty standard utility and there isn&rsquo;t much to it. I generally use cronie as my cron daemon with the associated anacron. Cron runs tasks periodically, and anacron helps ensure that a missed task will get run if it was off or powercycled when it would have otherwise run.
File Format The config format differs slightly between crontabs, regular cron files, and anacron entries. At the beginning of all the files environment variables can be set using key=value pairs to control the behavior of cron and anacron followed by entries for that file one to a line."/>



    <meta property="og:title" content="Cron Daemon" />
<meta property="og:description" content="Cron is a pretty standard utility and there isn&rsquo;t much to it. I generally use cronie as my cron daemon with the associated anacron. Cron runs tasks periodically, and anacron helps ensure that a missed task will get run if it was off or powercycled when it would have otherwise run.
File Format The config format differs slightly between crontabs, regular cron files, and anacron entries. At the beginning of all the files environment variables can be set using key=value pairs to control the behavior of cron and anacron followed by entries for that file one to a line." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stelfox.net/notes/cron-daemon/" /><meta property="article:section" content="notes" />
<meta property="article:published_time" content="2017-10-26T17:35:42-04:00" />
<meta property="article:modified_time" content="2017-10-26T17:35:42-04:00" />






    <meta property="article:published_time" content="2017-10-26 17:35:42 -0400 EDT" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                ./Sam_Stelfox.sh</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/blog/">Blog Posts</a></li><li><a href="/notes/">Various Notes</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://stelfox.net/notes/cron-daemon/">Cron Daemon</a></h2>

            
            
            

            <div class="post-content">
                <p>Cron is a pretty standard utility and there isn&rsquo;t much to it. I generally use
<code>cronie</code> as my cron daemon with the associated <code>anacron</code>. Cron runs tasks
periodically, and anacron helps ensure that a missed task will get run if it
was off or powercycled when it would have otherwise run.</p>
<h2 id="file-format">File Format</h2>
<p>The config format differs slightly between crontabs, regular cron files, and
anacron entries. At the beginning of all the files environment variables can be
set using <code>key=value</code> pairs to control the behavior of <code>cron</code> and <code>anacron</code>
followed by entries for that file one to a line.  The first five portions of
the cron and crontab entry format consist of numbers, steps, ranges, lists, or
the wildcard <code>*</code> character.</p>
<p>The fields are in order minutes (can be 0-59), hours (0-23), date (1-31), month
(1-12), and day of week (0-6, 0 being Sunday, and 6 being Saturday). The
wildcard character matches all values for the field. A hyphen can be used to
specify a range of numbers (such as 0-5 for the first six hours of a day). A
comma can be used to specify several numbers or ranges (0,20-23 for minutes
would be at the top of the hour and each of the four minutes between 20 and
23). The last one is step values which specifies every Nth value starting at
the lower end of the range (*/5 is every five minutes, 3-23/7 is every seventh
hour starting at 3 which would be 3, 10 and 17).</p>
<p>For cron files the next field is the username. The username is omitted from
crontabs as that is implicitely implied by the user that created it. And lastly
is the command that should be run. The following is a sample cron config that
you definitely should not put on your system:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># /etc/cron.d/sample
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SHELL=/bin/bash
</span></span><span style="display:flex;"><span>PATH=/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style="display:flex;"><span>MAILTO=root
</span></span><span style="display:flex;"><span>HOME=/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># On the 23rd minute after midnight the next time there is a Friday the 13th...
</span></span><span style="display:flex;"><span># execute a fork bomb... spoooookkyy alerts
</span></span><span style="display:flex;"><span>23 0 13 * 5 root /bin/bash -c &#39;:(){ :|: &amp; };:&#39;
</span></span></code></pre></div><p>Anacron has a different file format and can be found at <code>/etc/anacrontab</code>.
The variables at the header are generally the same The
format is period in days, the delay in minutes for anacron to execute the job
(can be useful to spread the jobs around), a unique job identifier name for
logging purposes, and finally a script or command to be run. A sample might
look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># /etc/anacrontab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SHELL=/bin/sh
</span></span><span style="display:flex;"><span>PATH=/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style="display:flex;"><span>MAILTO=root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># the maximal random delay added to the base delay of the jobs
</span></span><span style="display:flex;"><span>RANDOM_DELAY=45
</span></span><span style="display:flex;"><span># the jobs will be started during the following hours only
</span></span><span style="display:flex;"><span>START_HOURS_RANGE=3-22
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Period   Delay  Job ID        Command
</span></span><span style="display:flex;"><span>1          5      cron.daily    nice run-parts /etc/cron.daily
</span></span><span style="display:flex;"><span>7          25     cron.weekly   nice run-parts /etc/cron.weekly
</span></span><span style="display:flex;"><span>@monthly   45     cron.monthly  nice run-parts /etc/cron.monthly
</span></span></code></pre></div><h2 id="restricting-access">Restricting Access</h2>
<p>Tasks executed through cron will be executed with the privileges of the user
who created the crontab but can be done while they&rsquo;re not present. It is
generally a good idea to whitelist users to prevent abuse of resources on a
system. In practice this tends to be pretty easy to manage as most interactive
users tend to not need scheduled tasks like this (IMHO at least).</p>
<p>The primary means of restricting access is through the <code>/etc/cron.allow</code>, and
<code>/etc/cron.deny</code>. If the &ldquo;allow&rdquo; file exists the &ldquo;deny&rdquo; file will be ignored.
If neither exist then all users will be able to use <code>cron</code>. The files
themselves consist of one username per line with no leading or trailing
whitespace.</p>
<p>Starting out with an empty whitelist still allows for root to run cron tasks
but prevents any user on that system from executing them until added. This can
be done with the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>touch /etc/cron.allow
</span></span></code></pre></div><p>You can confirm the restriction from any user account by running the following
command (you&rsquo;ll see the same error):</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ crontab -l
</span></span><span style="display:flex;"><span>You <span style="color:#ff7b72;font-weight:bold">(</span>testuser<span style="color:#ff7b72;font-weight:bold">)</span> are not allowed to use this program <span style="color:#ff7b72;font-weight:bold">(</span>crontab<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>See crontab<span style="color:#ff7b72;font-weight:bold">(</span>1<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72">for</span> more information
</span></span></code></pre></div><p>The allow and deny files don&rsquo;t support specifying groups (which would generally
make access management to these significantly easier). This can be worked
around using the <code>pam_listfile</code> module but doesn&rsquo;t provide as much context when
a user is prevented to run a cron job. A user who is not permitted to run cron
jobs through PAM will have their configured jobs silently fail (the system log
will reflect the failure).</p>
<p>Add the following line to <code>/etc/pam.d/crond</code> session section:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>session    required   pam_listfile.so item=group sense=allow file=/etc/cron.groups.allow onerr=fail
</span></span></code></pre></div><p>Create a file <code>/etc/cron.groups.allow</code> with the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>crontab
</span></span></code></pre></div><p>This assumes the group <code>crontab</code> already exists on your system. To allow a user
to run cron entries they now just need to be added to the <code>crontab</code> group. If
they are not, they&rsquo;ll still be able to edit, view, and clear their crontab
entries but when they attempt to execute, lines like the following will show up
in the system logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>2017-10-26T22:52:01.000000+00:00 collapsed-autumn-sound crond[706]: pam_listfile(crond:session): Refused user testuser for service crond
</span></span><span style="display:flex;"><span>2017-10-26T22:52:01.000000+00:00 collapsed-autumn-sound crond[702]: (testuser) PAM ERROR (Authentication failure)
</span></span><span style="display:flex;"><span>2017-10-26T22:52:01.000000+00:00 collapsed-autumn-sound crond[702]: (testuser) FAILED to open PAM security session (Authentication failure)
</span></span></code></pre></div><h2 id="ensure-tasks-dont-overlap">Ensure Tasks Don&rsquo;t Overlap</h2>
<p>One trick I&rsquo;ve picked up to ensure that a periodically running long command
doesn&rsquo;t overlap with itself (for example a backup script, or scrubbing a large
ZFS pool).</p>
<p>This can be done with the <code>flock</code> utility, it creates an empty file with a lock
on it that is released when your command or script is finished executing. If it
can&rsquo;t obtain the lock, it simply won&rsquo;t run your script and return a bad exit
code. Be sure to use a unique lock file for each task.</p>
<p>An example of how to do this would look in a user&rsquo;s crontab would look like the
following:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>0 0 * * * /usr/bin/flock --nonblock /tmp/backup.lock $HOME/scripts/full_backup.sh
</span></span></code></pre></div><p>You can have flock wait for any number of seconds by replacing <code>--nonblock</code>
with <code>--wait 300</code> (300 being five minutes).</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://stelfox.net/tags/linux/">linux</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.c90b8161416b87c69a8e02683b54ddd6edb90aea699648bf655e6cbc45b419b8e465d196e715772463dba35a6faf5decb2eb247480d38680484d54645b434570.js" integrity="sha512-yQuBYUFrh8aajgJoO1Td1u25Cupplki/ZV5svEW0GbjkZdGW5xV3JGPbo1pvr13ssuskdIDThoBITVRkW0NFcA=="></script>



    </body>
</html>
