<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="ConfiguringThis page is referring to TRIM support for SSDs. To enable it add &amp;quot;noatime,discard&amp;quot; to the options on all of the fstab partition entries that live on the drive. Be sure to disable any swap partitions that live on that drive as well.
Note on Encrypted DrivesTurning TRIM support on for an encrypted hard drive will not actually do anything. &amp;quot;discard&amp;quot; is a file system level option and full disk encryption lives below that."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,disk,encryption,linux"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/trim/><title>Trim :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Trim"><meta itemprop=description content='ConfiguringThis page is referring to TRIM support for SSDs. To enable it add "noatime,discard" to the options on all of the fstab partition entries that live on the drive. Be sure to disable any swap partitions that live on that drive as well.
Note on Encrypted DrivesTurning TRIM support on for an encrypted hard drive will not actually do anything. "discard" is a file system level option and full disk encryption lives below that.'><meta itemprop=datePublished content="2013-01-01T00:00:01+00:00"><meta itemprop=dateModified content="2013-01-01T00:00:01+00:00"><meta itemprop=wordCount content="679"><meta itemprop=keywords content="Disk,Encryption,Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="Trim"><meta name=twitter:description content='ConfiguringThis page is referring to TRIM support for SSDs. To enable it add "noatime,discard" to the options on all of the fstab partition entries that live on the drive. Be sure to disable any swap partitions that live on that drive as well.
Note on Encrypted DrivesTurning TRIM support on for an encrypted hard drive will not actually do anything. "discard" is a file system level option and full disk encryption lives below that.'><meta property="article:published_time" content="2013-01-01 00:00:01 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/trim/>Trim</a></h2><div class=post-content><h2 id=configuring>Configuring</h2><p>This page is referring to TRIM support for SSDs. To enable it add "noatime,discard" to the options on all of the fstab partition entries that live on the drive. Be sure to disable any swap partitions that live on that drive as well.</p><h3 id=note-on-encrypted-drives>Note on Encrypted Drives</h3><p>Turning TRIM support on for an encrypted hard drive will not actually do anything. "discard" is a file system level option and full disk encryption lives below that. It makes sense that it doesn't work, writing a sector full of 0s to an encrypted partition will result in a sector of encrypted 0s which will look more or less like random garbage.</p><p>There is a trick to allow this to work but I'm not will to go that route due to the security implications of allowing attackers to see where the data lives on my hard drive and where it doesn't, but for completeness, I'm documenting (untested) what needs to be done to enable this.</p><p>You'll need to replace "&lt;your_device>" with the DM mapper crypted partition such as "/dev/mapper/vg_desktop-lv_root". You'll want to do this for all of the encrypted partitions on the drive.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> dmsetup table &lt;your_device&gt; --showkeys
</span></span><span class=line><span class=cl><span class=gp>$</span> dmsetup load &lt;your_device&gt; --<span class=s2>&#34;&lt;line above&gt; 1 allow_discards&#34;</span>
</span></span><span class=line><span class=cl><span class=gp>$</span> dmsetup resume &lt;your_device&gt;
</span></span></code></pre></td></tr></table></div></div><p>Even without TRIM support noatime and no swap partitions are still good performance improvements.</p><h2 id=testing>Testing</h2><p>This requires you install the "hdparm" package on Fedora.</p><p>To test and make sure that trim support is working, make sure you're in a directory that lives on a partition on the SSD, then create a test file like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5>5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6>6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> seq <span class=m>1</span> <span class=m>1000</span> &gt; trimtest
</span></span><span class=line><span class=cl><span class=gp>$</span> sync
</span></span><span class=line><span class=cl><span class=gp>$</span> hdparm --fibmap trimtest
</span></span><span class=line><span class=cl><span class=go>trimtest:
</span></span></span><span class=line><span class=cl><span class=go> filesystem blocksize 4096, begins at LBA 0; assuming 512 byte sectors.
</span></span></span><span class=line><span class=cl><span class=go> byte_offset  begin_LBA    end_LBA    sectors
</span></span></span><span class=line><span class=cl><span class=go>           0   25565616   25565623          8
</span></span></span></code></pre></td></tr></table></div></div><p>The important thing to take into account is the "begin_LBA" column make note of this number and use it in place in the following commands. You'll need to replace "/dev/sda" with the device name matching your SSD.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24>24</a>
</span><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25>25</a>
</span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29>29</a>
</span><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30>30</a>
</span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> hdparm --read-sector <span class=m>25565616</span> /dev/sda
</span></span><span class=line><span class=cl><span class=go>/dev/sda:
</span></span></span><span class=line><span class=cl><span class=go>reading sector 25565616: succeeded
</span></span></span><span class=line><span class=cl><span class=go>bb2d 06dc 87c3 6bb6 c43c fab7 a0a9 12db
</span></span></span><span class=line><span class=cl><span class=go>9e35 2246 4ae3 9eaf 373e 3ce3 ea75 2657
</span></span></span><span class=line><span class=cl><span class=go>4bb9 e299 c9cf eee9 c74b bb86 9b25 b36c
</span></span></span><span class=line><span class=cl><span class=go>5214 bf13 7f2b 0cf3 9866 6b7e 0344 8f33
</span></span></span><span class=line><span class=cl><span class=go>4ea4 0cdc 6ad3 f3e2 8a72 4032 b0d5 7c8c
</span></span></span><span class=line><span class=cl><span class=go>2002 82cc d631 6f80 0967 e698 5e7c b9c3
</span></span></span><span class=line><span class=cl><span class=go>c660 9953 ed1e 832f 29a2 7c46 5fab f7e0
</span></span></span><span class=line><span class=cl><span class=go>8705 6c74 10d2 3649 6b4c 136e e3ba b36f
</span></span></span><span class=line><span class=cl><span class=go>21dd f96e 9d7c 7c9e 8596 0c0b 67df 76fe
</span></span></span><span class=line><span class=cl><span class=go>6797 608c 0f42 145e b381 4efe 754f bd59
</span></span></span><span class=line><span class=cl><span class=go>8575 d75e 95b0 7281 f454 c364 43ab 11dd
</span></span></span><span class=line><span class=cl><span class=go>79a4 e3b2 1b11 67fa ec04 5d73 6ed9 d77b
</span></span></span><span class=line><span class=cl><span class=go>bebe 3df2 086c 26e3 ac8e c6b3 0591 370f
</span></span></span><span class=line><span class=cl><span class=go>5c9c ec7f 777e 15de 23e0 d432 5b8a 460a
</span></span></span><span class=line><span class=cl><span class=go>132c d09c a81d 3683 79ff c7de 4631 f88f
</span></span></span><span class=line><span class=cl><span class=go>fa53 5aa6 0286 1817 0dde 85c8 84bc 3a03
</span></span></span><span class=line><span class=cl><span class=go>f8b1 60eb e1ca 5f1e 2094 eba9 ec61 6fe8
</span></span></span><span class=line><span class=cl><span class=go>7214 1a0c 88e1 4dac 5f3c f3b7 9d29 7dfd
</span></span></span><span class=line><span class=cl><span class=go>2c2a 6539 a675 a755 482b 31c8 755c 832c
</span></span></span><span class=line><span class=cl><span class=go>e166 25b9 539d e0a2 2360 217b 79ec a7d9
</span></span></span><span class=line><span class=cl><span class=go>9930 e7a7 3af7 d318 83aa 1098 81c2 161f
</span></span></span><span class=line><span class=cl><span class=go>e55c 6c45 4641 b4e8 8aeb 58e3 e199 74d5
</span></span></span><span class=line><span class=cl><span class=go>b6ff 93a1 da35 11e9 c3f3 e84d 10e8 ee5b
</span></span></span><span class=line><span class=cl><span class=go>094f f905 af0e 2872 a683 4836 9d7b 1dba
</span></span></span><span class=line><span class=cl><span class=go>c528 e972 f72d 1575 a116 bc3d 44b4 970c
</span></span></span><span class=line><span class=cl><span class=go>db54 690e 2434 3c4e 9eec 2b60 6ccf 4765
</span></span></span><span class=line><span class=cl><span class=go>6f90 b0bc 7f15 9bd5 6213 3b4b c477 9972
</span></span></span><span class=line><span class=cl><span class=go>cb27 d777 afcb d95e 1528 2ecd 5d2e 63c9
</span></span></span><span class=line><span class=cl><span class=go>a25e 9132 39af dab4 81db ea9e a168 204e
</span></span></span><span class=line><span class=cl><span class=go>f162 8616 7c6a c7e3 bdb2 cb5c 7620 fd43
</span></span></span><span class=line><span class=cl><span class=go>17af b869 978d 6b58 c54f fdc9 8a37 01d2
</span></span></span><span class=line><span class=cl><span class=go>f82e b721 631b 3888 bb27 874c 872a 28e0
</span></span></span></code></pre></td></tr></table></div></div><p>Now we'll remove the file, sync the filesystem and check that sector again:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> rm -f trimtest
</span></span><span class=line><span class=cl><span class=gp>$</span> sync
</span></span><span class=line><span class=cl><span class=gp>$</span> hdparm --read-sector <span class=m>25565616</span> /dev/sda
</span></span></code></pre></td></tr></table></div></div><p>If trim support is working the sector read should be all 0s.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/disk/>disk</a></span>
<span class=tag><a href=https://stelfox.net/tags/encryption/>encryption</a></span>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=fbd8ca38d421539154d91c5d7396464201f62ccb target=_blank rel=noopener>fbd8ca38</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>