<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
This page goes through how to create a local PKI infrastructure for use with all the other components listed in my notes and many may not mention it at all. It uses OpenSSL and provides scripts, information about choices made during the process and where to go next.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Building a Certificate Authority • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='Note: This page is quite old and is likely out of date. My opinions may have also changed dramatically since this was written. It is here as a reference until I get around to updating it.
This page goes through how to create a local PKI infrastructure for use with all the other components listed in my notes and many may not mention it at all. It uses OpenSSL and provides scripts, information about choices made during the process and where to go next.'>
<meta property='og:url' content='https://stelfox.net/notes/building-a-certificate-authority/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='notes'><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.61.0-DEV" />

  <title>Building a Certificate Authority • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/notes/building-a-certificate-authority/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-notes'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Building a Certificate Authority</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='0001-01-01T00:00:00Z'>0001, Jan 01</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
7 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p><em><strong>Note: This page is quite old and is likely out of date. My opinions may have
also changed dramatically since this was written. It is here as a reference
until I get around to updating it.</strong></em></p>
<p>This page goes through how to create a local PKI infrastructure for use with
all the other components listed in my notes and many may not mention it at all.
It uses OpenSSL and provides scripts, information about choices made during the
process and where to go next.</p>
<h2 id="security-notes">Security Notes</h2>
<p>There are varying levels of security that need to be taken into account
throughout this process. The first and most important certificate is the &lsquo;root&rsquo;
certificate authority's certificate. If the private key for this is compromised
everything else will need to be done by scratch. Additionally the private key
needs to be generated from a true random source. This is important as a little
bit of predictability will impair all future operations done with this
certificate and thus all encrypted operations done from certificates at the
heart of this system.</p>
<p>Second level certificate authorities should still be protected with utmost
caution, but these are for secondary services such as one for the [Linux/389
Directory Server] to hand out certificates, another for [Linux/OpenVPN]
certificates, one for websites and perhaps even another for personal
certificates for email and code signing. If one of these gets compromised the
root certificate can issue a CRL automatically invalidating all certificates
from that authority and limits the damage done.</p>
<h2 id="root-ca">Root CA</h2>
<p>Caution needs to be taken when working with the root certificate from the get
go. It should be generated on a clean machine disconnected from the network.</p>
<h3 id="support-structure">Support Structure</h3>
<p>The following set of commands builds a directory structure in the current
user's home drive in a folder called pki. It adjusts the permissions on the
folders to ensure that it is somewhat protected (though not protected from the
root user). Once again this should be performed on a trusted machine.</p>
<pre><code>mkdir -p ~/pki/root/{certs,crl,newcerts,private}
chown -R `id -u`:`id -g` ~/pki
chmod -R 700 ~/pki
</code></pre><h3 id="create-the-configuration-file">Create the Configuration File</h3>
<p>Create a file in the root CA's directory named openssl.cnf with the following
contents:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">HOME</span>                    <span style="color:#f92672">=</span> <span style="color:#e6db74">.</span>
<span style="color:#a6e22e">RANDFILE</span>                <span style="color:#f92672">=</span> <span style="color:#e6db74">$ENV::HOME/.rnd</span>
<span style="color:#a6e22e">oid_section</span>             <span style="color:#f92672">=</span> <span style="color:#e6db74">new_oids</span>

<span style="color:#66d9ef">[ new_oids ]</span>

<span style="color:#66d9ef">[ ca ]</span>
<span style="color:#a6e22e">default_ca</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">CA_default</span>

<span style="color:#66d9ef">[ CA_default ]</span>
<span style="color:#a6e22e">dir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/home/sstelfox/pki             # The root directory</span>
<span style="color:#a6e22e">certs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/certs                   # Where the issued certs are kept</span>
<span style="color:#a6e22e">crl_dir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/crl                   # Where the issued crl are kept</span>
<span style="color:#a6e22e">database</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/index.txt            # Database index file.</span>
<span style="color:#a6e22e">unique_subject</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">yes</span>
<span style="color:#a6e22e">new_certs_dir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/newcerts        # Default place for new certs.</span>

<span style="color:#a6e22e">certificate</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/cacert.pem        # The CA certificate</span>
<span style="color:#a6e22e">serial</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/serial                 # The current serial number</span>
<span style="color:#a6e22e">crlnumber</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/crlnumber           # The current crl number</span>
<span style="color:#a6e22e">crl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/crl.pem                   # The current CRL</span>
<span style="color:#a6e22e">private_key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/private/ca.key # The private key</span>
<span style="color:#a6e22e">RANDFILE</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">$dir/private/.rand        # Private random number file</span>

<span style="color:#a6e22e">x509_extensions</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">usr_cert           # The extentions to add to the cert</span>

<span style="color:#a6e22e">name_opt</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ca_default                # Subject Name options</span>
<span style="color:#a6e22e">cert_opt</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ca_default                # Certificate field options</span>

<span style="color:#a6e22e">crl_extensions</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">crl_ext</span>

<span style="color:#a6e22e">default_days</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">365                   # How long to certify for</span>
<span style="color:#a6e22e">default_crl_days</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">7                 # How long before next CRL</span>
<span style="color:#a6e22e">default_md</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">sha256                  # Use sha256 for the hash</span>
<span style="color:#a6e22e">preserve</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">no                        # Keep passed DN ordering</span>
<span style="color:#a6e22e">policy</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">policy_match</span>

<span style="color:#75715e"># For the CA policy</span>
<span style="color:#66d9ef">[ policy_match ]</span>
<span style="color:#a6e22e">countryName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">match</span>
<span style="color:#a6e22e">stateOrProvinceName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">match</span>
<span style="color:#a6e22e">organizationName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">match</span>
<span style="color:#a6e22e">organizationalUnitName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>
<span style="color:#a6e22e">commonName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">supplied</span>
<span style="color:#a6e22e">emailAddress</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>

<span style="color:#66d9ef">[ policy_anything ]</span>
<span style="color:#a6e22e">countryName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>
<span style="color:#a6e22e">stateOrProvinceName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>
<span style="color:#a6e22e">localityName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>
<span style="color:#a6e22e">organizationName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>
<span style="color:#a6e22e">organizationalUnitName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>
<span style="color:#a6e22e">commonName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">supplied</span>
<span style="color:#a6e22e">emailAddress</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">optional</span>

<span style="color:#75715e">###################### CA Request Defaults ##########################</span>
<span style="color:#66d9ef">[ req ]</span>
<span style="color:#a6e22e">default_bits</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">4096</span>
<span style="color:#a6e22e">default_md</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">sha256</span>
<span style="color:#a6e22e">default_keyfile</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">priv.key</span>
<span style="color:#a6e22e">distinguished_name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">req_distinguished_name</span>
<span style="color:#a6e22e">attributes</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">req_attributes</span>
<span style="color:#a6e22e">x509_extensions</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">v3_ca # The extentions to add to the self signed cert</span>

<span style="color:#a6e22e">string_mask</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">utf8only</span>

<span style="color:#66d9ef">[ req_distinguished_name ]</span>
<span style="color:#a6e22e">countryName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Country Name</span>
<span style="color:#a6e22e">countryName_default</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">AC</span>
<span style="color:#a6e22e">countryName_min</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
<span style="color:#a6e22e">countryName_max</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>

<span style="color:#a6e22e">stateOrProvinceName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">State or Province Name (full name)</span>
<span style="color:#a6e22e">stateOrProvinceName_default</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">YmVkcm9vbXByb2dyYW1tZXJzLm5ldA==</span>

<span style="color:#a6e22e">localityName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Locality Name</span>
<span style="color:#a6e22e">localityName_default</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">dHJ1ZWR1YWxpdHk=</span>

<span style="color:#a6e22e">0.organizationName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Organization Name</span>
<span style="color:#a6e22e">0.organizationName_default</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">QmVkcm9vbSBQcm9ncmFtbWVycyAtIENvZGUgVGhlIFBsYW5ldA==</span>

<span style="color:#a6e22e">organizationalUnitName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Organizational Unit Name (eg, section)</span>
<span style="color:#a6e22e">organizationalUnitName_default</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">QWRtaW5pc3RyYXRpb24=</span>

<span style="color:#a6e22e">commonName</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">Common Name (User\&#39;s name the server\&#39;s hostname)</span>
<span style="color:#a6e22e">commonName_max</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">64</span>

<span style="color:#a6e22e">emailAddress</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">Email Address</span>
<span style="color:#a6e22e">emailAddress_max</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">64</span>

<span style="color:#66d9ef">[ req_attributes ]</span>
<span style="color:#a6e22e">challengePassword</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">A challenge password</span>
<span style="color:#a6e22e">challengePassword_min</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">4</span>
<span style="color:#a6e22e">challengePassword_max</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">24</span>

<span style="color:#66d9ef">[ usr_cert ]</span>
<span style="color:#a6e22e">basicConstraints</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">CA:false</span>

<span style="color:#75715e"># These two are the only expected use cases at the time for this CA. If it is</span>
<span style="color:#75715e"># omitted the certificate can be used for anything *except* object signing.</span>
<span style="color:#75715e"># nsCertType = server</span>
<span style="color:#75715e"># nsCertType = client, email, objsign</span>

<span style="color:#75715e"># This is typical in keyUsage for a client certificate.</span>
<span style="color:#75715e"># keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span>

<span style="color:#a6e22e">nsComment</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Certificate issued by BedroomProgrammers.net&#34;</span>

<span style="color:#75715e"># PKIX recommendations harmless if included in all certificates.</span>
<span style="color:#a6e22e">subjectKeyIdentifier</span><span style="color:#f92672">=</span><span style="color:#e6db74">hash</span>
<span style="color:#a6e22e">authorityKeyIdentifier</span><span style="color:#f92672">=</span><span style="color:#e6db74">keyid,issuer</span>

<span style="color:#75715e"># This stuff is for subjectAltName and issuerAltname.</span>
<span style="color:#75715e"># Import the email address.</span>
<span style="color:#75715e"># subjectAltName=email:copy</span>
<span style="color:#75715e"># An alternative to produce certificates that aren&#39;t</span>
<span style="color:#75715e"># deprecated according to PKIX.</span>
<span style="color:#75715e"># subjectAltName=email:move</span>

<span style="color:#75715e"># Location of the public cert</span>
<span style="color:#a6e22e">issuerAltName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">URI:http://bedroomprogrammers.net/bpca.crt</span>

<span style="color:#75715e"># Information about the certificates</span>
<span style="color:#a6e22e">nsCaRevocationUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/bpca.crl</span>
<span style="color:#a6e22e">nsBaseUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/</span>
<span style="color:#a6e22e">nsRevocationUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/revoke/?</span>
<span style="color:#a6e22e">nsRenewalUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/renew/?</span>
<span style="color:#a6e22e">nsCaPolicyUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/policy/</span>

<span style="color:#75715e"># This is required for TSA certificates.</span>
<span style="color:#75715e"># extendedKeyUsage = critical,timeStamping</span>

<span style="color:#66d9ef">[ v3_req ]</span>
<span style="color:#75715e"># Extensions to add to a certificate request</span>

<span style="color:#a6e22e">basicConstraints</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">CA:false</span>
<span style="color:#a6e22e">keyUsage</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">nonRepudiation, digitalSignature, keyEncipherment</span>

<span style="color:#66d9ef">[ v3_ca ]</span>
<span style="color:#75715e"># Extensions for a typical CA</span>

<span style="color:#75715e"># PKIX recommendation.</span>
<span style="color:#a6e22e">subjectKeyIdentifier</span><span style="color:#f92672">=</span><span style="color:#e6db74">hash</span>
<span style="color:#a6e22e">authorityKeyIdentifier</span><span style="color:#f92672">=</span><span style="color:#e6db74">keyid:always,issuer</span>

<span style="color:#75715e"># This may break some older clients</span>
<span style="color:#a6e22e">basicConstraints</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">critical,CA:true</span>
<span style="color:#75715e"># If this happens the certificate will have to be remade using this option:</span>
<span style="color:#75715e">#basicConstraints = CA:true</span>

<span style="color:#75715e"># Some might want this also</span>
<span style="color:#75715e"># nsCertType = sslCA, emailCA</span>

<span style="color:#75715e"># Include email address in subject alt name: another PKIX recommendation</span>
<span style="color:#75715e"># subjectAltName=email:copy</span>
<span style="color:#75715e"># Copy issuer details</span>
<span style="color:#a6e22e">issuerAltName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">URI:http://bedroomprogrammers.net/bpca.crt</span>

<span style="color:#66d9ef">[ crl_ext ]</span>
<span style="color:#a6e22e">issuerAltName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">URI:http://bedroomprogrammers.net/bpca.crt</span>
<span style="color:#a6e22e">authorityKeyIdentifier</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">keyid:always</span>

<span style="color:#66d9ef">[ proxy_cert_ext ]</span>
<span style="color:#a6e22e">basicConstraints</span><span style="color:#f92672">=</span><span style="color:#e6db74">CA:false</span>

<span style="color:#75715e"># nsCertType = server</span>
<span style="color:#75715e"># nsCertType = objsign</span>
<span style="color:#75715e"># nsCertType = client, email</span>
<span style="color:#75715e"># nsCertType = client, email, objsign</span>

<span style="color:#75715e"># This is typical in keyUsage for a client certificate.</span>
<span style="color:#75715e"># keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span>

<span style="color:#a6e22e">nsComment</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Certificate issued by BedroomProgrammers.net&#34;</span>

<span style="color:#75715e"># PKIX recommendations harmless if included in all certificates.</span>
<span style="color:#a6e22e">subjectKeyIdentifier</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">hash</span>
<span style="color:#a6e22e">authorityKeyIdentifier</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">keyid,issuer</span>

<span style="color:#75715e"># Copy subject details</span>
<span style="color:#a6e22e">issuerAltName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">issuer:copy</span>

<span style="color:#a6e22e">nsCaRevocationUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/bpca.crl</span>
<span style="color:#a6e22e">nsBaseUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/</span>
<span style="color:#a6e22e">nsRevocationUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/revoke/?</span>
<span style="color:#a6e22e">nsRenewalUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/renew/?</span>
<span style="color:#a6e22e">nsCaPolicyUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http://bedroomprogrammers.net/ssl/policy/</span>

<span style="color:#75715e"># This really needs to be in place for it to be a proxy certificate.</span>
<span style="color:#a6e22e">proxyCertInfo</span><span style="color:#f92672">=</span><span style="color:#e6db74">critical,language:id-ppl-anyLanguage,pathlen:3,policy:foo</span>
</code></pre></div><h3 id="create-ca-key--certificate">Create CA Key &amp; Certificate</h3>
<p>This section creates the CA private key, public certificate, and serial file
using the <code>openssl.cnf</code> file above.</p>
<pre><code>openssl req -new -keyout private/ca.key -out ca.csr -config openssl.cnf
openssl ca -create_serial -config ./openssl.cnf -out ca.crt -days 1095 -batch \
  -keyfile private/ca.key -selfsign -extensions v3_ca -infiles ca.csr
</code></pre><p>You will now want to distribute &ldquo;ca.crt&rdquo; to any client that will use a service
with your CA.</p>
<h2 id="common-tasks">Common Tasks</h2>
<h3 id="simple-client-certificate-creation">Simple Client Certificate Creation</h3>
<p>First we'll need to create a key for client, this should be done on the client
itself. It may be easier if the CA config (openssl.cnf) was distributed as well
as there are some strict signing requirements in the above configuration where
the country, state, and org name need to match exactly.</p>
<pre><code>openssl genrsa 2048 &gt; host.example.org.key
openssl req -new -key host.example.org.key -out host.example.org.csr \
  -extensions v3_req
</code></pre><p>Once the CSR has been generated transfer it to the host containing the CA, this
assumes you have placed the file (and are currently within) the CA's directory.</p>
<pre><code>openssl ca -config ./openssl.cnf -out host.example.org.crt -days 365 -batch \
  -keyfile private/ca.key -cert ca.crt -infiles host.example.org.csr
</code></pre><h3 id="advanced-client-certificate-creation">Advanced Client Certificate Creation</h3>
<p>Creating a certificate with multiple domains requires one extra step, create a
key and certificate as normal but create an additional file
<code>test.domain.net.cnf</code> that includes something along the following lines:</p>
<pre><code>subjectAltName=DNS:www.test.domain.net,DNS:*.test.domain.net,DNS:other.domain.net
</code></pre><p>When you sign the key you'll need to add the flag <code>-extfile</code> and specify the
file with the above contents. This will append those domains to the
certificate. An example way to sign the CSR:</p>
<pre><code>openssl ca -config ./openssl.cnf -out test.domain.net.crt -days 365 -batch \
  -keyfile private/ca.key -cert ca.crt -infiles test.domain.net.csr \
  -extfile test.domain.net.cnf
</code></pre><h3 id="convert-a-certificate-for-microsoft-certificate-store">Convert a Certificate for Microsoft Certificate Store</h3>
<p>This will convert a standard OpenSSL certificate/key pair into a pfx for use by
Microsoft products (fuck them for being different).</p>
<pre><code>openssl pkcs12 -export -out keycert.pfx -inkey priv.key -in cert.crt
</code></pre><h3 id="view-the-contents-of-a-certificate">View the Contents of a Certificate</h3>
<p>To view the text content of a certificate you can use the following command:</p>
<pre><code>openssl x509 -text -noout -in cert.crt
</code></pre><p>You can also view the contents of a signing request using:</p>
<pre><code>openssl req -text -noout -in cert.csr
</code></pre><h2 id="quick-self-signed-cert">Quick Self Signed Cert</h2>
<pre><code>openssl req -new -x509 -newkey rsa:4096 -keyout server.key -nodes -days 365 \
  -out server.crt
</code></pre><h2 id="add--change-a-password-on-a-keyfile">Add / Change a Password on a Keyfile</h2>
<pre><code>openssl rsa -des -in unprotected.key -out encrypted.key
</code></pre>
</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/notes/chronyd/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Chronyd</a>
    </div><div class='next-entry sep-before'>
      <a href='/notes/bind/'>
        <span class='screen-reader-text'>Next post: </span>Bind<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2020 Sam Stelfox </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script>

</body>

</html>

