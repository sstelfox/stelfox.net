<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="If you&amp;rsquo;ve already implemented the SSH keys for authentication and have a password on your key then you&amp;rsquo;ve already achieved multi-factor authentication to a certain degree.
The gatekeeper script is something that I haven&amp;rsquo;t come across on any other systems that other people administer. Perhaps it&amp;rsquo;s too much trouble for them without much gain. I had the idea for this while watching a James Bond movie.
A Russian systems engineer put riddles on one of his machines that you had to go through in order to access the system, while this alone isn&amp;rsquo;t secure, asking the user random questions after authentication couldn&amp;rsquo;t hurt security."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/gatekeeper-script-for-ssh/><title>Gatekeeper Script for SSH :: Sam Stelfox — A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.c8c76086c15b9d686ec1778dcf935d2ad37f3bb9c23165d2bd157ba7b18e5aec.css integrity="sha256-yMdghsFbnWhuwXeNz5NdKtN/O7nCMWXSvRV7p7GOWuw="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Gatekeeper Script for SSH"><meta itemprop=description content="If you’ve already implemented the SSH keys for authentication and have a password on your key then you’ve already achieved multi-factor authentication to a certain degree.
The gatekeeper script is something that I haven’t come across on any other systems that other people administer. Perhaps it’s too much trouble for them without much gain. I had the idea for this while watching a James Bond movie.
A Russian systems engineer put riddles on one of his machines that you had to go through in order to access the system, while this alone isn’t secure, asking the user random questions after authentication couldn’t hurt security."><meta itemprop=datePublished content="2017-10-09T12:09:43-04:00"><meta itemprop=dateModified content="2017-10-09T12:09:43-04:00"><meta itemprop=wordCount content="639"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gatekeeper Script for SSH"><meta name=twitter:description content="If you’ve already implemented the SSH keys for authentication and have a password on your key then you’ve already achieved multi-factor authentication to a certain degree.
The gatekeeper script is something that I haven’t come across on any other systems that other people administer. Perhaps it’s too much trouble for them without much gain. I had the idea for this while watching a James Bond movie.
A Russian systems engineer put riddles on one of his machines that you had to go through in order to access the system, while this alone isn’t secure, asking the user random questions after authentication couldn’t hurt security."></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/blog/>Posts</a></li><li><a href=/notes/>Notes</a></li><li><a href=/about/>About Me</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/gatekeeper-script-for-ssh/>Gatekeeper Script for SSH</a></h2><div class=post-content><p>If you&rsquo;ve already implemented the SSH keys for authentication and have a
password on your key then you&rsquo;ve already achieved multi-factor authentication
to a certain degree.</p><p>The gatekeeper script is something that I haven&rsquo;t come across on any other
systems that other people administer. Perhaps it&rsquo;s too much trouble for them
without much gain. I had the idea for this while watching a James Bond movie.</p><p>A Russian systems engineer put riddles on one of his machines that you had to
go through in order to access the system, while this alone isn&rsquo;t secure, asking
the user random questions after authentication couldn&rsquo;t hurt security. I highly
recommend using some logic that changes periodically, but the client can
remotely deduce.</p><p>First we need to make a script to handle the additional authentication. Please
note that the following script is just an example, most of the security is in
place but you&rsquo;ll want to implement your own logic for the questions and
answers.</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-1><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-2><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-3><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-4><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-5><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-6><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-7><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-8><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-9><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-10><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-11><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-12><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-13><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-14><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-15><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-16><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-17><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-18><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-19><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-20><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-21><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-22><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-23><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-24><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-25><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-26><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-27><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-28><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-29><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-30><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-31><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-32><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-33><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-34><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-35><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-36><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-37><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-38><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-39><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-40><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-41><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-42><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-43><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-44><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-45><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-46><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-47><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-48><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-49><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-50><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-51><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-52><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-53><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-54><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-55><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-c95af7e-56><a style=outline:none;text-decoration:none;color:inherit href=#code-c95af7e-56>56</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8b949e;font-weight:700;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-weight:700;font-style:italic></span><span style=color:#8b949e;font-style:italic># gatekeeper.sh - Post-login access question script</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># In the event that a user tries to get crafty and Ctrl-C out of the script</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># we&#39;ll just kill the connection</span>
</span></span><span style=display:flex><span>trap jail INT
</span></span><span style=display:flex><span>jail<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  kill -9 <span style=color:#79c0ff>$PPID</span>
</span></span><span style=display:flex><span>  exit <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Once a user logs in, check to see if they just wanted a shell.</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># SSH_ORIGINAL_COMMAND will be null (-z) if they did</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>[</span> -z <span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>$SSH_ORIGINAL_COMMAND</span><span style=color:#a5d6ff>&#34;</span> <span style=color:#ff7b72;font-weight:700>]</span>; <span style=color:#ff7b72>then</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># The answer the user needs to know, a function or call to another script</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># could be used to generate this answer based on any number of resources</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># available to the system. This could include querying an internal web</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># script to get a daily password user&#39;s of a site have access to (and</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># perhaps are supposed to be checking)</span>
</span></span><span style=display:flex><span>  local <span style=color:#79c0ff>CORRECT_ANSWER</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;muffins&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># Message displayed to the user before being prompted, I&#39;m going to assume</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># the user knows the question in this case what&#39;s the admin&#39;s favorite</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># breakfast</span>
</span></span><span style=display:flex><span>  echo -n <span style=color:#a5d6ff>&#34;Gatekeeper token authentication required: &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># Get the user&#39;s answer. If the answer is correct execute the command.</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic># If the answer is wrong, log the attempt and kill the connection.</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>while</span> read -s inputline; <span style=color:#ff7b72>do</span>
</span></span><span style=display:flex><span>    <span style=color:#79c0ff>RESPONSE</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>$inputline</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>    echo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>[</span> <span style=color:#79c0ff>$CORRECT_ANSWER</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>RESPONSE</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> <span style=color:#ff7b72;font-weight:700>]</span>; <span style=color:#ff7b72>then</span>
</span></span><span style=display:flex><span>      echo <span style=color:#a5d6ff>&#34;Gatekeeper authentication accepted.&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#79c0ff>$SHELL</span> -l
</span></span><span style=display:flex><span>      exit <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>else</span>
</span></span><span style=display:flex><span>      logger <span style=color:#a5d6ff>&#34;Gatekeeper: </span><span style=color:#79c0ff>$USER</span><span style=color:#a5d6ff> login failed from </span><span style=color:#79c0ff>$SSH_CLIENT</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>      kill -9 <span style=color:#79c0ff>$PPID</span>
</span></span><span style=display:flex><span>      exit <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>done</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># This command will bypass the gatekeeper script if the user tries to rsync as</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># this script will break rsync. It creates a fresh shell just for good measure.</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#if [ `echo $SSH_ORIGINAL_COMMAND | awk &#39;{print $1}&#39;` = rsync ]; then</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#  $SHELL -c &#34;$SSH_ORIGINAL_COMMAND&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#  exit 0</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># If a user tried to execute something other than an &#39;approved&#39; command just</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># kill the session. This will prevent SCP and SFTP unless they are configured</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># to bypass the script.</span>
</span></span><span style=display:flex><span>kill -9 <span style=color:#79c0ff>$PPID</span>
</span></span><span style=display:flex><span>exit <span style=color:#a5d6ff>0</span></span></span></code></pre></td></tr></table></div></div><p>Put this script in <code>/etc/ssh/gatekeeper.sh</code> and change it&rsquo;s permissions to 755
with the owner being root. To make the SSH server pass off control to the
Gatekeeper script once it&rsquo;s done authenticating a user, we&rsquo;ll use the
&lsquo;ForceCommand&rsquo; command in SSHd&rsquo;s config file (<code>/etc/ssh/sshd_config</code>). Add the
following line to the end of the config and restart the SSH daemon.</p><pre tabindex=0><code>ForceCommand /etc/ssh/gatekeeper.sh</code></pre><p>Assuming everything went according to plan, when you SSH into the remote server
once your done authenticating it&rsquo;ll ask for the token. Putting in &lsquo;muffins&rsquo;
should get you to your shell, while anything else will kill the connection.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=1bdad7e42eb7b73930a22b44cafb5fb6a7f2fb0d target=_blank rel=noopener>1bdad7e4</a> @ 2017-10-09</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>