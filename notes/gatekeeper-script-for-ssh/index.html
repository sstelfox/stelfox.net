<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="If you've already implemented the SSH keys for authentication and have a password on your key then you've already achieved multi-factor authentication to a certain degree.
The gatekeeper script is something that I haven't come across on any other systems that other people administer. Perhaps it's too much trouble for them without much gain. I had the idea for this while watching a James Bond movie.
A Russian systems engineer put riddles on one of his machines that you had to go through in order to access the system, while this alone isn't secure, asking the user random questions after authentication couldn't hurt security."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/notes/gatekeeper-script-for-ssh/><title>Gatekeeper Script for SSH :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Gatekeeper Script for SSH"><meta itemprop=description content="If you've already implemented the SSH keys for authentication and have a password on your key then you've already achieved multi-factor authentication to a certain degree.
The gatekeeper script is something that I haven't come across on any other systems that other people administer. Perhaps it's too much trouble for them without much gain. I had the idea for this while watching a James Bond movie.
A Russian systems engineer put riddles on one of his machines that you had to go through in order to access the system, while this alone isn't secure, asking the user random questions after authentication couldn't hurt security."><meta itemprop=datePublished content="2013-01-01T00:00:01+00:00"><meta itemprop=dateModified content="2013-01-01T00:00:01+00:00"><meta itemprop=wordCount content="640"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gatekeeper Script for SSH"><meta name=twitter:description content="If you've already implemented the SSH keys for authentication and have a password on your key then you've already achieved multi-factor authentication to a certain degree.
The gatekeeper script is something that I haven't come across on any other systems that other people administer. Perhaps it's too much trouble for them without much gain. I had the idea for this while watching a James Bond movie.
A Russian systems engineer put riddles on one of his machines that you had to go through in order to access the system, while this alone isn't secure, asking the user random questions after authentication couldn't hurt security."><meta property="article:published_time" content="2013-01-01 00:00:01 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/notes/gatekeeper-script-for-ssh/>Gatekeeper Script for SSH</a></h2><div class=post-content><p>If you've already implemented the SSH keys for authentication and have a
password on your key then you've already achieved multi-factor authentication
to a certain degree.</p><p>The gatekeeper script is something that I haven't come across on any other
systems that other people administer. Perhaps it's too much trouble for them
without much gain. I had the idea for this while watching a James Bond movie.</p><p>A Russian systems engineer put riddles on one of his machines that you had to
go through in order to access the system, while this alone isn't secure, asking
the user random questions after authentication couldn't hurt security. I highly
recommend using some logic that changes periodically, but the client can
remotely deduce.</p><p>First we need to make a script to handle the additional authentication. Please
note that the following script is just an example, most of the security is in
place but you'll want to implement your own logic for the questions and
answers.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39>39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40>40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41>41</a>
</span><span class=lnt id=hl-0-42><a class=lnlinks href=#hl-0-42>42</a>
</span><span class=lnt id=hl-0-43><a class=lnlinks href=#hl-0-43>43</a>
</span><span class=lnt id=hl-0-44><a class=lnlinks href=#hl-0-44>44</a>
</span><span class=lnt id=hl-0-45><a class=lnlinks href=#hl-0-45>45</a>
</span><span class=lnt id=hl-0-46><a class=lnlinks href=#hl-0-46>46</a>
</span><span class=lnt id=hl-0-47><a class=lnlinks href=#hl-0-47>47</a>
</span><span class=lnt id=hl-0-48><a class=lnlinks href=#hl-0-48>48</a>
</span><span class=lnt id=hl-0-49><a class=lnlinks href=#hl-0-49>49</a>
</span><span class=lnt id=hl-0-50><a class=lnlinks href=#hl-0-50>50</a>
</span><span class=lnt id=hl-0-51><a class=lnlinks href=#hl-0-51>51</a>
</span><span class=lnt id=hl-0-52><a class=lnlinks href=#hl-0-52>52</a>
</span><span class=lnt id=hl-0-53><a class=lnlinks href=#hl-0-53>53</a>
</span><span class=lnt id=hl-0-54><a class=lnlinks href=#hl-0-54>54</a>
</span><span class=lnt id=hl-0-55><a class=lnlinks href=#hl-0-55>55</a>
</span><span class=lnt id=hl-0-56><a class=lnlinks href=#hl-0-56>56</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># gatekeeper.sh - Post-login access question script</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># In the event that a user tries to get crafty and Ctrl-C out of the script</span>
</span></span><span class=line><span class=cl><span class=c1># we&#39;ll just kill the connection</span>
</span></span><span class=line><span class=cl><span class=nb>trap</span> jail INT
</span></span><span class=line><span class=cl>jail<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>kill</span> -9 <span class=nv>$PPID</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Once a user logs in, check to see if they just wanted a shell.</span>
</span></span><span class=line><span class=cl><span class=c1># SSH_ORIGINAL_COMMAND will be null (-z) if they did</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$SSH_ORIGINAL_COMMAND</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=c1># The answer the user needs to know, a function or call to another script</span>
</span></span><span class=line><span class=cl>  <span class=c1># could be used to generate this answer based on any number of resources</span>
</span></span><span class=line><span class=cl>  <span class=c1># available to the system. This could include querying an internal web</span>
</span></span><span class=line><span class=cl>  <span class=c1># script to get a daily password user&#39;s of a site have access to (and</span>
</span></span><span class=line><span class=cl>  <span class=c1># perhaps are supposed to be checking)</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>CORRECT_ANSWER</span><span class=o>=</span><span class=s2>&#34;muffins&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Message displayed to the user before being prompted, I&#39;m going to assume</span>
</span></span><span class=line><span class=cl>  <span class=c1># the user knows the question in this case what&#39;s the admin&#39;s favorite</span>
</span></span><span class=line><span class=cl>  <span class=c1># breakfast</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> -n <span class=s2>&#34;Gatekeeper token authentication required: &#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Get the user&#39;s answer. If the answer is correct execute the command.</span>
</span></span><span class=line><span class=cl>  <span class=c1># If the answer is wrong, log the attempt and kill the connection.</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=nb>read</span> -s inputline<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nv>RESPONSE</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$inputline</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=nv>$CORRECT_ANSWER</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>RESPONSE</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=nb>echo</span> <span class=s2>&#34;Gatekeeper authentication accepted.&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>$SHELL</span> -l
</span></span><span class=line><span class=cl>      <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      logger <span class=s2>&#34;Gatekeeper: </span><span class=nv>$USER</span><span class=s2> login failed from </span><span class=nv>$SSH_CLIENT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nb>kill</span> -9 <span class=nv>$PPID</span>
</span></span><span class=line><span class=cl>      <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This command will bypass the gatekeeper script if the user tries to rsync as</span>
</span></span><span class=line><span class=cl><span class=c1># this script will break rsync. It creates a fresh shell just for good measure.</span>
</span></span><span class=line><span class=cl><span class=c1>#if [ `echo $SSH_ORIGINAL_COMMAND | awk &#39;{print $1}&#39;` = rsync ]; then</span>
</span></span><span class=line><span class=cl><span class=c1>#  $SHELL -c &#34;$SSH_ORIGINAL_COMMAND&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#  exit 0</span>
</span></span><span class=line><span class=cl><span class=c1>#fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If a user tried to execute something other than an &#39;approved&#39; command just</span>
</span></span><span class=line><span class=cl><span class=c1># kill the session. This will prevent SCP and SFTP unless they are configured</span>
</span></span><span class=line><span class=cl><span class=c1># to bypass the script.</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> -9 <span class=nv>$PPID</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>Put this script in <code>/etc/ssh/gatekeeper.sh</code> and change it's permissions to 755
with the owner being root. To make the SSH server pass off control to the
Gatekeeper script once it's done authenticating a user, we'll use the
'ForceCommand' command in SSHd's config file (<code>/etc/ssh/sshd_config</code>). Add the
following line to the end of the config and restart the SSH daemon.</p><pre tabindex=0><code>ForceCommand /etc/ssh/gatekeeper.sh
</code></pre><p>Assuming everything went according to plan, when you SSH into the remote server
once your done authenticating it'll ask for the token. Putting in 'muffins'
should get you to your shell, while anything else will kill the connection.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=e0ae306a5897bc6892dbaa3e409f62aac8e8d735 target=_blank rel=noopener>e0ae306a</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>