<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&amp;rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www."><meta name=keywords content=",nginx,linux,cloudflare"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2018-10-21-weird-cloudflare-behavior/><title>Weird CloudFlare Behavior :: Sam Stelfox
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Weird CloudFlare Behavior"><meta itemprop=description content="While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www."><meta itemprop=datePublished content="2018-10-21T22:36:09-06:00"><meta itemprop=dateModified content="2018-10-21T22:36:09-06:00"><meta itemprop=wordCount content="300"><meta itemprop=keywords content="Nginx,Linux,Cloudflare"><meta name=twitter:card content="summary"><meta name=twitter:title content="Weird CloudFlare Behavior"><meta name=twitter:description content="While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www."><meta property="article:published_time" content="2018-10-21 22:36:09 -0600 -0600"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/blog/>Blog Posts</a></li><li><a href=/notes/>Various Notes</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2018-10-21-weird-cloudflare-behavior/>Weird CloudFlare Behavior</a></h2><div class=post-content><p>While working on a replacement webserver, I encountered some odd behavior which
took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with
CloudFlare, it was just unexpected.</p><p>The server was configured to respond to <code>www.example.tld</code> as well as
<code>example.tld</code>, to both encrypted and unencrypted connections. Any requests to
the <code>www.</code> domain get redirected to <code>https://example.tld</code>. The config was
roughly:</p><pre tabindex=0><code>server {
  listen 80;
  listen [::]:80;

  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  server_name www.example.tld;

  # Valid / Basic SSL settings (omitted for brevity)

  return 301 https://example.tld$request_uri;
}
</code></pre><p>This worked fine. To match this config, I configured the unencrypted root
domain to redirect traffic from http to https with a config like the following:</p><pre tabindex=0><code>server {
  listen 80;
  listen [::]:80;

  server_name example.tld;
  return 301 https://example.tld$request_uri;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  server_name example.tld;

  # Valid / Basic SSL settings (omitted for brevity)

  # Normal site config
}
</code></pre><p>When I attempted to go to the site, it performed the https redirect, but
continued to try to redirect the browser. CloudFlare was hitting my upstream on
the unencrypted port and always getting the redirect message.</p><p>I wanted to leave this in place so clients would have the same experience when
I bypassed CloudFlare&rsquo;s HTTP CDN proxy. The way I solved this was to simply
turn on &lsquo;Full (strict)&rsquo; SSL setting to ensure CloudFlare also connected to my
upstream on HTTPS, and relied on the &lsquo;Always Use HTTPS&rsquo; setting when CloudFlare
was active to maintain the same behavior. If you don&rsquo;t have a valid SSL
certificate (such as a self signed certificate) you&rsquo;ll have to use &lsquo;Full SSL&rsquo;
instead.</p><p>Funnily enough, this is apparently <a href=https://support.cloudflare.com/hc/en-us/articles/115000219871>common enough</a> of an issue to be
mentioned directly in the Help for the SSL configuration within CloudFlare.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/nginx/>nginx</a></span>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span>
<span class=tag><a href=https://stelfox.net/tags/cloudflare/>cloudflare</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>