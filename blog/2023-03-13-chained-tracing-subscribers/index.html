<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Tracing is a fantastic Rust library that I&amp;rsquo;ve found immensely useful, but I feel its documentation and API could still use a bit of polish. At first glance, the distinctions and roles of Subscribers, Layers, Filters, and Writers seem clear and well-documented. But when dealing with less common use cases, understanding their interactions and handling trait-based errors can become challenging.
So, I&amp;rsquo;m thinking I need multiple &amp;ldquo;Subscribers&amp;rdquo; for the various events being traced, right?"><meta name=keywords content=",rust,programming,tracing"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2023-03-13-chained-tracing-subscribers/><title>Combining "Subscribers" in Rust's Tracing Library :: Sam Stelfox
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content='Combining "Subscribers" in Rust&#39;s Tracing Library'><meta itemprop=description content="Tracing is a fantastic Rust library that I&rsquo;ve found immensely useful, but I feel its documentation and API could still use a bit of polish. At first glance, the distinctions and roles of Subscribers, Layers, Filters, and Writers seem clear and well-documented. But when dealing with less common use cases, understanding their interactions and handling trait-based errors can become challenging.
So, I&rsquo;m thinking I need multiple &ldquo;Subscribers&rdquo; for the various events being traced, right?"><meta itemprop=datePublished content="2023-04-13T20:51:02-04:00"><meta itemprop=dateModified content="2023-04-13T20:51:02-04:00"><meta itemprop=wordCount content="329"><meta itemprop=keywords content="Rust,Programming,Tracing"><meta name=twitter:card content="summary"><meta name=twitter:title content='Combining "Subscribers" in Rust&#39;s Tracing Library'><meta name=twitter:description content="Tracing is a fantastic Rust library that I&rsquo;ve found immensely useful, but I feel its documentation and API could still use a bit of polish. At first glance, the distinctions and roles of Subscribers, Layers, Filters, and Writers seem clear and well-documented. But when dealing with less common use cases, understanding their interactions and handling trait-based errors can become challenging.
So, I&rsquo;m thinking I need multiple &ldquo;Subscribers&rdquo; for the various events being traced, right?"><meta property="article:published_time" content="2023-04-13 20:51:02 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/blog/>Blog Posts</a></li><li><a href=/notes/>Various Notes</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2023-03-13-chained-tracing-subscribers/>Combining &ldquo;Subscribers&rdquo; in Rust&rsquo;s Tracing Library</a></h2><div class=post-content><p>Tracing is a fantastic Rust library that I&rsquo;ve found immensely useful, but I feel its documentation and API could still use a bit of polish. At first glance, the distinctions and roles of Subscribers, Layers, Filters, and Writers seem clear and well-documented. But when dealing with less common use cases, understanding their interactions and handling trait-based errors can become challenging.</p><p>So, I&rsquo;m thinking I need multiple &ldquo;Subscribers&rdquo; for the various events being traced, right? Well, it turns out the names can be a bit misleading. What I actually need are &ldquo;Layers&rdquo;. The documentation does mention this in the Layers section, but you kind of need to know that&rsquo;s what you&rsquo;re after in the first place to find it. Filters and Writers, on the other hand, are more straightforward. But I kept running into confusion in StackOverflow posts and example code from closed issues. These sources often refer to an outdated API, with filters chained onto builders, creating a tangled mess and leaving me wondering which subscriber has what filter and which output they&rsquo;ll be writing to.</p><p>In my experience, I usually run into this issue when I want to combine <code>tokio-console</code> with an existing subscriber for temporary diagnostics. My go-to workaround has been to simply swap them out, perform the diagnostics, and then swap the production one back in. However, I recently took the time to explore a better solution in a personal project. Now, this is my default tracing configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::time::Duration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> console_subscriber::ConsoleLayer;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tracing::Level;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tracing_subscriber::{EnvFilter, Layer};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tracing_subscriber::layer::SubscriberExt;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tracing_subscriber::util::SubscriberInitExt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> console_layer <span style=color:#f92672>=</span> ConsoleLayer::builder()
</span></span><span style=display:flex><span>        .retention(Duration::from_secs(<span style=color:#ae81ff>30</span>))
</span></span><span style=display:flex><span>        .spawn();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (non_blocking_writer, _guard) <span style=color:#f92672>=</span> tracing_appender::non_blocking(std::io::stderr());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> env_filter <span style=color:#f92672>=</span> EnvFilter::builder()
</span></span><span style=display:flex><span>        .with_default_directive(Level::<span style=color:#66d9ef>INFO</span>.into())
</span></span><span style=display:flex><span>        .from_env_lossy();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stderr_layer <span style=color:#f92672>=</span> tracing_subscriber::fmt::layer()
</span></span><span style=display:flex><span>        .compact()
</span></span><span style=display:flex><span>        .with_writer(non_blocking_writer)
</span></span><span style=display:flex><span>        .with_filter(env_filter);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tracing_subscriber::registry()
</span></span><span style=display:flex><span>        .with(console_layer)
</span></span><span style=display:flex><span>        .with(stderr_layer)
</span></span><span style=display:flex><span>        .init();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;sample program starting up&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The dependency section in my <code>Cargo.toml</code> file looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>dependencies</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>console-subscriber</span> = <span style=color:#e6db74>&#34;^0.1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tokio</span> = <span style=color:#e6db74>&#34;^1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tracing</span> = <span style=color:#e6db74>&#34;^0.1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tracing-appender</span> = <span style=color:#e6db74>&#34;^0.2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tracing-subscriber</span> = <span style=color:#e6db74>&#34;^0.3&#34;</span>
</span></span></code></pre></div><p>I hope this configuration helps you in your Rust adventures! Happy coding!</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/rust/>rust</a></span>
<span class=tag><a href=https://stelfox.net/tags/programming/>programming</a></span>
<span class=tag><a href=https://stelfox.net/tags/tracing/>tracing</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>