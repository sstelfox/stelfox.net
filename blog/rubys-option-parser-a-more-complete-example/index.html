<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Recently while writing a Ruby program I needed to parse some command line options. Helpfully Ruby provides a module named OptionParser to make this easy. I found a few parts of the documentation ambiguous and a few others down right confusing.
The catch I hit was the required field. In my mind the definition of a required argument is something that needs to be passed on the command line to continue."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,development,ruby"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/rubys-option-parser-a-more-complete-example/><title>Ruby's Option Parser - a More Complete Example :: Sam Stelfox
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Ruby's Option Parser - a More Complete Example"><meta itemprop=description content="Recently while writing a Ruby program I needed to parse some command line options. Helpfully Ruby provides a module named OptionParser to make this easy. I found a few parts of the documentation ambiguous and a few others down right confusing.
The catch I hit was the required field. In my mind the definition of a required argument is something that needs to be passed on the command line to continue."><meta itemprop=datePublished content="2012-12-02T22:59:00-05:00"><meta itemprop=dateModified content="2012-12-02T22:59:00-05:00"><meta itemprop=wordCount content="673"><meta itemprop=keywords content="Development,Ruby"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ruby's Option Parser - a More Complete Example"><meta name=twitter:description content="Recently while writing a Ruby program I needed to parse some command line options. Helpfully Ruby provides a module named OptionParser to make this easy. I found a few parts of the documentation ambiguous and a few others down right confusing.
The catch I hit was the required field. In my mind the definition of a required argument is something that needs to be passed on the command line to continue."><meta property="article:published_time" content="2012-12-02 22:59:00 -0500 EST"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/blog/>Blog Posts</a></li><li><a href=/notes/>Various Notes</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/rubys-option-parser-a-more-complete-example/>Ruby&rsquo;s Option Parser - a More Complete Example</a></h2><div class=post-content><p>Recently while writing a Ruby program I needed to parse some command line
options. Helpfully Ruby provides a module named <code>OptionParser</code> to make this
easy. I found a few parts of the documentation ambiguous and a few others down
right confusing.</p><p>The catch I hit was the required field. In my mind the definition of a required
argument is something that needs to be passed on the command line to continue.
What<code>OptionParser</code> actually means is that a value isn&rsquo;t required when the
argument is passed.<code>OptionParser</code> already provides boolean switches, so when
someone would use an optional switch is beyond me.</p><p>To make it a little more clear and to have something to work from in the future
I created the following chunk of code that includes a Configuration singleton
that can be used anywhere within your codebase to access the run-time
configuration, a sample parser with a wide range of different types of options,
and it will load configuration from a file named <code>config.yml</code> in the same
directory.</p><p>I feel like the following is a much more complete explanation of how
<code>OptionParser</code> is supposed to be used with supporting code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env ruby</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This file provides an example of creating a command line application with a</span>
</span></span><span style=display:flex><span><span style=color:#75715e># wide variety of command line options, parsing and the like as well as global</span>
</span></span><span style=display:flex><span><span style=color:#75715e># configuration singleton that can be relied on throughout a program.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This entire setup lives within the &#34;Example&#34; module. These are really common</span>
</span></span><span style=display:flex><span><span style=color:#75715e># names and it would be a shame to override required functionality in other code</span>
</span></span><span style=display:flex><span><span style=color:#75715e># that wasn&#39;t properly namespaced.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;optparse&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;singleton&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;yaml&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> Example
</span></span><span style=display:flex><span>  <span style=color:#75715e># Defines the available configuration options for the configuration</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ConfigurationStruct</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Struct</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>:enum</span>, <span style=color:#e6db74>:list</span>, <span style=color:#e6db74>:required</span>, <span style=color:#e6db74>:optional</span>, <span style=color:#e6db74>:verbose</span>, <span style=color:#e6db74>:float</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Configuration</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Singleton</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Initialize the configuration and set defaults:</span>
</span></span><span style=display:flex><span>    @@config <span style=color:#f92672>=</span> <span style=color:#66d9ef>ConfigurationStruct</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This is where the defaults are being set</span>
</span></span><span style=display:flex><span>    @@config<span style=color:#f92672>.</span>enum <span style=color:#f92672>=</span> <span style=color:#e6db74>:one</span>
</span></span><span style=display:flex><span>    @@config<span style=color:#f92672>.</span>list <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>    @@config<span style=color:#f92672>.</span>optional <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    @@config<span style=color:#f92672>.</span>verbose <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>config</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>yield</span>(@@config) <span style=color:#66d9ef>if</span> block_given?
</span></span><span style=display:flex><span>      @@config
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Loads a YAML configuration file and sets each of the configuration values to</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># whats in the file.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>load</span>(file)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>YAML</span><span style=color:#f92672>::</span>load_file(file)<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>key, value<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>key<span style=color:#e6db74>}</span><span style=color:#e6db74>=&#34;</span>, value)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This provides an easy way to dump the configuration as a hash</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>to_hash</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Hash</span><span style=color:#f92672>[</span>@@config<span style=color:#f92672>.</span>each_pair<span style=color:#f92672>.</span>to_a<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Pass any other calls (most likely attribute setters/getters on to the</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># configuration as a way to easily set/get attribute values </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>method_missing</span>(method, <span style=color:#f92672>*</span>args, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> @@config<span style=color:#f92672>.</span>respond_to?(method)
</span></span><span style=display:flex><span>        @@config<span style=color:#f92672>.</span>send(method, <span style=color:#f92672>*</span>args, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#66d9ef>NoMethodError</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Handles validating the configuration that has been loaded/configured</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>validate!</span>
</span></span><span style=display:flex><span>      valid <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      valid <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>required<span style=color:#f92672>.</span>nil?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>raise</span> <span style=color:#66d9ef>ArgumentError</span> <span style=color:#66d9ef>unless</span> valid
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConfigurationParser</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span>(args)
</span></span><span style=display:flex><span>      opts <span style=color:#f92672>=</span> <span style=color:#66d9ef>OptionParser</span><span style=color:#f92672>.</span>new <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>parser<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>separator <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>separator <span style=color:#e6db74>&#34;Specific options:&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on(<span style=color:#e6db74>&#34;--enum ENUM&#34;</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>:one</span>, <span style=color:#e6db74>:two</span>, <span style=color:#e6db74>:three</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;This field requires one of a set of predefined values be&#34;</span>, <span style=color:#e6db74>&#34;set. If wrapped in brackets this option can be set to nil.&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>setting<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>enum <span style=color:#f92672>=</span> setting
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on(<span style=color:#e6db74>&#34;-l&#34;</span>, <span style=color:#e6db74>&#34;--list x,y&#34;</span>, Array, <span style=color:#e6db74>&#34;This command flag takes a comma separated list (without&#34;</span>, <span style=color:#e6db74>&#34;spaces) of values and turns it into an array. This requires&#34;</span>, <span style=color:#e6db74>&#34;at least one argument.&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>setting<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>list <span style=color:#f92672>=</span> setting
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on(<span style=color:#e6db74>&#34;--[no-]verbose&#34;</span>, <span style=color:#e6db74>&#34;This is a common boolean flag, setting verbosity to either&#34;</span>, <span style=color:#e6db74>&#34;true or false.&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>setting<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>verbose <span style=color:#f92672>=</span> setting
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on(<span style=color:#e6db74>&#34;--optional [STR]&#34;</span>, <span style=color:#e6db74>&#34;This command doesn&#39;t require a string to be passed to it, if&#34;</span>, <span style=color:#e6db74>&#34;nothing is passed it will be nil. No error will be raised if&#34;</span>, <span style=color:#e6db74>&#34;nothing is passed to it that logic needs to be handled&#34;</span>, <span style=color:#e6db74>&#34;yourself.&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>setting<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>optional <span style=color:#f92672>=</span> setting
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on(<span style=color:#e6db74>&#34;-r&#34;</span>, <span style=color:#e6db74>&#34;--required STR&#34;</span>, <span style=color:#e6db74>&#34;This command requires a string to be passed to it.&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>setting<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>required <span style=color:#f92672>=</span> setting
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on(<span style=color:#e6db74>&#34;--float NUM&#34;</span>, Float, <span style=color:#e6db74>&#34;This command will only accept an integer or a float.&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>setting<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>float <span style=color:#f92672>=</span> setting
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on_tail(<span style=color:#e6db74>&#34;-h&#34;</span>, <span style=color:#e6db74>&#34;--help&#34;</span>, <span style=color:#e6db74>&#34;--usage&#34;</span>, <span style=color:#e6db74>&#34;Show this usage message and quit.&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>setting<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          puts parser<span style=color:#f92672>.</span>help
</span></span><span style=display:flex><span>          exit
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        parser<span style=color:#f92672>.</span>on_tail(<span style=color:#e6db74>&#34;-v&#34;</span>, <span style=color:#e6db74>&#34;--version&#34;</span>, <span style=color:#e6db74>&#34;Show version information about this program and quit.&#34;</span>) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>          puts <span style=color:#e6db74>&#34;Option Parser Example v1.0.0&#34;</span>
</span></span><span style=display:flex><span>          exit
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      opts<span style=color:#f92672>.</span>parse!(args)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>exists?(<span style=color:#e6db74>&#34;config.yml&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Example</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>load(<span style=color:#e6db74>&#34;config.yml&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Example</span><span style=color:#f92672>::</span><span style=color:#66d9ef>ConfigurationParser</span><span style=color:#f92672>.</span>parse(<span style=color:#66d9ef>ARGV</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>Example</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>validate!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#34;json&#34;</span>
</span></span><span style=display:flex><span>puts <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>pretty_generate(<span style=color:#66d9ef>Example</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Configuration</span><span style=color:#f92672>.</span>to_hash)
</span></span></code></pre></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/development/>development</a></span>
<span class=tag><a href=https://stelfox.net/tags/ruby/>ruby</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>