<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='This last Thursday I had the privilege of giving a talk at our local Linux User Group about diagnosing firewall issues on Linux entitled &ldquo;It&rsquo;s Never the Firewall: Diagnosing Linux Firewall Issues&rdquo;. I really enjoyed giving the talk, however, I left a few questions unanswered. While I may do a more extensive post on everything that I went through in the talk (I have been lax on writing content for this blog), this post is more to answer the outstanding questions and of course to make my slides available.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='It&#39;s Never the Firewall • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='This last Thursday I had the privilege of giving a talk at our local Linux User Group about diagnosing firewall issues on Linux entitled &ldquo;It&rsquo;s Never the Firewall: Diagnosing Linux Firewall Issues&rdquo;. I really enjoyed giving the talk, however, I left a few questions unanswered. While I may do a more extensive post on everything that I went through in the talk (I have been lax on writing content for this blog), this post is more to answer the outstanding questions and of course to make my slides available.'>
<meta property='og:url' content='https://stelfox.net/blog/2018/10/its-never-the-firewall/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='firewall'><meta property='article:tag' content='iptables'><meta property='article:tag' content='linux'><meta property='article:tag' content='security'><meta property='article:published_time' content='2018-10-14T13:36:09-06:00'/><meta property='article:modified_time' content='2018-10-14T13:36:09-06:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.51-DEV" />

  <title>It&#39;s Never the Firewall • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2018/10/its-never-the-firewall/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4a10984a.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>It&#39;s Never the Firewall</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2018-10-14T13:36:09-06:00'>2018, Oct 14</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
4 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>This last Thursday I had the privilege of giving a talk at our local Linux User
Group about diagnosing firewall issues on Linux entitled &ldquo;It&rsquo;s Never the
Firewall: Diagnosing Linux Firewall Issues&rdquo;. I really enjoyed giving the talk,
however, I left a few questions unanswered. While I may do a more extensive
post on everything that I went through in the talk (I have been lax on writing
content for this blog), this post is more to answer the outstanding questions
and of course <a href="/files/it_is_never_the_firewall.pdf">to make my slides available</a>.</p>

<p>As far as I remember the only question I wasn&rsquo;t able to answer was about file
descriptors related to TCP connections. It isn&rsquo;t exactly a firewall issue but
exhaustion of file descriptors is one of the issues I&rsquo;ve seen blamed on the
firewall (which in turn was relevant to the talk).</p>

<p>Established TCP connections consume file descriptors on Linux systems. Each
user session is restricted by a limit defined by the system administrator (or
more likely using the distribution&rsquo;s defaults). Some services consume a large
number of file descriptors for their basic operations before any network
connections are involved (<a href="https://redis.io/topics/clients">Redis</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/file-descriptors.html">Elasticsearch</a> being two common
services that both recommend increasing this limit).</p>

<p>When file descriptors are exhausted there are two common behaviors of
applications depending on how they&rsquo;re written. The first and more common
behavior will an immediately terminated connection, which to the user will look
quite similar to a iptables REJECT response. The less common behavior is
waiting until a file descriptor to become available before accepting the
connection, which will result in a hanging incomplete connection much like an
iptables DROP target.</p>

<p>An important caveat here is that I&rsquo;m talking about user perception. If you look
at the packets being exchanged, it&rsquo;s clear that this isn&rsquo;t the case.</p>

<p>A quick way to diagnose if this is an issue is to compare the current number of
open file descriptors by a user to their limit. In my experience most of these
commands are available to unprivileged users which is also handy if there is a
complicated process for using or executing commands with elevated privileges.</p>

<p>First let&rsquo;s check what the total number of open file descriptors are on the
system:</p>

<pre><code>[user@sample-host] ~ $ lsof | wc -l
185779
</code></pre>

<p>If it is under 10,000 there is a very good chance this is not the problem
you&rsquo;re looking for. If you see a large number like the output above, it is
worth investigating more. The host that I sampled that from currently has no
file descriptor issues.</p>

<p>First you&rsquo;ll want to identify the main process of the application that is
having issues. Make sure you note the user that the application is running as.
Identify the current configured limits for that process (replace <PID> with the
pid you just found):</p>

<pre><code>[user@sample-host] ~ $ grep 'open files' /proc/&lt;PID&gt;/limits
Max open files            1024                 4096                 files
</code></pre>

<p>This tells the process is currently operating with a soft limit of 1,024 file
descriptors and a hard limit of 4,096. This is where the diagnostics can get a
little fuzzy. File descriptors are limited by user <em>session</em> not by process or
user which is what we can directly query on. To get a rough idea of where we&rsquo;re
at lets query those two specifics.</p>

<pre><code>[user@sample-host] ~ $ lsof -p &lt;PID&gt; | wc -l
5
[user@sample-host] ~ $ lsof -u &lt;USER&gt; | wc -l
721
</code></pre>

<p>This particular example is enough for us to clearly see file descriptors are
not an issue. The current number of file descriptors open for the user (721) is
below the process&rsquo;s soft limit of 1,024. If the number of file descriptors is
closer to our limits you&rsquo;ll have to get an exact count of what is going on.
Unfortunately I don&rsquo;t know an easy one liner to check this.</p>

<p>To get an exact count you need to enumerate all processes with the same session
identifier (SID) as your target process, query them all for the current file
descriptor consumption, and add them up into a total. As a rule of thumb I
recommend leaving about a 25% overhead for your service during peak load which
can be set in your system limits file for that service&rsquo;s user.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/firewall/'>firewall</a>, <a class='tag' href='/tags/iptables/'>iptables</a>, <a class='tag' href='/tags/linux/'>linux</a>, <a class='tag' href='/tags/security/'>security</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2018/06/spf-and-google-site-verification-in-route-53/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>SPF and Google Site Verification in Route 53</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2018/10/weird-cloudflare-behavior/'>
        <span class='screen-reader-text'>Next post: </span>Weird CloudFlare Behavior<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2018 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.fae8ed32.js'></script>

</body>

</html>

