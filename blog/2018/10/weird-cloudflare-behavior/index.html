<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="sam@stelfox.net Sam Stelfox ">
<meta name="description" content="While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&amp;rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www." />
<meta name="keywords" content="blog, programming, linux, systems, personal, nginx, linux, cloudflare" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://stelfox.net/blog/2018/10/weird-cloudflare-behavior/" />


    <title>
        
            Weird CloudFlare Behavior :: Sam Stelfox 
        
    </title>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link rel="stylesheet" href="/main.2a064c455b0ecbd6b1481b3bf9df2441e95838691022f40a5338c2cb1244f075.css" integrity="sha256-KgZMRVsOy9axSBs7&#43;d8kQelYOGkQIvQKUzjCyxJE8HU=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Weird CloudFlare Behavior">
<meta itemprop="description" content="While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www."><meta itemprop="datePublished" content="2018-10-21T22:36:09-06:00" />
<meta itemprop="dateModified" content="2018-10-21T22:36:09-06:00" />
<meta itemprop="wordCount" content="300">
<meta itemprop="keywords" content="nginx,linux,cloudflare," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Weird CloudFlare Behavior"/>
<meta name="twitter:description" content="While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www."/>



    <meta property="og:title" content="Weird CloudFlare Behavior" />
<meta property="og:description" content="While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stelfox.net/blog/2018/10/weird-cloudflare-behavior/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2018-10-21T22:36:09-06:00" />
<meta property="article:modified_time" content="2018-10-21T22:36:09-06:00" />






    <meta property="article:published_time" content="2018-10-21 22:36:09 -0600 -0600" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                ./Sam_Stelfox.sh</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/blog/">Blog Posts</a></li><li><a href="/notes/">Various Notes</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://stelfox.net/blog/2018/10/weird-cloudflare-behavior/">Weird CloudFlare Behavior</a></h2>

            
            
            

            <div class="post-content">
                <p>While working on a replacement webserver, I encountered some odd behavior which
took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with
CloudFlare, it was just unexpected.</p>
<p>The server was configured to respond to <code>www.example.tld</code> as well as
<code>example.tld</code>, to both encrypted and unencrypted connections. Any requests to
the <code>www.</code> domain get redirected to <code>https://example.tld</code>. The config was
roughly:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>  listen 80;
</span></span><span style="display:flex;"><span>  listen [::]:80;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  listen 443 ssl http2;
</span></span><span style="display:flex;"><span>  listen [::]:443 ssl http2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  server_name www.example.tld;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  # Valid / Basic SSL settings (omitted for brevity)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  return 301 https://example.tld$request_uri;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This worked fine. To match this config, I configured the unencrypted root
domain to redirect traffic from http to https with a config like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>  listen 80;
</span></span><span style="display:flex;"><span>  listen [::]:80;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  server_name example.tld;
</span></span><span style="display:flex;"><span>  return 301 https://example.tld$request_uri;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>  listen 443 ssl http2;
</span></span><span style="display:flex;"><span>  listen [::]:443 ssl http2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  server_name example.tld;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  # Valid / Basic SSL settings (omitted for brevity)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  # Normal site config
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When I attempted to go to the site, it performed the https redirect, but
continued to try to redirect the browser. CloudFlare was hitting my upstream on
the unencrypted port and always getting the redirect message.</p>
<p>I wanted to leave this in place so clients would have the same experience when
I bypassed CloudFlare&rsquo;s HTTP CDN proxy. The way I solved this was to simply
turn on &lsquo;Full (strict)&rsquo; SSL setting to ensure CloudFlare also connected to my
upstream on HTTPS, and relied on the &lsquo;Always Use HTTPS&rsquo; setting when CloudFlare
was active to maintain the same behavior. If you don&rsquo;t have a valid SSL
certificate (such as a self signed certificate) you&rsquo;ll have to use &lsquo;Full SSL&rsquo;
instead.</p>
<p>Funnily enough, this is apparently <a href="https://support.cloudflare.com/hc/en-us/articles/115000219871">common enough</a> of an issue to be
mentioned directly in the Help for the SSL configuration within CloudFlare.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://stelfox.net/tags/nginx/">nginx</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/linux/">linux</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/cloudflare/">cloudflare</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.c90b8161416b87c69a8e02683b54ddd6edb90aea699648bf655e6cbc45b419b8e465d196e715772463dba35a6faf5decb2eb247480d38680484d54645b434570.js" integrity="sha512-yQuBYUFrh8aajgJoO1Td1u25Cupplki/ZV5svEW0GbjkZdGW5xV3JGPbo1pvr13ssuskdIDThoBITVRkW0NFcA=="></script>



    </body>
</html>
