<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Weird CloudFlare Behavior • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='While working on a replacement webserver, I encountered some odd behavior which took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with CloudFlare, it was just unexpected.
The server was configured to respond to www.example.tld as well as example.tld, to both encrypted and unencrypted connections. Any requests to the www. domain get redirected to https://example.tld. The config was roughly:
server { listen 80; listen [::]:80; listen 443 ssl http2; listen [::]:443 ssl http2; server_name www.'>
<meta property='og:url' content='https://stelfox.net/blog/2018/10/weird-cloudflare-behavior/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='nginx'><meta property='article:tag' content='linux'><meta property='article:tag' content='cloudflare'><meta property='article:published_time' content='2018-10-21T22:36:09-06:00'/><meta property='article:modified_time' content='2018-10-21T22:36:09-06:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.50-DEV" />

  <title>Weird CloudFlare Behavior • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2018/10/weird-cloudflare-behavior/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4267b3fa.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>


<body class='page type-blog'>

  <div class='site'>

    <a class='screen-reader-text' href='#content'>Skip to Content</a>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Weird CloudFlare Behavior</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2018-10-21T22:36:09-06:00'>2018, Oct 21</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
2 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>While working on a replacement webserver, I encountered some odd behavior which
took a bit to track down to CloudFlare. This isn&rsquo;t a bug or an issue with
CloudFlare, it was just unexpected.</p>

<p>The server was configured to respond to <code>www.example.tld</code> as well as
<code>example.tld</code>, to both encrypted and unencrypted connections. Any requests to
the <code>www.</code> domain get redirected to <code>https://example.tld</code>. The config was
roughly:</p>

<pre><code>server {
  listen 80;
  listen [::]:80;

  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  server_name www.example.tld;

  # Valid / Basic SSL settings (omitted for brevity)

  return 301 https://example.tld$request_uri;
}
</code></pre>

<p>This worked fine. To match this config, I configured the unencrypted root
domain to redirect traffic from http to https with a config like the following:</p>

<pre><code>server {
  listen 80;
  listen [::]:80;

  server_name example.tld;
  return 301 https://example.tld$request_uri;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  server_name example.tld;

  # Valid / Basic SSL settings (omitted for brevity)

  # Normal site config
}
</code></pre>

<p>When I attempted to go to the site, it performed the https redirect, but
continued to try to redirect the browser. CloudFlare was hitting my upstream on
the unencrypted port and always getting the redirect message.</p>

<p>I wanted to leave this in place so clients would have the same experience when
I bypassed CloudFlare&rsquo;s HTTP CDN proxy. The way I solved this was to simply
turn on &lsquo;Full (strict)&rsquo; SSL setting to ensure CloudFlare also connected to my
upstream on HTTPS, and relied on the &lsquo;Always Use HTTPS&rsquo; setting when CloudFlare
was active to maintain the same behavior. If you don&rsquo;t have a valid SSL
certificate (such as a self signed certificate) you&rsquo;ll have to use &lsquo;Full SSL&rsquo;
instead.</p>

<p>Funnily enough, this is apparently <a href="https://support.cloudflare.com/hc/en-us/articles/115000219871">common enough</a> of an issue to be
mentioned directly in the Help for the SSL configuration within CloudFlare.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/nginx/'>nginx</a>, <a class='tag' href='/tags/linux/'>linux</a>, <a class='tag' href='/tags/cloudflare/'>cloudflare</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2018/10/its-never-the-firewall/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>It&#39;s Never the Firewall</a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2018 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.59f76c44.js'></script>

</body>

</html>

