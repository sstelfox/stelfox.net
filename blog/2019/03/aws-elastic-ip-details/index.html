<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Sometimes it becomes important to understand how your cloud provider implements certain networking details. While working through an issue in AWS I needed to understand how they handle public IP addressing. While this issue for me was specific to an Elastic IP all of their public addresses are handled this way and may bite you even without them. The problems specifically crop up when a hosted piece of software does NAT traversal detection and changes it's behavior based on the result."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,aws,networking,operations"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2019/03/aws-elastic-ip-details/><title>AWS Elastic IP Details :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="AWS Elastic IP Details"><meta itemprop=description content="Sometimes it becomes important to understand how your cloud provider implements certain networking details. While working through an issue in AWS I needed to understand how they handle public IP addressing. While this issue for me was specific to an Elastic IP all of their public addresses are handled this way and may bite you even without them. The problems specifically crop up when a hosted piece of software does NAT traversal detection and changes it's behavior based on the result."><meta itemprop=datePublished content="2019-03-17T16:26:30-05:00"><meta itemprop=dateModified content="2019-03-17T16:26:30-05:00"><meta itemprop=wordCount content="490"><meta itemprop=keywords content="Aws,Networking,Operations"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Elastic IP Details"><meta name=twitter:description content="Sometimes it becomes important to understand how your cloud provider implements certain networking details. While working through an issue in AWS I needed to understand how they handle public IP addressing. While this issue for me was specific to an Elastic IP all of their public addresses are handled this way and may bite you even without them. The problems specifically crop up when a hosted piece of software does NAT traversal detection and changes it's behavior based on the result."><meta property="article:published_time" content="2019-03-17 16:26:30 -0500 -0500"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2019/03/aws-elastic-ip-details/>AWS Elastic IP Details</a></h2><div class=post-content><p>Sometimes it becomes important to understand how your cloud provider implements certain networking details. While working through an issue in AWS I needed to understand how they handle public IP addressing. While this issue for me was specific to an Elastic IP all of their public addresses are handled this way and may bite you even without them. The problems specifically crop up when a hosted piece of software does NAT traversal detection and changes it's behavior based on the result.</p><p>Amazon attaches public IP address to EC2 instances (and likely other of their hosted services) through 1:1 NAT mapping of external to internal addresses. All traffic will reach your instance without issue, but your system's native networking stack will (by default) not become aware of what that public IP is.</p><p>In most cases this isn't an issue, the traffic ends up at your instance and is properly changed to the internal address so your system responds without any additional configuration work.</p><p>The first issue is tunneled traffic. I <a href=/blog/2019/03/fighting-with-ipsec/>experienced this</a> in my last post with IPSec. The tunneled traffic is not modified by going through a 1:1 NAT and your host will not recognize the external address inside the tunnel, which in most cases will result in silently dropped packets (the "oh this isn't for me" syndrome).</p><p>There are ways to get your system to respond to tunneled packets with other IP addresses such as treating it like a high-availability shared virtual server IP address but I have yet to find a clean way to deal with responding to the address. IPSec had a way to deal with this built in directly and I'd refer you back to <a href=/blog/2019/03/fighting-with-ipsec/>my other post</a> to read about that.</p><p>Usually sniffing the tunneled traffic is enough to diagnose these issues. What is a bit more pernicious, is when a server changes its behavior when it detects a NAT in place. This requires deeper understanding of the protocol in use and in some cases the specific server implementation. Once again this post is ultimately about IPSec (and specifically libreswan).</p><p>While you don't have to make any changes to get IPSec working with AWS public IPs it will detect the NAT and start encapsulating the traffic. The encapsulation will require an additional port being opened on your security group firewall but more importantly, it will add variable latency and additional processing overhead to each packet. Not everything is sensitive to this but you'll be needlessly adding overhead to your network traffic is you don't address it. In my case (AWS VPC to AWS VPC) there aren't any meaningful NATs in place that require this encapsulation to function appropriately.</p><p>If you encounter this and are using libreswan on AWS you only need to add the following two lines to your tunnel's config disable this behavior:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>encapsulation=no
</span></span><span class=line><span class=cl>nat-keepalive=no
</span></span></code></pre></td></tr></table></div></div><p>I hope this helps someone else diagnose weird behavior when working with public IP addresses on AWS.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/aws/>aws</a></span>
<span class=tag><a href=https://stelfox.net/tags/networking/>networking</a></span>
<span class=tag><a href=https://stelfox.net/tags/operations/>operations</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=adbdd27b0c3e908cb1dca59e31b846a6a368cc76 target=_blank rel=noopener>adbdd27b</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>