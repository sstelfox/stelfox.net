<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="IPSec is a well known and well understood protocol that is pretty easy to get setup and going... Most of the time. While setting up an IPSec tunnel to an AWS host I came across a new and unique experience that didn't seem to have an easily searchable solution.
I had two CentOS 7 EC2 instances, each set up with their own Elastic IP in a default VPC. I installed and configured libreswan with the following config:"><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,ipsec,linux,networking"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2019/03/fighting-with-ipsec/><title>Fighting IPSec on AWS :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Fighting IPSec on AWS"><meta itemprop=description content="IPSec is a well known and well understood protocol that is pretty easy to get setup and going... Most of the time. While setting up an IPSec tunnel to an AWS host I came across a new and unique experience that didn't seem to have an easily searchable solution.
I had two CentOS 7 EC2 instances, each set up with their own Elastic IP in a default VPC. I installed and configured libreswan with the following config:"><meta itemprop=datePublished content="2019-03-14T21:26:30-04:00"><meta itemprop=dateModified content="2019-03-14T21:26:30-04:00"><meta itemprop=wordCount content="332"><meta itemprop=keywords content="Ipsec,Linux,Networking"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fighting IPSec on AWS"><meta name=twitter:description content="IPSec is a well known and well understood protocol that is pretty easy to get setup and going... Most of the time. While setting up an IPSec tunnel to an AWS host I came across a new and unique experience that didn't seem to have an easily searchable solution.
I had two CentOS 7 EC2 instances, each set up with their own Elastic IP in a default VPC. I installed and configured libreswan with the following config:"><meta property="article:published_time" content="2019-03-14 21:26:30 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2019/03/fighting-with-ipsec/>Fighting IPSec on AWS</a></h2><div class=post-content><p>IPSec is a well known and well understood protocol that is pretty easy to get setup and going... Most of the time. While setting up an IPSec tunnel to an AWS host I came across a new and unique experience that didn't seem to have an easily searchable solution.</p><p>I had two CentOS 7 EC2 instances, each set up with their own Elastic IP in a default VPC. I installed and configured libreswan with the following config:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>conn setup
</span></span><span class=line><span class=cl>  protostack=netkey
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>conn site-tunnel
</span></span><span class=line><span class=cl>  auto=start
</span></span><span class=line><span class=cl>  pfs=yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  leftid=@left_tunnel_server_name
</span></span><span class=line><span class=cl>  rightid=@right_tunnel_server_name
</span></span><span class=line><span class=cl>  left=%defaultroute
</span></span><span class=line><span class=cl>  right=&lt;remote-ip&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  authby=rsasig
</span></span><span class=line><span class=cl>  leftrsasigkey=&lt;left-key&gt;
</span></span><span class=line><span class=cl>  rightrsasigkey=&lt;right-key&gt;
</span></span></code></pre></td></tr></table></div></div><p>The IPSec link came up without issue but pings were timing out without a response. When sniffing the incoming packets, I was appropriately seeing the ICMP echo requests coming in encapsulated in the tunnel and being re-injected. There was never a response being generated.</p><p>The traffic capture was also pretty clear as to why. The encapsulated packet had the elastic IP as the destination which the EC2 instance doesn't <em>ACTUALLY</em> have and wasn't aware... So it didn't attempt to respond.</p><p>I went down a bit of a rabbit hole attempting to get the instance to recognize that address with limited success. Adding the IP to an additional loopback interface... IPTables DNAT rules... Some of them worked but they were dirty hacks that would have been left until something blew up...</p><p>The solution was simple and even improved the overall performance of the link. By default libreswan operates in "tunnel" mode which sends along the destination information as well (and can be used for routing network across). For the use I almost always use these links for, "transport" is more appropriate and has less protocol overhead.</p><p>By adding the following line to the connection configuration on both sides the problem vanished:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  type=transport
</span></span></code></pre></td></tr></table></div></div><p>With any luck the next person that comes across this issue will find this post and their life will be a tad bit easier.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/ipsec/>ipsec</a></span>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span>
<span class=tag><a href=https://stelfox.net/tags/networking/>networking</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=711e08f5c5f992fdbfe31175065122093c0ad81b target=_blank rel=noopener>711e08f5</a> @ 2024-07-14</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>