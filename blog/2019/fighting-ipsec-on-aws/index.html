<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1><a href="https:&#x2F;&#x2F;stelfox.net&#x2F;blog&#x2F;2019&#x2F;fighting-ipsec-on-aws&#x2F;">Fighting IPSec on AWS</a></h1>

  <div class="post-content"><p>IPSec is a well known and well understood protocol that is pretty easy to get
setup and going... Most of the time. While setting up an IPSec tunnel to an AWS
host I came across a new and unique experience that didn't seem to have an
easily searchable solution.</p>
<span id="continue-reading"></span>
<p>I had two CentOS 7 EC2 instances, each set up with their own Elastic IP in a
default VPC. I installed and configured libreswan with the following config:</p>
<pre><code>conn setup
  protostack=netkey

conn site-tunnel
  auto=start
  pfs=yes

  leftid=@left_tunnel_server_name
  rightid=@right_tunnel_server_name
  left=%defaultroute
  right=<remote-ip>

  authby=rsasig
  leftrsasigkey=<left-key>
  rightrsasigkey=<right-key>
</code></pre>
<p>The IPSec link came up without issue but pings were timing out without a
response. When sniffing the incoming packets, I was appropriately seeing the
ICMP echo requests coming in encapsulated in the tunnel and being re-injected.
There was never a response being generated.</p>
<p>The traffic capture was also pretty clear as to why. The encapsulated packet
had the elastic IP as the destination which the EC2 instance doesn't
<em>ACTUALLY</em> have and wasn't aware... So it didn't attempt to respond.</p>
<p>I went down a bit of a rabbit hole attempting to get the instance to recognize
that address with limited success. Adding the IP to an additional loopback
interface... IPTables DNAT rules... Some of them worked but they were dirty
hacks that would have been left until something blew up...</p>
<p>The solution was simple and even improved the overall performance of the
link. By default libreswan operates in <code>tunnel</code> mode which sends along the
destination information as well (and can be used for routing network across).
For the use I almost always use these links for, <code>transport</code> is more
appropriate and has less protocol overhead.</p>
<p>By adding the following line to the connection configuration on both sides the
problem vanished:</p>
<pre><code>  type=transport
</code></pre>
<p>With any luck the next person that comes across this issue will find this post
and their life will be a tad bit easier.</p>
</div><p class="meta">Posted on <span class="postdate">2019-03-14</span></p></article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
