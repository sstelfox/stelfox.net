<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='While cleaning up some tech debt, a curious issue cropped up. Nginx was running in an alpine container as a front end load balancer. It had a dynamic config that got periodically updated by a sidecar, and had filebeat shipping logs out to a central collector but otherwise was just a very simple Nginx config.
Every now and then the container would crash, it would automatically recover fast enough no alarms were lost and the clients would just resend their requests.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Fixing Hung Nginx Workers • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='While cleaning up some tech debt, a curious issue cropped up. Nginx was running in an alpine container as a front end load balancer. It had a dynamic config that got periodically updated by a sidecar, and had filebeat shipping logs out to a central collector but otherwise was just a very simple Nginx config.
Every now and then the container would crash, it would automatically recover fast enough no alarms were lost and the clients would just resend their requests.'>
<meta property='og:url' content='https://stelfox.net/blog/2019/10/fixing-hung-nginx-workers/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='linux'><meta property='article:tag' content='nginx'><meta property='article:tag' content='diagnostics'><meta property='article:published_time' content='2019-10-25T11:26:31-05:00'/><meta property='article:modified_time' content='2019-10-25T11:26:31-05:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.61.0-DEV" />

  <title>Fixing Hung Nginx Workers • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2019/10/fixing-hung-nginx-workers/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Fixing Hung Nginx Workers</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2019-10-25T11:26:31-05:00'>2019, Oct 25</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
4 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>While cleaning up some tech debt, a curious issue cropped up. Nginx was running
in an alpine container as a front end load balancer. It had a dynamic config
that got periodically updated by a sidecar, and had filebeat shipping logs out
to a central collector but otherwise was just a very simple Nginx config.</p>
<p>Every now and then the container would crash, it would automatically recover
fast enough no alarms were lost and the clients would just resend their
requests. No data was losts, everything failed gracefully, but it's still a
pretty crazy thing to leave happening.</p>
<p>There was nothing in the log besides some client errors and configuration
reloading notifications. The external metrics showed the container throwing
some kind of memory party before finally burning out and crashing. It was a
pretty steady trend upwards indicative of some kind of a memory leak. The graph
below illustrates this. Each of those drops is either the container crashing or
me manually restarting it to test behavior. Can you figure out when I fixed the
issue?</p>
<p><img src="/images/nginx_memory_consumption.png" alt="Graph showing Nginx memory usage. The graph goes from chaotic tosteady"></p>
<p>To figure out what was going on I had to get an invitation that container's
party.</p>
<p>I don't think there is great tooling for inspecting individual processes inside
of containers. As much as we'd like to think of containers as isolated
applications, its not uncommon for them to run <a href="https://github.com/krallin/tini">a minimal init container</a>,
or be composed of separate different processes themselves that handle different
things (Nginx has a master process and spawns off many worker processes). We
still need the data on those processes.</p>
<p>The common solution to getting this data seems to be to &ldquo;just exec into the
container&rdquo;. In general <code>exec</code> should be restricted. If you find yourself
running exec in a container, you're missing tooling or metrics that should
avoid that (which is the case here).</p>
<p>Denying <code>exec</code> is probably a longer discussion but the short of it is: If you
can <code>exec</code> into the container, you can extract its secrets, configuration, and
access any services that it's allowed to (likely escalating your personal
privileges within the cluster). This is without considering the ramifications
of <code>exec</code>'ing into a privileged container.</p>
<p>In any event, not all container clusters solution allow external execution
(looking at you AWS ECS, its the one good thing I have to say about you).</p>
<p>I chose to modify the container to log the data I needed instead. I setup a
wrapper that started and backgrounded the following script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">do</span>
  <span style="color:#75715e"># This generates a JSON output that can be pulled via the ECS logs of the top</span>
  <span style="color:#75715e"># memory consuming processes using what we have available in alpine.</span>
  ps -o pid,time,rss,vsz,args |
    tail -n +2 |
    awk <span style="color:#e6db74">&#39;memstat: { print &#34;{\&#34;pid\&#34;:&#34; $1 &#34;,\&#34;time\&#34;:\&#34;&#34; $2 &#34;\&#34;,\&#34;rss\&#34;:&#34; $3 &#34;,\&#34;vsz\&#34;:&#34;
</span><span style="color:#e6db74">$4 &#34;,\&#34;cmd\&#34;:\&#34;&#34; substr($0, index($0,$5)) &#34;\&#34;}&#34; }&#39;</span>

  sleep <span style="color:#ae81ff">300</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><p>Yes, I'm abusing <code>awk</code> to generate JSON I can parse later.</p>
<p>Each message has a prefix of <code>memstat:</code> so I can easily filter and extract that
data from the live log stream. After a couple of hours (the time it generally
took for the party to get going) the issue was pretty obvious. Inside the
container there was a growing number of processes with the name <code>nginx: worker process is shutting down</code>. Some Googling turned up <a href="https://forum.nginx.org/read.php?2,262403,262403">a post in the Nginx mailing
list</a> from a while ago.</p>
<p>The responses claimed that it was the result of a third party module, but this
is stock Nginx (version 1.15.8 at the time) which was at least three years
older than the post. It did indicate a clue though: config reloading.</p>
<p>I don't know why Nginx believed connections were still open, we have request
and connect timeouts both in this config and upstream. Some of these processes
were sticking around for hours (I never actually saw one exit after getting
into this hung state). Every config reload was dropping a zombie worker or two
into the container, permanently consuming ~30Mb of RAM. When it hit the
configured threshold, the party gets stopped.</p>
<p>An option was added in the <a href="http://nginx.org/en/docs/ngx_core_module.html#worker_shutdown_timeout">Nginx core module</a> to handle situations where
the worker wouldn't close, but this definitely seems like a bug of some kind.
There is a newer version of Nginx (1.17.5 at the time of the writing) that
could very well have fixed this issue.</p>
<p>Adding <code>worker_shutdown_timeout 60s;</code> to the main Nginx config solved the issue
(60 seconds matches our request and connect timeouts so nothing valid should
last longer than that). Sure enough Nginx went back to stable, and predictably
low memory usage.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/linux/'>linux</a>, <a class='tag' href='/tags/nginx/'>nginx</a>, <a class='tag' href='/tags/diagnostics/'>diagnostics</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2019/04/fixing-dark-input-boxes-in-firefox/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Fixing Dark Input Boxes in Firefox</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2019/11/blender-loop-select-in-cinnamon/'>
        <span class='screen-reader-text'>Next post: </span>Blender Loop Select in Cinnamon<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2020 Sam Stelfox </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script>

</body>

</html>

