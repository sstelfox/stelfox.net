<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1><a href="https:&#x2F;&#x2F;stelfox.net&#x2F;blog&#x2F;2016&#x2F;sharing-context-between-dependent-rake-tasks&#x2F;">Sharing Context Between Dependent Rake Tasks</a></h1>

  <div class="post-content"><p>I use Rakefiles quite a bit like traditional Makefiles, in that I specify
immediate dependencies for an individual task and Rake will execute all of
them. If a file or directory is the dependency and it exists, the task that
creates it will be skipped. A contrived Rakefile example might look like:</p>
<span id="continue-reading"></span><pre data-lang="ruby" class="language-ruby "><code class="language-ruby" data-lang="ruby">file 'sample' do |t|
  puts 'Creating sample directory'
  Dir.mkdir(t.name)
end

file 'sample/population.txt' => ['sample'] do |t|
  puts 'Creating sample population file...'
  # Perhaps download a dataset? Lets just create the file
  File.write(t.name, "---> Very important data <---\n")
end

task :process_population => ['sample/population.txt'] do
  puts 'Check out our data!'
  # Do some processing... whatever you need to...
  puts File.read('sample/population.txt')
end
</code></pre>
<p>The first time you run it you'll the following output:</p>
<pre><code>$ rake process_population
Creating sample directory
Creating sample population file...
Check out our data!
---> Very important data <---
</code></pre>
<p>And subsequent runs will skip the creation since they're already present:</p>
<pre><code>$ rake process_population
Check out our data!
---> Very important data <---
</code></pre>
<p>This is fine for statically implementing file contents, but what if you need
additional information to generate the file? With a normal rake task you can
provide bracketed arguments to access additional information like so:</p>
<pre><code>task :args_example, :word do |t, args|
  puts "The word is: #{args.word}"
end
</code></pre>
<p>You'd use it like so:</p>
<pre><code>$ rake args_example[data]
The word is: data
</code></pre>
<p>That information isn't made available to the dependent tasks though so we need
to broaden our scope a little bit. There is another way to provide arguments to
Rake using key value pairs. This has a bonus that was kind of an obvious
solution once I found it. Rake provides the values of key/value pairs to a task
via environment variables. Another contrived example of how to use this
(specifically with a file dependency example):</p>
<pre data-lang="ruby" class="language-ruby "><code class="language-ruby" data-lang="ruby">file 'passed_state' do |t|
  puts 'Creating state file'
  File.write(t.name, ENV['state'])
end

task :read_state => ['passed_state'] do
  puts File.read('passed_state')
end
</code></pre>
<pre data-lang="sh" class="language-sh "><code class="language-sh" data-lang="sh">$ rake read_state state=something
Creating state file
something
</code></pre>
<p>State has been transferred! There is a gotcha, that is handling expiration of
data yourself. Passing in state again with a different value you'll see the
problem:</p>
<pre data-lang="sh" class="language-sh "><code class="language-sh" data-lang="sh">$ rake read_state state=notsomething
something
</code></pre>
<p>It won't recreate that file again until it's removed which you'll need to
handle on your own.</p>
</div><p class="meta">Posted on <span class="postdate">2016-02-18</span></p></article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
