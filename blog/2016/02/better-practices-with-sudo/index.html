<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='I work with a lot of different linux machines from embedded devices, to cloud
servers and open stack hosts. For many of them I&rsquo;m either the sole
administrator or one of three or less with administrative access. Where there
are multiple administrative users, we all are generally working as backups to
each other. We use sudo whenever we need to execute a task with privileges on
any of these machines with no direct root login permitted remotely.

I must confess I have established two habits over time that are against best
practices with regard to sudo; Using it to execute a root shell only, and not
restricting which commands can be run with sudo.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Better Practices With Sudo • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='I work with a lot of different linux machines from embedded devices, to cloud
servers and open stack hosts. For many of them I&rsquo;m either the sole
administrator or one of three or less with administrative access. Where there
are multiple administrative users, we all are generally working as backups to
each other. We use sudo whenever we need to execute a task with privileges on
any of these machines with no direct root login permitted remotely.

I must confess I have established two habits over time that are against best
practices with regard to sudo; Using it to execute a root shell only, and not
restricting which commands can be run with sudo.'>
<meta property='og:url' content='https://stelfox.net/blog/2016/02/better-practices-with-sudo/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='linux'><meta property='article:tag' content='security'><meta property='article:published_time' content='2016-02-26T17:45:22-05:00'/><meta property='article:modified_time' content='2016-02-26T17:45:22-05:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.51-DEV" />

  <title>Better Practices With Sudo • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2016/02/better-practices-with-sudo/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4267b3fa.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>


<body class='page type-blog'>

  <div class='site'>

    <a class='screen-reader-text' href='#content'>Skip to Content</a>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Better Practices With Sudo</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2016-02-26T17:45:22-05:00'>2016, Feb 26</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
12 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>I work with a lot of different linux machines from embedded devices, to cloud
servers and open stack hosts. For many of them I&rsquo;m either the sole
administrator or one of three or less with administrative access. Where there
are multiple administrative users, we all are generally working as backups to
each other. We use sudo whenever we need to execute a task with privileges on
any of these machines with no direct root login permitted remotely.</p>

<p>I must confess I have established two habits over time that are against best
practices with regard to sudo; Using it to execute a root shell only, and not
restricting which commands can be run with sudo.</p>

<p>I&rsquo;m sure many other administrators commit these sins as well. I&rsquo;ve always
gotten sudo to the &lsquo;good enough&rsquo; point without ever learning how to configure
it properly countless times, which mostly meant leaving the distribution&rsquo;s
defaults.</p>

<p>At face value, executing a shell this way doesn&rsquo;t seem to pose a problem. We
use auditd to record administrative changes, and the kernel can track our
original login UID and record that in addition to our effective user ID.
Permission to use sudo is still restricted to a subset of trusted
administrators.</p>

<p>Using this default configuration is forming bad habits and after working
through it it&rsquo;s not particularly hard to make a drastic improvement on the
granularity of control.</p>

<p>I&rsquo;m going to work through the changes I&rsquo;ve made slowly building up my final
configuration.</p>

<p><strong><em>These changes, if made incorrectly or with the wrong paths to binaries may
effect your ability to get privileged access to the system. I strongly
encourage you to maintain a root shell independent of the shell you are using
to test just in case you need to revert a breaking change.</em></strong></p>

<h2 id="minimal-configuration">Minimal Configuration</h2>

<p>Rather than looking at what needs to be changed, or removed I prefer to start
with a minimal effective configuration.</p>

<p>Most distribution&rsquo;s default sudo configuration pass through environment
variables related to locale and a few others. I have left these out since the
way I see sudo executed most commonly (<code>sudo su -</code>), removes any environment
variables passed through anyway. If you work on multi-lingual systems or
otherwise your administrators make use of multiple system locales, you will
want to re-introduce the locale values used.</p>

<p>My entire starting sudo configuration is the following:</p>

<pre><code>Defaults env_reset
Defaults !visiblepw

root      ALL=(ALL)     ALL
%wheel    ALL=(root)    ALL
</code></pre>

<p>This is very similar to most distribution&rsquo;s configurations if you ignore the
environment variables and comments. The root user and members of the wheel
group can all execute anything as sudo as long as the user can authenticate
through PAM and the mechanism won&rsquo;t display their password.</p>

<p>There is also a small restriction in place that ensures members of the wheel
group will only be executing commands as the root user. Executing as other
user&rsquo;s directly should be a special case and added separately.</p>

<p>Usually distributions also include additional sudo configuration by including
all files in /etc/sudoers.d. This configuration isn&rsquo;t going to be terribly long
so we may as well KISS it and not allow the inclusion of other files.</p>

<h2 id="no-need-for-the-su">No Need for the su</h2>

<p>The first habit I wanted to break was executing <code>sudo su -</code> instead of <code>sudo
-s</code>. Generally when sudo is configured correctly, administrators are supposed
to minimize the number of times dropping to a root shell. There are always
going to be times when a root shell is necessary.</p>

<p>The differences between the two methods of executing a root shell are subtle.
They are creating to different types of shells. Executing <code>sudo su -</code> creates
a login shell, while <code>sudo -s</code> doesn&rsquo;t. Both can be subtly changed to provide
the other type (Adding the <code>-i</code> flag to sudo, or removing the <code>-</code> from su).</p>

<p>A login shell resets your environment, spawns the new user&rsquo;s default shell (in
this case root&rsquo;s default shell) and executes the user&rsquo;s profile scripts in
addition to the shell&rsquo;s rc files.</p>

<p>By not using a login shell, administrators can keep their preferred shells
while allowing selective bits of their configuration (whitelisted environment
variables) through to the new session.</p>

<p>By removing <code>su</code> from the process, administrators can enforce permitted root
shells just like whitelisting or blacklisting any other binary on the system.
The only way to enforce this transition is to blacklist <code>su</code> directly.</p>

<p>A blacklist is added by creating a command alias that includes the commands to
be blacklisted, then adjusting ACLs to make use of them. These need to be
defined before they&rsquo;re used. Generally this means all command aliases are at
the top of the configuration file. The following command alias will be used for our
blacklist. The path to <code>su</code> is valid for CentOS 7, other distributions do
vary.</p>

<pre><code>Cmnd_Alias BLACKLIST = /bin/su
</code></pre>

<p>To enforce the blacklist the wheel group ACL needs to be adjusted to the
following:</p>

<pre><code>%wheel  ALL=(root)  ALL,!BLACKLIST
</code></pre>

<p>Now when you try to execute <code>sudo su -</code> you&rsquo;ll instead get this warning after
authenticating:</p>

<pre><code>Sorry, user &lt;username&gt; is not allowed to execute '/bin/su -' as root on &lt;hostname&gt;.
</code></pre>

<p>This warning will enforce not using the less ideal mechanism.</p>

<h2 id="brief-interlude-on-blacklists">Brief Interlude on Blacklists</h2>

<p>I&rsquo;m going to be adding several more things to different forms of blacklists
inside sudo. Some of these may be unacceptably inconvenient for some
environments. If you find the explained reason insufficient to justify the
inconvenience and are willing to accept the risk, remove the offender from the
blacklist.</p>

<p>There is also always a risk that programs allowed through the blacklist have
the ability to execute blacklisted applications as root. The blacklist applies
only to direct execution through sudo.</p>

<p>Preventing &lsquo;commonly used&rsquo; escalation vectors does make it that much harder on
potential attackers and may allow you see an attack in progress through the
logs. This should not be considered perfect though. A good example of these
vectors is the utility <code>awk</code>. If allowed to be executed through sudo an
unrestricted root shell can be acquired with the following command:</p>

<pre><code>sudo awk 'BEGIN {system(&quot;/bin/sh&quot;)}'
</code></pre>

<h2 id="editing-files-as-root">Editing Files as Root</h2>

<p>Commonly when I wanted to edit a particular sensitive configuration file, I
would drop to a root shell, then open the file in my preferred editor, possibly
saving along the way until I was done. Less commonly I would open my editor
directly using <code>sudo</code> skipping the shell entirely.</p>

<p>The partially complete saves as part of that workflow, have caused issues
though they&rsquo;re temporary. Sudo provides a utility, <code>sudoedit</code>, that covers this
use case. It make a copy of the file to be edited into a temporary directory,
and allows you to edit and save as you like. When you&rsquo;re done save the file and
it will replace the real file with the temporary one you&rsquo;ve been editing.</p>

<p>Editing the sudoers file itself should be done using the <code>visudo</code> command. And
can be invoked by:</p>

<pre><code>sudo visudo
</code></pre>

<p>It&rsquo;s a good idea to restrict the list of editors that can be used by visudo
(this doesn&rsquo;t affect sudoedit at all) by adding the following line (replace
this with your preferred, colon separated list of editors):</p>

<pre><code>Defaults editor = /bin/vim:/bin/nano
</code></pre>

<h2 id="user-writable-directories">User Writable Directories</h2>

<p>Since the blacklist functionality is based on full paths to binaries, there is
a quick way for a user with sudo permissions to bypass the blacklist for a
specific program, copy it somewhere else.</p>

<p>When an attacker gets into a system and downloads a binary off their site they
want to run with privileges. They&rsquo;ll have to put it somewhere they have
permission to write to.</p>

<p>This is less of a threat if you always require authentication to use sudo,
trust all your administrators, and are confident their credentials will never
be stolen.</p>

<p>A salve to both problems is simply to prevent sudo from executing files in user
writable directories, and ensuring it has a sane path to lookup trusted
binaries. The following three lines need to be added to the sudoers file:</p>

<pre><code>Cmnd_Alias USER_WRITEABLE = /home/*, /tmp/*, /var/tmp/*
Defaults ignore_dot
Defaults secure_path = /sbin:/bin:/usr/sbin:/usr/bin
</code></pre>

<p>We also need to modify our wheel ACL to prevent the execution in the aliases
locations. Replace your previous line with the following one:</p>

<pre><code>%wheel  ALL=(root)  ALL,!BLACKLIST,!USER_WRITEABLE
</code></pre>

<h2 id="preventing-breakouts">Preventing Breakouts</h2>

<p>I&rsquo;ve already shown that there is a way to abuse individual commands to expose a
root shell. There are a few additional common applications that can regularly
shell out, advanced text editors, pagers, several unix utilities and any
interactive programming shell are easy candidates.</p>

<p>These utilities likely still need to be available for general administrative
purposes, but we don&rsquo;t want them in turn executing other programs. Sudo has a
trick up it&rsquo;s sleeve for this, the noexec flag.</p>

<p>There are two ways to effectively apply this, a whitelist and a blacklist. I
encourage you to try the whitelist approach first as it does offer
substantially better protection against this potential abuse.</p>

<p>Before applying this it is useful to know how this works and what it&rsquo;s
limitations are. Sudo disables the exec call using <code>LD_PRELOAD</code> and defining an
alternate version of the system call. This is largely effective, but will only
work with dynamically linked programs (most coming from a distribution are
going to be dynamically linked).</p>

<h3 id="whitelisting-programs-w-exec-privileges">Whitelisting Programs w/ Exec Privileges</h3>

<p>This is very strict but also very effective. We need to ensure that things we
expect and want to be able to execute other programs (like shells) still can.
Additionally visudo in turn executes your editor, so it to needs to be able to
spawn programs.</p>

<p>Be very sure of the paths in the following change. If you have no shells, or
editors that can be executed as root through sudo you may lock yourself out of
your system privileges.</p>

<pre><code>Cmnd_Alias SHELLS = /bin/sh, /bin/bash
Cmnd_Alias ALLOWED_EXEC = /usr/sbin/visudo
Defaults noexec
Defaults!ALLOWED_EXEC,SHELLS !noexec
</code></pre>

<p>As you use this in your environment you will probably find programs that behave
incorrectly and will need to be added to the whitelist. This whitelist
(assuming your paths are correct) will at least be enough to allow future
modifications of the sudoers file.</p>

<h3 id="blacklisting-programs-w-exec-privileges">Blacklisting Programs w/ Exec Privileges</h3>

<p>This is a much milder version of the exec restrictions, and won&rsquo;t catch unknown
abuses. This will also have the least impact on normal operations to apply and
is better than nothing.</p>

<pre><code>Cmnd_Alias EDITORS     = /bin/vim
Cmnd_Alias PAGERS      = /bin/less, /bin/more
Cmnd_Alias BREAKOUT    = /bin/awk, /bin/find
Cmnd_Alias DEVEL_SHELL = /bin/perl, /bin/python, /bin/ruby

Defaults!EDITORS,PAGERS,BREAKOUT,DEVEL_SHELL noexec
</code></pre>

<h2 id="ttys">TTYs!</h2>

<p>Enforcing the use of TTYs generally prevents non-interactive processes from
executing anything as sudo either remotely or locally. Examples of this might
be from cron, apache, or from a remote Jenkins server. In almost all cases
prevention of this type of execution is the ideal behavior.</p>

<p>There are a <a href="https://unix.stackexchange.com/questions/65774/is-it-okay-to-disable-requiretty">couple</a> of very <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1020147">visible</a> search results on this topic that
indicate there isn&rsquo;t any security benefit to this, but their are
<a href="https://superuser.com/questions/180764/sudoers-files-requiretty-flag-security-implications">exceptions</a> as well. The argument that seems to have the most merit, is
that no special privileges are required to create a PTY. This in turn means an
attacking process could spawn the PTY required, and continue it&rsquo;s attack.</p>

<p>The same argument could be used in favor of the option. An attacker would have
learn they need to make this adjustment and actively work around it. As the
administrator you know the option is set and should be able to work around it
more easily than the attacker.</p>

<p>The most common form of pain seems to be remotely executing privileged commands
through ssh. By providing the SSH command being executed the &lsquo;-t&rsquo; flag twice,
the client will force a PTY allocation even when there is no local tty. Other
more stubborn use cases can be individually exempted.</p>

<p>When the user already has a local TTY, the sudoers man page calls out to an
additional potential attack vector around TTYs under the &lsquo;use_pty&rsquo; option:</p>

<blockquote>
<p>A malicious program run under sudo could conceivably fork a background
process that retains to the user&rsquo;s terminal device after the main program has
finished executing. Use of this option will make that impossible.</p>
</blockquote>

<p>I haven&rsquo;t been able to find any attacks that exploit this possibility, but I
have yet to be impacted by turning that feature on within sudo. Making both
changes can be done by adding the following line to the sudoers configuration.</p>

<pre><code>Defaults requiretty, use_pty
</code></pre>

<h2 id="notification-of-violation">Notification of Violation</h2>

<p>Receiving immediate notification when privilege gain has been attempted can be
invaluable to stopping an attacker before they can do any damage. If the linux
system has a properly configured MTA forwarding root&rsquo;s email to relevant
parties it is recommended to have failure mailed to them directly to take
action.</p>

<pre><code>Defaults mail_badpass, mail_no_perms
Defaults mailfrom = root
Defaults mailsub = &quot;Sudo Policy Violation on %H by %u&quot;
</code></pre>

<p>The overridden subject provides everything but the command itself (which isn&rsquo;t
available through the expanded variables) needed to quickly judge a threat at a
glance.</p>

<h2 id="auditing-interactive-shells">Auditing Interactive Shells</h2>

<p>With all the protections put in place so far, we still have no visibility or
restrictions on what administrators do with the root shells when they
use them. These should hopefully be relatively few and far between.</p>

<p>Built into sudo is an option to <em>record</em> execution of commands. This has proven
to be valuable to narrow down things that have gone wrong, or see how something
was done before. This may not prove useful as much for an audit tool as a user
with root privileges can purge the recordings and logs.</p>

<p>If auditing is the goal, use of the kernel audit subsystem may be a better
choice, but will only give you the command and arguments executed. This shows
what was displayed to the privileged shell directly. There will be a future
article covering the use of the audit subsystem and centralizing the
information in a future post.</p>

<p>If you didn&rsquo;t go the whitelist exec route, to enable this you will need to pull
in the &lsquo;SHELLS&rsquo; command alias from there to make use of this.</p>

<pre><code>Defaults!SHELLS log_output
</code></pre>

<p>Once this is in place you can get a list of recorded sessions using the
command:</p>

<pre><code>$ sudo sudoreplay -l
Feb 26 17:56:18 2016 : jdoe : TTY=/dev/pts/7 ; CWD=/home/jdoe ; USER=root ; TSID=000001 ; COMMAND=/bin/bash
</code></pre>

<p>To view an individual session provide <code>sudoreplay</code> with the TSID value of the
session like so:</p>

<pre><code>$ sudo sudoreplay 000001
</code></pre>

<p>Refer to the man page of <code>sudoreplay</code> for additional tricks such as speeding up
playback.</p>

<h2 id="final-configuration">Final Configuration</h2>

<p>Some of the options from above I have combined into a single configuration
line. This uses the stricter whitelist policy for exec privileges.</p>

<pre><code># /etc/sudoers

Cmnd_Alias ALLOWED_EXEC = /usr/sbin/visudo
Cmnd_Alias BLACKLIST = /usr/bin/su
Cmnd_Alias SHELLS = /usr/bin/sh, /usr/bin/bash
Cmnd_Alias USER_WRITEABLE = /home/*, /tmp/*, /var/tmp/*

Defaults env_reset, mail_badpass, mail_no_perms, noexec, requiretty, use_pty
Defaults !visiblepw

Defaults editor = /usr/bin/vim
Defaults mailfrom = root
Defaults mailsub = &quot;Sudo Policy Violation on %H by %u&quot;
Defaults secure_path = /sbin:/bin:/usr/sbin:/usr/bin

Defaults!ALLOWED_EXEC,SHELLS !noexec
Defaults!SHELLS log_output

root    ALL=(ALL)   ALL
%wheel  ALL=(root)  ALL,!BLACKLIST,!USER_WRITEABLE
</code></pre>
</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/linux/'>linux</a>, <a class='tag' href='/tags/security/'>security</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2016/02/sharing-context-between-dependent-rake-tasks/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Sharing Context Between Dependent Rake Tasks</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2016/09/hash-cash/'>
        <span class='screen-reader-text'>Next post: </span>Hash Cash<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2018 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.59f76c44.js'></script>

</body>

</html>

