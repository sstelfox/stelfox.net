<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="I regularly find myself working on projects that involve the manipulation and storage of RSA keys. In the past I've never had to worry about identification or presentation of these keys. Normally I've only got one too three pairs at most that I'm manipulating (server, certificate authority, client).
I've not found myself working on a project that involves presenting the certificates to users for selection and comparison. The obvious way too do this is take a page out of other developer's books and present the key's fingerprint."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,development,ruby,security"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2014/04/calculating-rsa-key-fingerprints-in-ruby/><title>Calculating RSA Key Fingerprints in Ruby :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Calculating RSA Key Fingerprints in Ruby"><meta itemprop=description content="I regularly find myself working on projects that involve the manipulation and storage of RSA keys. In the past I've never had to worry about identification or presentation of these keys. Normally I've only got one too three pairs at most that I'm manipulating (server, certificate authority, client).
I've not found myself working on a project that involves presenting the certificates to users for selection and comparison. The obvious way too do this is take a page out of other developer's books and present the key's fingerprint."><meta itemprop=datePublished content="2014-04-21T18:37:04-04:00"><meta itemprop=dateModified content="2014-04-21T18:37:04-04:00"><meta itemprop=wordCount content="636"><meta itemprop=keywords content="Development,Ruby,Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="Calculating RSA Key Fingerprints in Ruby"><meta name=twitter:description content="I regularly find myself working on projects that involve the manipulation and storage of RSA keys. In the past I've never had to worry about identification or presentation of these keys. Normally I've only got one too three pairs at most that I'm manipulating (server, certificate authority, client).
I've not found myself working on a project that involves presenting the certificates to users for selection and comparison. The obvious way too do this is take a page out of other developer's books and present the key's fingerprint."><meta property="article:published_time" content="2014-04-21 18:37:04 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2014/04/calculating-rsa-key-fingerprints-in-ruby/>Calculating RSA Key Fingerprints in Ruby</a></h2><div class=post-content><p>I regularly find myself working on projects that involve the manipulation and storage of RSA keys. In the past I've never had to worry about identification or presentation of these keys. Normally I've only got one too three pairs at most that I'm manipulating (server, certificate authority, client).</p><p>I've not found myself working on a project that involves presenting the certificates to users for selection and comparison. The obvious way too do this is take a page out of other developer's books and present the key's fingerprint.</p><p>For those unfamiliar with key fingerprints, they are a condensed way to compare differing RSA with a high probability that if the fingerprints match, so do the keys. These are generally based on a cryptographic digest function such as SHA1 and MD5, and you'll see them most commonly when connecting to a new SSH host and will look like the following:.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The authenticity of host &#39;some.fakedomain.tld (127.0.0.1)&#39; can&#39;t be established.
</span></span><span class=line><span class=cl>RSA key fingerprint is 0c:6c:dd:32:b5:59:40:1d:ac:05:24:4f:04:bc:e0:f3.
</span></span><span class=line><span class=cl>Are you sure you want to continue connecting (yes/no)?
</span></span></code></pre></td></tr></table></div></div><p>The string of 32 hex characters presented there can be compared with another known value to make sure you're connecting to the correct SSH server and will always be the same length regardless of the bit-strength of the keys used. Without the fingerprint, users would have to compare 256 hex characters for a 1024 bit key, which is a very low security key.</p><p>You can calculate the SSH fingerprint for your SSH key or a SSH host key using the ssh-keygen command like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ssh-keygen -lf ~/.ssh/id_rsa
</span></span><span class=line><span class=cl><span class=gp>$</span> ssh-keygen -lf /etc/ssh/ssh_host_key.pub
</span></span></code></pre></td></tr></table></div></div><p>It will work when the path is either a private RSA key or a public key formatted for SSH authorized key files.</p><p>X509 certificates also use a key fingerprint to help identify a certificate's signing authority. What I rapidly learned through this investigation was that they are calculated slightly differently from SSH fingerprints even if they're in the same format.</p><p>I couldn't find any good Ruby code that calculated either, and the alternatives were some dense C++. Luckily SSH fingerprints are pretty documented in <a href=http://www.ietf.org/rfc/rfc4253.txt>RFC4253</a> and <a href=http://www.ietf.org/rfc/rfc4716.txt>RFC4716</a>. Fingerprints on RSA keys for use with OpenSSL are less clear, and there is a different method for calculating the fingerprints of certificates.</p><p>Slowly working through the undocumented bits of Ruby's OpenSSL wrapper, the RFCs and a couple of C++ implementations I finally got a set of working implementations that calculate the following fingerprints in Ruby:</p><ul><li>MD5 & SHA1 fingerprints for RSA SSH keys</li><li>Fingerprints of RSA keys for use with x509 certificates</li><li>Fingerprints of x509 certificates</li></ul><p>The easiest being a regular x509 certificate:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;openssl&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>path_to_cert</span> <span class=o>=</span> <span class=s1>&#39;/tmp/sample.crt&#39;</span>
</span></span><span class=line><span class=cl><span class=n>cert</span> <span class=o>=</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>X509</span><span class=o>::</span><span class=no>Certificate</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>path_to_cert</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>Digest</span><span class=o>::</span><span class=no>SHA1</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(</span><span class=n>cert</span><span class=o>.</span><span class=n>to_der</span><span class=p>)</span><span class=o>.</span><span class=n>scan</span><span class=p>(</span><span class=sr>/../</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>You can compare the output of the above code with OpenSSL's implementation with the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> openssl x509 -in /tmp/sample.crt -noout -fingerprint
</span></span></code></pre></td></tr></table></div></div><p>Please note that case sensitivity doesn't matter here (OpenSSL will return upper case hex codes).</p><p>The next one I got working was the SSH fingerprints thanks to the RFCs mentioned earlier.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4>4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5>5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6>6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;openssl&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>path_to_key</span> <span class=o>=</span> <span class=s1>&#39;/tmp/ssh_key&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>PKey</span><span class=o>::</span><span class=no>RSA</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>path_to_key</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>data_string</span> <span class=o>=</span> <span class=o>[</span><span class=mi>7</span><span class=o>].</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;N&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;ssh-rsa&#39;</span> <span class=o>+</span> <span class=n>key</span><span class=o>.</span><span class=n>public_key</span><span class=o>.</span><span class=n>e</span><span class=o>.</span><span class=n>to_s</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>key</span><span class=o>.</span><span class=n>public_key</span><span class=o>.</span><span class=n>n</span><span class=o>.</span><span class=n>to_s</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>Digest</span><span class=o>::</span><span class=no>MD5</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(</span><span class=n>data_string</span><span class=p>)</span><span class=o>.</span><span class=n>scan</span><span class=p>(</span><span class=sr>/../</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><em>Please note: The above only works for RSA SSH keys.</em></p><p>Calculating a SHA1 fingerprint for SSH hosts is as simple as replacing the 'MD5' class with 'SHA1' or any of the other support digest algorithms.</p><p>The last one was the hardest to track down and implement, eventually I found the answer in <a href=http://www.ietf.org/rfc/rfc3279.txt>RFC3279</a> under section 2.3.1 for the format of the public key I would need to generate before performing a digest calculation on it.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;openssl&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>path_to_key</span> <span class=o>=</span> <span class=s1>&#39;/tmp/x509_key.pem&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>PKey</span><span class=o>::</span><span class=no>RSA</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>path_to_key</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>data_string</span> <span class=o>=</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>ASN1</span><span class=o>::</span><span class=no>Sequence</span><span class=p>(</span><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=no>OpenSSL</span><span class=o>::</span><span class=no>ASN1</span><span class=o>::</span><span class=nb>Integer</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=o>.</span><span class=n>public_key</span><span class=o>.</span><span class=n>n</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=no>OpenSSL</span><span class=o>::</span><span class=no>ASN1</span><span class=o>::</span><span class=nb>Integer</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=o>.</span><span class=n>public_key</span><span class=o>.</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>]</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>Digest</span><span class=o>::</span><span class=no>SHA1</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(</span><span class=n>data_string</span><span class=o>.</span><span class=n>to_der</span><span class=p>)</span><span class=o>.</span><span class=n>scan</span><span class=p>(</span><span class=sr>/../</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/development/>development</a></span>
<span class=tag><a href=https://stelfox.net/tags/ruby/>ruby</a></span>
<span class=tag><a href=https://stelfox.net/tags/security/>security</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=bd9e1ab3269fdee0856f80854c902432ef10f201 target=_blank rel=noopener>bd9e1ab3</a> @ 2024-07-14</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>