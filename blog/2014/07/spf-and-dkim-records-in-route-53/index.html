<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='I&rsquo;m going to do a more detailed post on emailing from Amazon&rsquo;s infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon&rsquo;s Route 53, and most are user error (myself).
SPF Invalid Characters or Format After generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='SPF &amp; DKIM Records in Route 53 • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='I&rsquo;m going to do a more detailed post on emailing from Amazon&rsquo;s infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon&rsquo;s Route 53, and most are user error (myself).
SPF Invalid Characters or Format After generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:'>
<meta property='og:url' content='https://stelfox.net/blog/2014/07/spf-and-dkim-records-in-route-53/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='aws'><meta property='article:tag' content='security'><meta property='article:published_time' content='2014-07-30T10:46:13-04:00'/><meta property='article:modified_time' content='2014-07-30T10:46:13-04:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.51-DEV" />

  <title>SPF &amp; DKIM Records in Route 53 • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2014/07/spf-and-dkim-records-in-route-53/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4a10984a.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>SPF &amp; DKIM Records in Route 53</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2014-07-30T10:46:13-04:00'>2014, Jul 30</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
4 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<p>I&rsquo;m going to do a more detailed post on emailing from Amazon&rsquo;s infrastructure
soon, but in the meantime I wanted to quickly throw out solutions too a couple
of problems I encountered. These are all specific too Amazon&rsquo;s Route 53, and
most are user error (myself).</p>

<h2 id="spf-invalid-characters-or-format">SPF Invalid Characters or Format</h2>

<p>After generating my SPF record, I jumped into Route 53, created a new record
pasted in my record, attempted to save and received the following message:</p>

<blockquote>
<p>The record set could not be saved because:
- The Value field contains invalid characters or is in an invalid format.</p>
</blockquote>

<p>I was using the SPF record type at a time (see the next section) and assumed
that I had messed up the format of my record in some way. I banged my head
against the wall and through RFCs thoroughly before I found the solution&hellip;</p>

<p>Solution: Wrap your SPF records in quotation characters.</p>

<h2 id="no-spf-record-found-validation-failure">No SPF Record Found / Validation Failure</h2>

<p>Since I have my DMARC policy in place (I&rsquo;ll cover this in my email follow up),
I receive daily domain reports from Google whenever something fails validation
about my domain. After switching to Route 53 for DNS the <code>authresult</code> component
started showing up as fail for SPF.</p>

<p>Testing around a few online SPF validators indicated that none of them were
able to see my new SPF record, and there had been plenty of time for it too
propagate.</p>

<p>The SPF resource record type (RRTYPE 99) is available in Route 53 even though
<a href="https://tools.ietf.org/html/rfc6686#section-3.1">the record type has been deprecated</a>. Not being familiar with this
particular decision, I assumed I should be using it <em>instead</em> of the TXT record
I&rsquo;ve used for every other domain, and it would be handled correctly or more
intelligently.</p>

<p>Solution: Either switch the SPF record too a TXT record or, my preference,
duplicate it into a TXT record so you have both.</p>

<h2 id="invalid-dkim-record">Invalid DKIM record</h2>

<p>This one had me scratching my head for a while. This was my first time
deploying DKIM on a domain that I was not running a Bind name server for.
OpenDKIM is nice enough too generate a Bind record for you which works
perfectly. It&rsquo;s output looks like the following:</p>

<pre><code>default._domainkey.example.tld.   IN      TXT     ( &quot;v=DKIM1; k=rsa; t=y; s=email; &quot;
          &quot;p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJo&quot;
          &quot;nJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&quot; )  ; ----- DKIM key default for example.tld
</code></pre>

<p>Copying and pasting everything between the parentheses in the value field and
pasting them into Route 53 works flawlessly. The catch? This won&rsquo;t be treated
as a single record, but three individual responses. None of which are complete
and valid DKIM records.</p>

<p>This happens because Route 53&rsquo;s value field treats newlines as separate
records.</p>

<p>Solution: Turn it into one long string so it isn&rsquo;t covering multiple lines
right? Not quite&hellip;</p>

<h2 id="txtrdatatoolong">TXTRDATATooLong</h2>

<p>Combining the DKIM key into one string like so:</p>

<pre><code>&quot;v=DKIM1; k=rsa; t=y; s=email; p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJonJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&quot;
</code></pre>

<p>And attempting to save results in the following error message:</p>

<blockquote>
<p>Invalid Resource Record: FATAL problem: TXTRDATATooLong encountered at &hellip;<snip></p>
</blockquote>

<p>Now we&rsquo;re left in a tricky spot. After some research the reason behind this is
clear, and makes sense. Though it is another poor usability bug in the way
Amazon&rsquo;s Route 53 behaves. Individual DNS UDP packets are limited too 255
characters for their response.</p>

<p>Too properly deliver records longer than that DNS servers are supposed to break
up the response into chunks. Properly implemented clients combine these chunks
together (with no spaces, newlines or other characters added). What this means
is that the record can be broken up transparently behind the scenes anywhere in
the message and the client will put it back together correctly.</p>

<p>The Route 53 entry form won&rsquo;t handle this for you though, and in hindsight it
looks like Bind might not do it for you though I suspected that was more for
readability of zone files rather than a technical limitation (and I haven&rsquo;t
tested whether Bind is intelligent enough too handle just a long string).</p>

<p>Solution: Take the original output of Bind between the parentheses and just
remove the newline characters, leave the quotation marks and spaces between the
sections like the following sample and you&rsquo;ll be golden:</p>

<pre><code>&quot;v=DKIM1; k=rsa; t=y; s=email; &quot; &quot;p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJo&quot; &quot;nJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&quot;
</code></pre>

<p>Hope this helps someone else!</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/aws/'>aws</a>, <a class='tag' href='/tags/security/'>security</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2014/07/unregistering-from-whisperpush-after-flashing-a-new-rom/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Unregistering From WhisperPush After Flashing a New ROM</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2014/08/fast-hex-to-decimal-in-bash/'>
        <span class='screen-reader-text'>Next post: </span>Fast Hex to Decimal in Bash<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2019 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.fae8ed32.js'></script>

</body>

</html>

