<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="I'm going to do a more detailed post on emailing from Amazon's infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon's Route 53, and most are user error (myself).
SPF Invalid Characters or FormatAfter generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:"><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,aws,security"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2014/07/spf-and-dkim-records-in-route-53/><title>SPF & DKIM Records in Route 53 :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="SPF & DKIM Records in Route 53"><meta itemprop=description content="I'm going to do a more detailed post on emailing from Amazon's infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon's Route 53, and most are user error (myself).
SPF Invalid Characters or FormatAfter generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:"><meta itemprop=datePublished content="2014-07-30T10:46:13-04:00"><meta itemprop=dateModified content="2014-07-30T10:46:13-04:00"><meta itemprop=wordCount content="690"><meta itemprop=keywords content="Aws,Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="SPF & DKIM Records in Route 53"><meta name=twitter:description content="I'm going to do a more detailed post on emailing from Amazon's infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon's Route 53, and most are user error (myself).
SPF Invalid Characters or FormatAfter generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:"><meta property="article:published_time" content="2014-07-30 10:46:13 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2014/07/spf-and-dkim-records-in-route-53/>SPF & DKIM Records in Route 53</a></h2><div class=post-content><p>I'm going to do a more detailed post on emailing from Amazon's infrastructure
soon, but in the meantime I wanted to quickly throw out solutions too a couple
of problems I encountered. These are all specific too Amazon's Route 53, and
most are user error (myself).</p><h2 id=spf-invalid-characters-or-format>SPF Invalid Characters or Format</h2><p>After generating my SPF record, I jumped into Route 53, created a new record
pasted in my record, attempted to save and received the following message:</p><blockquote><p>The record set could not be saved because:</p><ul><li>The Value field contains invalid characters or is in an invalid format.</li></ul></blockquote><p>I was using the SPF record type at a time (see the next section) and assumed
that I had messed up the format of my record in some way. I banged my head
against the wall and through RFCs thoroughly before I found the solution...</p><p>Solution: Wrap your SPF records in quotation characters.</p><h2 id=no-spf-record-found--validation-failure>No SPF Record Found / Validation Failure</h2><p>Since I have my DMARC policy in place (I'll cover this in my email follow up),
I receive daily domain reports from Google whenever something fails validation
about my domain. After switching to Route 53 for DNS the <code>authresult</code> component
started showing up as fail for SPF.</p><p>Testing around a few online SPF validators indicated that none of them were
able to see my new SPF record, and there had been plenty of time for it too
propagate.</p><p>The SPF resource record type (RRTYPE 99) is available in Route 53 even though
<a href=https://tools.ietf.org/html/rfc6686#section-3.1>the record type has been deprecated</a>. Not being familiar with this
particular decision, I assumed I should be using it <em>instead</em> of the TXT record
I've used for every other domain, and it would be handled correctly or more
intelligently.</p><p>Solution: Either switch the SPF record too a TXT record or, my preference,
duplicate it into a TXT record so you have both.</p><h2 id=invalid-dkim-record>Invalid DKIM record</h2><p>This one had me scratching my head for a while. This was my first time
deploying DKIM on a domain that I was not running a Bind name server for.
OpenDKIM is nice enough too generate a Bind record for you which works
perfectly. It's output looks like the following:</p><pre tabindex=0><code>default._domainkey.example.tld.   IN      TXT     ( &#34;v=DKIM1; k=rsa; t=y; s=email; &#34;
          &#34;p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJo&#34;
          &#34;nJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&#34; )  ; ----- DKIM key default for example.tld
</code></pre><p>Copying and pasting everything between the parentheses in the value field and
pasting them into Route 53 works flawlessly. The catch? This won't be treated
as a single record, but three individual responses. None of which are complete
and valid DKIM records.</p><p>This happens because Route 53's value field treats newlines as separate
records.</p><p>Solution: Turn it into one long string so it isn't covering multiple lines
right? Not quite...</p><h2 id=txtrdatatoolong>TXTRDATATooLong</h2><p>Combining the DKIM key into one string like so:</p><pre tabindex=0><code>&#34;v=DKIM1; k=rsa; t=y; s=email; p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJonJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&#34;
</code></pre><p>And attempting to save results in the following error message:</p><blockquote><p>Invalid Resource Record: FATAL problem: TXTRDATATooLong encountered at ...</p></blockquote><p>Now we're left in a tricky spot. After some research the reason behind this is
clear, and makes sense. Though it is another poor usability bug in the way
Amazon's Route 53 behaves. Individual DNS UDP packets are limited too 255
characters for their response.</p><p>Too properly deliver records longer than that DNS servers are supposed to break
up the response into chunks. Properly implemented clients combine these chunks
together (with no spaces, newlines or other characters added). What this means
is that the record can be broken up transparently behind the scenes anywhere in
the message and the client will put it back together correctly.</p><p>The Route 53 entry form won't handle this for you though, and in hindsight it
looks like Bind might not do it for you though I suspected that was more for
readability of zone files rather than a technical limitation (and I haven't
tested whether Bind is intelligent enough too handle just a long string).</p><p>Solution: Take the original output of Bind between the parentheses and just
remove the newline characters, leave the quotation marks and spaces between the
sections like the following sample and you'll be golden:</p><pre tabindex=0><code>&#34;v=DKIM1; k=rsa; t=y; s=email; &#34; &#34;p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJo&#34; &#34;nJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&#34;
</code></pre><p>Hope this helps someone else!</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/aws/>aws</a></span>
<span class=tag><a href=https://stelfox.net/tags/security/>security</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=bd9e1ab3269fdee0856f80854c902432ef10f201 target=_blank rel=noopener>bd9e1ab3</a> @ 2024-07-14</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>