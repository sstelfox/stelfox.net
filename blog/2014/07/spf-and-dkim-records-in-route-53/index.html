<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="sam@stelfox.net Sam Stelfox ">
<meta name="description" content="I&amp;rsquo;m going to do a more detailed post on emailing from Amazon&amp;rsquo;s infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon&amp;rsquo;s Route 53, and most are user error (myself).
SPF Invalid Characters or Format After generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:" />
<meta name="keywords" content="blog, programming, linux, systems, personal, aws, security" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://stelfox.net/blog/2014/07/spf-and-dkim-records-in-route-53/" />


    <title>
        
            SPF &amp; DKIM Records in Route 53 :: Sam Stelfox 
        
    </title>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link rel="stylesheet" href="/main.2a064c455b0ecbd6b1481b3bf9df2441e95838691022f40a5338c2cb1244f075.css" integrity="sha256-KgZMRVsOy9axSBs7&#43;d8kQelYOGkQIvQKUzjCyxJE8HU=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="SPF &amp; DKIM Records in Route 53">
<meta itemprop="description" content="I&rsquo;m going to do a more detailed post on emailing from Amazon&rsquo;s infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon&rsquo;s Route 53, and most are user error (myself).
SPF Invalid Characters or Format After generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:"><meta itemprop="datePublished" content="2014-07-30T10:46:13-04:00" />
<meta itemprop="dateModified" content="2014-07-30T10:46:13-04:00" />
<meta itemprop="wordCount" content="694">
<meta itemprop="keywords" content="aws,security," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SPF &amp; DKIM Records in Route 53"/>
<meta name="twitter:description" content="I&rsquo;m going to do a more detailed post on emailing from Amazon&rsquo;s infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon&rsquo;s Route 53, and most are user error (myself).
SPF Invalid Characters or Format After generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:"/>



    <meta property="og:title" content="SPF &amp; DKIM Records in Route 53" />
<meta property="og:description" content="I&rsquo;m going to do a more detailed post on emailing from Amazon&rsquo;s infrastructure soon, but in the meantime I wanted to quickly throw out solutions too a couple of problems I encountered. These are all specific too Amazon&rsquo;s Route 53, and most are user error (myself).
SPF Invalid Characters or Format After generating my SPF record, I jumped into Route 53, created a new record pasted in my record, attempted to save and received the following message:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stelfox.net/blog/2014/07/spf-and-dkim-records-in-route-53/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2014-07-30T10:46:13-04:00" />
<meta property="article:modified_time" content="2014-07-30T10:46:13-04:00" />






    <meta property="article:published_time" content="2014-07-30 10:46:13 -0400 EDT" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                ./Sam_Stelfox.sh</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about/">About</a></li><li><a href="/blog/">Blog Posts</a></li><li><a href="/notes/">Various Notes</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://stelfox.net/blog/2014/07/spf-and-dkim-records-in-route-53/">SPF &amp; DKIM Records in Route 53</a></h2>

            
            
            

            <div class="post-content">
                <p>I&rsquo;m going to do a more detailed post on emailing from Amazon&rsquo;s infrastructure
soon, but in the meantime I wanted to quickly throw out solutions too a couple
of problems I encountered. These are all specific too Amazon&rsquo;s Route 53, and
most are user error (myself).</p>
<h2 id="spf-invalid-characters-or-format">SPF Invalid Characters or Format</h2>
<p>After generating my SPF record, I jumped into Route 53, created a new record
pasted in my record, attempted to save and received the following message:</p>
<blockquote>
<p>The record set could not be saved because:</p>
<ul>
<li>The Value field contains invalid characters or is in an invalid format.</li>
</ul>
</blockquote>
<p>I was using the SPF record type at a time (see the next section) and assumed
that I had messed up the format of my record in some way. I banged my head
against the wall and through RFCs thoroughly before I found the solution&hellip;</p>
<p>Solution: Wrap your SPF records in quotation characters.</p>
<h2 id="no-spf-record-found--validation-failure">No SPF Record Found / Validation Failure</h2>
<p>Since I have my DMARC policy in place (I&rsquo;ll cover this in my email follow up),
I receive daily domain reports from Google whenever something fails validation
about my domain. After switching to Route 53 for DNS the <code>authresult</code> component
started showing up as fail for SPF.</p>
<p>Testing around a few online SPF validators indicated that none of them were
able to see my new SPF record, and there had been plenty of time for it too
propagate.</p>
<p>The SPF resource record type (RRTYPE 99) is available in Route 53 even though
<a href="https://tools.ietf.org/html/rfc6686#section-3.1">the record type has been deprecated</a>. Not being familiar with this
particular decision, I assumed I should be using it <em>instead</em> of the TXT record
I&rsquo;ve used for every other domain, and it would be handled correctly or more
intelligently.</p>
<p>Solution: Either switch the SPF record too a TXT record or, my preference,
duplicate it into a TXT record so you have both.</p>
<h2 id="invalid-dkim-record">Invalid DKIM record</h2>
<p>This one had me scratching my head for a while. This was my first time
deploying DKIM on a domain that I was not running a Bind name server for.
OpenDKIM is nice enough too generate a Bind record for you which works
perfectly. It&rsquo;s output looks like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>default._domainkey.example.tld.   IN      TXT     ( &#34;v=DKIM1; k=rsa; t=y; s=email; &#34;
</span></span><span style="display:flex;"><span>          &#34;p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJo&#34;
</span></span><span style="display:flex;"><span>          &#34;nJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&#34; )  ; ----- DKIM key default for example.tld
</span></span></code></pre></div><p>Copying and pasting everything between the parentheses in the value field and
pasting them into Route 53 works flawlessly. The catch? This won&rsquo;t be treated
as a single record, but three individual responses. None of which are complete
and valid DKIM records.</p>
<p>This happens because Route 53&rsquo;s value field treats newlines as separate
records.</p>
<p>Solution: Turn it into one long string so it isn&rsquo;t covering multiple lines
right? Not quite&hellip;</p>
<h2 id="txtrdatatoolong">TXTRDATATooLong</h2>
<p>Combining the DKIM key into one string like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&#34;v=DKIM1; k=rsa; t=y; s=email; p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJonJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&#34;
</span></span></code></pre></div><p>And attempting to save results in the following error message:</p>
<blockquote>
<p>Invalid Resource Record: FATAL problem: TXTRDATATooLong encountered at &hellip;<!-- raw HTML omitted --></p>
</blockquote>
<p>Now we&rsquo;re left in a tricky spot. After some research the reason behind this is
clear, and makes sense. Though it is another poor usability bug in the way
Amazon&rsquo;s Route 53 behaves. Individual DNS UDP packets are limited too 255
characters for their response.</p>
<p>Too properly deliver records longer than that DNS servers are supposed to break
up the response into chunks. Properly implemented clients combine these chunks
together (with no spaces, newlines or other characters added). What this means
is that the record can be broken up transparently behind the scenes anywhere in
the message and the client will put it back together correctly.</p>
<p>The Route 53 entry form won&rsquo;t handle this for you though, and in hindsight it
looks like Bind might not do it for you though I suspected that was more for
readability of zone files rather than a technical limitation (and I haven&rsquo;t
tested whether Bind is intelligent enough too handle just a long string).</p>
<p>Solution: Take the original output of Bind between the parentheses and just
remove the newline characters, leave the quotation marks and spaces between the
sections like the following sample and you&rsquo;ll be golden:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&#34;v=DKIM1; k=rsa; t=y; s=email; &#34; &#34;p=MIHfMA0GCSqGSIb3DQEBAQUAA4HNADCByQKBwQC2Cwpa/+Xhfkzn0QnyQoxRwoJPb+s51dIt9UtFLMlMFuYa/k3GBwZ7UWeyAaQJ3RibSzKV/YwgFuMrzyISrLNSuL2k1bQlQQG8nl23Mu9Mowcb+mV2/3G7roshK6kOLNA0IV2SBl8/0UoNZR/x7c1lzVtVqdj0vW1SsJzgGfbt4LGRvCPyjdg+SLpYtOd/Li4Y1pvHgSRKQRrklpKeJo&#34; &#34;nJQ4+lXWqzYtuX9xdNH46ck2HUl56Ob4cy3/gYCJBWrAsCAwEAAQ==&#34;
</span></span></code></pre></div><p>Hope this helps someone else!</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://stelfox.net/tags/aws/">aws</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/security/">security</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.c90b8161416b87c69a8e02683b54ddd6edb90aea699648bf655e6cbc45b419b8e465d196e715772463dba35a6faf5decb2eb247480d38680484d54645b434570.js" integrity="sha512-yQuBYUFrh8aajgJoO1Td1u25Cupplki/ZV5svEW0GbjkZdGW5xV3JGPbo1pvr13ssuskdIDThoBITVRkW0NFcA=="></script>



    </body>
</html>
