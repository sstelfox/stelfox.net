<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Before I describe the issue that I encountered, let me be very clear. This hack is potentially dangerous and should absolutely only be done in development environments. This won't affect your host system, only the docker container so the most damage you'll do is prevent hostname and possibly user/group lookups within the container itself.
Alright with that out of the way, I was actively working on a codebase that uses subdomains as part of the identifier."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,docker,linux"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2014/06/modifying-the-hosts-file-in-a-docker-container/><title>Modifying the Hosts File in a Docker Container :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Modifying the Hosts File in a Docker Container"><meta itemprop=description content="Before I describe the issue that I encountered, let me be very clear. This hack is potentially dangerous and should absolutely only be done in development environments. This won't affect your host system, only the docker container so the most damage you'll do is prevent hostname and possibly user/group lookups within the container itself.
Alright with that out of the way, I was actively working on a codebase that uses subdomains as part of the identifier."><meta itemprop=datePublished content="2014-06-03T11:43:59-04:00"><meta itemprop=dateModified content="2014-06-03T11:43:59-04:00"><meta itemprop=wordCount content="588"><meta itemprop=keywords content="Docker,Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="Modifying the Hosts File in a Docker Container"><meta name=twitter:description content="Before I describe the issue that I encountered, let me be very clear. This hack is potentially dangerous and should absolutely only be done in development environments. This won't affect your host system, only the docker container so the most damage you'll do is prevent hostname and possibly user/group lookups within the container itself.
Alright with that out of the way, I was actively working on a codebase that uses subdomains as part of the identifier."><meta property="article:published_time" content="2014-06-03 11:43:59 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2014/06/modifying-the-hosts-file-in-a-docker-container/>Modifying the Hosts File in a Docker Container</a></h2><div class=post-content><p>Before I describe the issue that I encountered, let me be very clear. This hack
is <em>potentially dangerous and should absolutely only be done in development
environments</em>. This won't affect your host system, only the docker container so
the most damage you'll do is prevent hostname and possibly user/group lookups
within the container itself.</p><p>Alright with that out of the way, I was actively working on a codebase that
uses subdomains as part of the identifier. Rather than setup a full DNS server,
point my local system at it and load in the domains I wanted to simply modify
the /etc/hosts file inside the environment.</p><p>Docker mounts an /etc/hosts file inside it's containers, read-only, and the
container's 'root' user has had it's mount permissions revoked so it's not able
to be modified. Other users have encountered this issue, and a <a href=https://stackoverflow.com/questions/19414543/how-can-i-make-etc-hosts-writable-by-root-in-a-docker-container>novel
workaround was put forward</a>. The solution however makes use of Perl, and is
specific too Ubuntu base systems.</p><p>I'll explain the solution after showing a more general way to accomplish the
same thing. Different linux systems will store their libraries in different
directory structures. CentOS is different from Fedora, which is different from
Ubuntu and Debian. All of them name their libraries, in this case we're looking
for 'libnss_files.so.2'.</p><p>You can find where your copy of this library lives with the following command.
This should be run inside the docker container that you want to modify the
/etc/hosts file in.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>find / -name libnss_files.so.2 -print 2&gt; /dev/null
</span></span></code></pre></td></tr></table></div></div><p>Pay attention to the path, multiple files may show up and you want the one that
matches your system's running kernel (generally x86_64 systems will have their
libraries in a lib64 directory).</p><p>Once you've found this add the following lines to your Dockerfile. Make sure
you modify the path in the copy in the first line to the path of your copy of
the library. Once done you'll use the /var/hosts file to modify your hosts file
instead.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=k>RUN</span> mkdir -p /override_lib <span class=o>&amp;&amp;</span> cp /etc/hosts /var/ <span class=o>&amp;&amp;</span> cp /usr/lib64/libnss_files.so.2 /override_lib<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sed -ie <span class=s1>&#39;s:/etc/hosts:/var/hosts:g&#39;</span> /override_lib/libnss_files.so.2<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> LD_LIBRARY_PATH /override_lib<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>So what is this actually doing? On linux systems, name configurations such as
DNS, username, and group lookups are generally handled by the <code>nss</code> or name
service switch configuration tools including the hosts file. The library that
we're copying and modifying is a very specific to reading from files on the
system and includes the default paths to these files.</p><p>Generally you have to be very careful when you're manipulating strings within
compiled libraries. The length of the string is encoded along with it, so at a
minimum it's important that the string is <em>the same length or less</em>. You can
get away with less but it requires additionally writing an end of string
character as well.</p><p>Too make this hack simple, we're simply replacing the 'etc' with 'var', both
systems directories that regular users generally should have read access but
not write access too.</p><p>Finally we need to tell all programs that need to perform lookups using
hostnames in the hosts file to make use of our modified library instead of the
system one. Linux will look for shared libraries at runtime in any paths set in
in the LD_LIBRARY_PATH (colon delimited just like PATH) and this doesn't
require any privileges too set.</p><p>And the result? An editable hosts file, with no extra services. I can't stress
enough though, there could be bad ramifications from modifying libraries this
way. This is definitely not a 'production ready' hack.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/docker/>docker</a></span>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=bd9e1ab3269fdee0856f80854c902432ef10f201 target=_blank rel=noopener>bd9e1ab3</a> @ 2024-07-14</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>