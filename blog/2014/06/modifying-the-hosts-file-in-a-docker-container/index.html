<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Before I describe the issue that I encountered, let me be very clear. This hack is potentially dangerous and should absolutely only be done in development environments. This won&rsquo;t affect your host system, only the docker container so the most damage you&rsquo;ll do is prevent hostname and possibly user/group lookups within the container itself.
Alright with that out of the way, I was actively working on a codebase that uses subdomains as part of the identifier.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Modifying the Hosts File in a Docker Container • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='Before I describe the issue that I encountered, let me be very clear. This hack is potentially dangerous and should absolutely only be done in development environments. This won&rsquo;t affect your host system, only the docker container so the most damage you&rsquo;ll do is prevent hostname and possibly user/group lookups within the container itself.
Alright with that out of the way, I was actively working on a codebase that uses subdomains as part of the identifier.'>
<meta property='og:url' content='https://stelfox.net/blog/2014/06/modifying-the-hosts-file-in-a-docker-container/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='docker'><meta property='article:tag' content='linux'><meta property='article:published_time' content='2014-06-03T11:43:59-04:00'/><meta property='article:modified_time' content='2014-06-03T11:43:59-04:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.51-DEV" />

  <title>Modifying the Hosts File in a Docker Container • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2014/06/modifying-the-hosts-file-in-a-docker-container/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4a10984a.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Modifying the Hosts File in a Docker Container</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2014-06-03T11:43:59-04:00'>2014, Jun 03</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
3 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>Before I describe the issue that I encountered, let me be very clear. This hack
is <em>potentially dangerous and should absolutely only be done in development
environments</em>. This won&rsquo;t affect your host system, only the docker container so
the most damage you&rsquo;ll do is prevent hostname and possibly user/group lookups
within the container itself.</p>

<p>Alright with that out of the way, I was actively working on a codebase that
uses subdomains as part of the identifier. Rather than setup a full DNS server,
point my local system at it and load in the domains I wanted to simply modify
the /etc/hosts file inside the environment.</p>

<p>Docker mounts an /etc/hosts file inside it&rsquo;s containers, read-only, and the
container&rsquo;s &lsquo;root&rsquo; user has had it&rsquo;s mount permissions revoked so it&rsquo;s not able
to be modified. Other users have encountered this issue, and a <a href="https://stackoverflow.com/questions/19414543/how-can-i-make-etc-hosts-writable-by-root-in-a-docker-container">novel
workaround was put forward</a>. The solution however makes use of Perl, and is
specific too Ubuntu base systems.</p>

<p>I&rsquo;ll explain the solution after showing a more general way to accomplish the
same thing. Different linux systems will store their libraries in different
directory structures. CentOS is different from Fedora, which is different from
Ubuntu and Debian. All of them name their libraries, in this case we&rsquo;re looking
for &lsquo;libnss_files.so.2&rsquo;.</p>

<p>You can find where your copy of this library lives with the following command.
This should be run inside the docker container that you want to modify the
/etc/hosts file in.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">find / -name libnss_files.so.2 -print <span style="color:#ae81ff">2</span>&gt; /dev/null</code></pre></div>
<p>Pay attention to the path, multiple files may show up and you want the one that
matches your system&rsquo;s running kernel (generally x86_64 systems will have their
libraries in a lib64 directory).</p>

<p>Once you&rsquo;ve found this add the following lines to your Dockerfile. Make sure
you modify the path in the copy in the first line to the path of your copy of
the library. Once done you&rsquo;ll use the /var/hosts file to modify your hosts file
instead.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#66d9ef">RUN</span> mkdir -p /override_lib <span style="color:#f92672">&amp;&amp;</span> cp /etc/hosts /var/ <span style="color:#f92672">&amp;&amp;</span> cp /usr/lib64/libnss_files.so.2 /override_lib<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -ie <span style="color:#e6db74">&#39;s:/etc/hosts:/var/hosts:g&#39;</span> /override_lib/libnss_files.so.2<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span><span style="color:#e6db74"> LD_LIBRARY_PATH /override_lib</span></code></pre></div>
<p>So what is this actually doing? On linux systems, name configurations such as
DNS, username, and group lookups are generally handled by the <code>nss</code> or name
service switch configuration tools including the hosts file. The library that
we&rsquo;re copying and modifying is a very specific to reading from files on the
system and includes the default paths to these files.</p>

<p>Generally you have to be very careful when you&rsquo;re manipulating strings within
compiled libraries. The length of the string is encoded along with it, so at a
minimum it&rsquo;s important that the string is <em>the same length or less</em>. You can
get away with less but it requires additionally writing an end of string
character as well.</p>

<p>Too make this hack simple, we&rsquo;re simply replacing the &lsquo;etc&rsquo; with &lsquo;var&rsquo;, both
systems directories that regular users generally should have read access but
not write access too.</p>

<p>Finally we need to tell all programs that need to perform lookups using
hostnames in the hosts file to make use of our modified library instead of the
system one. Linux will look for shared libraries at runtime in any paths set in
in the LD_LIBRARY_PATH (colon delimited just like PATH) and this doesn&rsquo;t
require any privileges too set.</p>

<p>And the result? An editable hosts file, with no extra services. I can&rsquo;t stress
enough though, there could be bad ramifications from modifying libraries this
way. This is definitely not a &lsquo;production ready&rsquo; hack.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/docker/'>docker</a>, <a class='tag' href='/tags/linux/'>linux</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2014/05/extracting-content-from-markdown/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Extracting Content From Markdown</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2014/06/aws-reserved-instance-pricing/'>
        <span class='screen-reader-text'>Next post: </span>AWS Reserved Instance Pricing<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2019 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.fae8ed32.js'></script>

</body>

</html>

