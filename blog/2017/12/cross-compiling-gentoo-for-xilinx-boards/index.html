<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Note: If you've come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.
I got a hold of a Zynq 7100 development board, and while I've played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel's SAMD10 and Atmega lines, I've never played with FPGA development before so I considered this an interesting learning opportunity."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,arm,embedded,linux,tips"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2017/12/cross-compiling-gentoo-for-xilinx-boards/><title>Cross-Compiling Gentoo for Xilinx Boards :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Cross-Compiling Gentoo for Xilinx Boards"><meta itemprop=description content="Note: If you've come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.
I got a hold of a Zynq 7100 development board, and while I've played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel's SAMD10 and Atmega lines, I've never played with FPGA development before so I considered this an interesting learning opportunity."><meta itemprop=datePublished content="2017-12-18T17:49:22-05:00"><meta itemprop=dateModified content="2017-12-18T17:49:22-05:00"><meta itemprop=wordCount content="2864"><meta itemprop=keywords content="Arm,Embedded,Linux,Tips"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cross-Compiling Gentoo for Xilinx Boards"><meta name=twitter:description content="Note: If you've come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.
I got a hold of a Zynq 7100 development board, and while I've played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel's SAMD10 and Atmega lines, I've never played with FPGA development before so I considered this an interesting learning opportunity."><meta property="article:published_time" content="2017-12-18 17:49:22 -0500 EST"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2017/12/cross-compiling-gentoo-for-xilinx-boards/>Cross-Compiling Gentoo for Xilinx Boards</a></h2><div class=post-content><p><em>Note: If you've come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.</em></p><p>I got a hold of a Zynq 7100 development board, and while I've played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel's SAMD10 and Atmega lines, I've never played with FPGA development before so I considered this an interesting learning opportunity.</p><p>To do development of the FPGA and generally use the board at all you have to shell out $2,995 for a non-transferable license of a proprietary piece of software called Vivado to develop on the FPGA. For a hobby project just exploring the board this isn't going to fly. There is a 30-day evaluation version though and there are guides to getting it to work in Linux.</p><p>For this post I'm going to gloss over this part and get to the meat of the largest issue I had while attempting to bootstrap the Linux portion of this development board. Xilinx maintains its own very rough hacked together distribution called <a href=http://www.wiki.xilinx.com/PetaLinux>PetaLinux</a> which is just a very poorly designed wrapper around <a href=https://www.yoctoproject.org/>Yocto Linux</a>.</p><p>Unfortunately I haven't been fully able to remove PetaLinux from my build, I still need to use it to integrate the board specifics with the Linux kernel and in turn compile the Linux kernel, u-boot, and handle the configuration to point at a root filesystem living on the SD card. PetaLinux's incredibly limited documentation can at least get you this far. This post covers building that root filesystem and guides around some of the problems the Gentoo cross process doesn't cover.</p><p>I want a target that is a bit more inclusive than most embedded Linux root filesystems (think IoT devices). This device is less constrained than devices like most OpenWRT capable devices (we're not limited to 16MB of space). Let's quickly define some criteria that will determine the successful build of a root filesystem:</p><ul><li>It will have all the utilities necessary to support interactive logins</li><li>It will have a working file editor</li><li>It will have a valid native compiler for itself</li><li>It will have a working package manager to allow it to extend itself</li></ul><p>From this set of goals we will both be able to re-compile everything natively on the board if we so choose, and get access to the vast majority of packaged software from the Gentoo repositories as well as easily perform project development directly.</p><p>To get started you will have to have a working Gentoo install to start the cross compilation from. I've personally had issues with the hardened, SELinux, and no-multilib profile variants. If you encounter issues I strongly recommend trying the standard system profile on your build host. I'm also sure there is probably some way to get the portage cross tooling working in other distributions, but I'll leave that as an exercise to the reader.</p><h2 id=tooling>Tooling</h2><p>To get started we're going to want to setup an overlay specifically for our cross development. This will allow customization of the profile for the device later on. This is largely for use beyond this guide and is a good practice to separate changes from your system and the target board.</p><p>These commands are pretty straight forward and do need to be run as root:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mkdir -p /usr/local/overlay/portage-crossdev/<span class=o>{</span>profiles,metadata<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;crossdev&#39;</span> &gt; /usr/local/overlay/portage-crossdev/profiles/repo_name
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;masters = gentoo&#39;</span> &gt; /usr/local/overlay/portage-crossdev/metadata/layout.conf
</span></span><span class=line><span class=cl><span class=gp>$</span> chown -R portage:portage /usr/local/overlay/portage-crossdev
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> cat &lt;&lt; EOF &gt; /usr/local/overlay/portage-crossdev/metadata/layout.conf
</span></span><span class=line><span class=cl><span class=go>masters = gentoo
</span></span></span><span class=line><span class=cl><span class=go>thin-manifests = true
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> mkdir -p /etc/portage/repos.conf
</span></span><span class=line><span class=cl><span class=gp>$</span> cat &lt;&lt; EOF &gt; /etc/portage/repos.conf/crossdev.conf
</span></span><span class=line><span class=cl><span class=go>[crossdev]
</span></span></span><span class=line><span class=cl><span class=go>location = /usr/local/overlay/portage-crossdev
</span></span></span><span class=line><span class=cl><span class=go>priority = 10
</span></span></span><span class=line><span class=cl><span class=go>masters = gentoo
</span></span></span><span class=line><span class=cl><span class=go>auto-sync = no
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span></code></pre></td></tr></table></div></div><p>With our overlay setup we now need to install the cross development tools (once again as root):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> emerge sys-devel/crossdev
</span></span></code></pre></td></tr></table></div></div><p>The next step is to build our initial tool chain. Having worked with many tool chains before this is absolutely the easiest time I've ever had setting one up. One command will get you all the way to a C/C++ compiler, linker, bintools, and a standard library. The specific tool chain target tuple is for a glibc based tool chain, on a Xilinx variant of an arm processor (or arm-xilinx-linux-gnueabi).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> crossdev --stable -s4 -t arm-xilinx-linux-gnueabi
</span></span></code></pre></td></tr></table></div></div><p>This will result in a very bare bones root filesystem in "/usr/arm-xilinx-linux-gnueabi". This doesn't really have anything of value yet.</p><h2 id=base-system>Base System</h2><p>We need to configure portage and then a profile for our build. First off the portage configuration, this exists in "/etc/arm-xilinx-linux-gnueabi/etc/portage/make.conf" and varies slightly from the default.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a class=lnlinks href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a class=lnlinks href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a class=lnlinks href=#hl-3-23>23</a>
</span><span class=lnt id=hl-3-24><a class=lnlinks href=#hl-3-24>24</a>
</span><span class=lnt id=hl-3-25><a class=lnlinks href=#hl-3-25>25</a>
</span><span class=lnt id=hl-3-26><a class=lnlinks href=#hl-3-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>CHOST</span><span class=o>=</span><span class=s1>&#39;arm-xilinx-linux-gnueabi&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>CBUILD</span><span class=o>=</span><span class=s1>&#39;x86_64-pc-linux-gnu&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>ARCH</span><span class=o>=</span><span class=s1>&#39;arm&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>HOSTCC</span><span class=o>=</span><span class=s1>&#39;x86_64-pc-linux-gnu-gcc&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>CFLAGS</span><span class=o>=</span><span class=s1>&#39;-O2 -pipe -fomit-frame-pointer&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>CXXFLAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>CFLAGS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ROOT</span><span class=o>=</span><span class=s2>&#34;/usr/</span><span class=si>${</span><span class=nv>CHOST</span><span class=si>}</span><span class=s2>/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ACCEPT_KEYWORDS</span><span class=o>=</span><span class=s1>&#39;arm&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>USE</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>FEATURES</span><span class=o>=</span><span class=s1>&#39;sandbox noman noinfo nodoc&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Be sure we dont overwrite pkgs from another repo..</span>
</span></span><span class=line><span class=cl><span class=nv>PKGDIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>ROOT</span><span class=si>}</span><span class=s2>packages/&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PORTAGE_TMPDIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>ROOT</span><span class=si>}</span><span class=s2>tmp/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ELIBC</span><span class=o>=</span><span class=s1>&#39;glibc&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PKG_CONFIG_PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>ROOT</span><span class=si>}</span><span class=s2>usr/lib/pkgconfig/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PYTHON_TARGETS</span><span class=o>=</span><span class=s1>&#39;python2_7&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>If you pay attention compared to the defaults there are a few changes I've explicitly made:</p><ol><li>Do not build packages, we simply don't need them</li><li>Allow PAM to be included</li><li>Reject the testing arm packages (~arm keyword)</li><li>Re-enable the file collision protections between packages</li><li>Explicitly define our valid python target at 2.7 only</li></ol><p>The first three align with my original stated goals, building will be allowed and preferred on the device so we won't need to host any packages. We want a standard interactive login and ideally we want a stable system (as much as possible). The last one is personal preference as in my build (after this guide is over) I'll be using software that doesn't work on Python 3 variants.</p><p>The fourth change is something I want to draw specific attention to. This is disabled by default because the stock ARM profile is inherently broken. It attempts to force both a complete busybox system in addition to the standard Gentoo base. The faux busybox binaries directly conflict and you'll end up in a weird mixed state that isn't good. This is true of libraries as well which will result in some core libraries failing to compile ("dev-libs/gmp" was the first one that failed on me).</p><p>To both fix that issue and allow us to have a clean build, I needed to build a custom Gentoo profile for targeting this device. This minimal profile will work cleanly for our target.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> rm /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile
</span></span><span class=line><span class=cl><span class=gp>$</span> mkdir /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=m>5</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile/eabi
</span></span><span class=line><span class=cl><span class=gp>$</span> cat &lt;&lt; EOF &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile/parent
</span></span><span class=line><span class=cl><span class=go>/usr/portage/profiles/base
</span></span></span><span class=line><span class=cl><span class=go>/usr/portage/profiles/arch/arm/armv7a
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> mkdir -p /usr/arm-xilinx-linux-gnueabi/etc/portage/package.accept_keywords
</span></span><span class=line><span class=cl><span class=gp>$</span> cat &lt;&lt; EOF &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.accept_keywords/system
</span></span><span class=line><span class=cl><span class=go>sys-apps/coreutils ~arm
</span></span></span><span class=line><span class=cl><span class=go>sys-apps/sandbox ~arm
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span></code></pre></td></tr></table></div></div><p>There is one final workaround we're going to need to put in place before we can begin compiling our system. Currently "sys-apps/portage" and "dev-python/pyxattr" are incorrectly packaged and will use the system library paths rather than those in the chroot.</p><p>This prevents both of them from being compiled with native extensions and incorrectly places the files inside the chroot (They're in the 64 bit path on a 32 bit target). This is fixable once we have the root filesystem on the device but in the meantime we need to set some use flags to avoid the issue:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mkdir -p /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;sys-apps/portage -native-extensions -xattr&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use/portage
</span></span></code></pre></td></tr></table></div></div><p>With that in place sit back grab a cup of your favorite warm beverage and watch the system compile (seriously this is going to take a hot minute):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge --update --newuse --deep @system
</span></span></code></pre></td></tr></table></div></div><p>There is one final gotcha with the root filesystem, the commands to date will not create several important directories. These can be created with the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mkdir -p /usr/arm-xilinx-linux-gnueabi/<span class=o>{</span>dev,home,proc,root,sys<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>At this point you should have a mostly complete root filesystem and may want to start diverging from this guide (but pay attention to the kernel modules section, and the rebuild section). There are a couple of things that won't currently work, specifically:</p><ul><li>Authentication</li><li>Serial Console</li><li>Networking</li></ul><h2 id=authentication--serial-usage>Authentication & Serial Usage</h2><p>First authentication, we need to provide root with a password and PAM needs its configuration files to function. We can't use the native tools (without qemu binary emulation) to change the password so the fastest way to give root a password is to pre-generate a password hash and drop it directly into the relevant files. If you'd like to keep going you can use the hash below for the super secure password 'root' (I don't recommend it):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sed -i <span class=s1>&#39;s`root:[^:]*:`root:$6$ufWqa3MP$CfFwj0M7tW15gUYBRVms3GG2FJTRMAhlpkwV7Bp4aro6mGFHmotMjHoePNoTd1Gf9fgzh/jJM3rvJgkGgSjz31:`&#39;</span> /usr/arm-xilinx-linux-gnueabi/etc/shadow
</span></span></code></pre></td></tr></table></div></div><p>And the requisite PAM configuration files:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge sys-auth/pambase
</span></span></code></pre></td></tr></table></div></div><p>The serial console is going to be more device specific and is a bit tricky to figure out. To find this out on my board I created a service that collected the names of all devices under "/dev", logged them to a file and found mine to be "ttyPS0" (also one I've never seen before).</p><p>The following command will replace the default serial configuration with one for this device (you may also have to change the baud rate it's running at):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sed -i <span class=s1>&#39;s`^s0:.*$`ps0:12345:respawn:/sbin/agetty -L 115200 ttyPS0 vt100`&#39;</span> /usr/arm-xilinx-linux-gnueabi/etc/inittab
</span></span></code></pre></td></tr></table></div></div><h2 id=networking>Networking</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge sys-apps/net-tools net-misc/netifrc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=go>  net-misc/dhcpcd net-misc/iputils sys-apps/iproute2
</span></span></span></code></pre></td></tr></table></div></div><p>To get it to come up by default, since we can't use the "rc" tools natively yet we can cheat. This assumes your kernel is configured to use the legacy network names (which are more consistent and predictable :-/). This will setup eth0 to come up automatically and use DHCP to grab an address on the network:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15>15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16>16</a>
</span><span class=lnt id=hl-12-17><a class=lnlinks href=#hl-12-17>17</a>
</span><span class=lnt id=hl-12-18><a class=lnlinks href=#hl-12-18>18</a>
</span><span class=lnt id=hl-12-19><a class=lnlinks href=#hl-12-19>19</a>
</span><span class=lnt id=hl-12-20><a class=lnlinks href=#hl-12-20>20</a>
</span><span class=lnt id=hl-12-21><a class=lnlinks href=#hl-12-21>21</a>
</span><span class=lnt id=hl-12-22><a class=lnlinks href=#hl-12-22>22</a>
</span><span class=lnt id=hl-12-23><a class=lnlinks href=#hl-12-23>23</a>
</span><span class=lnt id=hl-12-24><a class=lnlinks href=#hl-12-24>24</a>
</span><span class=lnt id=hl-12-25><a class=lnlinks href=#hl-12-25>25</a>
</span><span class=lnt id=hl-12-26><a class=lnlinks href=#hl-12-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> cat &lt;&lt; <span class=s1>&#39;EOF&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/conf.d/net
</span></span><span class=line><span class=cl><span class=gp>#</span> /etc/conf.d/net
</span></span><span class=line><span class=cl><span class=go>modules=&#34;iproute2&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span> Default DHCP config <span class=k>for</span> interfaces
</span></span><span class=line><span class=cl><span class=go>dhcp=&#34;release nonis nontp&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>config_eth0=&#34;dhcp&#34;
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;arm-board&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/hostname
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;hostname=&#34;arm-board.localhost&#34;&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/conf.d/hostname
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> cat &lt;&lt; <span class=s1>&#39;EOF&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/hosts
</span></span><span class=line><span class=cl><span class=gp>#</span> /etc/hosts
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>127.0.0.1 localhost4 localhost
</span></span></span><span class=line><span class=cl><span class=go>::1       localhost6 localhost
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> <span class=nb>cd</span> /usr/arm-xilinx-linux-gnueabi/etc/init.d/
</span></span><span class=line><span class=cl><span class=gp>$</span> ln -s net.lo net.eth0
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> <span class=nb>cd</span> /usr/arm-xilinx-linux-gnueabi/etc/runlevels/default/
</span></span><span class=line><span class=cl><span class=gp>$</span> ln -s /etc/init.d/net.eth0 net.eth0
</span></span><span class=line><span class=cl><span class=gp>$</span> rm -f netmount
</span></span></code></pre></td></tr></table></div></div><h2 id=kernel-modules>Kernel Modules</h2><p>Part of the kernel build that has to happen still in the PetaLinux environment are kernel modules. One of the build artifacts is the root filesystem PetaLinux thinks you're going to use. These contain very important kernel modules which need to be extracted.</p><p>Inside the root of your PetaLinux project after a build you should find a file "images/linux/rootfs.tar.gz" which will have a directory inside it "./lib/modules". The contents need to be transferred to your root filesystem. If you transfer that to the system you're building the board root on you can extract all of the appropriate files using the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> tar -xf rootfs.tar.gz -C /usr/arm-xilinx-linux-gnueabi/ ./lib/modules
</span></span></code></pre></td></tr></table></div></div><p>You can verify they are present by confirming a directory that looks along the lines of "4.9.0-xilinx-v2017.2" exists in "/usr/arm-xilinx-linux-gnueabi/lib/modules/".</p><h2 id=ssh-server>SSH Server</h2><p>If you would additionally like an SSH server running (that supports root login) there is a bit of a trick. User privilege separation requires a dedicated user and group named <code>sshd</code> for this to work.</p><p>The OpenSSH ebuild doesn't create this user and I'm not entirely sure what does. For now we can solve this issue by creating the user and group manually.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a class=lnlinks href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a class=lnlinks href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a class=lnlinks href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a class=lnlinks href=#hl-14-22>22</a>
</span><span class=lnt id=hl-14-23><a class=lnlinks href=#hl-14-23>23</a>
</span><span class=lnt id=hl-14-24><a class=lnlinks href=#hl-14-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge net-misc/openssh
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;sshd:x:22:22:added by portage for openssh:/var/empty:/sbin/nologin&#39;</span> &gt;&gt; /usr/arm-xilinx-linux-gnueabi/etc/passwd
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;sshd:*:0:0:::::&#39;</span> &gt;&gt; /usr/arm-xilinx-linux-gnueabi/etc/shadow
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;sshd:x:22:&#39;</span> &gt;&gt; /usr/arm-xilinx-linux-gnueabi/etc/group
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> cat &lt;&lt; <span class=s1>&#39;EOF&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/ssh/sshd_config
</span></span><span class=line><span class=cl><span class=gp>#</span> /etc/ssh/sshd_config
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>HostKeyAlgorithms ssh-ed25519,ecdsa-sha2-nistp521,ssh-rsa
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ClientAliveInterval 10
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>UseDNS no
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>AllowTcpForwarding no
</span></span></span><span class=line><span class=cl><span class=go>UsePAM yes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PasswordAuthentication yes
</span></span></span><span class=line><span class=cl><span class=go>PermitRootLogin yes
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> <span class=nb>cd</span> /usr/arm-xilinx-linux-gnueabi/etc/runlevels/default/
</span></span><span class=line><span class=cl><span class=gp>$</span> ln -s /etc/init.d/sshd sshd
</span></span></code></pre></td></tr></table></div></div><h2 id=additional-tools>Additional Tools</h2><p>This is a pretty solid foundation for any root Linux system. Everything at this point is going to preferential and determined by your project requirements. A few things you may want to include:</p><ul><li>VIM</li><li>NTPd or Chronyd for time keeping</li><li>A syslog server (I recommend syslog-ng) and in turn logrotate</li><li>Network performance testing tools (such as iperf3)</li></ul><p>From the above list I wanted both VIM and iperf3 and thus ran the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2>2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;net-misc/iperf ~arm&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.accept_keywords/network_utils
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>echo</span> <span class=s1>&#39;app-editors/vim minimal&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use/vim
</span></span><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge app-editors/vim net-misc/iperf
</span></span></code></pre></td></tr></table></div></div><h2 id=rebuilding-on-the-system>Rebuilding on the System</h2><p>Once all the packages you want for your base system are installed, the root may be in an inconsistent state. It's a good idea to run a sync, global use update, a preserved rebuild, and dependency clean on the board before continuing:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> emerge --sync
</span></span><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge --update --newuse --deep @world
</span></span><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge @preserved-rebuild
</span></span><span class=line><span class=cl><span class=gp>$</span> arm-xilinx-linux-gnueabi-emerge --depclean
</span></span></code></pre></td></tr></table></div></div><p>We now need to get the root filesystem on a live board and rebuilding cleaning up some of the mismatch package flags and irregularities introduced by the cross compilation process. At a minimum want to fix the incorrectly built portage package so everything is usable normally.</p><p>Before transferring this it's a good idea to preemptively adjust the make config to no longer be a cross environment, and remove the special case for portage. This can be done with the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a class=lnlinks href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a class=lnlinks href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a class=lnlinks href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a class=lnlinks href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a class=lnlinks href=#hl-17-15>15</a>
</span><span class=lnt id=hl-17-16><a class=lnlinks href=#hl-17-16>16</a>
</span><span class=lnt id=hl-17-17><a class=lnlinks href=#hl-17-17>17</a>
</span><span class=lnt id=hl-17-18><a class=lnlinks href=#hl-17-18>18</a>
</span><span class=lnt id=hl-17-19><a class=lnlinks href=#hl-17-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> cat &lt;&lt; <span class=s1>&#39;EOF&#39;</span> &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/make.conf
</span></span><span class=line><span class=cl><span class=go>ARCH=&#39;arm&#39;
</span></span></span><span class=line><span class=cl><span class=go>CFLAGS=&#39;-O2 -pipe&#39;
</span></span></span><span class=line><span class=cl><span class=go>CXXFLAGS=&#34;${CFLAGS}&#34;
</span></span></span><span class=line><span class=cl><span class=go>CHOST=&#39;arm-xilinx-linux-gnueabi&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ACCEPT_KEYWORDS=&#39;arm&#39;
</span></span></span><span class=line><span class=cl><span class=go>FEATURES=&#39;sandbox noman noinfo nodoc&#39;
</span></span></span><span class=line><span class=cl><span class=go>USE=&#34;${ARCH} pam&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ELIBC=&#39;glibc&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>L10N=&#39;en&#39;
</span></span></span><span class=line><span class=cl><span class=go>LINGUAS=&#39;en&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PYTHON_TARGETS=&#39;python2_7&#39;
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> rm -f /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use/portage
</span></span></code></pre></td></tr></table></div></div><p>We now need to package up our root filesystem:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> tar -cJf ~/xilinx_root_non_native.txz -C /usr/arm-xilinx-linux-gnueabi .
</span></span></code></pre></td></tr></table></div></div><p>This next bit requires the proper settings in PetaLinux and a completed build (you'll need your own BOOT.BIN, image.ub, and system.dtb files). After inserting an appropriately size SD card (You're going to want 4 or 8Gb more likely than not). For me the device showed up as mmcblk0 on my machine. Confirm yours before following the next steps:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16>16</a>
</span><span class=lnt id=hl-19-17><a class=lnlinks href=#hl-19-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>bs</span><span class=o>=</span>1M <span class=nv>count</span><span class=o>=</span><span class=m>1</span> <span class=nv>oflag</span><span class=o>=</span>sync <span class=nv>of</span><span class=o>=</span>/dev/mmcblk0
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> parted --script -a optimal /dev/mmcblk0 -- mklabel msdos
</span></span><span class=line><span class=cl><span class=gp>$</span> parted --script -a optimal /dev/mmcblk0 -- mkpart primary fat32 <span class=m>100</span> <span class=m>600</span>
</span></span><span class=line><span class=cl><span class=gp>$</span> parted --script -a optimal /dev/mmcblk0 -- mkpart primary ext4 <span class=m>600</span> -1
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>bs</span><span class=o>=</span>1M <span class=nv>count</span><span class=o>=</span><span class=m>1</span> <span class=nv>oflag</span><span class=o>=</span>sync <span class=nv>of</span><span class=o>=</span>/dev/mmcblk0p1
</span></span><span class=line><span class=cl><span class=gp>$</span> dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>bs</span><span class=o>=</span>1M <span class=nv>count</span><span class=o>=</span><span class=m>1</span> <span class=nv>oflag</span><span class=o>=</span>sync <span class=nv>of</span><span class=o>=</span>/dev/mmcblk0p2
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> mkfs.vfat -n BOOT -F <span class=m>32</span> /dev/mmcblk0p1
</span></span><span class=line><span class=cl><span class=gp>$</span> mkfs.ext4 -L rootfs /dev/mmcblk0p2
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> mkdir -p /mnt/boot
</span></span><span class=line><span class=cl><span class=gp>$</span> mount /dev/mmcblk0p1 /mnt/boot
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> mkdir -p /mnt/root
</span></span><span class=line><span class=cl><span class=gp>$</span> mount /dev/mmcblk0p2 /mnt/root
</span></span></code></pre></td></tr></table></div></div><p>You'll need to copy "BOOT.BIN", "image.ub", and "system.dtb" to "/mnt/boot" and extract the root filesystem into the root directory (compressed version still lives at "~/xilinx_root_non_native.txz").</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> tar -xf ~/xilinx_root_non_native.txz -C /mnt/root
</span></span></code></pre></td></tr></table></div></div><p>Ensure the writes complete and cleanly unmount the filesystems:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sync
</span></span><span class=line><span class=cl><span class=gp>$</span> umount /mnt/boot /mnt/root
</span></span></code></pre></td></tr></table></div></div><p>Stick the microSD card into the board and let it boot up. If you're following this guide you should be able to get to a login screen and be able to login with root / root.</p><p>The device should be on the network and you should be able to SSH to the device. For my board at the very least I haven't gotten the hardware clock working correctly so it needs to be set manually upon every boot. Before we can compile quite a few of the packages the date needs to be roughly correct. You can reference the build host's time using the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> date +%s
</span></span></code></pre></td></tr></table></div></div><p>And set it on the board using the following command (replacing VALUE with the value returned above):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> date --set<span class=o>=</span><span class=s2>&#34;@VALUE&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>We now need to sync the system's packages and fix portage. This is where we have to work around the issue of portage being incorrectly installed by prefixing any use of the portage python module with a '64 bit' path:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1> 1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2> 2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3> 3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4> 4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5> 5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6> 6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7> 7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8> 8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9> 9</a>
</span><span class=lnt id=hl-24-10><a class=lnlinks href=#hl-24-10>10</a>
</span><span class=lnt id=hl-24-11><a class=lnlinks href=#hl-24-11>11</a>
</span><span class=lnt id=hl-24-12><a class=lnlinks href=#hl-24-12>12</a>
</span><span class=lnt id=hl-24-13><a class=lnlinks href=#hl-24-13>13</a>
</span><span class=lnt id=hl-24-14><a class=lnlinks href=#hl-24-14>14</a>
</span><span class=lnt id=hl-24-15><a class=lnlinks href=#hl-24-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nv>PYTHONPATH</span><span class=o>=</span><span class=s1>&#39;/usr/lib64/python2.7/site-packages&#39;</span> env-update
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> cat &lt;&lt; <span class=s1>&#39;EOF&#39;</span> &gt; /etc/locale.gen
</span></span><span class=line><span class=cl><span class=go>en_US ISO-8859-1
</span></span></span><span class=line><span class=cl><span class=go>en_US.UTF-8 UTF-8
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> locale-gen
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> <span class=nv>PYTHONPATH</span><span class=o>=</span><span class=s1>&#39;/usr/lib64/python2.7/site-packages&#39;</span> eselect locale <span class=nb>set</span> <span class=s2>&#34;</span><span class=k>$(</span>eselect locale list <span class=p>|</span> grep <span class=s1>&#39;en_US.utf8&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;{ print $1 }&#39;</span> <span class=p>|</span> grep -oE <span class=s1>&#39;[0-9]+&#39;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nv>PYTHONPATH</span><span class=o>=</span><span class=s1>&#39;/usr/lib64/python2.7/site-packages&#39;</span> env-update
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> . /etc/profile
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> <span class=nv>PYTHONPATH</span><span class=o>=</span><span class=s1>&#39;/usr/lib64/python2.7/site-packages&#39;</span> emerge --sync
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nv>PYTHONPATH</span><span class=o>=</span><span class=s1>&#39;/usr/lib64/python2.7/site-packages&#39;</span> emerge --oneshot sys-apps/portage
</span></span></code></pre></td></tr></table></div></div><p>There is a circular dependency that has to be broken during this update:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nv>USE</span><span class=o>=</span><span class=s2>&#34;dev-util/pkgconfig internal-glib&#34;</span> emerge dev-util/pkgconfig
</span></span></code></pre></td></tr></table></div></div><p>With the circular update broken we can update everything (this will recompile pkgconfig again)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> emerge --update --newuse --deep @world
</span></span></code></pre></td></tr></table></div></div><p>The last will recompile quite a few packages (though not all). I recommend shutting the system down, removing the SD card and making a clean backup of the root by performing the following commands once the drive is back in your machine (this assumes the same device name as before):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1>1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2>2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mount /dev/mmcblk0p2 /mnt/root
</span></span><span class=line><span class=cl><span class=gp>$</span> rm -rf /mnt/root/root/.bash_history /mnt/root/etc/ssh/ssh_host* /usr/portage/*
</span></span><span class=line><span class=cl><span class=gp>$</span> tar -cJf ~/xilinx_root_native.txz -C /mnt/root .
</span></span></code></pre></td></tr></table></div></div><p>You now have a solid base to perform development on and a good backup in case you mess up. I hope this helps someone else out there.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/arm/>arm</a></span>
<span class=tag><a href=https://stelfox.net/tags/embedded/>embedded</a></span>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span>
<span class=tag><a href=https://stelfox.net/tags/tips/>tips</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=bd9e1ab3269fdee0856f80854c902432ef10f201 target=_blank rel=noopener>bd9e1ab3</a> @ 2024-07-14</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>