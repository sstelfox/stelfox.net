<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="sam@stelfox.net Sam Stelfox ">
<meta name="description" content="Note: If you&amp;rsquo;ve come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.
I got a hold of a Zynq 7100 development board, and while I&amp;rsquo;ve played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel&amp;rsquo;s SAMD10 and Atmega lines, I&amp;rsquo;ve never played with FPGA development before so I considered this an interesting learning opportunity." />
<meta name="keywords" content="blog, programming, linux, systems, personal, arm, embedded, linux, tips" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://stelfox.net/blog/2017/12/cross-compiling-gentoo-for-xilinx-boards/" />


    <title>
        
            Cross-Compiling Gentoo for Xilinx Boards :: Sam Stelfox 
        
    </title>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link rel="stylesheet" href="/main.2a064c455b0ecbd6b1481b3bf9df2441e95838691022f40a5338c2cb1244f075.css" integrity="sha256-KgZMRVsOy9axSBs7&#43;d8kQelYOGkQIvQKUzjCyxJE8HU=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Cross-Compiling Gentoo for Xilinx Boards">
<meta itemprop="description" content="Note: If you&rsquo;ve come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.
I got a hold of a Zynq 7100 development board, and while I&rsquo;ve played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel&rsquo;s SAMD10 and Atmega lines, I&rsquo;ve never played with FPGA development before so I considered this an interesting learning opportunity."><meta itemprop="datePublished" content="2017-12-18T17:49:22-05:00" />
<meta itemprop="dateModified" content="2017-12-18T17:49:22-05:00" />
<meta itemprop="wordCount" content="2606">
<meta itemprop="keywords" content="arm,embedded,linux,tips," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cross-Compiling Gentoo for Xilinx Boards"/>
<meta name="twitter:description" content="Note: If you&rsquo;ve come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.
I got a hold of a Zynq 7100 development board, and while I&rsquo;ve played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel&rsquo;s SAMD10 and Atmega lines, I&rsquo;ve never played with FPGA development before so I considered this an interesting learning opportunity."/>



    <meta property="og:title" content="Cross-Compiling Gentoo for Xilinx Boards" />
<meta property="og:description" content="Note: If you&rsquo;ve come here looking to build a root filesystem for 32 bit ARM devices I suspect everything but the build tuple will be the same. The issues that need to be worked around largely packaging and profile issues that should all be the same.
I got a hold of a Zynq 7100 development board, and while I&rsquo;ve played with some embedded ARM microcontrollers such as the STM32F3 series and more basic RISC style microcontrollers like Atmel&rsquo;s SAMD10 and Atmega lines, I&rsquo;ve never played with FPGA development before so I considered this an interesting learning opportunity." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stelfox.net/blog/2017/12/cross-compiling-gentoo-for-xilinx-boards/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2017-12-18T17:49:22-05:00" />
<meta property="article:modified_time" content="2017-12-18T17:49:22-05:00" />






    <meta property="article:published_time" content="2017-12-18 17:49:22 -0500 EST" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                ./Sam_Stelfox.sh</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/blog/">Blog Posts</a></li><li><a href="/notes/">Various Notes</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://stelfox.net/blog/2017/12/cross-compiling-gentoo-for-xilinx-boards/">Cross-Compiling Gentoo for Xilinx Boards</a></h2>

            
            
            

            <div class="post-content">
                <p><em>Note: If you&rsquo;ve come here looking to build a root filesystem for 32 bit ARM
devices I suspect everything but the build tuple will be the same. The issues
that need to be worked around largely packaging and profile issues that should
all be the same.</em></p>
<p>I got a hold of a Zynq 7100 development board, and while I&rsquo;ve played with some
embedded ARM microcontrollers such as the STM32F3 series and more basic RISC
style microcontrollers like Atmel&rsquo;s SAMD10 and Atmega lines, I&rsquo;ve never played
with FPGA development before so I considered this an interesting learning
opportunity.</p>
<p>To do development of the FPGA and generally use the board at all you have to
shell out $2,995 for a non-transferable license of a proprietary piece of
software called Vivado to develop on the FPGA. For a hobby project just
exploring the board this isn&rsquo;t going to fly. There is a 30-day evaluation
version though and there are guides to getting it to work in Linux.</p>
<p>For this post I&rsquo;m going to gloss over this part and get to the meat of the
largest issue I had while attempting to bootstrap the Linux portion of this
development board. Xilinx maintains its own very rough hacked together
distribution called <a href="http://www.wiki.xilinx.com/PetaLinux">PetaLinux</a> which is just a very poorly designed wrapper
around <a href="https://www.yoctoproject.org/">Yocto Linux</a>.</p>
<p>Unfortunately I haven&rsquo;t been fully able to remove PetaLinux from my build, I
still need to use it to integrate the board specifics with the Linux kernel and
in turn compile the Linux kernel, u-boot, and handle the configuration to point
at a root filesystem living on the SD card. PetaLinux&rsquo;s incredibly limited
documentation can at least get you this far. This post covers building that
root filesystem and guides around some of the problems the Gentoo cross process
doesn&rsquo;t cover.</p>
<p>I want a target that is a bit more inclusive than most embedded Linux root
filesystems (think IoT devices). This device is less constrained than devices
like most OpenWRT capable devices (we&rsquo;re not limited to 16MB of space). Let&rsquo;s
quickly define some criteria that will determine the successful build of a root
filesystem:</p>
<ul>
<li>It will have all the utilities necessary to support interactive logins</li>
<li>It will have a working file editor</li>
<li>It will have a valid native compiler for itself</li>
<li>It will have a working package manager to allow it to extend itself</li>
</ul>
<p>From this set of goals we will both be able to re-compile everything natively
on the board if we so choose, and get access to the vast majority of packaged
software from the Gentoo repositories as well as easily perform project
development directly.</p>
<p>To get started you will have to have a working Gentoo install to start the
cross compilation from. I&rsquo;ve personally had issues with the hardened, SELinux,
and no-multilib profile variants. If you encounter issues I strongly recommend
trying the standard system profile on your build host. I&rsquo;m also sure there is
probably some way to get the portage cross tooling working in other
distributions, but I&rsquo;ll leave that as an exercise to the reader.</p>
<h2 id="tooling">Tooling</h2>
<p>To get started we&rsquo;re going to want to setup an overlay specifically for our
cross development. This will allow customization of the profile for the device
later on. This is largely for use beyond this guide and is a good practice to
separate changes from your system and the target board.</p>
<p>These commands are pretty straight forward and do need to be run as root:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /usr/local/overlay/portage-crossdev/<span style="color:#ff7b72;font-weight:bold">{</span>profiles,metadata<span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#a5d6ff">&#39;crossdev&#39;</span> &gt; /usr/local/overlay/portage-crossdev/profiles/repo_name
</span></span><span style="display:flex;"><span>echo <span style="color:#a5d6ff">&#39;masters = gentoo&#39;</span> &gt;
</span></span><span style="display:flex;"><span>/usr/local/overlay/portage-crossdev/metadata/layout.conf
</span></span><span style="display:flex;"><span>chown -R portage:portage /usr/local/overlay/portage-crossdev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#a5d6ff">&lt;&lt; EOF &gt; /usr/local/overlay/portage-crossdev/metadata/layout.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">masters = gentoo
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">thin-manifests = true
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/portage/repos.conf
</span></span><span style="display:flex;"><span>cat <span style="color:#a5d6ff">&lt;&lt; EOF &gt; /etc/portage/repos.conf/crossdev.conf
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">[crossdev]
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">location = /usr/local/overlay/portage-crossdev
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">priority = 10
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">masters = gentoo
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">auto-sync = no
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">EOF</span>
</span></span></code></pre></div><p>With our overlay setup we now need to install the cross development tools (once
again as root):</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>emerge sys-devel/crossdev
</span></span></code></pre></div><p>The next step is to build our initial tool chain. Having worked with many tool
chains before this is absolutely the easiest time I&rsquo;ve ever had setting one up.
One command will get you all the way to a C/C++ compiler, linker, bintools, and
a standard library. The specific tool chain target tuple is for a glibc based
tool chain, on a Xilinx variant of an arm processor (or
arm-xilinx-linux-gnueabi).</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>crossdev --stable -s4 -t arm-xilinx-linux-gnueabi
</span></span></code></pre></div><p>This will result in a very bare bones root filesystem in
<code>/usr/arm-xilinx-linux-gnueabi</code>. This doesn&rsquo;t really have anything of value
yet.</p>
<h2 id="base-system">Base System</h2>
<p>We need to configure portage and then a profile for our build. First off the
portage configuration, this exists in
<code>/etc/arm-xilinx-linux-gnueabi/etc/portage/make.conf</code> and varies slightly from
the default.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CHOST=&#39;arm-xilinx-linux-gnueabi&#39;
</span></span><span style="display:flex;"><span>CBUILD=&#39;x86_64-pc-linux-gnu&#39;
</span></span><span style="display:flex;"><span>ARCH=&#39;arm&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HOSTCC=&#39;x86_64-pc-linux-gnu-gcc&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CFLAGS=&#39;-O2 -pipe -fomit-frame-pointer&#39;
</span></span><span style="display:flex;"><span>CXXFLAGS=&#34;${CFLAGS}&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ROOT=&#34;/usr/${CHOST}/&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ACCEPT_KEYWORDS=&#39;arm&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USE=&#34;${ARCH}&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FEATURES=&#39;sandbox noman noinfo nodoc&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Be sure we dont overwrite pkgs from another repo..
</span></span><span style="display:flex;"><span>PKGDIR=&#34;${ROOT}packages/&#34;
</span></span><span style="display:flex;"><span>PORTAGE_TMPDIR=&#34;${ROOT}tmp/&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ELIBC=&#39;glibc&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PKG_CONFIG_PATH=&#34;${ROOT}usr/lib/pkgconfig/&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PYTHON_TARGETS=&#39;python2_7&#39;
</span></span></code></pre></div><p>If you pay attention compared to the defaults there are a few changes I&rsquo;ve
explicitly made:</p>
<ol>
<li>Do not build packages, we simply don&rsquo;t need them</li>
<li>Allow PAM to be included</li>
<li>Reject the testing arm packages (~arm keyword)</li>
<li>Re-enable the file collision protections between packages</li>
<li>Explicitly define our valid python target at 2.7 only</li>
</ol>
<p>The first three align with my original stated goals, building will be allowed
and preferred on the device so we won&rsquo;t need to host any packages. We want a
standard interactive login and ideally we want a stable system (as much as
possible). The last one is personal preference as in my build (after this guide
is over) I&rsquo;ll be using software that doesn&rsquo;t work on Python 3 variants.</p>
<p>The fourth change is something I want to draw specific attention to. This is
disabled by default because the stock ARM profile is inherently broken. It
attempts to force both a complete busybox system in addition to the standard
Gentoo base. The faux busybox binaries directly conflict and you&rsquo;ll end up in a
weird mixed state that isn&rsquo;t good. This is true of libraries as well which will
result in some core libraries failing to compile (<code>dev-libs/gmp</code> was the first
one that failed on me).</p>
<p>To both fix that issue and allow us to have a clean build, I needed to build a
custom Gentoo profile for targeting this device. This minimal profile will work
cleanly for our target.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>rm /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile
</span></span><span style="display:flex;"><span>mkdir /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile
</span></span><span style="display:flex;"><span>echo 5 &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile/eabi
</span></span><span style="display:flex;"><span>cat &lt;&lt; EOF &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/make.profile/parent
</span></span><span style="display:flex;"><span>/usr/portage/profiles/base
</span></span><span style="display:flex;"><span>/usr/portage/profiles/arch/arm/armv7a
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /usr/arm-xilinx-linux-gnueabi/etc/portage/package.accept_keywords
</span></span><span style="display:flex;"><span>cat &lt;&lt; EOF &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.accept_keywords/system
</span></span><span style="display:flex;"><span>sys-apps/coreutils ~arm
</span></span><span style="display:flex;"><span>sys-apps/sandbox ~arm
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><p>There is one final workaround we&rsquo;re going to need to put in place before we can
begin compiling our system. Currently <code>sys-apps/portage</code> and
<code>dev-python/pyxattr</code> are incorrectly packaged and will use the system library
paths rather than those in the chroot.</p>
<p>This prevents both of them from being compiled with native extensions and
incorrectly places the files inside the chroot (They&rsquo;re in the 64 bit path on a
32 bit target). This is fixable once we have the root filesystem on the device
but in the meantime we need to set some use flags to avoid the issue:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>mkdir -p /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use
</span></span><span style="display:flex;"><span>echo &#39;sys-apps/portage -native-extensions -xattr&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use/portage
</span></span></code></pre></div><p>With that in place sit back grab a cup of your favorite warm beverage and watch
the system compile (seriously this is going to take a hot minute):</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge --update --newuse --deep @system
</span></span></code></pre></div><p>There is one final gotcha with the root filesystem, the commands to date will
not create several important directories. These can be created with the
following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>mkdir -p /usr/arm-xilinx-linux-gnueabi/{dev,home,proc,root,sys}
</span></span></code></pre></div><p>At this point you should have a mostly complete root filesystem and may want to
start diverging from this guide (but pay attention to the kernel modules
section, and the rebuild section). There are a couple of things that won&rsquo;t
currently work, specifically:</p>
<ul>
<li>Authentication</li>
<li>Serial Console</li>
<li>Networking</li>
</ul>
<h2 id="authentication--serial-usage">Authentication &amp; Serial Usage</h2>
<p>First authentication, we need to provide root with a password and PAM needs its
configuration files to function. We can&rsquo;t use the native tools (without qemu
binary emulation) to change the password so the fastest way to give root a
password is to pregenerate a password hash and drop it directly into the
relevant files. If you&rsquo;d like to keep going you can use the hash below for the
super secure password &lsquo;root&rsquo; (I don&rsquo;t recommend it):</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sed -i &#39;s`root:[^:]*:`root:$6$ufWqa3MP$CfFwj0M7tW15gUYBRVms3GG2FJTRMAhlpkwV7Bp4aro6mGFHmotMjHoePNoTd1Gf9fgzh/jJM3rvJgkGgSjz31:`&#39; /usr/arm-xilinx-linux-gnueabi/etc/shadow
</span></span></code></pre></div><p>And the requisite PAM configuration files:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge sys-auth/pambase
</span></span></code></pre></div><p>The serial console is going to be more device specific and is a bit tricky to
figure out. To find this out on my board I created a service that collected the
names of all devices under <code>/dev</code>, logged them to a file and found mine to be
<code>ttyPS0</code> (also one I&rsquo;ve never seen before).</p>
<p>The following command will replace the default serial configuration with one
for this device (you may also have to change the baud rate it&rsquo;s running at):</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sed -i &#39;s`^s0:.*$`ps0:12345:respawn:/sbin/agetty -L 115200 ttyPS0 vt100`&#39; /usr/arm-xilinx-linux-gnueabi/etc/inittab
</span></span></code></pre></div><h2 id="networking">Networking</h2>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge sys-apps/net-tools net-misc/netifrc \
</span></span><span style="display:flex;"><span>  net-misc/dhcpcd net-misc/iputils sys-apps/iproute2
</span></span></code></pre></div><p>To get it to come up by default, since we can&rsquo;t use the <code>rc</code> tools natively yet
we can cheat. This assumes your kernel is configured to use the legacy network
names (which are more consistent and predictable :-/). This will setup eth0 to
come up automatically and use DHCP to grab an address on the network:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cat &lt;&lt; &#39;EOF&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/conf.d/net
</span></span><span style="display:flex;"><span># /etc/conf.d/net
</span></span><span style="display:flex;"><span>modules=&#34;iproute2&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Default DHCP config for interfaces
</span></span><span style="display:flex;"><span>dhcp=&#34;release nonis nontp&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config_eth0=&#34;dhcp&#34;
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo &#39;arm-board&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/hostname
</span></span><span style="display:flex;"><span>echo &#39;hostname=&#34;arm-board.localhost&#34;&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/conf.d/hostname
</span></span><span style="display:flex;"><span>cat &lt;&lt; &#39;EOF&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/hosts
</span></span><span style="display:flex;"><span># /etc/hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>127.0.0.1 localhost4 localhost
</span></span><span style="display:flex;"><span>::1       localhost6 localhost
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cd /usr/arm-xilinx-linux-gnueabi/etc/init.d/
</span></span><span style="display:flex;"><span>ln -s net.lo net.eth0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cd /usr/arm-xilinx-linux-gnueabi/etc/runlevels/default/
</span></span><span style="display:flex;"><span>ln -s /etc/init.d/net.eth0 net.eth0
</span></span><span style="display:flex;"><span>rm -f netmount
</span></span></code></pre></div><h2 id="kernel-modules">Kernel Modules</h2>
<p>Part of the kernel build that has to happen still in the PetaLinux environment
are kernel modules. One of the build artifacts is the root filesystem PetaLinux
thinks you&rsquo;re going to use. These contain very important kernel modules which
need to be extracted.</p>
<p>Inside the root of your PetaLinux project after a build you should find a file
<code>images/linux/rootfs.tar.gz</code> which will have a directory inside it
<code>./lib/modules</code>. The contents need to be transferred to your root filesystem.
If you transfer that to the system you&rsquo;re building the board root on you can
extract all of the appropriate files using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>tar -xf rootfs.tar.gz -C /usr/arm-xilinx-linux-gnueabi/ ./lib/modules
</span></span></code></pre></div><p>You can verify they are present by confirming a directory that looks along the
lines of <code>4.9.0-xilinx-v2017.2</code> exists in
<code>/usr/arm-xilinx-linux-gnueabi/lib/modules/</code>.</p>
<h2 id="ssh-server">SSH Server</h2>
<p>If you would additionally like an SSH server running (that supports root
login) there is a bit of a trick. User privilege separation requires a
dedicated user and group named <code>sshd</code> for this to work.</p>
<p>The OpenSSH ebuild doesn&rsquo;t create this user and I&rsquo;m not entirely sure what
does. For now we can solve this issue by creating the user and group manually.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge net-misc/openssh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo &#39;sshd:x:22:22:added by portage for openssh:/var/empty:/sbin/nologin&#39; &gt;&gt; /usr/arm-xilinx-linux-gnueabi/etc/passwd
</span></span><span style="display:flex;"><span>echo &#39;sshd:*:0:0:::::&#39; &gt;&gt; /usr/arm-xilinx-linux-gnueabi/etc/shadow
</span></span><span style="display:flex;"><span>echo &#39;sshd:x:22:&#39; &gt;&gt; /usr/arm-xilinx-linux-gnueabi/etc/group
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; &#39;EOF&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/ssh/sshd_config
</span></span><span style="display:flex;"><span># /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HostKeyAlgorithms ssh-ed25519,ecdsa-sha2-nistp521,ssh-rsa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ClientAliveInterval 10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>UseDNS no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>AllowTcpForwarding no
</span></span><span style="display:flex;"><span>UsePAM yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PasswordAuthentication yes
</span></span><span style="display:flex;"><span>PermitRootLogin yes
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cd /usr/arm-xilinx-linux-gnueabi/etc/runlevels/default/
</span></span><span style="display:flex;"><span>ln -s /etc/init.d/sshd sshd
</span></span></code></pre></div><h2 id="additional-tools">Additional Tools</h2>
<p>This is a pretty solid foundation for any root Linux system. Everything at this
point is going to preferential and determined by your project requirements. A
few things you may want to include:</p>
<ul>
<li>VIM</li>
<li>NTPd or Chronyd for time keeping</li>
<li>A syslog server (I recommend syslog-ng) and in turn logrotate</li>
<li>Network performance testing tools (such as iperf3)</li>
</ul>
<p>From the above list I wanted both VIM and iperf3 and thus ran the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>echo &#39;net-misc/iperf ~arm&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.accept_keywords/network_utils
</span></span><span style="display:flex;"><span>echo &#39;app-editors/vim minimal&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use/vim
</span></span><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge app-editors/vim net-misc/iperf
</span></span></code></pre></div><h2 id="rebuilding-on-the-system">Rebuilding on the System</h2>
<p>Once all the packages you want for your base system are installed, the root may
be in an inconsitent state. It&rsquo;s a good idea to run a sync, global use update,
a preserved rebuild, and dependency clean on the board before continuing:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>emerge --sync
</span></span><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge --update --newuse --deep @world
</span></span><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge @preserved-rebuild
</span></span><span style="display:flex;"><span>arm-xilinx-linux-gnueabi-emerge --depclean
</span></span></code></pre></div><p>We now need to get the root filesystem on a live board and rebuilding cleaning
up some of the mismatch package flags and irregularities introduced by the
cross compilation process. At a minimum want to fix the incorrectly built
portage package so everything is usable normally.</p>
<p>Before transferring this it&rsquo;s a good idea to preemptively adjust the make
config to no longer be a cross environment, and remove the special case for
portage. This can be done with the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cat &lt;&lt; &#39;EOF&#39; &gt; /usr/arm-xilinx-linux-gnueabi/etc/portage/make.conf
</span></span><span style="display:flex;"><span>ARCH=&#39;arm&#39;
</span></span><span style="display:flex;"><span>CFLAGS=&#39;-O2 -pipe&#39;
</span></span><span style="display:flex;"><span>CXXFLAGS=&#34;${CFLAGS}&#34;
</span></span><span style="display:flex;"><span>CHOST=&#39;arm-xilinx-linux-gnueabi&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ACCEPT_KEYWORDS=&#39;arm&#39;
</span></span><span style="display:flex;"><span>FEATURES=&#39;sandbox noman noinfo nodoc&#39;
</span></span><span style="display:flex;"><span>USE=&#34;${ARCH} pam&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ELIBC=&#39;glibc&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>L10N=&#39;en&#39;
</span></span><span style="display:flex;"><span>LINGUAS=&#39;en&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PYTHON_TARGETS=&#39;python2_7&#39;
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rm -f /usr/arm-xilinx-linux-gnueabi/etc/portage/package.use/portage
</span></span></code></pre></div><p>We now need to package up our root filesystem:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>tar -cJf ~/xilinx_root_non_native.txz -C /usr/arm-xilinx-linux-gnueabi .
</span></span></code></pre></div><p>This next bit requires the proper settings in PetaLinux and a completed build
(you&rsquo;ll need your own BOOT.BIN, image.ub, and system.dtb files). After
inserting an appropriately size SD card (You&rsquo;re going to want 4 or 8Gb more
likely than not). For me the device showed up as mmcblk0 on my machine. Confirm
yours before following the next steps:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>dd if=/dev/zero bs=1M count=1 oflag=sync of=/dev/mmcblk0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>parted --script -a optimal /dev/mmcblk0 -- mklabel msdos
</span></span><span style="display:flex;"><span>parted --script -a optimal /dev/mmcblk0 -- mkpart primary fat32 100 600
</span></span><span style="display:flex;"><span>parted --script -a optimal /dev/mmcblk0 -- mkpart primary ext4 600 -1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dd if=/dev/zero bs=1M count=1 oflag=sync of=/dev/mmcblk0p1
</span></span><span style="display:flex;"><span>dd if=/dev/zero bs=1M count=1 oflag=sync of=/dev/mmcblk0p2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkfs.vfat -n BOOT -F 32 /dev/mmcblk0p1
</span></span><span style="display:flex;"><span>mkfs.ext4 -L rootfs /dev/mmcblk0p2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /mnt/boot
</span></span><span style="display:flex;"><span>mount /dev/mmcblk0p1 /mnt/boot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /mnt/root
</span></span><span style="display:flex;"><span>mount /dev/mmcblk0p2 /mnt/root
</span></span></code></pre></div><p>You&rsquo;ll need to copy BOOT.BIN, image.ub, and system.dtb to /mnt/boot and
extract the root filesystem into the root directory (compressed version still
lives at ~/xilinx_root_non_native.txz).</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>tar -xf ~/xilinx_root_non_native.txz -C /mnt/root
</span></span></code></pre></div><p>Ensure the writes complete and cleanly unmount the filesystems:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sync
</span></span><span style="display:flex;"><span>umount /mnt/boot /mnt/root
</span></span></code></pre></div><p>Stick the microSD card into the board and let it boot up. If you&rsquo;re following
this guide you should be able to get to a login screen and be able to login
with root / root.</p>
<p>The device should be on the network and you should be able to SSH to the
device. For my board at the very least I haven&rsquo;t gotten the hardware clock
working correctly so it needs to be set manually upon every boot. Before we can
compile quite a few of the packages the date needs to be roughly correct. You
can reference the build host&rsquo;s time using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>date +%s
</span></span></code></pre></div><p>And set it on the board using the following command (replacing VALUE with
the value returned above):</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>date --set=&#34;@VALUE&#34;
</span></span></code></pre></div><p>We now need to sync the system&rsquo;s packages and fix portage. This is where we
have to work around the issue of portage being incorrectly installed by
prefixing any use of the portage python module with a &lsquo;64 bit&rsquo; path:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>PYTHONPATH=&#39;/usr/lib64/python2.7/site-packages&#39; env-update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; &#39;EOF&#39; &gt; /etc/locale.gen
</span></span><span style="display:flex;"><span>en_US ISO-8859-1
</span></span><span style="display:flex;"><span>en_US.UTF-8 UTF-8
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>locale-gen
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PYTHONPATH=&#39;/usr/lib64/python2.7/site-packages&#39; eselect locale set &#34;$(eselect locale list | grep &#39;en_US.utf8&#39; | awk &#39;{ print $1 }&#39; | grep -oE &#39;[0-9]+&#39;)&#34;
</span></span><span style="display:flex;"><span>PYTHONPATH=&#39;/usr/lib64/python2.7/site-packages&#39; env-update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>. /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PYTHONPATH=&#39;/usr/lib64/python2.7/site-packages&#39; emerge --sync
</span></span><span style="display:flex;"><span>PYTHONPATH=&#39;/usr/lib64/python2.7/site-packages&#39; emerge --oneshot sys-apps/portage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># There is a circular dependency that has to be broken during this update
</span></span><span style="display:flex;"><span>USE=&#34;dev-util/pkgconfig internal-glib&#34; emerge dev-util/pkgconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># With the circular update broken we can update everything (this will recompile
</span></span><span style="display:flex;"><span># pkgconfig again)
</span></span><span style="display:flex;"><span>emerge --update --newuse --deep @world
</span></span></code></pre></div><p>The last will recompile quite a few packages (though not all). I recommend
shutting the system down, removing the SD card and making a clean backup of the
root by performing the following commands once the drive is back in your
machine (this assumes the same device name as before):</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>mount /dev/mmcblk0p2 /mnt/root
</span></span><span style="display:flex;"><span>rm -rf /mnt/root/root/.bash_history /mnt/root/etc/ssh/ssh_host* /usr/portage/*
</span></span><span style="display:flex;"><span>tar -cJf ~/xilinx_root_native.txz -C /mnt/root .
</span></span></code></pre></div><p>You now have a solid base to perform development on and a good backup in case
you mess up. I hope this helps someone else out there.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://stelfox.net/tags/arm/">arm</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/embedded/">embedded</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/linux/">linux</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/tips/">tips</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.c90b8161416b87c69a8e02683b54ddd6edb90aea699648bf655e6cbc45b419b8e465d196e715772463dba35a6faf5decb2eb247480d38680484d54645b434570.js" integrity="sha512-yQuBYUFrh8aajgJoO1Td1u25Cupplki/ZV5svEW0GbjkZdGW5xV3JGPbo1pvr13ssuskdIDThoBITVRkW0NFcA=="></script>



    </body>
</html>
