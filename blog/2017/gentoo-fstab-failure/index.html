<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1><a href="https:&#x2F;&#x2F;stelfox.net&#x2F;blog&#x2F;2017&#x2F;gentoo-fstab-failure&#x2F;">Gentoo Fstab Failure</a></h1>

  <div class="post-content"><p>I use Gentoo with OpenRC quite a bit both for my personal servers and as a
compilation test bed for new software since I can control the dependency
versions very tightly.  I have a set of scripts I've been using for quite some
time that handle setting up a hardened, fairly minimal install.</p>
<span id="continue-reading"></span>
<p>I recently encountered a weird issue with them that resulted in an esoteric
error that prevented my host from fully booting and leaving the root filesystem
read-only. There also didn't seem to be much reliable information on the
problem so I'm documenting it here in hopes it may help someone else.</p>
<p>In addition to the read-only filesystem, none of the system services would
start up leaving me with the kernel's default hostname of <code>(none)</code>. This
includes networking so I had to diagnose this directly via the console. I was
able to login as a user but unable to use <code>sudo</code> to switch to a new user
(though I could still use it to execute commands with elevated privileges).</p>
<p>I was able to verify all the OpenRC services had not started with by executing:</p>
<pre><code>sudo rc-status
</code></pre>
<p>I attempted to start the SSH daemon (though any networked service should behave
the same) using the following command:</p>
<pre><code>sudo service sshd start
</code></pre>
<p>This was the first time any error had directly presented itself to my screen
(and since my filesystems were read-only, and my logger was stopped I had no on
disk logs to go off from). The error that was repeated over my screen was the
following:</p>
<pre><code> * Checking local filesystems  .../sbin/fsck.xfs: XFS file system.
fsck.fat 4.0 (2016-05-06)
open: No such file or directory

 * Filesystems couldn't be fixed
                                         [ !! ]
 * ERROR: fsck failed to start
 * ERROR: cannot start root as fsck would not start
</code></pre>
<p>This was quite confusing and more than a little concerning as XFS doesn't use
<code>fsck</code>, instead it uses <code>xfs_repair</code>. There was also the &quot;No such file or
directory&quot; error which also didn't seem to make sense.</p>
<p>Ultimately, after reviewing the <code>fsck</code> init script I found the culprit. There
was a bad line in my <code>/etc/fstab</code> file pointing at a device that didn't exist.
I was able to remount my root filesystem read-write and edit my fstab to fix
the device name in my fstab file:</p>
<pre><code>sudo mount -o remount,rw /
sudoedit /etc/fstab
</code></pre>
<p>Tracing things back, this was ultimately caused by the Gentoo installation
medium detecting it's only disk as <code>/dev/sda</code> while the kernel I use exposed it
as <code>/dev/vda</code>. Since I was already using a GPT filesystem I was able to adjust
my scripts so they reference this particular partition by UUID instead of
directly by device name.</p>
</div><p class="meta">Posted on <span class="postdate">2017-11-01</span></p></article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
