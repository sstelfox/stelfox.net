<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1><a href="https:&#x2F;&#x2F;stelfox.net&#x2F;blog&#x2F;2017&#x2F;the-case-of-an-empty-executable&#x2F;">The Case of an Empty Executable</a></h1>

  <div class="post-content"><p>I recently came across a <a href="http://trillian.mit.edu/%7Ejc/humor/ATT_Copyright_true.html">short article</a> written about a decade ago. It was
a curious thing already as it was hosted in a user's home directory off a web
server with the standard <code>~&lt;username&gt;</code> showing up in the URL. The important
part that caught my eye was this:</p>
<blockquote>
<p>The &quot;true&quot; program does nothing; it merely exits with a zero exit status.
This can be done with an empty file that's marked executable, and that's what
it was in the earliest unix system libraries.</p>
</blockquote>
<span id="continue-reading"></span>
<p>Being a curious sort, and presented with an old mystery, I had to try out this
little tidbit of information:</p>
<pre data-lang="sh" class="language-sh "><code class="language-sh" data-lang="sh">$ echo -n > test
$ chmod +x test
$ ./test
$ echo $?
0
</code></pre>
<p>Sure enough, an empty file can be successfully run. It obviously doesn't have a
known binary header, so it won't be interpretted as a valid executable on it's
own. Even scripts rely on the shebang header (<code>#!</code>) to be considered valid by
the kernel, so something else has to be executing this. We can confirm the
kernel isn't recognizing this by abusing <code>strace</code> into calling an explicit
execve on the file:</p>
<pre><code>$ strace ./test
execve("./test", ["./test"], 0x7ffe74e0a720 /* 70 vars */) = -1 ENOEXEC (Exec format error)
fstat(2, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 3), ...}) = 0
write(2, "strace: exec: Exec format error\n", 32strace: exec: Exec format error
) = 32
getpid()                                = 24047
exit_group(1)                           = ?
+++ exited with 1 +++
</code></pre>
<p>This is exactly what I was expecting and the <a href="https://github.com/torvalds/linux/blob/c2315c187fa0d3ab363fdebe22718170b40473e3/fs/binfmt_script.c#L24">Kernel source</a> reflects
exactly what I'd expect. I'll leave it up to you test the results on an empty
but otherwise valid shell script. With the kernel cleared of any odd behavior I
was left with only one suspect. A little shell by the name of bash.</p>
<p>Bash is a coy devil with several different mechanisms built-in to execute a
program. Likely one of these culprits are being used behind the scenes when we
run a program. A quick trip the <a href="https://www.gnu.org/software/bash/manual/bash.txt">man page</a> and a late night cup of coffee
narrowed down my search to the following functions:</p>
<ul>
<li>command</li>
<li>eval</li>
<li>exec</li>
</ul>
<p>I decided it was time to talk to each of them one by one and see what was up.
Putting them under the bright light I was surprised that they all were telling
the same story:</p>
<pre><code>$ command ./test
$ echo $?
0
$ eval ./test
$ echo $?
0
$ exec ./test
-bash: /home/playground/test: Success
</code></pre>
<p>How sinister! Someone had gotten to them first, I have to go higher into their
organization. This calls for... The Source. I quickly traverse into the builtin
directory and identify the commonality <code>parse_and_execute</code>. This is where it
gets a little fuzzy as bash is a rather complicated code base and I didn't want
to spend to much time on this in the middle of the night.</p>
<p>After parsing the file, it does seem to treat it as a script (as expected).
There are two possibilities here and I didn't trace down which was true. Either
<code>parse_and_execute</code> is simply returning with a success or it is sending the
contents to <code>execute_command_internal</code>, which in turn defaults to a
successfully return value.</p>
<p>The motive remains unclear, but no harm seems to be getting done so I'm going
to call this one case closed. It'd be interesting to see how other shells
behave with empty files.</p>
</div><p class="meta">Posted on <span class="postdate">2017-10-12</span></p></article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
