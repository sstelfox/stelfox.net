<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1><a href="https:&#x2F;&#x2F;stelfox.net&#x2F;blog&#x2F;2020&#x2F;extracting-dracut-built-initramfs&#x2F;">Extracting Dracut Built initramfs</a></h1>

  <div class="post-content"><p>It's been a hot second since I've dived into the lands of initramfs and since
then it seems like things have gotten more complicated. This is the way of
things in tech and usually has a good reason. The simple way that used to work
wonders (and is still required) to start with, was to identify if the file is
compressed:</p>
<span id="continue-reading"></span><pre><code>$ file /boot/initramfs-current.img
/boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC)
</code></pre>
<p>In this case the file appears to be entirely uncompressed which is convenient
and likely exactly what you'll experience for reasons I'm about to get to. This
could indicate that there is a type of compression in place (such as gzip or
the like) in which case your initramfs has likely not been generated by a
modern version of Dracut and this post isn't right for you.</p>
<p>Next let's extract the contents into a new temporary directory:</p>
<pre><code>$ mkdir init_tmp
$ cd init_tmp
$ cpio -mvid < /boot/initramfs-current.img
.
early_cpio
kernel
kernel/x86
kernel/x86/microcode
kernel/x86/microcode/AuthenticAMD.bin
62 blocks
</code></pre>
<p>This is where things got weird and I got caught up. No <code>/init</code>? No tools for
dealing with LVM, filesystems, device scanning? No core system directories like
<code>/dev</code>, <code>/sys</code>, or <code>/proc</code>? What is going on here. We can also quickly see the
size doesn't match what we extracted:</p>
<pre><code>$ du --max-depth=1 -h
32K     ./kernel
36K     .
$ ls -lh /boot/initramfs-current.img
-rwxr-xr-x 1 root root 13M Feb 18 15:13 /boot/initramfs-current.img
</code></pre>
<p>Turns out this is an early optimization by dracut to get updated microcode to
the processor before we pass control over to any userspace programs. It's
actually pretty slick and I'll have to figure out how this works in some future
post. To get to the real initramfs we simply need to skip the first one using
<code>dd</code>.</p>
<p>Previosly when we extracted the CPIO archive it told us how large it was (The
<code>62 blocks</code> at the end). We simply need to skip those then we should be able to
decode the inner archive.</p>
<p>Side note for clarity with the following commands, I switched back to my home
directory and emptied out the extracted contents of the <code>init_tmp</code> directory we
created earlier as that's where we want to put the extracted inner initramfs
contents.</p>
<pre><code>$ dd if=/boot/initramfs-current.img bs=512 skip=62 of=inner-initramfs-current.img
25995+1 records in
25995+1 records out
13309841 bytes (13 MB, 13 MiB) copied, 0.0848529 s, 157 MB/s
</code></pre>
<p>Once again we need to identify if compression is present:</p>
<pre><code>$ file inner-initramfs-current.img
inner-initramfs-current.img: LZ4 compressed data (v0.1-v0.9)
</code></pre>
<p>From here we can decompress it and extract the inner archive much like before
using the appropriate utility (lz4cat does the trick here, your compression may
vary).</p>
<pre><code>$ cd init_tmp
$ lz4cat ../inner-initramfs-current.img | cpio -mvid
.
bin
bin/bash
bin/cat
bin/chown
bin/chroot
...<contents remove for brevity>
var
var/lock
var/run
var/tmp
54581 blocks
</code></pre>
<p>Bam! That is a lot more like it. I'm really curious how the kernel boot process
works with that early microcode but this got me where I needed to be and I hope
this helps someone else out.</p>
<p>Additional note: I missed this but apparently dracut ships with a utility
called <code>skipcpio</code> which you can pipe one of these initramfs files through to
skip the extra <code>dd</code> step. Had a friend point that out after I wrote this up...</p>
</div><p class="meta">Posted on <span class="postdate">2020-02-18</span></p></article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
