<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="It's been a hot second since I've dived into the lands of initramfs and as is the way of things, it has gotten a tad more complicated. The simple way that used to work wonders (and is still required) to start with, was to identify if the file is compressed:
1 2 $ file /boot/initramfs-current.img /boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC) In this case the file appears to be entirely uncompressed which is convenient and likely exactly what you'll experience for reasons I'm about to get to."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,dracut,linux"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2020/02/extracting-dracut-initramfs/><title>Extracting Dracut Built initramfs :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Extracting Dracut Built initramfs"><meta itemprop=description content="It's been a hot second since I've dived into the lands of initramfs and as is the way of things, it has gotten a tad more complicated. The simple way that used to work wonders (and is still required) to start with, was to identify if the file is compressed:
1 2 $ file /boot/initramfs-current.img /boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC) In this case the file appears to be entirely uncompressed which is convenient and likely exactly what you'll experience for reasons I'm about to get to."><meta itemprop=datePublished content="2020-02-18T18:42:02-05:00"><meta itemprop=dateModified content="2020-02-18T18:42:02-05:00"><meta itemprop=wordCount content="569"><meta itemprop=keywords content="Dracut,Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="Extracting Dracut Built initramfs"><meta name=twitter:description content="It's been a hot second since I've dived into the lands of initramfs and as is the way of things, it has gotten a tad more complicated. The simple way that used to work wonders (and is still required) to start with, was to identify if the file is compressed:
1 2 $ file /boot/initramfs-current.img /boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC) In this case the file appears to be entirely uncompressed which is convenient and likely exactly what you'll experience for reasons I'm about to get to."><meta property="article:published_time" content="2020-02-18 18:42:02 -0500 EST"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2020/02/extracting-dracut-initramfs/>Extracting Dracut Built initramfs</a></h2><div class=post-content><p>It's been a hot second since I've dived into the lands of initramfs and as is the way of things, it has gotten a tad more complicated. The simple way that used to work wonders (and is still required) to start with, was to identify if the file is compressed:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> file /boot/initramfs-current.img
</span></span><span class=line><span class=cl><span class=go>/boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC)
</span></span></span></code></pre></td></tr></table></div></div><p>In this case the file appears to be entirely uncompressed which is convenient and likely exactly what you'll experience for reasons I'm about to get to. This could indicate that there is a type of compression in place (such as gzip or the like) in which case your initramfs has likely not been generated by a modern version of Dracut and this post isn't right for you.</p><p>Next let's extract the contents into a new temporary directory:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mkdir init_tmp
</span></span><span class=line><span class=cl><span class=gp>$</span> <span class=nb>cd</span> init_tmp
</span></span><span class=line><span class=cl><span class=gp>$</span> cpio -mvid &lt; /boot/initramfs-current.img
</span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>early_cpio
</span></span></span><span class=line><span class=cl><span class=go>kernel
</span></span></span><span class=line><span class=cl><span class=go>kernel/x86
</span></span></span><span class=line><span class=cl><span class=go>kernel/x86/microcode
</span></span></span><span class=line><span class=cl><span class=go>kernel/x86/microcode/AuthenticAMD.bin
</span></span></span><span class=line><span class=cl><span class=go>62 blocks
</span></span></span></code></pre></td></tr></table></div></div><p>This is where things got weird and I got caught up. No /init? No tools for dealing with LVM, filesystems, device scanning? No core system directories like /dev, /sys, or /proc? What is going on here. We can also quickly see the size doesn't match what we extracted:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> du --max-depth<span class=o>=</span><span class=m>1</span> -h
</span></span><span class=line><span class=cl><span class=go>32K     ./kernel
</span></span></span><span class=line><span class=cl><span class=go>36K     .
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> ls -lh /boot/initramfs-current.img
</span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 13M Feb 18 15:13 /boot/initramfs-current.img
</span></span></span></code></pre></td></tr></table></div></div><p>Turns out this is an early optimization by Dracut to get updated microcode to the processor before we pass control over to any userspace programs. It's actually pretty slick and I'll have to figure out how this works in some future post. To get to the real initramfs we simply need to skip the first one using dd.</p><p>Previously when we extracted the CPIO archive it told us how large it was (The 62 blocks at the end). We simply need to skip those then we should be able to decode the inner archive.</p><p>Side note for clarity with the following commands, I switched back to my home directory and emptied out the extracted contents of the init_tmp directory we created earlier as that's where we want to put the extracted inner initramfs contents.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> dd <span class=k>if</span><span class=o>=</span>/boot/initramfs-current.img <span class=nv>bs</span><span class=o>=</span><span class=m>512</span> <span class=nv>skip</span><span class=o>=</span><span class=m>62</span> <span class=nv>of</span><span class=o>=</span>inner-initramfs-current.img
</span></span><span class=line><span class=cl><span class=go>25995+1 records in
</span></span></span><span class=line><span class=cl><span class=go>25995+1 records out
</span></span></span><span class=line><span class=cl><span class=go>13309841 bytes (13 MB, 13 MiB) copied, 0.0848529 s, 157 MB/s
</span></span></span></code></pre></td></tr></table></div></div><p>Once again we need to identify if compression is present:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> file inner-initramfs-current.img
</span></span><span class=line><span class=cl><span class=go>inner-initramfs-current.img: LZ4 compressed data (v0.1-v0.9)
</span></span></span></code></pre></td></tr></table></div></div><p>From here we can decompress it and extract the inner archive much like before using the appropriate utility (lz4cat does the trick here, your compression may vary).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nb>cd</span> init_tmp
</span></span><span class=line><span class=cl><span class=gp>$</span> lz4cat ../inner-initramfs-current.img <span class=p>|</span> cpio -mvid
</span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>bin
</span></span></span><span class=line><span class=cl><span class=go>bin/bash
</span></span></span><span class=line><span class=cl><span class=go>bin/cat
</span></span></span><span class=line><span class=cl><span class=go>bin/chown
</span></span></span><span class=line><span class=cl><span class=go>bin/chroot
</span></span></span><span class=line><span class=cl><span class=go>...&lt;contents remove for brevity&gt;
</span></span></span><span class=line><span class=cl><span class=go>var
</span></span></span><span class=line><span class=cl><span class=go>var/lock
</span></span></span><span class=line><span class=cl><span class=go>var/run
</span></span></span><span class=line><span class=cl><span class=go>var/tmp
</span></span></span><span class=line><span class=cl><span class=go>54581 blocks
</span></span></span></code></pre></td></tr></table></div></div><p>Bam! That is a lot more like it. I'm really curious how the kernel boot process works with that early microcode but this got me where I needed to be and I hope this helps someone else out.</p><p>Additional note: I missed this but apparently Dracut ships with a utility called skipcpio which you can pipe one of these initramfs files through to skip the extra dd step. Had a friend point that out after I wrote this up...</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/dracut/>dracut</a></span>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=ac3c177eb78019063bdce225211b16f9e6b96848 target=_blank rel=noopener>ac3c177e</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>