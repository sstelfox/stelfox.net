<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='It&#39;s been a hot second since I&#39;ve dived into the lands of initramfs and since then it seems like things have gotten more complicated. This is the way of things in tech and usually has a good reason. The simple way that used to work wonders (and is still required) to start with, was to identify if the file is compressed:
$ file /boot/initramfs-current.img /boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC) In this case the file appears to be entirely uncompressed which is convenient and likely exactly what you&#39;ll experience for reasons I&#39;m about to get to.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Extracting Dracut Built initramfs • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='It&#39;s been a hot second since I&#39;ve dived into the lands of initramfs and since then it seems like things have gotten more complicated. This is the way of things in tech and usually has a good reason. The simple way that used to work wonders (and is still required) to start with, was to identify if the file is compressed:
$ file /boot/initramfs-current.img /boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC) In this case the file appears to be entirely uncompressed which is convenient and likely exactly what you&#39;ll experience for reasons I&#39;m about to get to.'>
<meta property='og:url' content='https://stelfox.net/blog/2020/02/extracting-dracut-built-initramfs/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='dracut'><meta property='article:tag' content='linux'><meta property='article:published_time' content='2020-02-18T18:42:02-05:00'/><meta property='article:modified_time' content='2020-02-18T18:42:02-05:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.61.0-DEV" />

  <title>Extracting Dracut Built initramfs • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2020/02/extracting-dracut-built-initramfs/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Extracting Dracut Built initramfs</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2020-02-18T18:42:02-05:00'>2020, Feb 18</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
3 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>It's been a hot second since I've dived into the lands of initramfs and since
then it seems like things have gotten more complicated. This is the way of
things in tech and usually has a good reason. The simple way that used to work
wonders (and is still required) to start with, was to identify if the file is
compressed:</p>
<pre><code>$ file /boot/initramfs-current.img
/boot/initramfs-current.img: ASCII cpio archive (SVR4 with no CRC)
</code></pre><p>In this case the file appears to be entirely uncompressed which is convenient
and likely exactly what you'll experience for reasons I'm about to get to. This
could indicate that there is a type of compression in place (such as gzip or
the like) in which case your initramfs has likely not been generated by a
modern version of Dracut and this post isn't right for you.</p>
<p>Next let's extract the contents into a new temporary directory:</p>
<pre><code>$ mkdir init_tmp
$ cd init_tmp
$ cpio -mvid &lt; /boot/initramfs-current.img
.
early_cpio
kernel
kernel/x86
kernel/x86/microcode
kernel/x86/microcode/AuthenticAMD.bin
62 blocks
</code></pre><p>This is where things got weird and I got caught up. No <code>/init</code>? No tools for
dealing with LVM, filesystems, device scanning? No core system directories like
<code>/dev</code>, <code>/sys</code>, or <code>/proc</code>? What is going on here. We can also quickly see the
size doesn't match what we extracted:</p>
<pre><code>$ du --max-depth=1 -h
32K     ./kernel
36K     .
$ ls -lh /boot/initramfs-current.img
-rwxr-xr-x 1 root root 13M Feb 18 15:13 /boot/initramfs-current.img
</code></pre><p>Turns out this is an early optimization by dracut to get updated microcode to the
processor before we pass control over to any userspace programs. It's actually
pretty slick and I'll have to figure out how this works in some future post. To
get to the real initramfs we simply need to skip the first one using <code>dd</code>.</p>
<p>Previosly when we extracted the CPIO archive it told us how large it was (The
<code>62 blocks</code> at the end). We simply need to skip those then we should be able to
decode the inner archive.</p>
<p>Side note for clarity with the following commands, I switched back to my home
directory and emptied out the extracted contents of the <code>init_tmp</code> directory we
created earlier as that's where we want to put the extracted inner initramfs
contents.</p>
<pre><code>$ dd if=/boot/initramfs-current.img bs=512 skip=62 of=inner-initramfs-current.img
25995+1 records in
25995+1 records out
13309841 bytes (13 MB, 13 MiB) copied, 0.0848529 s, 157 MB/s
</code></pre><p>Once again we need to identify if compression is present:</p>
<pre><code>$ file inner-initramfs-current.img
inner-initramfs-current.img: LZ4 compressed data (v0.1-v0.9)
</code></pre><p>From here we can decompress it and extract the inner archive much like before
using the appropriate utility (lz4cat does the trick here, your compression may
vary).</p>
<pre><code>$ cd init_tmp
$ lz4cat ../inner-initramfs-current.img | cpio -mvid
.
bin
bin/bash
bin/cat
bin/chown
bin/chroot
...&lt;contents remove for brevity&gt;
var
var/lock
var/run
var/tmp
54581 blocks
</code></pre><p>Bam! That is a lot more like it. I'm really curious how the kernel boot process
works with that early microcode but this got me where I needed to be and I hope
this helps someone else out.</p>
<p>Additional note: I missed this but apparently dracut ships with a utility
called <code>skipcpio</code> which you can pipe one of these initramfs files through to
skip the extra <code>dd</code> step. Had a friend point that out after I wrote this up&hellip;</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/dracut/'>dracut</a>, <a class='tag' href='/tags/linux/'>linux</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2019/11/blender-loop-select-in-cinnamon/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Blender Loop Select in Cinnamon</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2020/02/logical-volume-in-use/'>
        <span class='screen-reader-text'>Next post: </span>Logical Volume in Use<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2020 Sam Stelfox </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script>

</body>

</html>

