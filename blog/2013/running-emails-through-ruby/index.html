<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1><a href="https:&#x2F;&#x2F;stelfox.net&#x2F;blog&#x2F;2013&#x2F;running-emails-through-ruby&#x2F;">Running Emails Through Ruby</a></h1>

  <div class="post-content"><p>Following up on my <a href="https://stelfox.net/blog/2013/backing-up-gmail-with-fetchmail/">earlier post</a> where I covered how to backup your Gmail
account using <code>fetchmail</code> and <code>procmail</code>; I wanted to cover how I was
additionally processing received mail through ruby.</p>
<p>This was part of a larger project where I was doing statistical analysis on my
email while evaluating various data stores. To get the emails into the various
data stores, I used the ruby script to parse, process and store the emails as
they came in.</p>
<span id="continue-reading"></span>
<p>If you're going to be doing any form of mail manipulation or statistics I
highly recommend the <a href="https://github.com/mikel/mail">mail</a> gem. It did almost everything I needed out of
the box, though it didn't correctly enumerate any of the additional headers.</p>
<p>Procmail is a highly flexible mail filtering and local delivery agent. Without
much effort you can pass the mail it is handling through a series of filters
which can manipulate and reject mail before eventually delivering it to your
inbox. In light of this, we're going to make a filter that simply counts the
total number of emails the script has processed, and add a header to the
message that indicates this count.</p>
<pre data-lang="ruby" class="language-ruby "><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby

require 'mail'

# Get the email message from STDIN or a passed filename
message = ""
while input = ARGF.gets
  message += input
end

# Parse the email into a ruby object
msg = Mail.new(message)

# Location of our count file
count_file = "#{ENV['HOME']}/.mail_counter.txt"

# Load or initialize our count value and increment it
count = File.exists?(count_file) ? File.read(count_file).to_i : 0
count += 1

# Update our count on disk
File.write(count_file, count.to_s)

# Add our header with the count
msg.header.fields << Mail::Field.new("X-Mail-Counter: #{count}")

# Output the now modified message back out to $stdout
begin
  $stdout.puts msg.to_s
rescue Errno::EPIPE
  exit(74)
end
</code></pre>
<p>Make sure you mark the script executable after saving it.</p>
<p>If you followed along with <a href="https://stelfox.net/blog/2013/backing-up-gmail-with-fetchmail/">my earlier post</a> the only change we need to make
is to add our ruby mail processor as a procmail filter. I've stored the script
in <code>~/.bin/mail-counter.rb</code>, if you've stored it in a different location you'll
want to update your path to reflect that.</p>
<p>Filters in procmail are handled by using the pipe helper. The following is a
minimum working example of a <code>procmailrc</code> file to make use of our filter:</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">MAILDIR=$HOME
VERBOSE=on

:0fw
| /home/sstelfox/Documents/ruby/riak-mail-indexer/counter.rb

:0
Maildir/
</code></pre>
<p>Store the above file in <code>~/.procmailrc</code>. The next time you run <code>fetchmail</code>
those headers will be added to the messages before being delivered and you can
watch the count increment by looking at the contents of <code>~/.mail_counter.txt</code>.</p>
<p>The following are a few additional sources I made use of while writing this
article:</p>
<ul>
<li>http://stackoverflow.com/questions/273262/best-practices-with-stdin-in-ruby</li>
<li>http://www.jstorimer.com/blogs/workingwithcode/7766125-writing-ruby-scripts-that-respect-pipelines</li>
</ul>
</div><p class="meta">Posted on <span class="postdate">2013-12-08</span></p></article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
