<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="sam@stelfox.net Sam Stelfox ">
<meta name="description" content="Following up on my earlier post where I covered how to backup your Gmail account using fetchmail and procmail; I wanted to cover how I was additionally processing received mail through ruby.
This was part of a larger project where I was doing statistical analysis on my email while evaluating various data stores. To get the emails into the various data stores, I used the ruby script to parse, process and store the emails as they came in." />
<meta name="keywords" content="blog, programming, linux, systems, personal, linux, ruby, tips" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://stelfox.net/blog/2013/12/running-emails-through-ruby/" />


    <title>
        
            Running Emails Through Ruby :: Sam Stelfox 
        
    </title>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link rel="stylesheet" href="/main.2a064c455b0ecbd6b1481b3bf9df2441e95838691022f40a5338c2cb1244f075.css" integrity="sha256-KgZMRVsOy9axSBs7&#43;d8kQelYOGkQIvQKUzjCyxJE8HU=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Running Emails Through Ruby">
<meta itemprop="description" content="Following up on my earlier post where I covered how to backup your Gmail account using fetchmail and procmail; I wanted to cover how I was additionally processing received mail through ruby.
This was part of a larger project where I was doing statistical analysis on my email while evaluating various data stores. To get the emails into the various data stores, I used the ruby script to parse, process and store the emails as they came in."><meta itemprop="datePublished" content="2013-12-08T09:32:05-05:00" />
<meta itemprop="dateModified" content="2013-12-08T09:32:05-05:00" />
<meta itemprop="wordCount" content="439">
<meta itemprop="keywords" content="linux,ruby,tips," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Running Emails Through Ruby"/>
<meta name="twitter:description" content="Following up on my earlier post where I covered how to backup your Gmail account using fetchmail and procmail; I wanted to cover how I was additionally processing received mail through ruby.
This was part of a larger project where I was doing statistical analysis on my email while evaluating various data stores. To get the emails into the various data stores, I used the ruby script to parse, process and store the emails as they came in."/>



    <meta property="og:title" content="Running Emails Through Ruby" />
<meta property="og:description" content="Following up on my earlier post where I covered how to backup your Gmail account using fetchmail and procmail; I wanted to cover how I was additionally processing received mail through ruby.
This was part of a larger project where I was doing statistical analysis on my email while evaluating various data stores. To get the emails into the various data stores, I used the ruby script to parse, process and store the emails as they came in." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stelfox.net/blog/2013/12/running-emails-through-ruby/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2013-12-08T09:32:05-05:00" />
<meta property="article:modified_time" content="2013-12-08T09:32:05-05:00" />






    <meta property="article:published_time" content="2013-12-08 09:32:05 -0500 EST" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                ./Sam_Stelfox.sh</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/blog/">Blog Posts</a></li><li><a href="/notes/">Various Notes</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://stelfox.net/blog/2013/12/running-emails-through-ruby/">Running Emails Through Ruby</a></h2>

            
            
            

            <div class="post-content">
                <p>Following up on my <a href="https://stelfox.net/blog/2013/11/backing-up-gmail-with-fetchmail/">earlier post</a> where I covered how to backup your Gmail
account using <code>fetchmail</code> and <code>procmail</code>; I wanted to cover how I was
additionally processing received mail through ruby.</p>
<p>This was part of a larger project where I was doing statistical analysis on my
email while evaluating various data stores. To get the emails into the various
data stores, I used the ruby script to parse, process and store the emails as
they came in.</p>
<p>If you&rsquo;re going to be doing any form of mail manipulation or statistics I
highly recommend the <a href="https://github.com/mikel/mail">mail</a> gem. It did almost everything I needed out of
the box, though it didn&rsquo;t correctly enumerate any of the additional headers.</p>
<p>Procmail is a highly flexible mail filtering and local delivery agent. Without
much effort you can pass the mail it is handling through a series of filters
which can manipulate and reject mail before eventually delivering it to your
inbox. In light of this, we&rsquo;re going to make a filter that simply counts the
total number of emails the script has processed, and add a header to the
message that indicates this count.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#!/usr/bin/env ruby</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>require <span style="color:#a5d6ff">&#39;mail&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Get the email message from STDIN or a passed filename</span>
</span></span><span style="display:flex;"><span>message <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">while</span> input <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff;font-weight:bold">ARGF</span><span style="color:#ff7b72;font-weight:bold">.</span>gets
</span></span><span style="display:flex;"><span>  message <span style="color:#ff7b72;font-weight:bold">+=</span> input
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Parse the email into a ruby object</span>
</span></span><span style="display:flex;"><span>msg <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff;font-weight:bold">Mail</span><span style="color:#ff7b72;font-weight:bold">.</span>new(message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Location of our count file</span>
</span></span><span style="display:flex;"><span>count_file <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;</span><span style="color:#a5d6ff">#{</span><span style="color:#79c0ff;font-weight:bold">ENV</span><span style="color:#ff7b72;font-weight:bold">[</span><span style="color:#a5d6ff">&#39;HOME&#39;</span><span style="color:#ff7b72;font-weight:bold">]</span><span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">/.mail_counter.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Load or initialize our count value and increment it</span>
</span></span><span style="display:flex;"><span>count <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff;font-weight:bold">File</span><span style="color:#ff7b72;font-weight:bold">.</span>exists?(count_file) ? <span style="color:#79c0ff;font-weight:bold">File</span><span style="color:#ff7b72;font-weight:bold">.</span>read(count_file)<span style="color:#ff7b72;font-weight:bold">.</span>to_i : <span style="color:#a5d6ff">0</span>
</span></span><span style="display:flex;"><span>count <span style="color:#ff7b72;font-weight:bold">+=</span> <span style="color:#a5d6ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Update our count on disk</span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">File</span><span style="color:#ff7b72;font-weight:bold">.</span>write(count_file, count<span style="color:#ff7b72;font-weight:bold">.</span>to_s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Add our header with the count</span>
</span></span><span style="display:flex;"><span>msg<span style="color:#ff7b72;font-weight:bold">.</span>header<span style="color:#ff7b72;font-weight:bold">.</span>fields <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> <span style="color:#79c0ff;font-weight:bold">Mail</span><span style="color:#ff7b72;font-weight:bold">::</span><span style="color:#79c0ff;font-weight:bold">Field</span><span style="color:#ff7b72;font-weight:bold">.</span>new(<span style="color:#a5d6ff">&#34;X-Mail-Counter: </span><span style="color:#a5d6ff">#{</span>count<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Output the now modified message back out to $stdout</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">begin</span>
</span></span><span style="display:flex;"><span>  $stdout<span style="color:#ff7b72;font-weight:bold">.</span>puts msg<span style="color:#ff7b72;font-weight:bold">.</span>to_s
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">rescue</span> <span style="color:#79c0ff;font-weight:bold">Errno</span><span style="color:#ff7b72;font-weight:bold">::</span><span style="color:#79c0ff;font-weight:bold">EPIPE</span>
</span></span><span style="display:flex;"><span>  exit(<span style="color:#a5d6ff">74</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">end</span>
</span></span></code></pre></div><p>Make sure you mark the script executable after saving it.</p>
<p>If you followed along with <a href="https://stelfox.net/blog/2013/11/backing-up-gmail-with-fetchmail/">my earlier post</a> the only change we need to make
is to add our ruby mail processor as a procmail filter. I&rsquo;ve stored the script
in <code>~/.bin/mail-counter.rb</code>, if you&rsquo;ve stored it in a different location you&rsquo;ll
want to update your path to reflect that.</p>
<p>Filters in procmail are handled by using the pipe helper. The following is a
minimum working example of a <code>procmailrc</code> file to make use of our filter:</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#79c0ff">MAILDIR</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">$HOME</span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">VERBOSE</span><span style="color:#ff7b72;font-weight:bold">=</span>on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:0fw
</span></span><span style="display:flex;"><span>| /home/sstelfox/Documents/ruby/riak-mail-indexer/counter.rb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:0
</span></span><span style="display:flex;"><span>Maildir/
</span></span></code></pre></div><p>Store the above file in <code>~/.procmailrc</code>. The next time you run <code>fetchmail</code>
those headers will be added to the messages before being delivered and you can
watch the count increment by looking at the contents of <code>~/.mail_counter.txt</code>.</p>
<p>The following are a few additional sources I made use of while writing this
article:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/273262/best-practices-with-stdin-in-ruby">http://stackoverflow.com/questions/273262/best-practices-with-stdin-in-ruby</a></li>
<li><a href="http://www.jstorimer.com/blogs/workingwithcode/7766125-writing-ruby-scripts-that-respect-pipelines">http://www.jstorimer.com/blogs/workingwithcode/7766125-writing-ruby-scripts-that-respect-pipelines</a></li>
</ul>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://stelfox.net/tags/linux/">linux</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/ruby/">ruby</a></span>
        <span class="tag"><a href="https://stelfox.net/tags/tips/">tips</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.c90b8161416b87c69a8e02683b54ddd6edb90aea699648bf655e6cbc45b419b8e465d196e715772463dba35a6faf5decb2eb247480d38680484d54645b434570.js" integrity="sha512-yQuBYUFrh8aajgJoO1Td1u25Cupplki/ZV5svEW0GbjkZdGW5xV3JGPbo1pvr13ssuskdIDThoBITVRkW0NFcA=="></script>



    </body>
</html>
