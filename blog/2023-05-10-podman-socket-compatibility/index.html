<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="I&amp;rsquo;ve long appreciated what a project called metalk8s has been doing&amp;hellip; Making Kubernetes run in an opinionated way for private data centers. I don&amp;rsquo;t agree with all their opinions but it&amp;rsquo;s open source and customizable. There is a problem though&amp;hellip;
The docker binary and daemon are largely being replaced and deprecated in favor of podman in the RedHat distros that metalk8s targets. I fully support this change, podman is a great open source tool that listens to user feedback and has far outstripped Docker in capabilities and security features."><meta name=keywords content=",docker,kubernetes,linux,metalk8s,podman"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2023-05-10-podman-socket-compatibility/><title>Podman Socket Compatibility for Metalk8s :: Sam Stelfox
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Podman Socket Compatibility for Metalk8s"><meta itemprop=description content="I&rsquo;ve long appreciated what a project called metalk8s has been doing&mldr; Making Kubernetes run in an opinionated way for private data centers. I don&rsquo;t agree with all their opinions but it&rsquo;s open source and customizable. There is a problem though&mldr;
The docker binary and daemon are largely being replaced and deprecated in favor of podman in the RedHat distros that metalk8s targets. I fully support this change, podman is a great open source tool that listens to user feedback and has far outstripped Docker in capabilities and security features."><meta itemprop=datePublished content="2023-05-10T22:41:02-04:00"><meta itemprop=dateModified content="2023-05-10T22:41:02-04:00"><meta itemprop=wordCount content="422"><meta itemprop=keywords content="Docker,Kubernetes,Linux,Metalk8s,Podman"><meta name=twitter:card content="summary"><meta name=twitter:title content="Podman Socket Compatibility for Metalk8s"><meta name=twitter:description content="I&rsquo;ve long appreciated what a project called metalk8s has been doing&mldr; Making Kubernetes run in an opinionated way for private data centers. I don&rsquo;t agree with all their opinions but it&rsquo;s open source and customizable. There is a problem though&mldr;
The docker binary and daemon are largely being replaced and deprecated in favor of podman in the RedHat distros that metalk8s targets. I fully support this change, podman is a great open source tool that listens to user feedback and has far outstripped Docker in capabilities and security features."><meta property="article:published_time" content="2023-05-10 22:41:02 -0400 EDT"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/blog/>Blog Posts</a></li><li><a href=/notes/>Various Notes</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2023-05-10-podman-socket-compatibility/>Podman Socket Compatibility for Metalk8s</a></h2><div class=post-content><p>I&rsquo;ve long appreciated what a project called <a href=https://github.com/scality/metalk8s>metalk8s</a> has been doing&mldr; Making Kubernetes run in an opinionated way for private data centers. I don&rsquo;t agree with all their opinions but it&rsquo;s open source and customizable. There is a problem though&mldr;</p><p>The <code>docker</code> binary and daemon are largely being replaced and deprecated in favor of <code>podman</code> in the RedHat distros that metalk8s targets. I fully support this change, <code>podman</code> is a great open source tool that listens to user feedback and has far outstripped Docker in capabilities and security features.</p><p>I&rsquo;ve poked at the project a few times for various reasons, but up to this point I haven&rsquo;t built and deployed a proper cluster using their project. Metalk8s unfortunately still relies on <code>docker</code> being installed to build its base ISO images.</p><p>Let me be clear <code>docker</code> is a hard requirement the project explicitly lists, but I really don&rsquo;t want to install it and the build will fail quickly without it. Let&rsquo;s see if we can work around it.</p><p>After checking out <a href=https://github.com/scality/metalk8s>the repository</a>, assuming you have the dependencies installed you should just be able to run <code>./doit.sh</code> and get an ISO out that can be used to bootstrap your cluster. Running it without docker will get you fairly far with the output successfully reporting a few images being downloaded&mldr; But then <code>nginx</code>&mldr; You get a long backtrace ending with the following line:</p><p>requests.exceptions.ConnectionError: (&lsquo;Connection aborted.&rsquo;, FileNotFoundError(2, &lsquo;No such file or directory&rsquo;))</p><pre tabindex=0><code>What an odd error. Connection aborted and file not found together. You only see that combination with unix sockets... Oh... Docker... The running as root service that runs arbitrary code also as root using a unix socket with minimal permission control... Right...

Whelp there is a local override that works as a compatibility shim using `podman` that almost always works. You need to startup a systemd socket service as the user and point anything looking for the Docker daemon at that which is pretty straight forward...

```sh
systemctl --user start podman.socket
export DOCKER_HOST=http+unix:///run/user/$(id -u)/podman/podman.sock
</code></pre><p>For most applications a simple <code>alias docker=podman</code> suffices, unfortunately not for this one. And unfortunately this won&rsquo;t 100% solve the problem. The build script will get through pulling all the remote docker images but will fail once it gets to the local ones using the <code>skopeo</code> utility as the <code>metalk8s</code>project appears to be adding an extra <code>http://</code> in front of the socket path that doesn&rsquo;t belong there.</p><p>It&rsquo;s getting late and I&rsquo;m hitting the end of this diagnostics section. Stay tuned for a PR most likely to <code>metalk8s</code>.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/docker/>docker</a></span>
<span class=tag><a href=https://stelfox.net/tags/kubernetes/>kubernetes</a></span>
<span class=tag><a href=https://stelfox.net/tags/linux/>linux</a></span>
<span class=tag><a href=https://stelfox.net/tags/metalk8s/>metalk8s</a></span>
<span class=tag><a href=https://stelfox.net/tags/podman/>podman</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>