<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='For the past few days I&rsquo;ve been working on a Ruby project that needed to interact with a remote XMLRPC API. This isn&rsquo;t particularly unusual but it was the first time from within a Ruby application. Luckily enough Ruby has a built in XMLRPC client that handles a lot of the messy bits.
The XMLRPC::Client class itself seems fairly simple. There are only a handful of methods, five of which are for opening a new connection in a few different ways, and at least two ways to open each type of connection.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Ruby&#39;s XMLRPC::Client and SSL • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='For the past few days I&rsquo;ve been working on a Ruby project that needed to interact with a remote XMLRPC API. This isn&rsquo;t particularly unusual but it was the first time from within a Ruby application. Luckily enough Ruby has a built in XMLRPC client that handles a lot of the messy bits.
The XMLRPC::Client class itself seems fairly simple. There are only a handful of methods, five of which are for opening a new connection in a few different ways, and at least two ways to open each type of connection.'>
<meta property='og:url' content='https://stelfox.net/blog/2012/02/rubys-xmlrpcclient-and-ssl/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='development'><meta property='article:tag' content='ruby'><meta property='article:published_time' content='2012-02-14T18:08:51Z'/><meta property='article:modified_time' content='2012-02-14T18:08:51Z'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.51-DEV" />

  <title>Ruby&#39;s XMLRPC::Client and SSL • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2012/02/rubys-xmlrpcclient-and-ssl/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4267b3fa.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>


<body class='page type-blog'>

  <div class='site'>

    <a class='screen-reader-text' href='#content'>Skip to Content</a>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Ruby&#39;s XMLRPC::Client and SSL</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2012-02-14T18:08:51Z'>2012, Feb 14</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
4 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>For the past few days I&rsquo;ve been working on a Ruby project that needed to
interact with a remote XMLRPC API. This isn&rsquo;t particularly unusual but it was
the first time from within a Ruby application. Luckily enough Ruby has a built
in XMLRPC client that handles a lot of the messy bits.</p>

<p>The XMLRPC::Client class itself seems fairly simple. There are only a handful
of methods, five of which are for opening a new connection in a few different
ways, and at least two ways to open each type of connection.</p>

<p>As a starting point this was a simplified chunk of code that I was using to
connect to the remote API:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#39;xmlrpc/client&#39;</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">APIConnection</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(username, password, host)
    <span style="color:#75715e"># Build the arguments for the XMLRPC::Client object</span>
    conn_args <span style="color:#f92672">=</span> {
      <span style="color:#e6db74">:user</span> <span style="color:#f92672">=&gt;</span> username,
      <span style="color:#e6db74">:password</span> <span style="color:#f92672">=&gt;</span> password,
      <span style="color:#e6db74">:host</span> <span style="color:#f92672">=&gt;</span> host,
      <span style="color:#e6db74">:use_ssl</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>,
      <span style="color:#e6db74">:path</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/api&#34;</span>
    }

    @connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">XMLRPC</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Client</span><span style="color:#f92672">.</span>new_from_hash(conn_args)
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">version</span>
    @connection<span style="color:#f92672">.</span>call(<span style="color:#e6db74">&#34;version&#34;</span>)
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>The problem I ran into was when connecting to a server using HTTPS. I knew that
this certificate was good however I continued to get the message:</p>

<pre><code>warning: peer certificate won't be verified in this SSL session
</code></pre>

<p>Ruby has taken the approach of by default not including any trusted certificate
authorities which I greatly appreciate especially considering that in 2010 and
2011 12 certificate authorities were known to have been hacked including major
ones such as VeriSign, and <a href="http://www.symantec.com/connect/blogs/diginotar-ssl-breach-update">DigiNotar</a>. Some of which were <a href="http://nakedsecurity.sophos.com/2011/08/29/falsely-issued-google-ssl-certificate-in-the-wild-for-more-than-5-weeks/">proven</a> to
have issued false certificates.</p>

<p>Since XMLRPC::Client doesn&rsquo;t expose it&rsquo;s SSL trust settings through it&rsquo;s
methods I went on a bit of a journey through Google to find an answer. What I
found was overly disturbing, a lot of people don&rsquo;t seem to understand what SSL
is actually for. The solutions I found from the most egregious to least:</p>

<ul>
<li>Disabling OpenSSL certificate checking globally with
 OpenSSL::SSL::VERIFY_NONE</li>
<li>Overriding the Net::HTTP certificate checking</li>
<li>Disabling OpenSSL certificate checking locally by extending XMLRPC::Client
and over-riding how it was establishing connections</li>
<li>Using an SSL stripping proxy</li>
</ul>

<p>I couldn&rsquo;t find a solution out there that didn&rsquo;t the security conscious voice
in my head scream in despair. I asked on <a href="http://stackoverflow.com/questions/9199660/why-is-ruby-unable-to-verify-an-ssl-certificate">StackOverflow</a> for a good
solution. When I asked I didn&rsquo;t have a good grasp on how Ruby was handling SSL
certificates at all. The thorough answer from <a href="http://stackoverflow.com/a/9238221/95114">emboss</a> didn&rsquo;t quite answer
my question but it gave me more than enough to really hunt down what I wanted.</p>

<p>First stop, I needed the certificates that I&rsquo;ll be using to verify the
connection. Every single certificate authority that issues certificates for
public websites makes the public portion of their certificates available and
this is what we need to verify the connection. To find out which ones you
specifically need you can go to the API server&rsquo;s address and look at it&rsquo;s
certificate information by clicking on the site&rsquo;s lock icon. Every browser is a
little different so you&rsquo;ll have to find this out on your own. With Chrome (and
perhaps others) you can download each of the certificates in the chain that
you&rsquo;ll need to verify the server&rsquo;s certificate.</p>

<p>The server I was connecting to was using a <a href="http://www.rapidssl.com/">RapidSSL</a> certificate, who has
been verified by <a href="http://www.geotrust.com/">GeoTrust</a>. You want to grab their certificates base64
encoded in PEM format. Stick them all in a <code>ca.crt</code> file.</p>

<p>How do we get XMLRPC::Client to actually use that information without hacking
it all to pieces? Net::HTTP has a few methods that allow you to set the
appropriate connection settings and XMLRPC::Client uses Net::HTTP. If
XMLRPC::Client allowed to you specify this directly somehow I would&rsquo;ve been a
lot happier.</p>

<p>Here&rsquo;s that code snippet again, this time forcing certificate verification with
the <code>ca.crt</code> file. This code assumes that the <code>ca.crt</code> file lives in the same
directory as the connection script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#39;xmlrpc/client&#39;</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">APIConnection</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(username, password, host)
    <span style="color:#75715e"># Build the arguments for the XMLRPC::Client object</span>
    conn_args <span style="color:#f92672">=</span> {
      <span style="color:#e6db74">:user</span> <span style="color:#f92672">=&gt;</span> username,
      <span style="color:#e6db74">:password</span> <span style="color:#f92672">=&gt;</span> password,
      <span style="color:#e6db74">:host</span> <span style="color:#f92672">=&gt;</span> host,
      <span style="color:#e6db74">:use_ssl</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>,
      <span style="color:#e6db74">:path</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/api&#34;</span>
    }

    @connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">XMLRPC</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Client</span><span style="color:#f92672">.</span>new_from_hash(conn_args)

    @connection<span style="color:#f92672">.</span>instance_variable_get(<span style="color:#e6db74">&#34;@http&#34;</span>)<span style="color:#f92672">.</span>verify_mode <span style="color:#f92672">=</span> <span style="color:#66d9ef">OpenSSL</span><span style="color:#f92672">::</span><span style="color:#66d9ef">SSL</span><span style="color:#f92672">::</span><span style="color:#66d9ef">VERIFY_PEER</span>
    @connection<span style="color:#f92672">.</span>instance_variable_get(<span style="color:#e6db74">&#34;@http&#34;</span>)<span style="color:#f92672">.</span>ca_file <span style="color:#f92672">=</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>join(<span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>dirname(__FILE__), <span style="color:#e6db74">&#34;ca.crt&#34;</span>)
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">version</span>
    @connection<span style="color:#f92672">.</span>call(<span style="color:#e6db74">&#34;version&#34;</span>)
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Those last two lines in the initialize method first dive into the connection
we&rsquo;ve already setup (but before it&rsquo;s been called), grab the of Net::HTTP and
tells it to force peer verification and to use the certificate file we created
before. No more warning, and we&rsquo;re actually safe.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/development/'>development</a>, <a class='tag' href='/tags/ruby/'>ruby</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2011/05/exploration-of-a-acn-iris-3000/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Exploration of an ACN Iris 3000</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2012/07/thoughts-on-ipv6-security-and-mitigation/'>
        <span class='screen-reader-text'>Next post: </span>Thoughts on IPv6 Security and Mitigation<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2018 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.59f76c44.js'></script>

</body>

</html>

