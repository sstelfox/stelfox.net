<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Recently while writing a Ruby program I needed to parse some command line options. Helpfully Ruby provides a module named OptionParser to make this easy. I found a few parts of the documentation ambiguous and a few others down right confusing.
The catch I hit was the required field. In my mind the definition of a required argument is something that needs to be passed on the command line to continue.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Ruby&#39;s Option Parser - a More Complete Example • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='Recently while writing a Ruby program I needed to parse some command line options. Helpfully Ruby provides a module named OptionParser to make this easy. I found a few parts of the documentation ambiguous and a few others down right confusing.
The catch I hit was the required field. In my mind the definition of a required argument is something that needs to be passed on the command line to continue.'>
<meta property='og:url' content='https://stelfox.net/blog/2012/12/rubys-option-parser-a-more-complete-example/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='development'><meta property='article:tag' content='ruby'><meta property='article:published_time' content='2012-12-02T22:59:00-05:00'/><meta property='article:modified_time' content='2012-12-02T22:59:00-05:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.50-DEV" />

  <title>Ruby&#39;s Option Parser - a More Complete Example • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2012/12/rubys-option-parser-a-more-complete-example/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.dd2efce5.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Ruby&#39;s Option Parser - a More Complete Example</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2012-12-02T22:59:00-05:00'>2012, Dec 02</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
4 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>Recently while writing a Ruby program I needed to parse some command line
options. Helpfully Ruby provides a module named <code>OptionParser</code> to make this
easy. I found a few parts of the documentation ambiguous and a few others down
right confusing.</p>

<p>The catch I hit was the required field. In my mind the definition of a required
argument is something that needs to be passed on the command line to continue.
What<code>OptionParser</code> actually means is that a value isn&rsquo;t required when the
argument is passed.<code>OptionParser</code> already provides boolean switches, so when
someone would use an optional switch is beyond me.</p>

<p>To make it a little more clear and to have something to work from in the future
I created the following chunk of code that includes a Configuration singleton
that can be used anywhere within your codebase to access the run-time
configuration, a sample parser with a wide range of different types of options,
and it will load configuration from a file named <code>config.yml</code> in the same
directory.</p>

<p>I feel like the following is a much more complete explanation of how
<code>OptionParser</code> is supposed to be used with supporting code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e">#!/usr/bin/env ruby</span>

<span style="color:#75715e"># This file provides an example of creating a command line application with a</span>
<span style="color:#75715e"># wide variety of command line options, parsing and the like as well as global</span>
<span style="color:#75715e"># configuration singleton that can be relied on throughout a program.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># This entire setup lives within the &#34;Example&#34; module. These are really common</span>
<span style="color:#75715e"># names and it would be a shame to override required functionality in other code</span>
<span style="color:#75715e"># that wasn&#39;t properly namespaced.</span>

require <span style="color:#e6db74">&#39;optparse&#39;</span>
require <span style="color:#e6db74">&#39;singleton&#39;</span>
require <span style="color:#e6db74">&#39;yaml&#39;</span>

<span style="color:#66d9ef">module</span> Example
  <span style="color:#75715e"># Defines the available configuration options for the configuration</span>
  <span style="color:#66d9ef">ConfigurationStruct</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Struct</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">:enum</span>, <span style="color:#e6db74">:list</span>, <span style="color:#e6db74">:required</span>, <span style="color:#e6db74">:optional</span>, <span style="color:#e6db74">:verbose</span>, <span style="color:#e6db74">:float</span>)

  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Configuration</span>
    <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Singleton</span>

    <span style="color:#75715e"># Initialize the configuration and set defaults:</span>
    @@config <span style="color:#f92672">=</span> <span style="color:#66d9ef">ConfigurationStruct</span><span style="color:#f92672">.</span>new

    <span style="color:#75715e"># This is where the defaults are being set</span>
    @@config<span style="color:#f92672">.</span>enum <span style="color:#f92672">=</span> <span style="color:#e6db74">:one</span>
    @@config<span style="color:#f92672">.</span>list <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
    @@config<span style="color:#f92672">.</span>optional <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
    @@config<span style="color:#f92672">.</span>verbose <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">config</span>
      <span style="color:#66d9ef">yield</span>(@@config) <span style="color:#66d9ef">if</span> block_given?
      @@config
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># Loads a YAML configuration file and sets each of the configuration values to</span>
    <span style="color:#75715e"># whats in the file.</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">load</span>(file)
      <span style="color:#66d9ef">YAML</span><span style="color:#f92672">::</span>load_file(file)<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>key, value<span style="color:#f92672">|</span>
        self<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">=&#34;</span>, value)
      <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># This provides an easy way to dump the configuration as a hash</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">to_hash</span>
      <span style="color:#66d9ef">Hash</span><span style="color:#f92672">[</span>@@config<span style="color:#f92672">.</span>each_pair<span style="color:#f92672">.</span>to_a<span style="color:#f92672">]</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># Pass any other calls (most likely attribute setters/getters on to the</span>
    <span style="color:#75715e"># configuration as a way to easily set/get attribute values </span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">method_missing</span>(method, <span style="color:#f92672">*</span>args, <span style="color:#f92672">&amp;</span>block)
      <span style="color:#66d9ef">if</span> @@config<span style="color:#f92672">.</span>respond_to?(method)
        @@config<span style="color:#f92672">.</span>send(method, <span style="color:#f92672">*</span>args, <span style="color:#f92672">&amp;</span>block)
      <span style="color:#66d9ef">else</span>
        <span style="color:#66d9ef">raise</span> <span style="color:#66d9ef">NoMethodError</span>
      <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># Handles validating the configuration that has been loaded/configured</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">validate!</span>
      valid <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>

      valid <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>required<span style="color:#f92672">.</span>nil?

      <span style="color:#66d9ef">raise</span> <span style="color:#66d9ef">ArgumentError</span> <span style="color:#66d9ef">unless</span> valid
    <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConfigurationParser</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span>(args)
      opts <span style="color:#f92672">=</span> <span style="color:#66d9ef">OptionParser</span><span style="color:#f92672">.</span>new <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>parser<span style="color:#f92672">|</span>

        parser<span style="color:#f92672">.</span>separator <span style="color:#e6db74">&#34;&#34;</span>
        parser<span style="color:#f92672">.</span>separator <span style="color:#e6db74">&#34;Specific options:&#34;</span>

        parser<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;--enum ENUM&#34;</span>, <span style="color:#f92672">[</span><span style="color:#e6db74">:one</span>, <span style="color:#e6db74">:two</span>, <span style="color:#e6db74">:three</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">&#34;This field requires one of a set of predefined values be&#34;</span>, <span style="color:#e6db74">&#34;set. If wrapped in brackets this option can be set to nil.&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>setting<span style="color:#f92672">|</span>
          <span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>enum <span style="color:#f92672">=</span> setting
        <span style="color:#66d9ef">end</span>

        parser<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;-l&#34;</span>, <span style="color:#e6db74">&#34;--list x,y&#34;</span>, Array, <span style="color:#e6db74">&#34;This command flag takes a comma separated list (without&#34;</span>, <span style="color:#e6db74">&#34;spaces) of values and turns it into an array. This requires&#34;</span>, <span style="color:#e6db74">&#34;at least one argument.&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>setting<span style="color:#f92672">|</span>
          <span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>list <span style="color:#f92672">=</span> setting
        <span style="color:#66d9ef">end</span>

        parser<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;--[no-]verbose&#34;</span>, <span style="color:#e6db74">&#34;This is a common boolean flag, setting verbosity to either&#34;</span>, <span style="color:#e6db74">&#34;true or false.&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>setting<span style="color:#f92672">|</span>
          <span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>verbose <span style="color:#f92672">=</span> setting
        <span style="color:#66d9ef">end</span>

        parser<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;--optional [STR]&#34;</span>, <span style="color:#e6db74">&#34;This command doesn&#39;t require a string to be passed to it, if&#34;</span>, <span style="color:#e6db74">&#34;nothing is passed it will be nil. No error will be raised if&#34;</span>, <span style="color:#e6db74">&#34;nothing is passed to it that logic needs to be handled&#34;</span>, <span style="color:#e6db74">&#34;yourself.&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>setting<span style="color:#f92672">|</span>
          <span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>optional <span style="color:#f92672">=</span> setting
        <span style="color:#66d9ef">end</span>

        parser<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;-r&#34;</span>, <span style="color:#e6db74">&#34;--required STR&#34;</span>, <span style="color:#e6db74">&#34;This command requires a string to be passed to it.&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>setting<span style="color:#f92672">|</span>
          <span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>required <span style="color:#f92672">=</span> setting
        <span style="color:#66d9ef">end</span>

        parser<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;--float NUM&#34;</span>, Float, <span style="color:#e6db74">&#34;This command will only accept an integer or a float.&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>setting<span style="color:#f92672">|</span>
          <span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>float <span style="color:#f92672">=</span> setting
        <span style="color:#66d9ef">end</span>

        parser<span style="color:#f92672">.</span>on_tail(<span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;--help&#34;</span>, <span style="color:#e6db74">&#34;--usage&#34;</span>, <span style="color:#e6db74">&#34;Show this usage message and quit.&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>setting<span style="color:#f92672">|</span>
          puts parser<span style="color:#f92672">.</span>help
          exit
        <span style="color:#66d9ef">end</span>

        parser<span style="color:#f92672">.</span>on_tail(<span style="color:#e6db74">&#34;-v&#34;</span>, <span style="color:#e6db74">&#34;--version&#34;</span>, <span style="color:#e6db74">&#34;Show version information about this program and quit.&#34;</span>) <span style="color:#66d9ef">do</span>
          puts <span style="color:#e6db74">&#34;Option Parser Example v1.0.0&#34;</span>
          exit
        <span style="color:#66d9ef">end</span>
      <span style="color:#66d9ef">end</span>

      opts<span style="color:#f92672">.</span>parse!(args)
    <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>exists?(<span style="color:#e6db74">&#34;config.yml&#34;</span>)
  <span style="color:#66d9ef">Example</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>load(<span style="color:#e6db74">&#34;config.yml&#34;</span>)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">Example</span><span style="color:#f92672">::</span><span style="color:#66d9ef">ConfigurationParser</span><span style="color:#f92672">.</span>parse(<span style="color:#66d9ef">ARGV</span>)
<span style="color:#66d9ef">Example</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>validate!

require <span style="color:#e6db74">&#34;json&#34;</span>
puts <span style="color:#66d9ef">JSON</span><span style="color:#f92672">.</span>pretty_generate(<span style="color:#66d9ef">Example</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Configuration</span><span style="color:#f92672">.</span>to_hash)</code></pre></div>
</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/development/'>development</a>, <a class='tag' href='/tags/ruby/'>ruby</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2012/11/keep-your-gems-updated/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Keep Your Gems Updated</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2013/11/backing-up-gmail-with-fetchmail/'>
        <span class='screen-reader-text'>Next post: </span>Backing up Gmail with fetchmail<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2019 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.00df04b7.js'></script>

</body>

</html>

