<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

    <title>Sam Stelfox&#x27;s Thoughts &amp; Notes</title>
    <link rel="stylesheet" href="https://stelfox.net/colors-dark.css">

    

    
    
  </head>
  <body>
    <header id="header">
      <h1><a href="https:&#x2F;&#x2F;stelfox.net">Sam Stelfox&#x27;s Thoughts &amp; Notes</a></h1>
      <p>Thought&#x27;s from a software engineer, systems architect, and Linux gubernƒÅre.</p>
    </header>
    <div id="page">
      <div id="sidebar">
        
          
          <nav>
            <ul class="nav">
              
                
                  <li>
                    <a href="&#x2F;"><span>Home</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;about&#x2F;"><span>About</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;blog&#x2F;"><span>Blog</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;projects&#x2F;"><span>Projects</span></a>
                  </li>
                
                  <li>
                    <a href="&#x2F;notes&#x2F;"><span>Various Notes</span></a>
                  </li>
                
              
            </ul>
          </nav>
          
        
      </div>
      <div id="content">
        
<article class="post">
  <h1><a href="https:&#x2F;&#x2F;stelfox.net&#x2F;blog&#x2F;2012&#x2F;adding-a-table-prefix-to-datamapper-tables&#x2F;">Adding a Table Prefix to DataMapper Tables</a></h1>

  <div class="post-content"><p>So I recently encountered a situation where I needed to define a prefix on the
tables used by the &quot;data_mapper&quot; gem. When I went searching I found quite a bit
of information about similar projects in Python, and PHP named DataMapper but
nothing about the ruby &quot;data_mapper&quot;. The search continued eventually ending in
my reading through the source of the data_mapper gem only to find that there
was no feature for simply defining a prefix.</p>
<span id="continue-reading"></span>
<p>Reading through the source though did allow me to find any easy way to
implement such functionality. The following snippet is a minimalist data_mapper
initialization and setup of one model with a table prefix of <code>source_</code> (chosen
at random and of no significance).</p>
<pre data-lang="ruby" class="language-ruby "><code class="language-ruby" data-lang="ruby"># encoding: utf-8

# (1)
require "dm-core"
require "dm-migrations"

# (2)
module PrefixNamingConvention
  def self.call(model_name)
    # (3)
    prefix = "source_"
    # (4)
    table_name = DataMapper::NamingConventions::Resource::UnderscoredAndPluralized.call(model_name)

    "#{prefix}#{table_name}"
  end
end

# (5)
DataMapper::Logger.new($stdout, :debug)

# (6)
DataMapper.setup(:default, "sqlite:example.db")
DataMapper.repository(:default).adapter.resource_naming_convention = PrefixNamingConvention

# (7)
class Person
  include DataMapper::Resource

  property :id, Serial
  property :first_name, String
  property :last_name, String
  property :email, String
end

# (8)
DataMapper.finalize
DataMapper.auto_upgrade!
</code></pre>
<p>So here are some notes on what's going on in this snippet. Each area that I
will be discussing has been annotated with a number like &quot;# (1)&quot; to make it
easier to find a section you have questions about.</p>
<ol>
<li>Since this is an example I'm only including the bare minimum data mapper
gems to accomplish the task. If you're using bundler you may need to also
require &quot;rubygems&quot; to get this too work.</li>
<li>This is where the real work happens, DataMapper uses external modules that
receive the &quot;call&quot; method to handle the conversion of class names to table
names. By default DataMapper uses the module
&quot;DataMapper::NamingConventions::Resource::UnderscoredAndPluralized&quot;, which
I'll use later to maintain the same names.</li>
<li>This is where I'm defining the table prefix. This could be defined in a
global, call another method or class, whatever your heart desires to get a
string that will be used as a prefix.</li>
<li>Here I'm getting what DataMapper would have named the table if I wasn't
interferring</li>
<li>I'm logging to standard out so that I can see the queries called to verify
that DataMapper is creating tables with the names that I want. This is used
later on in this post to demonstrate this solution working, however, it
could be left out without affecting anything.</li>
<li>Initial setup of a sqlite database, and then the good stuff. Once a database
has been setup with a specific adapter you can change the naming convention
DataMapper will use to generate table names. This is accomplished by passing
the module constant name through the repositories adapter and too
&quot;resource_naming_convention&quot; as demonstrated in the code.</li>
<li>Here I'm defining an example model of no importance. This is purely for
demonstration, normally DataMapper would name this model &quot;people&quot;.</li>
<li>Inform DataMapper we're done setting it up and to run the migrations to
create the model defined.</li>
</ol>
<p>When you run this ruby file (assuming you have the &quot;data_mapper&quot; and
&quot;dm-sqlite-adapter&quot; gem installed) you'll see output very similar too this:</p>
<pre><code>~ (0.001402) PRAGMA table_info("source_people")
~ (0.000089) SELECT sqlite_version(*)
~ (0.077840) CREATE TABLE "source_people" ("id" INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, "first_name" VARCHAR(50), "last_name" VARCHAR(50), "email" VARCHAR(50))
</code></pre>
<p>Notice the third line? Specifically the name of the table? It's named exactly
as it would have been except now it has a prefix of &quot;source_&quot;.</p>
<p>Hope this saves someone else some trouble. Cheers!</p>
</div><p class="meta">Posted on <span class="postdate">2012-08-07</span></p></article>

      </div>
      <footer id="footer">
        <p class="copyright">
          
          &copy; 2011 &ndash; 2021 Sam Stelfox | <a href="https://stelfox.net/licenses/">Site Content Licenses</a>
          
        </p>
      </footer>
    </div>
  </body>
</html>
