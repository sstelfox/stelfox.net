<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="So I recently encountered a situation where I needed to define a prefix on the tables used by the &amp;quot;data_mapper&amp;quot; gem. When I went searching I found quite a bit of information about similar projects in Python, and PHP named DataMapper but nothing about the ruby &amp;quot;data_mapper&amp;quot;. The search continued eventually ending in my reading through the source of the data_mapper gem only to find that there was no feature for simply defining a prefix."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,development,ruby"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2012/08/adding-a-table-prefix-to-datamapper-tables/><title>Adding a Table Prefix to DataMapper Tables :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Adding a Table Prefix to DataMapper Tables"><meta itemprop=description content='So I recently encountered a situation where I needed to define a prefix on the tables used by the "data_mapper" gem. When I went searching I found quite a bit of information about similar projects in Python, and PHP named DataMapper but nothing about the ruby "data_mapper". The search continued eventually ending in my reading through the source of the data_mapper gem only to find that there was no feature for simply defining a prefix.'><meta itemprop=datePublished content="2012-08-07T14:09:33+00:00"><meta itemprop=dateModified content="2012-08-07T14:09:33+00:00"><meta itemprop=wordCount content="609"><meta itemprop=keywords content="Development,Ruby"><meta name=twitter:card content="summary"><meta name=twitter:title content="Adding a Table Prefix to DataMapper Tables"><meta name=twitter:description content='So I recently encountered a situation where I needed to define a prefix on the tables used by the "data_mapper" gem. When I went searching I found quite a bit of information about similar projects in Python, and PHP named DataMapper but nothing about the ruby "data_mapper". The search continued eventually ending in my reading through the source of the data_mapper gem only to find that there was no feature for simply defining a prefix.'><meta property="article:published_time" content="2012-08-07 14:09:33 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2012/08/adding-a-table-prefix-to-datamapper-tables/>Adding a Table Prefix to DataMapper Tables</a></h2><div class=post-content><p>So I recently encountered a situation where I needed to define a prefix on the tables used by the "data_mapper" gem. When I went searching I found quite a bit of information about similar projects in Python, and PHP named DataMapper but nothing about the ruby "data_mapper". The search continued eventually ending in my reading through the source of the data_mapper gem only to find that there was no feature for simply defining a prefix.</p><p>Reading through the source though did allow me to find any easy way to implement such functionality. The following snippet is a minimalist data_mapper initialization and setup of one model with a table prefix of "source_" (chosen at random and of no significance).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># encoding: utf-8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># (1)</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;dm-core&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;dm-migrations&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># (2)</span>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>PrefixNamingConvention</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>call</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># (3)</span>
</span></span><span class=line><span class=cl>    <span class=n>prefix</span> <span class=o>=</span> <span class=s2>&#34;source_&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># (4)</span>
</span></span><span class=line><span class=cl>    <span class=n>table_name</span> <span class=o>=</span> <span class=no>DataMapper</span><span class=o>::</span><span class=no>NamingConventions</span><span class=o>::</span><span class=no>Resource</span><span class=o>::</span><span class=no>UnderscoredAndPluralized</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;</span><span class=si>#{</span><span class=n>prefix</span><span class=si>}#{</span><span class=n>table_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># (5)</span>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>::</span><span class=no>Logger</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=vg>$stdout</span><span class=p>,</span> <span class=ss>:debug</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># (6)</span>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>.</span><span class=n>setup</span><span class=p>(</span><span class=ss>:default</span><span class=p>,</span> <span class=s2>&#34;sqlite:example.db&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>.</span><span class=n>repository</span><span class=p>(</span><span class=ss>:default</span><span class=p>)</span><span class=o>.</span><span class=n>adapter</span><span class=o>.</span><span class=n>resource_naming_convention</span> <span class=o>=</span> <span class=no>PrefixNamingConvention</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># (7)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Person</span>
</span></span><span class=line><span class=cl>  <span class=kp>include</span> <span class=no>DataMapper</span><span class=o>::</span><span class=no>Resource</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:id</span><span class=p>,</span> <span class=no>Serial</span>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:first_name</span><span class=p>,</span> <span class=nb>String</span>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:last_name</span><span class=p>,</span> <span class=nb>String</span>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:email</span><span class=p>,</span> <span class=nb>String</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># (8)</span>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>.</span><span class=n>finalize</span>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>.</span><span class=n>auto_upgrade!</span>
</span></span></code></pre></td></tr></table></div></div><p>So here are some notes on what's going on in this snippet. Each area that I will be discussing has been annotated with a number like "# (1)" to make it easier to find a section you have questions about.</p><ol><li>Since this is an example I'm only including the bare minimum data mapper gems to accomplish the task. If you're using bundler you may need to also require "rubygems" to get this too work.</li><li>This is where the real work happens, DataMapper uses external modules that receive the "call" method to handle the conversion of class names to table names. By default DataMapper uses the module <code>DataMapper::NamingConventions::Resource::UnderscoredAndPluralized</code>, which I'll use later to maintain the same names.</li><li>This is where I'm defining the table prefix. This could be defined in a global, call another method or class, whatever your heart desires to get a string that will be used as a prefix.</li><li>Here I'm getting what DataMapper would have named the table if I wasn't interfering</li><li>I'm logging to standard out so that I can see the queries called to verify that DataMapper is creating tables with the names that I want. This is used later on in this post to demonstrate this solution working, however, it could be left out without affecting anything.</li><li>Initial setup of a sqlite database, and then the good stuff. Once a database has been setup with a specific adapter you can change the naming convention DataMapper will use to generate table names. This is accomplished by passing the module constant name through the repositories adapter and too "resource_naming_convention" as demonstrated in the code.</li><li>Here I'm defining an example model of no importance. This is purely for demonstration, normally DataMapper would name this model "people".</li><li>Inform DataMapper we're done setting it up and to run the migrations to create the model defined.</li></ol><p>When you run this ruby file (assuming you have the "data_mapper" and "dm-sqlite-adapter" gem installed) you'll see output very similar too this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>~ (0.001402) PRAGMA table_info(&#34;source_people&#34;)
</span></span><span class=line><span class=cl>~ (0.000089) SELECT sqlite_version(*)
</span></span><span class=line><span class=cl>~ (0.077840) CREATE TABLE &#34;source_people&#34; (&#34;id&#34; INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, &#34;first_name&#34; VARCHAR(50), &#34;last_name&#34; VARCHAR(50), &#34;email&#34; VARCHAR(50))
</span></span></code></pre></td></tr></table></div></div><p>Notice the third line? Specifically the name of the table? It's named exactly as it would have been except now it has a prefix of "source_".</p><p>Hope this saves someone else some trouble. Cheers!</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/development/>development</a></span>
<span class=tag><a href=https://stelfox.net/tags/ruby/>ruby</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=711e08f5c5f992fdbfe31175065122093c0ad81b target=_blank rel=noopener>711e08f5</a> @ 2024-07-14</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>