<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='So I recently encountered a situation where I needed to define a prefix on the tables used by the &ldquo;data_mapper&rdquo; gem. When I went searching I found quite a bit of information about similar projects in Python, and PHP named DataMapper but nothing about the ruby &ldquo;data_mapper&rdquo;. The search continued eventually ending in my reading through the source of the data_mapper gem only to find that there was no feature for simply defining a prefix.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Adding a Table Prefix to DataMapper Tables • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='So I recently encountered a situation where I needed to define a prefix on the tables used by the &ldquo;data_mapper&rdquo; gem. When I went searching I found quite a bit of information about similar projects in Python, and PHP named DataMapper but nothing about the ruby &ldquo;data_mapper&rdquo;. The search continued eventually ending in my reading through the source of the data_mapper gem only to find that there was no feature for simply defining a prefix.'>
<meta property='og:url' content='https://stelfox.net/blog/2012/08/adding-a-table-prefix-to-datamapper-tables/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='development'><meta property='article:tag' content='ruby'><meta property='article:published_time' content='2012-08-07T14:09:33Z'/><meta property='article:modified_time' content='2012-08-07T14:09:33Z'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.61.0-DEV" />

  <title>Adding a Table Prefix to DataMapper Tables • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2012/08/adding-a-table-prefix-to-datamapper-tables/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Adding a Table Prefix to DataMapper Tables</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2012-08-07T14:09:33Z'>2012, Aug 07</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
3 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>So I recently encountered a situation where I needed to define a prefix on the
tables used by the &ldquo;data_mapper&rdquo; gem. When I went searching I found quite a bit
of information about similar projects in Python, and PHP named DataMapper but
nothing about the ruby &ldquo;data_mapper&rdquo;. The search continued eventually ending in
my reading through the source of the data_mapper gem only to find that there
was no feature for simply defining a prefix.</p>
<p>Reading through the source though did allow me to find any easy way to
implement such functionality. The following snippet is a minimalist data_mapper
initialization and setup of one model with a table prefix of &ldquo;source_&rdquo; (chosen
at random and of no significance).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># encoding: utf-8</span>

<span style="color:#75715e"># (1)</span>
require <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dm-core</span><span style="color:#e6db74">&#34;</span>
require <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dm-migrations</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># (2)</span>
<span style="color:#66d9ef">module</span> PrefixNamingConvention
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">call</span>(model_name)
    <span style="color:#75715e"># (3)</span>
    prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">source_</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#75715e"># (4)</span>
    table_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">DataMapper</span><span style="color:#f92672">::</span><span style="color:#66d9ef">NamingConventions</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Resource</span><span style="color:#f92672">::</span><span style="color:#66d9ef">UnderscoredAndPluralized</span><span style="color:#f92672">.</span>call(model_name)

    <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">#{</span>table_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># (5)</span>
<span style="color:#66d9ef">DataMapper</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Logger</span><span style="color:#f92672">.</span>new($stdout, <span style="color:#e6db74">:debug</span>)

<span style="color:#75715e"># (6)</span>
<span style="color:#66d9ef">DataMapper</span><span style="color:#f92672">.</span>setup(<span style="color:#e6db74">:default</span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sqlite:example.db</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">DataMapper</span><span style="color:#f92672">.</span>repository(<span style="color:#e6db74">:default</span>)<span style="color:#f92672">.</span>adapter<span style="color:#f92672">.</span>resource_naming_convention <span style="color:#f92672">=</span> <span style="color:#66d9ef">PrefixNamingConvention</span>

<span style="color:#75715e"># (7)</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Person</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">DataMapper</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Resource</span>

  property <span style="color:#e6db74">:id</span>, <span style="color:#66d9ef">Serial</span>
  property <span style="color:#e6db74">:first_name</span>, String
  property <span style="color:#e6db74">:last_name</span>, String
  property <span style="color:#e6db74">:email</span>, String
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># (8)</span>
<span style="color:#66d9ef">DataMapper</span><span style="color:#f92672">.</span>finalize
<span style="color:#66d9ef">DataMapper</span><span style="color:#f92672">.</span>auto_upgrade!
</code></pre></div><p>So here are some notes on what's going on in this snippet. Each area that I
will be discussing has been annotated with a number like &ldquo;# (1)&rdquo; to make it
easier to find a section you have questions about.</p>
<ol>
<li>Since this is an example I'm only including the bare minimum data mapper
gems to accomplish the task. If you're using bundler you may need to also
require &ldquo;rubygems&rdquo; to get this too work.</li>
<li>This is where the real work happens, DataMapper uses external modules that
receive the &ldquo;call&rdquo; method to handle the conversion of class names to table
names. By default DataMapper uses the module
&ldquo;DataMapper::NamingConventions::Resource::UnderscoredAndPluralized&rdquo;, which
I'll use later to maintain the same names.</li>
<li>This is where I'm defining the table prefix. This could be defined in a
global, call another method or class, whatever your heart desires to get a
string that will be used as a prefix.</li>
<li>Here I'm getting what DataMapper would have named the table if I wasn't
interferring</li>
<li>I'm logging to standard out so that I can see the queries called to verify
that DataMapper is creating tables with the names that I want. This is used
later on in this post to demonstrate this solution working, however, it
could be left out without affecting anything.</li>
<li>Initial setup of a sqlite database, and then the good stuff. Once a database
has been setup with a specific adapter you can change the naming convention
DataMapper will use to generate table names. This is accomplished by passing
the module constant name through the repositories adapter and too
&ldquo;resource_naming_convention&rdquo; as demonstrated in the code.</li>
<li>Here I'm defining an example model of no importance. This is purely for
demonstration, normally DataMapper would name this model &ldquo;people&rdquo;.</li>
<li>Inform DataMapper we're done setting it up and to run the migrations to
create the model defined.</li>
</ol>
<p>When you run this ruby file (assuming you have the &ldquo;data_mapper&rdquo; and
&ldquo;dm-sqlite-adapter&rdquo; gem installed) you'll see output very similar too this:</p>
<pre><code>~ (0.001402) PRAGMA table_info(&quot;source_people&quot;)
~ (0.000089) SELECT sqlite_version(*)
~ (0.077840) CREATE TABLE &quot;source_people&quot; (&quot;id&quot; INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, &quot;first_name&quot; VARCHAR(50), &quot;last_name&quot; VARCHAR(50), &quot;email&quot; VARCHAR(50))
</code></pre><p>Notice the third line? Specifically the name of the table? It's named exactly
as it would have been except now it has a prefix of &ldquo;source_&quot;.</p>
<p>Hope this saves someone else some trouble. Cheers!</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/development/'>development</a>, <a class='tag' href='/tags/ruby/'>ruby</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2012/07/thoughts-on-ipv6-security-and-mitigation/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Thoughts on IPv6 Security and Mitigation</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2012/08/security-through-obesity/'>
        <span class='screen-reader-text'>Next post: </span>Security Through Obesity<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2019 Sam Stelfox | <!-- raw HTML omitted -->Licensing<!-- raw HTML omitted --></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.67d669ac.js'></script>

</body>

</html>

