<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Jeremy Spilman recently proposed changes to how user's hashes are stored in website's and companies databases. This post was originally going to look at some of the issues involved in the scheme he envisioned, however, he rather quickly posted a followup article with a well thought out solution that countered all of the issues that other people and myself were able to come up with. I'd strongly recommend reading both if you haven't done so."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,development,programming,ruby,security"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2012/08/security-through-obesity/><title>Security Through Obesity :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="Security Through Obesity"><meta itemprop=description content="Jeremy Spilman recently proposed changes to how user's hashes are stored in website's and companies databases. This post was originally going to look at some of the issues involved in the scheme he envisioned, however, he rather quickly posted a followup article with a well thought out solution that countered all of the issues that other people and myself were able to come up with. I'd strongly recommend reading both if you haven't done so."><meta itemprop=datePublished content="2012-08-08T15:06:56+00:00"><meta itemprop=dateModified content="2012-08-08T15:06:56+00:00"><meta itemprop=wordCount content="1014"><meta itemprop=keywords content="Development,Programming,Ruby,Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="Security Through Obesity"><meta name=twitter:description content="Jeremy Spilman recently proposed changes to how user's hashes are stored in website's and companies databases. This post was originally going to look at some of the issues involved in the scheme he envisioned, however, he rather quickly posted a followup article with a well thought out solution that countered all of the issues that other people and myself were able to come up with. I'd strongly recommend reading both if you haven't done so."><meta property="article:published_time" content="2012-08-08 15:06:56 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2012/08/security-through-obesity/>Security Through Obesity</a></h2><div class=post-content><p>Jeremy Spilman recently <a href=http://www.opine.me/a-better-way-to-store-password-hashes/>proposed changes</a> to how user's hashes are stored in website's and companies databases. This post was originally going to look at some of the issues involved in the scheme he envisioned, however, he rather quickly posted a <a href=http://www.opine.me/all-your-hashes-arent-belong-to-us/>followup article</a> with a well thought out solution that countered all of the issues that other people and myself were able to come up with. I'd strongly recommend reading both if you haven't done so. Instead of announcing flaws, I'm turning this into a post with a simple functional implementation of the described scheme in Ruby using DataMapper.</p><p>At first I'd like to point out that this is one of those few examples where a form of security through obscurity is actually increasing not only the perceived security but the cost to attack a system as well.</p><p>Please note this code is a minimal, functional, example and should not be used in production. It is missing a lot of things that I personally would add before attempting to use this but that is an exercise for the reader. I'll walk through the code briefly afterwards going over some bits.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39>39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40>40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41>41</a>
</span><span class=lnt id=hl-0-42><a class=lnlinks href=#hl-0-42>42</a>
</span><span class=lnt id=hl-0-43><a class=lnlinks href=#hl-0-43>43</a>
</span><span class=lnt id=hl-0-44><a class=lnlinks href=#hl-0-44>44</a>
</span><span class=lnt id=hl-0-45><a class=lnlinks href=#hl-0-45>45</a>
</span><span class=lnt id=hl-0-46><a class=lnlinks href=#hl-0-46>46</a>
</span><span class=lnt id=hl-0-47><a class=lnlinks href=#hl-0-47>47</a>
</span><span class=lnt id=hl-0-48><a class=lnlinks href=#hl-0-48>48</a>
</span><span class=lnt id=hl-0-49><a class=lnlinks href=#hl-0-49>49</a>
</span><span class=lnt id=hl-0-50><a class=lnlinks href=#hl-0-50>50</a>
</span><span class=lnt id=hl-0-51><a class=lnlinks href=#hl-0-51>51</a>
</span><span class=lnt id=hl-0-52><a class=lnlinks href=#hl-0-52>52</a>
</span><span class=lnt id=hl-0-53><a class=lnlinks href=#hl-0-53>53</a>
</span><span class=lnt id=hl-0-54><a class=lnlinks href=#hl-0-54>54</a>
</span><span class=lnt id=hl-0-55><a class=lnlinks href=#hl-0-55>55</a>
</span><span class=lnt id=hl-0-56><a class=lnlinks href=#hl-0-56>56</a>
</span><span class=lnt id=hl-0-57><a class=lnlinks href=#hl-0-57>57</a>
</span><span class=lnt id=hl-0-58><a class=lnlinks href=#hl-0-58>58</a>
</span><span class=lnt id=hl-0-59><a class=lnlinks href=#hl-0-59>59</a>
</span><span class=lnt id=hl-0-60><a class=lnlinks href=#hl-0-60>60</a>
</span><span class=lnt id=hl-0-61><a class=lnlinks href=#hl-0-61>61</a>
</span><span class=lnt id=hl-0-62><a class=lnlinks href=#hl-0-62>62</a>
</span><span class=lnt id=hl-0-63><a class=lnlinks href=#hl-0-63>63</a>
</span><span class=lnt id=hl-0-64><a class=lnlinks href=#hl-0-64>64</a>
</span><span class=lnt id=hl-0-65><a class=lnlinks href=#hl-0-65>65</a>
</span><span class=lnt id=hl-0-66><a class=lnlinks href=#hl-0-66>66</a>
</span><span class=lnt id=hl-0-67><a class=lnlinks href=#hl-0-67>67</a>
</span><span class=lnt id=hl-0-68><a class=lnlinks href=#hl-0-68>68</a>
</span><span class=lnt id=hl-0-69><a class=lnlinks href=#hl-0-69>69</a>
</span><span class=lnt id=hl-0-70><a class=lnlinks href=#hl-0-70>70</a>
</span><span class=lnt id=hl-0-71><a class=lnlinks href=#hl-0-71>71</a>
</span><span class=lnt id=hl-0-72><a class=lnlinks href=#hl-0-72>72</a>
</span><span class=lnt id=hl-0-73><a class=lnlinks href=#hl-0-73>73</a>
</span><span class=lnt id=hl-0-74><a class=lnlinks href=#hl-0-74>74</a>
</span><span class=lnt id=hl-0-75><a class=lnlinks href=#hl-0-75>75</a>
</span><span class=lnt id=hl-0-76><a class=lnlinks href=#hl-0-76>76</a>
</span><span class=lnt id=hl-0-77><a class=lnlinks href=#hl-0-77>77</a>
</span><span class=lnt id=hl-0-78><a class=lnlinks href=#hl-0-78>78</a>
</span><span class=lnt id=hl-0-79><a class=lnlinks href=#hl-0-79>79</a>
</span><span class=lnt id=hl-0-80><a class=lnlinks href=#hl-0-80>80</a>
</span><span class=lnt id=hl-0-81><a class=lnlinks href=#hl-0-81>81</a>
</span><span class=lnt id=hl-0-82><a class=lnlinks href=#hl-0-82>82</a>
</span><span class=lnt id=hl-0-83><a class=lnlinks href=#hl-0-83>83</a>
</span><span class=lnt id=hl-0-84><a class=lnlinks href=#hl-0-84>84</a>
</span><span class=lnt id=hl-0-85><a class=lnlinks href=#hl-0-85>85</a>
</span><span class=lnt id=hl-0-86><a class=lnlinks href=#hl-0-86>86</a>
</span><span class=lnt id=hl-0-87><a class=lnlinks href=#hl-0-87>87</a>
</span><span class=lnt id=hl-0-88><a class=lnlinks href=#hl-0-88>88</a>
</span><span class=lnt id=hl-0-89><a class=lnlinks href=#hl-0-89>89</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># encoding: utf-8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;rubygems&#34;</span>           <span class=c1># You only need this if you use bundler</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;dm-core&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;dm-migrations&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;dm-sqlite-adapter&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;dm-validations&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;scrypt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>.</span><span class=n>setup</span> <span class=ss>:default</span><span class=p>,</span> <span class=s2>&#34;sqlite:hash.db&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span>
</span></span><span class=line><span class=cl>  <span class=kp>include</span> <span class=no>DataMapper</span><span class=o>::</span><span class=no>Resource</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:id</span><span class=p>,</span>             <span class=no>Serial</span>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:username</span><span class=p>,</span>       <span class=nb>String</span><span class=p>,</span> <span class=ss>:required</span> <span class=o>=&gt;</span> <span class=kp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=ss>:unique</span> <span class=o>=&gt;</span> <span class=kp>true</span> 
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:crypt_hash</span><span class=p>,</span>     <span class=nb>String</span><span class=p>,</span> <span class=ss>:required</span> <span class=o>=&gt;</span> <span class=kp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=ss>:length</span> <span class=o>=&gt;</span> <span class=mi>64</span>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:salt</span><span class=p>,</span>           <span class=nb>String</span><span class=p>,</span> <span class=ss>:required</span> <span class=o>=&gt;</span> <span class=kp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=ss>:length</span> <span class=o>=&gt;</span> <span class=mi>25</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>check_password</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_hash</span> <span class=o>=</span> <span class=n>scrypt_helper</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span> <span class=nb>self</span><span class=o>.</span><span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>hash_obj</span> <span class=o>=</span> <span class=no>SiteHash</span><span class=o>.</span><span class=n>first</span><span class=p>(</span><span class=ss>:crypt_hash</span> <span class=o>=&gt;</span> <span class=n>encrypted_hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>hash_obj</span><span class=o>.</span><span class=n>nil?</span>
</span></span><span class=line><span class=cl>      <span class=nb>puts</span> <span class=s2>&#34;Invalid password&#34;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kp>false</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>verification_hash</span> <span class=o>=</span> <span class=n>scrypt_helper</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span> <span class=n>hash_obj</span><span class=o>.</span><span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>self</span><span class=o>.</span><span class=n>crypt_hash</span> <span class=o>==</span> <span class=n>verification_hash</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=nb>puts</span> <span class=s2>&#34;WARNING: Found matching hash, but verification failed.&#34;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kp>false</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>password</span><span class=o>=</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_salt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_password</span> <span class=o>=</span> <span class=no>SiteHash</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_password</span><span class=o>.</span><span class=n>crypt_hash</span> <span class=o>=</span> <span class=n>scrypt_helper</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                  <span class=nb>self</span><span class=o>.</span><span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_password</span><span class=o>.</span><span class=n>save</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>self</span><span class=o>.</span><span class=n>crypt_hash</span> <span class=o>=</span> <span class=n>scrypt_helper</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>encrypted_password</span><span class=o>.</span><span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>generate_salt</span>
</span></span><span class=line><span class=cl>    <span class=nb>self</span><span class=o>.</span><span class=n>salt</span> <span class=o>=</span> <span class=no>SCrypt</span><span class=o>::</span><span class=no>Engine</span><span class=o>.</span><span class=n>generate_salt</span><span class=p>(</span><span class=ss>:max_time</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=o>.</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>scrypt_helper</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span> <span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=no>SCrypt</span><span class=o>::</span><span class=no>Engine</span><span class=o>.</span><span class=n>scrypt</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span> <span class=n>salt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=no>SCrypt</span><span class=o>::</span><span class=no>Engine</span><span class=o>.</span><span class=n>autodetect_cost</span><span class=p>(</span><span class=n>salt</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                          <span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;H*&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>first</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SiteHash</span>
</span></span><span class=line><span class=cl>  <span class=kp>include</span> <span class=no>DataMapper</span><span class=o>::</span><span class=no>Resource</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:id</span><span class=p>,</span>             <span class=no>Serial</span>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:crypt_hash</span><span class=p>,</span>     <span class=nb>String</span><span class=p>,</span>   <span class=ss>:required</span> <span class=o>=&gt;</span> <span class=kp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=ss>:length</span> <span class=o>=&gt;</span> <span class=mi>64</span>
</span></span><span class=line><span class=cl>  <span class=n>property</span> <span class=ss>:salt</span><span class=p>,</span>           <span class=nb>String</span><span class=p>,</span>   <span class=ss>:required</span> <span class=o>=&gt;</span> <span class=kp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=ss>:length</span> <span class=o>=&gt;</span> <span class=mi>25</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>super</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_salt</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>generate_salt</span>
</span></span><span class=line><span class=cl>    <span class=nb>self</span><span class=o>.</span><span class=n>salt</span> <span class=o>=</span> <span class=no>SCrypt</span><span class=o>::</span><span class=no>Engine</span><span class=o>.</span><span class=n>generate_salt</span><span class=p>(</span><span class=ss>:max_time</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=o>.</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>.</span><span class=n>finalize</span>
</span></span><span class=line><span class=cl><span class=no>DataMapper</span><span class=o>.</span><span class=n>auto_upgrade!</span>
</span></span></code></pre></td></tr></table></div></div><p>I tried to keep this as a simple minimum implementation without playing golf. Strictly speaking the validations on the data_mapper models aren't necessary and could have been removed, in this case, however, the length fields do actually indicate a bit more of what you might expect to see in the database, while the requires are just good habits living on.</p><p>Both of the two models are required to have both a salt and a hash, the name <code>crypt_hash</code> was chosen do too a conflict with one of data_mapper's reserved words <code>hash</code>, the same goes for the model name, however, that class comes from elsewhere. Raw scrypt'd hashes are 256 bits long or 64 hex characters long, while the salts are 64 bits (16 hex characters) plus some meta-data totaling 25 hex characters in this example.</p><p>Salts are hashes are computed by the "scrypt" gem. In this example I've bumped up the max time option to create a hash from the default of 0.2 seconds up to 1 second. This is one of those things that I could have left out as the default is fine for an example, but it also couldn't hurt slightly increasing it in case someone did copy-paste this into production.</p><p>The one thing that I'd like to point out is a couple of "puts" statements I dropped in the check_password method on the User model. The first one simply announces an invalid password. A lot of these could indicate a brute force attack. The second one is more serious, it indicates that there is either a bug in the code, a hash collision has occurred, or an attacker has been able to drop in hash of their choosing into the site_hashes table, but haven't updated the verification hash on the user model yet. I'd strongly recommend reading through both of Jeremy's posts if you want to understand how this threat works and specifically the second post to see how the verification hash protects what it does.</p><p>So how would you use this code? Well you'd want to create a user with a password and then check if their password is valid or not later on like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>User</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=ss>:username</span> <span class=o>=&gt;</span> <span class=s1>&#39;admin&#39;</span><span class=p>,</span> <span class=ss>:password</span> <span class=o>=&gt;</span> <span class=s1>&#39;admin&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=no>User</span><span class=o>.</span><span class=n>first</span><span class=p>(</span><span class=ss>:username</span> <span class=o>=&gt;</span> <span class=s1>&#39;admin&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>check_password</span><span class=p>(</span><span class=s1>&#39;admin&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>One of the key ways this separation increases the security of real users hashes is by having a large number of fake hashes in the hash table that the attackers will have to crack at the same time. As a bonus I've written a module to handle just that for the code I've already provided. Once again this is licensed under the MIT license and should not be considered production ready.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24>24</a>
</span><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25>25</a>
</span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29>29</a>
</span><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30>30</a>
</span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35>35</a>
</span><span class=lnt id=hl-2-36><a class=lnlinks href=#hl-2-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># This is the code above, you can also include everything below</span>
</span></span><span class=line><span class=cl><span class=c1># this in the same file if you&#39;re into that sort of thing</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;user_hash_example&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>HashFaker</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>fast_hash</span>
</span></span><span class=line><span class=cl>    <span class=no>SiteHash</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=ss>:crypt_hash</span> <span class=o>=&gt;</span> <span class=n>get_bytes</span><span class=p>(</span><span class=mi>32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>hash</span>
</span></span><span class=line><span class=cl>    <span class=no>SiteHash</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=ss>:crypt_hash</span> <span class=o>=&gt;</span> <span class=n>scrypt_helper</span><span class=p>(</span><span class=n>get_bytes</span><span class=p>(</span><span class=mi>24</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>generate_salt</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>generate_hashes</span><span class=p>(</span><span class=n>count</span> <span class=o>=</span> <span class=mi>5000</span><span class=p>,</span> <span class=n>fast</span> <span class=o>=</span> <span class=kp>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span><span class=o>.</span><span class=n>times</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=n>fast</span> <span class=p>?</span> <span class=n>fast_hash</span> <span class=p>:</span> <span class=nb>hash</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>generate_salt</span>
</span></span><span class=line><span class=cl>    <span class=no>SCrypt</span><span class=o>::</span><span class=no>Engine</span><span class=o>.</span><span class=n>generate_salt</span><span class=p>(</span><span class=ss>:max_time</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=o>.</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>get_bytes</span><span class=p>(</span><span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=no>OpenSSL</span><span class=o>::</span><span class=no>Random</span><span class=o>.</span><span class=n>random_bytes</span><span class=p>(</span><span class=n>num</span><span class=p>)</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;H*&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>first</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>scrypt_helper</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span> <span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=no>SCrypt</span><span class=o>::</span><span class=no>Engine</span><span class=o>.</span><span class=n>scrypt</span><span class=p>(</span><span class=n>plaintext_password</span><span class=p>,</span> <span class=n>salt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=no>SCrypt</span><span class=o>::</span><span class=no>Engine</span><span class=o>.</span><span class=n>autodetect_cost</span><span class=p>(</span><span class=n>salt</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                          <span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;H*&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>first</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/development/>development</a></span>
<span class=tag><a href=https://stelfox.net/tags/programming/>programming</a></span>
<span class=tag><a href=https://stelfox.net/tags/ruby/>ruby</a></span>
<span class=tag><a href=https://stelfox.net/tags/security/>security</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=5cc61bddb3608f4b520ea01481747b9e2f886434 target=_blank rel=noopener>5cc61bdd</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>