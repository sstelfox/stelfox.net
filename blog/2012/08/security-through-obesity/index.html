<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Jeremy Spilman recently proposed changes to how user&amp;rsquo;s hashes are stored in website&amp;rsquo;s and companies databases. This post was originally going to look at some of the issues involved in the scheme he envisioned, however, he rather quickly posted a followup article with a well thought out solution that countered all of the issues that other people and myself were able to come up with. I&amp;rsquo;d strongly recommend reading both if you haven&amp;rsquo;t done so."><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,development,ruby,security"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2012/08/security-through-obesity/><title>Security Through Obesity :: Sam Stelfox — A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.c8c76086c15b9d686ec1778dcf935d2ad37f3bb9c23165d2bd157ba7b18e5aec.css integrity="sha256-yMdghsFbnWhuwXeNz5NdKtN/O7nCMWXSvRV7p7GOWuw="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Security Through Obesity"><meta itemprop=description content="Jeremy Spilman recently proposed changes to how user’s hashes are stored in website’s and companies databases. This post was originally going to look at some of the issues involved in the scheme he envisioned, however, he rather quickly posted a followup article with a well thought out solution that countered all of the issues that other people and myself were able to come up with. I’d strongly recommend reading both if you haven’t done so."><meta itemprop=datePublished content="2012-08-08T15:06:56+00:00"><meta itemprop=dateModified content="2012-08-08T15:06:56+00:00"><meta itemprop=wordCount content="1021"><meta itemprop=keywords content="Development,Ruby,Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="Security Through Obesity"><meta name=twitter:description content="Jeremy Spilman recently proposed changes to how user’s hashes are stored in website’s and companies databases. This post was originally going to look at some of the issues involved in the scheme he envisioned, however, he rather quickly posted a followup article with a well thought out solution that countered all of the issues that other people and myself were able to come up with. I’d strongly recommend reading both if you haven’t done so."><meta property="article:published_time" content="2012-08-08 15:06:56 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/blog/>Posts</a></li><li><a href=/notes/>Notes</a></li><li><a href=/about/>About Me</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2012/08/security-through-obesity/>Security Through Obesity</a></h2><div class=post-content><p>Jeremy Spilman recently <a href=http://www.opine.me/a-better-way-to-store-password-hashes/>proposed changes</a> to how user&rsquo;s hashes are stored
in website&rsquo;s and companies databases. This post was originally going to look at
some of the issues involved in the scheme he envisioned, however, he rather
quickly posted a <a href=http://www.opine.me/all-your-hashes-arent-belong-to-us/>followup article</a> with a well thought out solution that
countered all of the issues that other people and myself were able to come up
with. I&rsquo;d strongly recommend reading both if you haven&rsquo;t done so. Instead of
announcing flaws, I&rsquo;m turning this into a post with a simple functional
implementation of the described scheme in Ruby using DataMapper.</p><p>At first I&rsquo;d like to point out that this is one of those few examples where a
form of security through obscurity is actually increasing not only the
perceived security but the cost to attack a system as well.</p><p>Please note this code is a minimal, functional, example and should not be used
in production. It is missing a lot of things that I personally would add before
attempting to use this but that is an exercise for the reader. It is licensed
under the MIT license. I&rsquo;ll walk through the code briefly afterwards going over
some bits.</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-1><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-2><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-3><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-4><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-5><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-6><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-7><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-8><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-9><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-10><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-11><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-12><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-13><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-14><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-15><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-16><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-17><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-18><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-19><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-20><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-21><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-22><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-23><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-24><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-25><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-26><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-27><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-28><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-29><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-30><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-31><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-32><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-33><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-34><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-35><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-36><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-37><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-38><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-39><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-40><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-41><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-42><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-43><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-44><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-45><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-46><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-47><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-48><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-49><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-50><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-51><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-52><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-53><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-54><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-55><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-56><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-57><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-58><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-59><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-60><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-61><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-62><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-63><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-64><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-65><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-66><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-66>66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-67><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-67>67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-68><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-68>68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-69><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-69>69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-70><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-70>70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-71><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-71>71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-72><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-72>72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-73><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-73>73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-74><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-74>74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-75><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-75>75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-76><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-76>76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-77><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-77>77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-78><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-78>78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-79><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-79>79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-80><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-80>80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-81><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-81>81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-82><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-82>82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-83><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-83>83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-84><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-84>84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-85><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-85>85</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-86><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-86>86</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-87><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-87>87</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-88><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-88>88</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-ea7793b-89><a style=outline:none;text-decoration:none;color:inherit href=#code-ea7793b-89>89</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#8b949e;font-style:italic># encoding: utf-8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#a5d6ff>&#34;rubygems&#34;</span>           <span style=color:#8b949e;font-style:italic># You only need this if you use bundler</span>
</span></span><span style=display:flex><span>require <span style=color:#a5d6ff>&#34;dm-core&#34;</span>
</span></span><span style=display:flex><span>require <span style=color:#a5d6ff>&#34;dm-migrations&#34;</span>
</span></span><span style=display:flex><span>require <span style=color:#a5d6ff>&#34;dm-sqlite-adapter&#34;</span>
</span></span><span style=display:flex><span>require <span style=color:#a5d6ff>&#34;dm-validations&#34;</span>
</span></span><span style=display:flex><span>require <span style=color:#a5d6ff>&#34;scrypt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#79c0ff;font-weight:700>DataMapper</span><span style=color:#ff7b72;font-weight:700>.</span>setup <span style=color:#a5d6ff>:default</span>, <span style=color:#a5d6ff>&#34;sqlite:hash.db&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>User</span>
</span></span><span style=display:flex><span>  <span style=color:#79c0ff>include</span> <span style=color:#79c0ff;font-weight:700>DataMapper</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Resource</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  property <span style=color:#a5d6ff>:id</span>,             <span style=color:#79c0ff;font-weight:700>Serial</span>
</span></span><span style=display:flex><span>  property <span style=color:#a5d6ff>:username</span>,       String, <span style=color:#a5d6ff>:required</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>                                    <span style=color:#a5d6ff>:unique</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#79c0ff>true</span> 
</span></span><span style=display:flex><span>  property <span style=color:#a5d6ff>:crypt_hash</span>,     String, <span style=color:#a5d6ff>:required</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>                                    <span style=color:#a5d6ff>:length</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>64</span>
</span></span><span style=display:flex><span>  property <span style=color:#a5d6ff>:salt</span>,           String, <span style=color:#a5d6ff>:required</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>                                    <span style=color:#a5d6ff>:length</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>25</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>check_password</span>(plaintext_password)
</span></span><span style=display:flex><span>    encrypted_hash <span style=color:#ff7b72;font-weight:700>=</span> scrypt_helper(plaintext_password, self<span style=color:#ff7b72;font-weight:700>.</span>salt)
</span></span><span style=display:flex><span>    hash_obj <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff;font-weight:700>SiteHash</span><span style=color:#ff7b72;font-weight:700>.</span>first(<span style=color:#a5d6ff>:crypt_hash</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> encrypted_hash)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> hash_obj<span style=color:#ff7b72;font-weight:700>.</span>nil?
</span></span><span style=display:flex><span>      puts <span style=color:#a5d6ff>&#34;Invalid password&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    verification_hash <span style=color:#ff7b72;font-weight:700>=</span> scrypt_helper(plaintext_password, hash_obj<span style=color:#ff7b72;font-weight:700>.</span>salt)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>crypt_hash <span style=color:#ff7b72;font-weight:700>==</span> verification_hash
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>else</span>
</span></span><span style=display:flex><span>      puts <span style=color:#a5d6ff>&#34;WARNING: Found matching hash, but verification failed.&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>password</span><span style=color:#ff7b72;font-weight:700>=</span>(plaintext_password)
</span></span><span style=display:flex><span>    generate_salt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    encrypted_password <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff;font-weight:700>SiteHash</span><span style=color:#ff7b72;font-weight:700>.</span>new
</span></span><span style=display:flex><span>    encrypted_password<span style=color:#ff7b72;font-weight:700>.</span>crypt_hash <span style=color:#ff7b72;font-weight:700>=</span> scrypt_helper(plaintext_password,
</span></span><span style=display:flex><span>                                                  self<span style=color:#ff7b72;font-weight:700>.</span>salt)
</span></span><span style=display:flex><span>    encrypted_password<span style=color:#ff7b72;font-weight:700>.</span>save
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    self<span style=color:#ff7b72;font-weight:700>.</span>crypt_hash <span style=color:#ff7b72;font-weight:700>=</span> scrypt_helper(plaintext_password,
</span></span><span style=display:flex><span>                                    encrypted_password<span style=color:#ff7b72;font-weight:700>.</span>salt)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#79c0ff>private</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>generate_salt</span>
</span></span><span style=display:flex><span>    self<span style=color:#ff7b72;font-weight:700>.</span>salt <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff;font-weight:700>SCrypt</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Engine</span><span style=color:#ff7b72;font-weight:700>.</span>generate_salt(<span style=color:#a5d6ff>:max_time</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>1</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#a5d6ff>0</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>scrypt_helper</span>(plaintext_password, salt)
</span></span><span style=display:flex><span>    <span style=color:#79c0ff;font-weight:700>SCrypt</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Engine</span><span style=color:#ff7b72;font-weight:700>.</span>scrypt(plaintext_password, salt,
</span></span><span style=display:flex><span>                          <span style=color:#79c0ff;font-weight:700>SCrypt</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Engine</span><span style=color:#ff7b72;font-weight:700>.</span>autodetect_cost(salt),
</span></span><span style=display:flex><span>                          <span style=color:#a5d6ff>32</span>)<span style=color:#ff7b72;font-weight:700>.</span>unpack(<span style=color:#a5d6ff>&#39;H*&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>first
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SiteHash</span>
</span></span><span style=display:flex><span>  <span style=color:#79c0ff>include</span> <span style=color:#79c0ff;font-weight:700>DataMapper</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Resource</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  property <span style=color:#a5d6ff>:id</span>,             <span style=color:#79c0ff;font-weight:700>Serial</span>
</span></span><span style=display:flex><span>  property <span style=color:#a5d6ff>:crypt_hash</span>,     String,   <span style=color:#a5d6ff>:required</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>                                      <span style=color:#a5d6ff>:length</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>64</span>
</span></span><span style=display:flex><span>  property <span style=color:#a5d6ff>:salt</span>,           String,   <span style=color:#a5d6ff>:required</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>                                      <span style=color:#a5d6ff>:length</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>25</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>initialize</span>(<span style=color:#ff7b72;font-weight:700>*</span>args)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>super</span>
</span></span><span style=display:flex><span>    generate_salt
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#79c0ff>private</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>generate_salt</span>
</span></span><span style=display:flex><span>    self<span style=color:#ff7b72;font-weight:700>.</span>salt <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff;font-weight:700>SCrypt</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Engine</span><span style=color:#ff7b72;font-weight:700>.</span>generate_salt(<span style=color:#a5d6ff>:max_time</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>1</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#a5d6ff>0</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#79c0ff;font-weight:700>DataMapper</span><span style=color:#ff7b72;font-weight:700>.</span>finalize
</span></span><span style=display:flex><span><span style=color:#79c0ff;font-weight:700>DataMapper</span><span style=color:#ff7b72;font-weight:700>.</span>auto_upgrade!</span></span></code></pre></td></tr></table></div></div><p>I tried to keep this as a simple minimum implementation without playing golf.
Strictly speaking the validations on the data_mapper models aren&rsquo;t necessary
and could have been removed, in this case, however, the length fields do
actually indicate a bit more of what you might expect to see in the database,
while the requires are just good habits living on.</p><p>Both of the two models are required to have both a salt and a hash, the name
&lsquo;crypt_hash&rsquo; was chosen do too a conflict with one of data_mapper&rsquo;s reserved
words &lsquo;hash&rsquo;, the same goes for the model name, however, that class comes from
elsewhere. Raw scrypt&rsquo;d hashes are 256 bits long or 64 hex characters long,
while the salts are 64 bits (16 hex characters) plus some meta-data totaling 25
hex characters in this example.</p><p>Salts are hashes are computed by the &lsquo;scrypt&rsquo; gem. In this example I&rsquo;ve bumped
up the max time option to create a hash from the default of 0.2 seconds up to 1
second. This is one of those things that I could have left out as the default
is fine for an example, but it also couldn&rsquo;t hurt slightly increasing it in
case someone did copy-paste this into production.</p><p>The one thing that I&rsquo;d like to point out is a couple of &lsquo;puts&rsquo; statements I
dropped in the check_password method on the User model. The first one simply
announces an invalid password. A lot of these could indicate a brute force
attack. The second one is more serious, it indicates that there is either a bug
in the code, a hash collision has occurred, or an attacker has been able to
drop in hash of their choosing into the site_hashes table, but haven&rsquo;t updated
the verification hash on the user model yet. I&rsquo;d strongly recommend reading
through both of Jeremy&rsquo;s posts if you want to understand how this threat works
and specifically the second post to see how the verification hash protects what
it does.</p><p>So how would you use this code? Well you&rsquo;d want to create a user with a
password and then check if their password is valid or not later on like so:</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-5dcd3a9-1><a style=outline:none;text-decoration:none;color:inherit href=#code-5dcd3a9-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-5dcd3a9-2><a style=outline:none;text-decoration:none;color:inherit href=#code-5dcd3a9-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#79c0ff;font-weight:700>User</span><span style=color:#ff7b72;font-weight:700>.</span>create(<span style=color:#a5d6ff>:username</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>&#39;admin&#39;</span>, <span style=color:#a5d6ff>:password</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>&#39;admin&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#79c0ff;font-weight:700>User</span><span style=color:#ff7b72;font-weight:700>.</span>first(<span style=color:#a5d6ff>:username</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>&#39;admin&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>check_password(<span style=color:#a5d6ff>&#39;admin&#39;</span>)</span></span></code></pre></td></tr></table></div></div><p>One of the key ways this separation increases the security of real users hashes
is by having a large number of fake hashes in the hash table that the attackers
will have to crack at the same time. As a bonus I&rsquo;ve written a module to handle
just that for the code I&rsquo;ve already provided. Once again this is licensed under
the MIT license and should not be considered production ready.</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-1><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-2><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-3><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-4><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-5><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-6><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-7><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-8><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-9><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-10><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-11><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-12><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-13><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-14><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-15><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-16><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-17><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-18><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-19><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-20><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-21><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-22><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-23><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-24><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-25><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-26><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-27><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-28><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-29><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-30><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-31><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-32><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-33><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-34><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-35><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679" id=code-e287de9-36><a style=outline:none;text-decoration:none;color:inherit href=#code-e287de9-36>36</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#8b949e;font-style:italic># This is the code above, you can also include everything below</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># this in the same file if you&#39;re into that sort of thing</span>
</span></span><span style=display:flex><span>require <span style=color:#a5d6ff>&#34;user_hash_example&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>module</span> <span style=color:#ff7b72>HashFaker</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#f0883e;font-weight:700>self</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#d2a8ff;font-weight:700>fast_hash</span>
</span></span><span style=display:flex><span>    <span style=color:#79c0ff;font-weight:700>SiteHash</span><span style=color:#ff7b72;font-weight:700>.</span>create(<span style=color:#a5d6ff>:crypt_hash</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> get_bytes(<span style=color:#a5d6ff>32</span>))
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#f0883e;font-weight:700>self</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#d2a8ff;font-weight:700>hash</span>
</span></span><span style=display:flex><span>    <span style=color:#79c0ff;font-weight:700>SiteHash</span><span style=color:#ff7b72;font-weight:700>.</span>create(<span style=color:#a5d6ff>:crypt_hash</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> scrypt_helper(get_bytes(<span style=color:#a5d6ff>24</span>),
</span></span><span style=display:flex><span>                                                 generate_salt))
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#f0883e;font-weight:700>self</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#d2a8ff;font-weight:700>generate_hashes</span>(count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>5000</span>, fast <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span>)
</span></span><span style=display:flex><span>    count<span style=color:#ff7b72;font-weight:700>.</span>times <span style=color:#ff7b72>do</span>
</span></span><span style=display:flex><span>      fast ? fast_hash : hash
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#79c0ff>private</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#f0883e;font-weight:700>self</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#d2a8ff;font-weight:700>generate_salt</span>
</span></span><span style=display:flex><span>    <span style=color:#79c0ff;font-weight:700>SCrypt</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Engine</span><span style=color:#ff7b72;font-weight:700>.</span>generate_salt(<span style=color:#a5d6ff>:max_time</span> <span style=color:#ff7b72;font-weight:700>=&gt;</span> <span style=color:#a5d6ff>1</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#a5d6ff>0</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#f0883e;font-weight:700>self</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#d2a8ff;font-weight:700>get_bytes</span>(num)
</span></span><span style=display:flex><span>    <span style=color:#79c0ff;font-weight:700>OpenSSL</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Random</span><span style=color:#ff7b72;font-weight:700>.</span>random_bytes(num)<span style=color:#ff7b72;font-weight:700>.</span>unpack(<span style=color:#a5d6ff>&#39;H*&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>first
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>def</span> <span style=color:#f0883e;font-weight:700>self</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#d2a8ff;font-weight:700>scrypt_helper</span>(plaintext_password, salt)
</span></span><span style=display:flex><span>    <span style=color:#79c0ff;font-weight:700>SCrypt</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Engine</span><span style=color:#ff7b72;font-weight:700>.</span>scrypt(plaintext_password, salt,
</span></span><span style=display:flex><span>                          <span style=color:#79c0ff;font-weight:700>SCrypt</span><span style=color:#ff7b72;font-weight:700>::</span><span style=color:#79c0ff;font-weight:700>Engine</span><span style=color:#ff7b72;font-weight:700>.</span>autodetect_cost(salt),
</span></span><span style=display:flex><span>                          <span style=color:#a5d6ff>32</span>)<span style=color:#ff7b72;font-weight:700>.</span>unpack(<span style=color:#a5d6ff>&#39;H*&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>first
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>end</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>end</span></span></span></code></pre></td></tr></table></div></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/development/>development</a></span>
<span class=tag><a href=https://stelfox.net/tags/ruby/>ruby</a></span>
<span class=tag><a href=https://stelfox.net/tags/security/>security</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=bd9e1ab3269fdee0856f80854c902432ef10f201 target=_blank rel=noopener>bd9e1ab3</a> @ 2024-07-14</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>