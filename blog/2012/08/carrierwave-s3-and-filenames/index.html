<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='This is going to be a real quick post. I&rsquo;m using the &ldquo;carrier_wave&rdquo; gem with &ldquo;fog&rdquo; for one of my projects and found that when a file is stored on S3 the &ldquo;identifier&rdquo;, and &ldquo;filename&rdquo; methods return nil. I got around this issue in two separate ways neither of which I&rsquo;m particularly happy about.
Outside of the uploader, you can use the File utility and the URL of the object to get the base filename like so:'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='CarrierWave, S3 and Filenames • Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:description' content='This is going to be a real quick post. I&rsquo;m using the &ldquo;carrier_wave&rdquo; gem with &ldquo;fog&rdquo; for one of my projects and found that when a file is stored on S3 the &ldquo;identifier&rdquo;, and &ldquo;filename&rdquo; methods return nil. I got around this issue in two separate ways neither of which I&rsquo;m particularly happy about.
Outside of the uploader, you can use the File utility and the URL of the object to get the base filename like so:'>
<meta property='og:url' content='https://stelfox.net/blog/2012/08/carrierwave-s3-and-filenames/'>
<meta property='og:site_name' content='Sam Stelfox&#39;s Thoughts &amp; Notes'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='development'><meta property='article:tag' content='ruby'><meta property='article:published_time' content='2012-08-09T20:00:57Z'/><meta property='article:modified_time' content='2012-08-09T20:00:57Z'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.50-DEV" />

  <title>CarrierWave, S3 and Filenames • Sam Stelfox&#39;s Thoughts &amp; Notes</title>
  <link rel='canonical' href='https://stelfox.net/blog/2012/08/carrierwave-s3-and-filenames/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.dd2efce5.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-32188490-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/blog/'>Blog Posts</a>
      </li><li class='item'>
        <a href='/notes/'>Various Notes</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Sam Stelfox&#39;s Thoughts &amp; Notes</p><p class='desc site-desc'>Thoughts from a software engineer, systems architect and Linux gubernāre.</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>CarrierWave, S3 and Filenames</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2012-08-09T20:00:57Z'>2012, Aug 09</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
2 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>This is going to be a real quick post. I&rsquo;m using the &ldquo;carrier_wave&rdquo; gem with
&ldquo;fog&rdquo; for one of my projects and found that when a file is stored on S3 the
&ldquo;identifier&rdquo;, and &ldquo;filename&rdquo; methods return nil. I got around this issue in two
separate ways neither of which I&rsquo;m particularly happy about.</p>

<p>Outside of the uploader, you can use the File utility and the URL of the object
to get the base filename like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>basename(<span style="color:#66d9ef">Model</span><span style="color:#f92672">.</span>asset<span style="color:#f92672">.</span>url)</code></pre></div>
<p>If you try and do this within the uploader itself like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>basename(self<span style="color:#f92672">.</span>url)</code></pre></div>
<p>It will work, but not when creating additional versions such as thumbnails as
the file hasn&rsquo;t actually been created yet so a URL can&rsquo;t be built and you&rsquo;ll
get an error trying to perform <code>File.basename(nil)</code>. You&rsquo;d need to go back up
to the model and get the normal version&rsquo;s URL like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>basename(self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>asset<span style="color:#f92672">.</span>url)</code></pre></div>
<p>Now if you&rsquo;re trying to get the file name to build part of the store_dir,
you&rsquo;ve just created an infinite loop! Ruby will be happy to tell you that the
stack level too deep (<code>SystemStackError</code>). So ultimately how did I end up
getting it into my store_dir?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>attributes<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;asset&#34;</span><span style="color:#f92672">]</span></code></pre></div>
<p>The file name gets stored raw directly in the database, and thus you can pull
it out by accessing the value directly without going through the accessor that
get overridden by CarrierWave. I&rsquo;m pretty sure this is a bug, and will report
it with example code and a test (as is appropriate for any bug report <em>hint</em>)
as soon as my dead line has passed.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/development/'>development</a>, <a class='tag' href='/tags/ruby/'>ruby</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2012/08/security-through-obesity/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Security Through Obesity</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2012/11/auditing-heroku-ssh-keys/'>
        <span class='screen-reader-text'>Next post: </span>Auditing Heroku SSH Keys<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2011-2019 Sam Stelfox | <a rel='license' href='/licenses/'>Licensing</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.00df04b7.js'></script>

</body>

</html>

