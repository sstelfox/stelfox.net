<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="This is going to be a real quick post. I'm using the &amp;quot;carrier_wave&amp;quot; gem with &amp;quot;fog&amp;quot; for one of my projects and found that when a file is stored on S3 the &amp;quot;identifier&amp;quot;, and &amp;quot;filename&amp;quot; methods return nil. I got around this issue in two separate ways neither of which I'm particularly happy about.
Outside of the uploader, you can use the File utility and the URL of the object to get the base filename like so:"><meta name=keywords content="blog,programming,linux,systems,personal,rust,philosophy,development,ruby"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://stelfox.net/blog/2012/08/carrierwave-s3-and-filenames/><title>CarrierWave, S3 and Filenames :: ./Sam_Stelfox.sh â€” A simple place for my collected thoughts and notes.
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta itemprop=name content="CarrierWave, S3 and Filenames"><meta itemprop=description content='This is going to be a real quick post. I&#39;m using the "carrier_wave" gem with "fog" for one of my projects and found that when a file is stored on S3 the "identifier", and "filename" methods return nil. I got around this issue in two separate ways neither of which I&#39;m particularly happy about.
Outside of the uploader, you can use the File utility and the URL of the object to get the base filename like so:'><meta itemprop=datePublished content="2012-08-09T20:00:57+00:00"><meta itemprop=dateModified content="2012-08-09T20:00:57+00:00"><meta itemprop=wordCount content="261"><meta itemprop=keywords content="Development,Ruby"><meta name=twitter:card content="summary"><meta name=twitter:title content="CarrierWave, S3 and Filenames"><meta name=twitter:description content='This is going to be a real quick post. I&#39;m using the "carrier_wave" gem with "fog" for one of my projects and found that when a file is stored on S3 the "identifier", and "filename" methods return nil. I got around this issue in two separate ways neither of which I&#39;m particularly happy about.
Outside of the uploader, you can use the File utility and the URL of the object to get the base filename like so:'><meta property="article:published_time" content="2012-08-09 20:00:57 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>./Sam_Stelfox.sh</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/notes/>Notes</a></li><li><a href=/blog/>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://stelfox.net/blog/2012/08/carrierwave-s3-and-filenames/>CarrierWave, S3 and Filenames</a></h2><div class=post-content><p>This is going to be a real quick post. I'm using the "carrier_wave" gem with "fog" for one of my projects and found that when a file is stored on S3 the "identifier", and "filename" methods return nil. I got around this issue in two separate ways neither of which I'm particularly happy about.</p><p>Outside of the uploader, you can use the File utility and the URL of the object to get the base filename like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>File</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=no>Model</span><span class=o>.</span><span class=n>asset</span><span class=o>.</span><span class=n>url</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>If you try and do this within the uploader itself like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>File</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=nb>self</span><span class=o>.</span><span class=n>url</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>It will work, but not when creating additional versions such as thumbnails as the file hasn't actually been created yet so a URL can't be built and you'll get an error trying to perform <code>File.basename(nil)</code>. You'd need to go back up to the model and get the normal version's URL like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>File</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=nb>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>asset</span><span class=o>.</span><span class=n>url</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Now if you're trying to get the file name to build part of the store_dir, you've just created an infinite loop! Ruby will be happy to tell you that the stack level too deep (<code>SystemStackError</code>). So ultimately how did I end up getting it into my store_dir?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>attributes</span><span class=o>[</span><span class=s2>&#34;asset&#34;</span><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>The file name gets stored raw directly in the database, and thus you can pull it out by accessing the value directly without going through the accessor that get overridden by CarrierWave. I'm pretty sure this is a bug, and will report it with example code and a test (as is appropriate for any bug report <em>hint</em>) as soon as my dead line has passed.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://stelfox.net/tags/development/>development</a></span>
<span class=tag><a href=https://stelfox.net/tags/ruby/>ruby</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=5cc61bddb3608f4b520ea01481747b9e2f886434 target=_blank rel=noopener>5cc61bdd</a> @ 2024-07-15</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>